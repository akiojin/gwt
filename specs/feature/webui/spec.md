# 機能仕様: Web UI機能の追加

**仕様ID**: `SPEC-d5e56259`
**作成日**: 2025-11-10
**ステータス**: ドラフト
**入力**: ユーザー説明: "Web UI機能の追加 - claude-worktree serveコマンドでWebサーバーを起動し、ブラウザからWorktree管理とAI Tool起動を行えるようにする"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Webサーバーの起動とアクセス (優先度: P1)

開発者は`claude-worktree serve`コマンドを実行してローカルでWebサーバーを起動し、ブラウザから`http://localhost:3000`にアクセスしてWorktree管理画面を表示できる。

**この優先度の理由**: Web UIの基盤となる機能であり、すべての後続機能の前提条件。サーバーが起動しなければ他の機能は使用できない。

**独立したテスト**: `claude-worktree serve`を実行してブラウザでアクセスし、正常にページが表示されることで完全にテストでき、CLIを使わずにブラウザからアクセスできるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** ターミナルでclaude-worktreeがインストール済み、**操作** `claude-worktree serve`を実行、**期待結果** "Server running at <http://localhost:3000>"のようなメッセージが表示され、サーバーが起動する
2. **前提条件** Webサーバーが起動中、**操作** ブラウザで<http://localhost:3000>にアクセス、**期待結果** Worktree管理のWebインターフェースが表示される
3. **前提条件** Webサーバーが起動中、**操作** `Ctrl+C`でサーバーを停止、**期待結果** サーバーが正常にシャットダウンし、ブラウザからアクセスできなくなる

---

### ユーザーストーリー 2 - ブラウザからブランチ一覧の表示とWorktree作成 (優先度: P1)

開発者はブラウザでブランチ一覧を見て、作業したいブランチを選択し、クリック操作でWorktreeを作成できる。

**この優先度の理由**: Worktree管理の核心機能であり、CLIの主要機能をWeb UIで実現する最重要機能。ユーザーはマウス操作で直感的にWorktreeを作成できるようになる。

**独立したテスト**: ブラウザからブランチリストを表示し、任意のブランチを選択してWorktreeを作成することで完全にテストでき、CLIコマンドを覚えずに視覚的に操作できるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** Web UIが起動中、**操作** ブランチ一覧画面にアクセス、**期待結果** ローカルとリモートのすべてのブランチがリスト表示される
2. **前提条件** ブランチ一覧が表示中、**操作** 任意のブランチを選択して「Worktreeを作成」ボタンをクリック、**期待結果** Worktreeが作成され、作成完了のメッセージが表示される
3. **前提条件** 既存のWorktreeがあるブランチ、**操作** そのブランチを選択、**期待結果** 「Worktree already exists」のような情報が表示され、既存のWorktreeパスが示される
4. **前提条件** ブランチ一覧が表示中、**操作** 検索ボックスでブランチ名をフィルター、**期待結果** 入力内容に合致するブランチのみが表示される

---

### ユーザーストーリー 3 - ブラウザからAI Toolの起動とリアルタイム出力表示 (優先度: P1)

開発者はブラウザでAI Tool (Claude Code/Codex CLI) を選択して起動し、ターミナル風の画面でリアルタイムに出力を確認し、キーボード入力でインタラクティブに操作できる。

**この優先度の理由**: Web UIの最大の価値であるAI Toolとの統合。ブラウザからターミナル操作を行うことで、リモート環境での作業やタブ管理が容易になる。

**独立したテスト**: ブラウザからClaude Codeを起動し、ターミナル画面でリアルタイムな出力と入力が動作することで完全にテストでき、ブラウザでターミナル操作ができるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** Worktreeが作成済み、**操作** ブランチを選択して「AI Toolを起動」をクリック、**期待結果** AI Tool選択画面が表示される（Claude Code、Codex CLI、Custom Tool）
2. **前提条件** AI Tool選択画面、**操作** Claude Codeを選択し、モード（normal/continue/resume）を選択して起動、**期待結果** ブラウザ内にターミナル画面が表示され、Claude Codeの起動ログがリアルタイムで表示される
3. **前提条件** Claude Codeが起動中、**操作** ターミナル画面でキーボード入力（例: プロンプト入力）、**期待結果** 入力がClaude Codeに送信され、応答がリアルタイムで表示される
4. **前提条件** Claude Codeが起動中、**操作** ターミナルのサイズを変更、**期待結果** ターミナルが新しいサイズに適応し、表示が再調整される
5. **前提条件** Claude Codeが実行中、**操作** ブラウザタブを閉じる、**期待結果** バックグラウンドでセッションが継続し、再接続時に出力履歴が表示される

---

### ユーザーストーリー 4 - Worktreeの削除と管理 (優先度: P2)

開発者はブラウザから既存のWorktree一覧を確認し、不要なWorktreeを削除できる。また、マージ済みPRのWorktreeを一括クリーンアップできる。

**この優先度の理由**: Worktreeのライフサイクル管理機能。作成だけでなく削除も可能にすることで、ディスク容量の管理が容易になる。

**独立したテスト**: Worktree管理画面から既存のWorktreeを選択して削除し、ファイルシステムから削除されることで完全にテストでき、不要なWorktreeを簡単に整理できるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** 複数のWorktreeが存在、**操作** Worktree管理画面にアクセス、**期待結果** すべてのWorktreeがリスト表示され、各Worktreeのブランチ名とパスが表示される
2. **前提条件** Worktree一覧が表示中、**操作** 任意のWorktreeを選択して「削除」ボタンをクリック、**期待結果** 確認ダイアログが表示され、OKを押すとWorktreeが削除される
3. **前提条件** マージ済みのPRブランチに対応するWorktreeが存在、**操作** 「マージ済みPRのクリーンアップ」ボタンをクリック、**期待結果** マージ済みブランチのWorktree一覧が表示され、一括削除できる
4. **前提条件** 保護ブランチ（main/master/develop）のWorktree、**操作** 削除を試みる、**期待結果** 警告メッセージが表示され、削除が制限される

---

### ユーザーストーリー 5 - カスタムAI Toolの設定管理 (優先度: P2)

開発者はブラウザから`~/.claude-worktree/tools.json`の内容を編集し、カスタムAI Toolを追加・削除・変更できる。

**この優先度の理由**: 拡張性を提供する機能。ユーザーが独自のAI Toolを登録できることで、claude-worktreeの用途が広がる。

**独立したテスト**: 設定管理画面からカスタムツールを追加し、保存後にAI Tool選択画面で新しいツールが表示されることで完全にテストでき、JSONファイルを直接編集せずにGUIで設定できるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** Web UIが起動中、**操作** 設定管理画面にアクセス、**期待結果** 既存のカスタムツール一覧が表示される（JSONから読み込み）
2. **前提条件** 設定管理画面、**操作** 「新規ツール追加」ボタンをクリックし、ツール名、コマンド、実行タイプを入力して保存、**期待結果** 新しいツールが一覧に追加され、`tools.json`が更新される
3. **前提条件** カスタムツールが登録済み、**操作** 既存のツールを選択して編集、**期待結果** 編集フォームが表示され、変更を保存できる
4. **前提条件** カスタムツールが登録済み、**操作** 削除ボタンをクリック、**期待結果** 確認ダイアログが表示され、OKを押すとツールが削除される
5. **前提条件** 設定管理画面、**操作** 不正なJSON構文でツールを追加、**期待結果** バリデーションエラーメッセージが表示され、保存が拒否される

---

### ユーザーストーリー 6 - Git操作のビジュアル化 (優先度: P3)

開発者はブラウザでブランチツリーを視覚的に確認し、各ブランチのマージ状態や差分を視覚的に理解できる。

**この優先度の理由**: UXを大幅に向上させる機能だが、コア機能ではない。視覚化により複雑なブランチ構造の理解が容易になる。

**独立したテスト**: ブランチツリー表示画面で視覚的なグラフが表示され、ブランチ間の関係性が確認できることで完全にテストでき、コマンドラインでは把握しづらいブランチ構造を一目で理解できるという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** 複数のブランチが存在、**操作** ブランチツリー画面にアクセス、**期待結果** すべてのブランチがツリー構造で視覚的に表示される
2. **前提条件** ブランチツリーが表示中、**操作** 任意のブランチをクリック、**期待結果** そのブランチの詳細情報（コミット履歴、差分）が表示される
3. **前提条件** ブランチツリーが表示中、**操作** マージ済みブランチを確認、**期待結果** マージ済みのブランチが別の色やアイコンで示される

---

### エッジケース

- ポートが既に使用中の場合、サーバーは別のポートで起動するか、エラーメッセージを表示するか？
- AI Toolの実行中にネットワーク接続が切断された場合、どのように処理されるか？
- 複数のブラウザタブで同時にAI Toolを起動した場合、セッションはどのように管理されるか？
- Worktree作成中にディスク容量が不足した場合、エラーはどのように通知されるか？
- 非常に大量のブランチ（1000以上）が存在する場合、パフォーマンスは許容範囲か？
- WebSocketの再接続中にAI Toolからの出力が失われないか？
- `tools.json`が破損している場合、設定管理画面はどのように動作するか？

## 要件 *(必須)*

### 機能要件

#### サーバー起動と基盤

- **FR-001**: システムは`claude-worktree serve`コマンドでローカルWebサーバーを起動しなければならない
- **FR-002**: サーバーはデフォルトで`http://localhost:3000`でリッスンしなければならない
- **FR-003**: サーバーはポートが使用中の場合、エラーメッセージを表示して終了しなければならない
- **FR-004**: サーバーは`Ctrl+C`で正常にシャットダウンしなければならない
- **FR-005**: サーバーはフロントエンドの静的ファイル（HTML/CSS/JS）を配信しなければならない

#### ブランチ管理とWorktree操作

- **FR-006**: Web UIはローカルおよびリモートのすべてのブランチを一覧表示しなければならない
- **FR-007**: ユーザーはブランチ名で検索・フィルターできなければならない
- **FR-008**: ユーザーは任意のブランチを選択してWorktreeを作成できなければならない
- **FR-009**: システムは既存のWorktreeがあるブランチに対して、既存のWorktreeパスを表示しなければならない
- **FR-010**: ユーザーは既存のWorktree一覧を表示し、個別に削除できなければならない
- **FR-011**: システムはマージ済みPRのWorktreeを検出し、一括削除できなければならない
- **FR-012**: システムは保護ブランチ（main/master/develop）のWorktree削除時に警告を表示しなければならない

#### AI Tool起動とターミナル統合

- **FR-013**: ユーザーはAI Tool（Claude Code、Codex CLI、Custom Tool）を選択して起動できなければならない
- **FR-014**: ユーザーは起動モード（normal/continue/resume）を選択できなければならない
- **FR-015**: ユーザーはオプション（skipPermissions、bypassApprovalsなど）を設定できなければならない
- **FR-016**: システムはAI ToolをPTY（疑似端末）経由で起動しなければならない
- **FR-017**: Web UIはブラウザ内にターミナルエミュレーターを表示しなければならない
- **FR-018**: ターミナルはAI Toolの標準出力・エラー出力をリアルタイムで表示しなければならない
- **FR-019**: ターミナルはユーザーのキーボード入力をAI Toolに転送しなければならない
- **FR-020**: ターミナルはANSI escape codes（色、カーソル移動など）を正しく解釈して表示しなければならない
- **FR-021**: ターミナルはリサイズに対応し、新しいサイズでPTYを再調整しなければならない
- **FR-022**: システムはAI Toolセッションを管理し、複数の同時セッションをサポートしなければならない
- **FR-023**: システムはWebSocket接続が切断された場合、セッションをバックグラウンドで保持しなければならない
- **FR-024**: ユーザーは再接続時に過去の出力履歴を確認できなければならない

#### 設定管理

- **FR-025**: Web UIは`~/.claude-worktree/tools.json`の内容を読み込んで表示しなければならない
- **FR-026**: ユーザーはカスタムAI Toolを追加・編集・削除できなければならない
- **FR-027**: システムはカスタムツールのバリデーション（必須フィールド、JSON構文）を行わなければならない
- **FR-028**: システムは設定変更を`tools.json`に保存しなければならない

#### Git操作ビジュアル化

- **FR-029**: Web UIはブランチツリーをグラフィカルに表示しなければならない
- **FR-030**: ユーザーは任意のブランチをクリックして詳細情報を表示できなければならない
- **FR-031**: システムはマージ済みブランチを視覚的に区別して表示しなければならない

#### CLI互換性

- **FR-032**: システムは既存の`claude-worktree`（CLI）機能を維持しなければならない
- **FR-033**: システムは`claude-worktree`と`claude-worktree serve`で異なる動作を提供しなければならない
- **FR-034**: CLIとWeb UIは共通のコアロジック（Git操作、Worktree管理）を共有しなければならない

### 主要エンティティ

- **Worktree**: 特定のGitブランチに対応する作業ディレクトリ。属性: ブランチ名、ファイルシステムパス、作成日時、現在の状態（アクティブ/アイドル）
- **Branch**: Gitブランチ。属性: ブランチ名、タイプ（local/remote）、最新コミットハッシュ、マージ状態（未マージ/マージ済み）、関連Worktreeパス
- **AIToolSession**: AI Tool実行セッション。属性: セッションID、ツールタイプ（Claude Code/Codex CLI/Custom）、モード、Worktreeパス、PTYプロセスID、WebSocket接続ID、開始時刻、終了時刻、出力ログ
- **CustomAITool**: ユーザー定義のカスタムAI Tool。属性: ツール名、コマンド、実行タイプ（path/bunx/command）、デフォルト引数、環境変数

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはWebサーバーを5秒以内に起動でき、ブラウザでアクセスできる
- **SC-002**: ユーザーはブランチ一覧から任意のブランチを選択し、30秒以内にWorktreeを作成できる
- **SC-003**: ユーザーはAI Toolを起動し、ターミナル画面でリアルタイムな入出力を遅延なく（100ms以内）体験できる
- **SC-004**: システムは1000以上のブランチがある場合でも、ブランチ一覧を3秒以内に表示できる
- **SC-005**: ユーザーの95%が初回でWorktree作成とAI Tool起動を成功できる（チュートリアルなしで）
- **SC-006**: WebSocket接続が切断されても、再接続時にセッションが復元され、ユーザーは作業を中断なく継続できる
- **SC-007**: CLI版の既存ユーザーは、追加学習なしに`claude-worktree serve`コマンドを実行できる

## 制約と仮定 *(該当する場合)*

### 制約

- ローカル環境（localhost）でのみ動作し、リモートアクセスやマルチユーザー対応は行わない
- 既存のCLI機能を維持する必要があるため、コアロジックを破壊的に変更できない
- Gitリポジトリ内で実行される必要がある（非Gitディレクトリではエラー）
- AI Tool（Claude Code/Codex CLI）がローカルにインストールされている必要がある
- Node.js/Bunランタイムで動作する必要がある

### 仮定

- ユーザーはモダンなブラウザ（Chrome、Firefox、Safari、Edge最新版）を使用している
- ユーザーはターミナル操作の基本的な知識がある
- ユーザーはGitの基本概念（ブランチ、Worktree）を理解している
- システムはローカルのファイルシステムに読み書き権限がある
- PTY（node-pty）がユーザーの環境で動作する（Windows/macOS/Linux）

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- リモートサーバーへのデプロイとホスティング
- マルチユーザー対応と認証機能
- クラウドベースのGitリポジトリ管理
- モバイルアプリ（iOS/Android）
- AI Toolのライセンス管理や課金機能
- Gitの高度な操作（rebase、cherry-pick、merge conflict解決）
- コードエディタ機能（VSCodeのような統合開発環境）
- CI/CD統合
- チーム協業機能（リアルタイム共同編集など）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- **ローカルアクセスのみ**: サーバーは`localhost`でのみリッスンし、外部ネットワークからのアクセスは許可しない
- **任意コマンド実行リスク**: カスタムAI Toolの設定でユーザーが任意のコマンドを実行できるため、`tools.json`の編集は慎重に行う必要がある（ユーザーの自己責任）
- **ファイルシステムアクセス**: Web UIはローカルのファイルシステム（Gitリポジトリ、`~/.claude-worktree/`）に読み書きアクセスするため、悪意あるスクリプトによる攻撃に注意が必要（サーバー側でパス検証を実施）
- **WebSocket通信**: ローカルネットワーク内の通信のため、TLS/SSL暗号化は不要（将来リモート対応する場合は必須）
- **セッション管理**: セッションIDは予測困難なランダム文字列（UUID）を使用し、セッションハイジャックを防止

## 依存関係 *(該当する場合)*

- **node-pty**: PTY（疑似端末）管理ライブラリ。AI ToolプロセスをPTYで起動するために必須
- **xterm.js**: ブラウザ側のターミナルエミュレーター。ANSI escape codesの解釈とレンダリングに必須
- **Fastify**: 高速なNode.js Webフレームワーク。REST APIとWebSocketサーバーの実装に使用
- **Vite**: モダンなフロントエンドビルドツール。React SPAのビルドと開発サーバーに使用
- **React 19**: UIフレームワーク。既存のInk（React for CLI）の知識を活用
- **既存のclaude-worktreeコア機能**: Git操作、Worktree管理、AI Tool起動ロジックを再利用

## 参考資料 *(該当する場合)*

- [既存のCLI実装](../../src/index.ts)
- [Ink UIコンポーネント](../../src/ui/components/)
- [node-ptyドキュメント](https://github.com/microsoft/node-pty)
- [xterm.jsドキュメント](https://xtermjs.org/)
- [Fastifyドキュメント](https://fastify.dev/)
