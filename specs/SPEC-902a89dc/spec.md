# 機能仕様: Worktreeパス修復機能

**仕様ID**: `SPEC-902a89dc`
**作成日**: 2026-01-05
**ステータス**: ドラフト
**入力**: ユーザー説明: "Worktreeパス修復機能 - ブランチ一覧画面で選択済みかつ🔴表示のブランチに対して、xキーでgit worktree repairを実行し、パスの不整合を修復する"

## 概要

Gitのworktree機能は絶対パスで管理されているため、異なる環境間（Docker、WSL、リポジトリ移動後など）でWorktreeが使用できなくなる。本機能は、ブランチ一覧画面から手動で`git worktree repair`を実行し、パスの不整合を修復する機能を提供する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 選択済みWorktreeの修復 (優先度: P1)

開発者がブランチ一覧画面で🔴（アクセス不能）表示されているWorktreeを見つけた場合、スペースキーでチェックを付け、`x`キーを押すことで`git worktree repair`を実行し、パスの不整合を修復できる。

**この優先度の理由**: 本機能のコア価値。環境移動やリポジトリ移動後にWorktreeが使用できなくなった場合、手動で修復コマンドを実行する必要がなくなり、開発者の生産性が向上する。

**独立したテスト**: 🔴表示のブランチをチェックし、`x`キーで修復を実行し、🟢表示に変わることを確認することで、Worktree修復という価値を提供する。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面で🔴表示のブランチが存在する、**操作** スペースキーでチェックし`x`キーを押す、**期待結果** `git worktree repair`が実行され、修復成功のメッセージがフッターに表示される
2. **前提条件** 複数の🔴表示ブランチがチェックされている、**操作** `x`キーを押す、**期待結果** 全てのチェック済み🔴ブランチに対して修復が試行され、結果（成功/失敗数）がフッターに表示される
3. **前提条件** 🔴表示のブランチが修復された、**操作** 画面を確認する、**期待結果** ブランチの表示が🔴から🟢に変わる

---

### ユーザーストーリー 2 - チェック済みブランチの修復実行 (優先度: P1)

開発者が🟢（正常）表示のブランチを含めてチェックした状態で`x`キーを押した場合でも、チェック済みのローカルブランチはすべて修復対象となる（アクセス可能/不可能は問わない）。リモートブランチは対象外とする。

**この優先度の理由**: チェック済みブランチはユーザーが明示的に対象にしたものであり、修復対象の自動除外が予期しない挙動になるため。

**独立したテスト**: 🟢と🔴両方のブランチをチェックし、`x`キーで修復を実行し、両方が修復対象になることを確認する。

**受け入れシナリオ**:

1. **前提条件** 🟢表示と🔴表示のブランチが両方チェックされている、**操作** `x`キーを押す、**期待結果** 両方のブランチが修復対象となる
2. **前提条件** 🟢表示のブランチのみがチェックされている、**操作** `x`キーを押す、**期待結果** そのブランチが修復対象として処理される

---

### ユーザーストーリー 3 - 修復中の進捗表示 (優先度: P2)

開発者が修復を実行中、処理の進捗状況がフッターに表示され、完了までの状態を把握できる。また、修復中は他のキー入力がロックされる。

**この優先度の理由**: ユーザビリティの向上。修復処理中の状態を可視化することで、開発者が安心して待機できる。

**独立したテスト**: 修復を実行し、フッターに進捗メッセージが表示され、完了後に結果が表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 🔴表示のブランチがチェックされている、**操作** `x`キーを押す、**期待結果** フッターに「Repairing worktrees...」のようなメッセージが表示される
2. **前提条件** 修復処理が実行中、**操作** 他のキー（r, c, f等）を押す、**期待結果** キー入力は無視され、処理が中断されない
3. **前提条件** 修復処理が完了、**操作** フッターを確認する、**期待結果** 「Repaired X worktree(s)」のような結果メッセージが表示される

---

### ユーザーストーリー 4 - Git バージョン互換性チェック (優先度: P3)

開発者の環境で`git worktree repair`コマンドがサポートされていない（Git 2.30.0未満）場合、警告メッセージが表示され、修復は実行されない。

**この優先度の理由**: エラー防止。サポートされていない環境での失敗を事前に防ぐ。

**独立したテスト**: Git 2.30.0未満の環境で`x`キーを押し、適切な警告が表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** Git 2.30.0未満の環境、**操作** `x`キーを押す、**期待結果** 「git worktree repair requires Git 2.30.0 or later」のような警告が表示され、修復は実行されない

---

### ユーザーストーリー 5 - ブランチ選択時の自動修復 (優先度: P1)

開発者がクロス環境（Windows/macOS ↔ Docker）間でWorktreeパスの不整合があるブランチを選択した場合、gwtが自動的にパス修復を試み、修復成功時は正常にWorktreeを使用できる。修復不能な場合は古いメタデータを削除して新規作成を許可する。

**この優先度の理由**: ユーザー体験の向上。ブランチ選択時に自動的に修復を試みることで、手動で`x`キーを押す必要がなくなり、スムーズな環境切り替えが可能になる。

**独立したテスト**: パス不整合のあるブランチを選択し、自動的に修復が試行され、成功時は正常にWorktreeが利用できることを確認する。

**受け入れシナリオ**:

1. **前提条件** Windows環境で作成されたWorktree（`E:/gwt/.worktrees/...`）がDocker環境で選択される（期待パス `/gwt/.worktrees/...` にディレクトリが存在する）、**操作** ブランチを選択しEnterを押す、**期待結果** `git worktree repair`が自動実行され、「Worktree path repaired」メッセージが表示され、正常にWorktreeが利用できる
2. **前提条件** リモート環境で作成されたWorktreeのメタデータが残っているが、ディレクトリが存在しない、**操作** ブランチを選択しEnterを押す、**期待結果** 古いメタデータが削除され、「Stale worktree metadata removed」メッセージが表示され、新規Worktreeが作成される
3. **前提条件** 修復も削除も失敗した、**操作** ブランチを選択しEnterを押す、**期待結果** 「Failed to repair worktree」警告が表示される

---

### エッジケース

- チェックなしで`x`キーを押した場合、何も実行されず警告メッセージを表示する
- 修復に失敗した場合、失敗したWorktreeの情報をフッターに表示し、他のWorktreeの修復は継続する
- 保護ブランチ（main/develop）のWorktreeも修復対象に含める（削除ではないため）
- リモートブランチはチェック済みでも修復対象から除外する
- フィルターモード中は`x`キーを無効化する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはブランチ一覧画面で`x`キーによるWorktree修復機能を提供**しなければならない**
- **FR-002**: システムはチェック済み（`selectedBranches`）のローカルブランチを修復対象と**しなければならない**（アクセス可能/不可能は問わない）
- **FR-002a**: システムはリモートブランチを修復対象から除外**しなければならない**
- **FR-003**: システムは`git worktree repair`コマンドを使用してWorktreeパスの不整合を修復**しなければならない**
- **FR-004**: システムは修復結果（成功数/失敗数）をフッターに表示**しなければならない**
- **FR-005**: システムは修復処理中、キー入力をロックして他の操作を防止**しなければならない**
- **FR-006**: システムは修復処理中、フッターに進捗メッセージを表示**しなければならない**
- **FR-007**: システムはチェックされたブランチがない、または修復対象がない場合、警告メッセージを表示**しなければならない**
- **FR-008**: システムはフィルターモード中、`x`キーによる修復機能を無効化**しなければならない**
- **FR-009**: システムはブランチ選択時にWorktreeパスの不整合を検出した場合、自動的に修復を試み**なければならない**
- **FR-010**: システムは修復対象のWorktreeディレクトリが期待されるパスに存在する場合、`git worktree repair`で修復**しなければならない**
- **FR-011**: システムは修復対象のWorktreeディレクトリが存在しない場合、`git worktree remove --force`でメタデータを削除**しなければならない**
- **FR-012**: システムは修復成功時に「Worktree path repaired」メッセージを表示**しなければならない**
- **FR-013**: システムはメタデータ削除成功時に「Stale worktree metadata removed」メッセージを表示**しなければならない**

### 主要エンティティ

- **修復対象Worktree**: `selectedBranches`に含まれるローカルブランチに紐づくWorktree（アクセス可能/不可能は問わない）
- **修復結果**: 修復の成功数、失敗数、失敗理由を含む情報

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者は🔴表示のWorktreeを5秒以内に修復できる
- **SC-002**: 修復成功時、Worktreeの状態が🔴から🟢に即座に反映される
- **SC-003**: 開発者の90%が初回使用時に説明なしで修復機能を使用できる（`x`キーの操作が直感的）
- **SC-004**: 修復処理中の誤操作（他キー押下）が100%防止される

## 制約と仮定 *(該当する場合)*

### 制約

- `git worktree repair`コマンドはGit 2.30.0以降でのみ利用可能
- 既存のブランチ一覧UIと選択UIを活用する必要がある
- キーバインディングは既存のショートカットキー（r: リフレッシュ、c: クリーンアップ、f: フィルター等）と競合しないようにする必要がある

### 仮定

- ユーザーはターミナル操作に慣れており、スペースキーによる選択と`x`キーによる修復操作が直感的に理解できる
- Worktreeのパス不整合は`git worktree repair`で修復可能である
- `.worktrees`ディレクトリ内の実際のWorktreeパスが存在する場合、修復が成功する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- リスト表示時の自動修復（ブランチ選択または`x`キー操作時のみ実行）
- Worktreeの再作成（修復不能な場合の自動再作成）
- 複数リポジトリをまたぐWorktree修復
- パスマッピングやシンボリックリンクによる代替解決策

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- `git worktree repair`はGitの標準コマンドであり、セキュリティリスクは低い
- 修復操作はローカルファイルシステムのみに影響し、リモートリポジトリには影響しない

## 依存関係 *(該当する場合)*

- Git 2.30.0以降
- 既存のブランチ一覧画面コンポーネント（`BranchListScreen.tsx`）
- 既存の選択機能（`selectedBranches`、`onToggleSelect`）
- 既存のWorktree管理機能（`WorktreeRepository`）

## 参考資料 *(該当する場合)*

- [Git - git-worktree Documentation](https://git-scm.com/docs/git-worktree)
- [SPEC-d2f4762a](../SPEC-d2f4762a/spec.md) - ブランチ選択画面仕様
- [SPEC-55fe506f](../SPEC-55fe506f/spec.md) - Worktreeクリーンアップ選択機能
