openapi: 3.1.0
info:
  title: claude-worktree Web UI REST API
  description: REST API for claude-worktree Web UI - Git branch and worktree management
  version: 1.0.0
  contact:
    name: claude-worktree
    url: https://github.com/akiojin/claude-worktree

servers:
  - url: http://localhost:3000/api
    description: Local development server

tags:
  - name: health
    description: Health check endpoints
  - name: branches
    description: Git branch operations
  - name: worktrees
    description: Git worktree operations
  - name: sessions
    description: AI tool session management
  - name: config
    description: Configuration management

paths:
  /health:
    get:
      tags: [health]
      summary: Health check
      description: Returns server status
      operationId: getHealth
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /branches:
    get:
      tags: [branches]
      summary: Get all branches
      description: Returns list of all local and remote branches
      operationId: getBranches
      parameters:
        - name: filter
          in: query
          description: Filter branches by name (partial match)
          required: false
          schema:
            type: string
            example: 'feature/'
        - name: type
          in: query
          description: Filter by branch type
          required: false
          schema:
            type: string
            enum: [local, remote]
      responses:
        '200':
          description: List of branches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BranchListResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /branches/{branchName}:
    get:
      tags: [branches]
      summary: Get branch details
      description: Returns detailed information for a specific branch. Branch name must be URL-encoded (e.g., 'feature%2Fwebui' for 'feature/webui')
      operationId: getBranch
      parameters:
        - name: branchName
          in: path
          description: Branch name (URL-encoded)
          required: true
          schema:
            type: string
            example: 'feature%2Fwebui'
      responses:
        '200':
          description: Branch details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BranchResponse'
        '404':
          description: Branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /branches/{branchName}/sync:
    post:
      tags: [branches]
      summary: Sync branch with remote
      description: Runs git fetch --all and git pull --ff-only for the specified worktree, mirroring the CLI safety flow, and returns refreshed divergence metadata.
      operationId: syncBranch
      parameters:
        - name: branchName
          in: path
          description: Branch name (URL-encoded)
          required: true
          schema:
            type: string
            example: 'feature%2Fwebui'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BranchSyncRequest'
      responses:
        '200':
          description: Branch synced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BranchSyncResponse'
        '400':
          description: Missing worktree path or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Branch not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /worktrees:
    get:
      tags: [worktrees]
      summary: Get all worktrees
      description: Returns list of all existing worktrees
      operationId: getWorktrees
      responses:
        '200':
          description: List of worktrees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorktreeListResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags: [worktrees]
      summary: Create new worktree
      description: Creates a new worktree for the specified branch
      operationId: createWorktree
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorktreeRequest'
      responses:
        '201':
          description: Worktree created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorktreeResponse'
        '400':
          description: Invalid request (branch not found, worktree already exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /worktrees/delete:
    delete:
      tags: [worktrees]
      summary: Delete worktree
      description: Deletes the specified worktree. Uses query parameters to avoid ambiguous path encoding.
      operationId: deleteWorktree
      parameters:
        - name: path
          in: query
          description: Worktree path (URL-encoded)
          required: true
          schema:
            type: string
            example: '/claude-worktree/.worktrees/feature-webui'
        - name: force
          in: query
          description: Force deletion even if worktree is locked or has uncommitted changes
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Worktree deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid request (worktree not found, protected branch, uncommitted changes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Worktree is locked or has pending operations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /worktrees/cleanup:
    post:
      tags: [worktrees]
      summary: Cleanup worktrees and branches by rule
      description: Performs cleanup (e.g., merged PR, divergence-free). Mirrors CLI cleanup targets.
      operationId: cleanupWorktrees
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: [merged-pr, no-diff, orphaned]
                  description: Cleanup strategy to apply
                targets:
                  type: array
                  items:
                    type: string
                  description: Optional explicit worktree paths or branch names to cleanup
      responses:
        '200':
          description: Cleanup summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  deleted:
                    type: array
                    items:
                      type: string
                  skipped:
                    type: array
                    items:
                      type: object
                      properties:
                        target:
                          type: string
                        reason:
                          type: string
        '400':
          description: Invalid request (unknown type, protected branch)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Git or filesystem error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /worktrees/cleanup/merged:
    post:
      tags: [worktrees]
      summary: Cleanup merged PR worktrees
      description: Deletes worktrees for branches that have been merged
      operationId: cleanupMergedWorktrees
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CleanupResponse'
        '500':
          description: Git operation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sessions:
    get:
      tags: [sessions]
      summary: Get session history
      description: Returns list of AI tool session history
      operationId: getSessions
      parameters:
        - name: limit
          in: query
          description: Maximum number of sessions to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'
        '500':
          description: Failed to retrieve sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags: [sessions]
      summary: Start AI tool session
      description: Starts a new AI tool session (PTY + WebSocket)
      operationId: startSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartSessionRequest'
      responses:
        '201':
          description: Session started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to start session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sessions/{sessionId}:
    get:
      tags: [sessions]
      summary: Get session details
      description: Returns details of a specific session
      operationId: getSession
      parameters:
        - name: sessionId
          in: path
          description: Session ID (UUID)
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [sessions]
      summary: Terminate session
      description: Terminates a running session
      operationId: terminateSession
      parameters:
        - name: sessionId
          in: path
          description: Session ID (UUID)
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Session terminated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to terminate session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /config:
    get:
      tags: [config]
      summary: Get configuration
      description: Returns current configuration (tools.json)
      operationId: getConfig
      responses:
        '200':
          description: Current configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '500':
          description: Failed to read configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [config]
      summary: Update configuration
      description: Updates configuration (tools.json)
      operationId: updateConfig
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConfigRequest'
      responses:
        '200':
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfigResponse'
        '400':
          description: Invalid configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to update configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthResponse:
      type: object
      required: [success, status, timestamp]
      properties:
        success:
          type: boolean
          example: true
        status:
          type: string
          example: 'ok'
        timestamp:
          type: string
          format: date-time
          example: '2025-11-10T00:00:00Z'

    Branch:
      type: object
      required: [name, type, commitHash, mergeStatus, worktreePath]
      properties:
        name:
          type: string
          example: 'feature/webui'
        type:
          type: string
          enum: [local, remote]
          example: 'local'
        commitHash:
          type: string
          minLength: 7
          maxLength: 7
          example: 'a1b2c3d'
        commitMessage:
          type: string
          nullable: true
          example: 'feat: add web UI support'
        author:
          type: string
          nullable: true
          example: 'John Doe'
        commitDate:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-10T00:00:00Z'
        mergeStatus:
          type: string
          enum: [unmerged, merged, unknown]
          example: 'unmerged'
        hasUnpushedCommits:
          type: boolean
          description: Indicates there are local commits not pushed to remote
          example: false
        worktreePath:
          type: string
          nullable: true
          example: '/claude-worktree/.worktrees/feature-webui'
        baseBranch:
          type: string
          nullable: true
          example: 'main'
          description: >
            Êé®ÂÆö„Éô„Éº„Çπ„Éñ„É©„É≥„ÉÅÔºàPR„ÅÆbaseRef„ÄÅGit upstream„ÄÅmerge-base„Éí„É•„Éº„É™„Çπ„ÉÜ„Ç£„ÇØ„Çπ„Åã„ÇâÁÆóÂá∫Ôºâ
        divergence:
          type: object
          nullable: true
          required: [ahead, behind, upToDate]
          properties:
            ahead:
              type: integer
              minimum: 0
              example: 2
            behind:
              type: integer
              minimum: 0
              example: 1
            upToDate:
              type: boolean
              example: false
        prInfo:
          type: object
          nullable: true
          properties:
            number:
              type: integer
              example: 123
            title:
              type: string
              example: 'Add web UI support'
            state:
              type: string
              enum: [open, merged, closed]
            mergedAt:
              type: string
              format: date-time
              nullable: true
              example: '2025-11-09T12:00:00Z'

    BranchListResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Branch'

    BranchResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Branch'

    BranchSyncRequest:
      type: object
      required: [worktreePath]
      properties:
        worktreePath:
          type: string
          description: Path to the worktree associated with the branch
          example: '/claude-worktree/.worktrees/feature-webui'

    BranchSyncResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required: [branch, divergence, fetchStatus, pullStatus]
          properties:
            branch:
              $ref: '#/components/schemas/Branch'
            divergence:
              $ref: '#/components/schemas/Branch/properties/divergence'
            fetchStatus:
              type: string
              enum: [success]
              example: 'success'
            pullStatus:
              type: string
              enum: [success, failed]
              example: 'success'
            warnings:
              type: array
              items:
                type: string
              example: ['Fast-forward pull failed; please resolve divergence manually.']

    Worktree:
      type: object
      required: [path, branchName, head, isLocked, isPrunable]
      properties:
        path:
          type: string
          example: '/claude-worktree/.worktrees/feature-webui'
        branchName:
          type: string
          example: 'feature/webui'
        head:
          type: string
          example: 'a1b2c3d'
        isLocked:
          type: boolean
          example: false
        isPrunable:
          type: boolean
          example: false
        isProtected:
          type: boolean
          description: Indicates worktree belongs to protected branch (main/master/develop)
          example: true
        divergence:
          $ref: '#/components/schemas/Branch/properties/divergence'
        prInfo:
          $ref: '#/components/schemas/Branch/properties/prInfo'
        createdAt:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-10T00:00:00Z'
        lastAccessedAt:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-10T00:00:00Z'

    WorktreeListResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Worktree'

    CreateWorktreeRequest:
      type: object
      required: [branchName]
      properties:
        branchName:
          type: string
          example: 'feature/webui'
        createBranch:
          type: boolean
          default: false
          description: Create new branch if not exists

    WorktreeResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Worktree'

    CleanupResponse:
      type: object
      required: [success, deleted]
      properties:
        success:
          type: boolean
          example: true
        deleted:
          type: array
          items:
            type: string
          example: ['/claude-worktree/.worktrees/feature-old']

    AIToolSession:
      type: object
      required: [sessionId, toolType, mode, worktreePath, status, startedAt]
      properties:
        sessionId:
          type: string
          format: uuid
          example: '550e8400-e29b-41d4-a716-446655440000'
        toolType:
          type: string
          enum: [claude-code, codex-cli, custom]
          example: 'claude-code'
        toolName:
          type: string
          nullable: true
          example: 'My Custom Tool'
        mode:
          type: string
          enum: [normal, continue, resume]
          example: 'normal'
        worktreePath:
          type: string
          example: '/claude-worktree/.worktrees/feature-webui'
        ptyPid:
          type: integer
          nullable: true
          example: 12345
        websocketId:
          type: string
          nullable: true
          example: 'ws-abc123'
        status:
          type: string
          enum: [pending, running, completed, failed]
          example: 'running'
        startedAt:
          type: string
          format: date-time
          example: '2025-11-10T00:00:00Z'
        endedAt:
          type: string
          format: date-time
          nullable: true
          example: '2025-11-10T00:05:00Z'
        exitCode:
          type: integer
          nullable: true
          example: 0
        errorMessage:
          type: string
          nullable: true
          example: 'PTY process crashed'

    SessionListResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/AIToolSession'

    StartSessionRequest:
      type: object
      required: [toolType, mode, worktreePath]
      properties:
        toolType:
          type: string
          enum: [claude-code, codex-cli, custom]
          example: 'claude-code'
        toolName:
          type: string
          nullable: true
          description: Required if toolType is 'custom'
          example: 'My Custom Tool'
        mode:
          type: string
          enum: [normal, continue, resume]
          example: 'normal'
        worktreePath:
          type: string
          example: '/claude-worktree/.worktrees/feature-webui'
        skipPermissions:
          type: boolean
          default: false
        bypassApprovals:
          type: boolean
          default: false
        extraArgs:
          type: array
          items:
            type: string
          description: Additional arguments passed to the tool (mirrors CLI extraArgs)
        customToolId:
          type: string
          nullable: true
          description: Optional identifier to reference tools.json entry when toolType is 'custom'

    SessionResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/AIToolSession'

    CustomAITool:
      type: object
      required: [id, displayName, command, executionType, modeArgs, createdAt, updatedAt]
      properties:
        id:
          type: string
          format: uuid
          example: '550e8400-e29b-41d4-a716-446655440000'
        displayName:
          type: string
          minLength: 1
          maxLength: 100
          example: 'My Custom Tool'
        icon:
          type: string
          nullable: true
          example: 'ü§ñ'
        command:
          type: string
          minLength: 1
          maxLength: 500
          example: '/usr/local/bin/my-tool'
        executionType:
          type: string
          enum: [path, bunx, command]
          example: 'path'
        defaultArgs:
          type: array
          items:
            type: string
          nullable: true
          example: ['--verbose']
        modeArgs:
          type: object
          required: []
          properties:
            normal:
              type: array
              items:
                type: string
              description: Arguments added when launching in normal mode
            continue:
              type: array
              items:
                type: string
              description: Arguments added for continue mode
            resume:
              type: array
              items:
                type: string
              description: Arguments added for resume mode
        permissionSkipArgs:
          type: array
          items:
            type: string
          nullable: true
          description: Arguments appended when skipPermissions is true
        env:
          type: object
          additionalProperties:
            type: string
          nullable: true
          example: { 'DEBUG': 'true' }
        description:
          type: string
          nullable: true
          maxLength: 500
          example: 'My custom development tool'
        createdAt:
          type: string
          format: date-time
          example: '2025-11-10T00:00:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2025-11-10T00:00:00Z'

    ConfigResponse:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          required: [tools]
          properties:
            tools:
              type: array
              items:
                $ref: '#/components/schemas/CustomAITool'

    UpdateConfigRequest:
      type: object
      required: [tools]
      properties:
        tools:
          type: array
          items:
            $ref: '#/components/schemas/CustomAITool'

    SuccessResponse:
      type: object
      required: [success, message]
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: 'Operation completed successfully'

    ErrorResponse:
      type: object
      required: [success, error]
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: 'Branch not found'
        details:
          type: string
          nullable: true
          example: 'The branch "feature/nonexistent" does not exist'
