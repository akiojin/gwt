# 実装計画: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-18

## 概要

gwtにtmuxマルチモードを追加し、複数のコーディングエージェントを同時に並列実行できるようにする。

## 実装フェーズ

### フェーズ 1: 基盤（環境検出とモード切り替え）

**目標**: tmux環境の自動検出とシングル/マルチモードの切り替え

**成果物**:

- `gwt-core/src/tmux/mod.rs` - tmux操作モジュール
- `gwt-core/src/tmux/detector.rs` - tmux環境検出
- `gwt-core/src/execution_mode.rs` - 実行モード列挙型

**実装内容**:

1. TMUX環境変数の検出ロジック
2. ExecutionMode列挙型（Single/Multi）の定義
3. tmuxコマンド実行ラッパー
4. tmuxインストール有無の確認

**依存関係**: なし

---

### フェーズ 2: セッション管理

**目標**: tmuxセッションの作成と管理

**成果物**:

- `gwt-core/src/tmux/session.rs` - セッション管理
- `gwt-core/src/tmux/naming.rs` - セッション命名規則

**実装内容**:

1. `gwt-{リポジトリ名}` 形式のセッション名生成
2. 既存セッション検出と番号付与（-2, -3...）
3. セッション作成・削除API
4. マスターペインの設定

**依存関係**: フェーズ 1

---

### フェーズ 3: ペイン起動

**目標**: エージェント用のtmuxペイン作成と起動

**成果物**:

- `gwt-core/src/tmux/pane.rs` - ペイン管理
- `gwt-cli/src/agent_launcher_tmux.rs` - tmux用エージェント起動

**実装内容**:

1. 新規ペイン作成（split-window）
2. 作業ディレクトリ設定（-c オプション）
3. エージェントコマンド実行
4. フォーカス移動（select-pane）

**依存関係**: フェーズ 2

---

### フェーズ 4: TUI分割表示

**目標**: ブランチ一覧とペイン一覧の上下分割表示

**成果物**:

- `gwt-cli/src/ui/pane_list.rs` - ペイン一覧コンポーネント
- `gwt-cli/src/ui/split_layout.rs` - 分割レイアウト

**実装内容**:

1. 上下分割レイアウトの実装
2. ペイン一覧の表示（ブランチ名、エージェント名、稼働時間）
3. アクティブペインのハイライト表示
4. 1秒ポーリングによる状態更新

**依存関係**: フェーズ 3

---

### フェーズ 5: キーバインドとフォーカス管理

**目標**: キーバインドの変更とフォーカス切り替え機能

**成果物**:

- `gwt-cli/src/ui/keybindings.rs` の更新
- `gwt-core/src/tmux/keybind.rs` - tmuxキーバインド設定

**実装内容**:

1. Tab: ブランチ一覧 ⇔ ペイン一覧のフォーカス切り替え
2. m: 表示モード切り替え（All/Local/Remote）
3. Enter: 選択ペインへのフォーカス移動
4. Ctrl-g: gwtペインへの復帰キーバインド設定

**依存関係**: フェーズ 4、SPEC-d2f4762a（既存キーバインド変更）

---

### フェーズ 6: ペイン終了管理

**目標**: ペインの終了と確認ダイアログ

**成果物**:

- `gwt-cli/src/ui/dialogs/terminate_confirm.rs` - 終了確認ダイアログ
- `gwt-core/src/tmux/terminate.rs` - プロセス終了

**実装内容**:

1. 終了確認ダイアログUI
2. SIGTERM送信によるプロセス終了
3. エージェント終了時のペイン自動クローズ
4. gwt終了時の全エージェント確認

**依存関係**: フェーズ 5

---

### フェーズ 7: ログキャプチャとエラーハンドリング

**目標**: ログキャプチャの継続とエラー処理

**成果物**:

- `gwt-core/src/tmux/logging.rs` - tmuxモード用ログキャプチャ
- `gwt-core/src/tmux/error.rs` - エラー型定義

**実装内容**:

1. stderrキャプチャの実装（pipe-pane）
2. ログファイルへの保存
3. tmux操作失敗時のエラーメッセージ表示
4. 多重起動警告ダイアログ

**依存関係**: フェーズ 6

---

### フェーズ 8: エージェントペインの列/行レイアウト

**目標**: gwt左列 + 右側エージェント列の多段配置を実現

**成果物**:

- `gwt-core/src/tmux/pane.rs` - ペイン位置情報取得とリサイズAPI
- `gwt-core/src/tmux/launcher.rs` - 追加分割方向の対応
- `gwt-cli/src/tui/app.rs` - 列/行レイアウトの選択と再配置制御

**実装内容**:

1. ペイン位置（left/top/width/height）の取得
2. 右側エージェント列の最大3行制約
3. 3行を超えた場合の新規列追加
4. 列数に応じた幅の自動調整
5. 列内の行高さの均等化

**依存関係**: フェーズ 3

---

### フェーズ 9: エージェント表示名の短縮

**目標**: Codex/Gemini 表示名の短縮（CLI表記の削除）

**成果物**:

- `gwt-core/src/agent/mod.rs` - 表示名の調整
- `gwt-cli/src/tui/screens/wizard.rs` - UIラベルの調整
- `gwt-core/src/config/session.rs` - セッション表示名の調整

**実装内容**:

1. Codex CLI → Codex の表示名統一
2. Gemini CLI → Gemini の表示名統一
3. 既存UI/ログ/履歴への反映

**依存関係**: なし

---

### フェーズ 10: ペイン表示時のmouse有効化

**目標**: ペイン表示時にtmux mouseを有効化する

**成果物**:

- `gwt-core/src/tmux/pane.rs` - ペイン表示時のmouse有効化

**実装内容**:

1. `tmux set -g mouse on` を実行するヘルパー追加
2. ペイン表示（join-pane）前にmouseを有効化

**依存関係**: フェーズ 3

---

## 技術的考慮事項

### tmuxコマンド

運用ガイドのコマンド例を参照: `docs/operations.md`

### Ctrl-g キーバインド設定

運用ガイドのキーバインド例を参照: `docs/operations.md`

### ペイン状態監視

- 1秒間隔でtmux list-panesを実行
- pane_pid からプロセス状態を確認
- 終了したペインを自動検出

## リスクと対策

| リスク | 対策 |
|--------|------|
| tmuxバージョン互換性 | tmux 2.0以上を必須とし、バージョンチェックを実装 |
| ペイン状態の同期遅延 | 1秒ポーリングで許容し、即時性が必要な操作は直接確認 |
| Ctrl-gの競合 | tmuxセッション作成時のみ設定し、グローバル設定には影響しない |

## テスト戦略

1. **ユニットテスト**: tmux環境検出、セッション名生成、ペイン状態解析
2. **インテグレーションテスト**: 実際のtmuxセッションでの操作確認
3. **手動テスト**: TUI操作、キーバインド、視覚的な確認
