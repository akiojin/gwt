# 機能仕様: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-18
**ステータス**: 完了
**入力**: ユーザー説明: "シングルモードとtmuxによるマルチモードを選択できるようにする。gwtを司令塔として常駐させ、エージェント起動ごとに新しいtmuxペインを追加する。gwtからペインの起動・終了・フォーカス切り替えを管理できるフル管理機能を提供する。"

## 概要

gwtにtmuxマルチモードを追加し、複数のコーディングエージェントを同時に並列実行できるようにする。tmux環境の有無を自動検出し、tmux内で起動された場合は自動的にマルチモードで動作する。gwtはtmuxセッションのマスターペインとして常駐し、エージェント起動時は新しいペインを作成して起動する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - tmux環境の自動検出とモード切り替え (優先度: P0)

開発者がgwtを起動したとき、システムはtmux環境の有無を自動検出し、tmux内であればマルチモード、それ以外はシングルモードで動作する。

**この優先度の理由**: tmuxサポートの基盤となる機能であり、これがなければ他の全ての機能が動作しない。

**独立したテスト**: tmux内外でgwtを起動し、それぞれのモードで正しく動作することを確認する。

**受け入れシナリオ**:

1. **前提条件** tmux環境外でgwtを起動、**操作** gwtを起動、**期待結果** シングルモードで動作し、エージェント起動時はgwtがバックグラウンドに移行する（従来の動作）
2. **前提条件** tmux環境内でgwtを起動、**操作** gwtを起動、**期待結果** マルチモードで動作し、エージェント起動時は新しいペインが作成される
3. **前提条件** TMUX環境変数が設定されていない、**操作** gwtを起動、**期待結果** シングルモードで動作する
4. **前提条件** TMUX環境変数が設定されている、**操作** gwtを起動、**期待結果** マルチモードで動作する

---

### ユーザーストーリー 2 - tmuxセッションの作成とマスターペイン (優先度: P0)

開発者がtmux外でgwtを起動した場合でも、gwtがtmuxセッションを新規作成してマスターペインとして動作できる。

**この優先度の理由**: tmux外からのマルチモード利用を可能にする基本機能。

**独立したテスト**: tmux外でgwtを起動し、新規tmuxセッションが作成され、gwtがマスターペインとして動作することを確認する。

**受け入れシナリオ**:

1. **前提条件** tmux外でgwt --tmuxを実行、**操作** gwtを起動、**期待結果** `gwt-{リポジトリ名}` 形式のtmuxセッションが作成され、gwtがマスターペインで動作する
2. **前提条件** 同じリポジトリで既にgwtセッションが存在、**操作** gwtを新規起動、**期待結果** `gwt-{リポジトリ名}-2` のように番号付きで新規セッションが作成される
3. **前提条件** tmuxがインストールされていない、**操作** gwtを起動、**期待結果** シングルモードにフォールバックし、警告メッセージを表示しない（自動検出により適切に処理）

---

### ユーザーストーリー 3 - エージェントのペイン起動 (優先度: P0)

開発者がブランチを選択してエージェントを起動したとき、新しいtmuxペインが作成されてエージェントが起動し、フォーカスが新しいペインに移動する。

**この優先度の理由**: tmuxマルチモードの中核機能。

**独立したテスト**: マルチモードでエージェントを起動し、新しいペインが作成され、エージェントが起動することを確認する。

**受け入れシナリオ**:

1. **前提条件** マルチモードで動作中、**操作** ブランチを選択してClaude Codeを起動、**期待結果** 新しいペインが作成され、Claude Codeが起動し、フォーカスが新しいペインに移動する
2. **前提条件** マルチモードで動作中、**操作** 同じworktreeで別のエージェント（Codex）を起動、**期待結果** 別の新しいペインが作成され、Codexが起動する
3. **前提条件** マルチモードで動作中、**操作** 別のworktreeでエージェントを起動、**期待結果** 新しいペインが作成され、そのworktreeディレクトリでエージェントが起動する
4. **前提条件** マルチモードで動作中、**操作** 同じworktreeで同じエージェントを再度起動、**期待結果** 警告ダイアログが表示され、確認後に新しいペインが作成される

---

### ユーザーストーリー 4 - ペイン一覧の表示と管理 (優先度: P1)

開発者がgwt TUIで稼働中のエージェントペインを一覧表示し、各ペインの状態（ブランチ、エージェント、稼働時間）を確認できる。

**この優先度の理由**: 複数エージェントを管理するための基本的な可視化機能。

**独立したテスト**: 複数のエージェントを起動し、ペイン一覧に正しく表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 複数のエージェントペインが稼働中、**操作** gwt TUIを確認、**期待結果** 上下分割でブランチ一覧（上）とペイン一覧（下）が表示される
2. **前提条件** ペイン一覧を確認、**操作** 各ペインの情報を確認、**期待結果** ブランチ名、エージェント名、稼働時間が表示される
3. **前提条件** ペインが1つもない状態、**操作** gwt TUIを確認、**期待結果** ペイン一覧セクションは空または非表示
4. **前提条件** アクティブなペインがある、**操作** ペイン一覧を確認、**期待結果** アクティブなペインは色とマーカー（>）の両方で強調表示される
5. **前提条件** ペイン状態が変化、**操作** 1秒後に確認、**期待結果** ペイン一覧が自動更新される（1秒ポーリング）

---

### ユーザーストーリー 5 - ペインのフォーカス切り替え (優先度: P1)

開発者がgwt TUIからエージェントペインにフォーカスを移動し、またCtrl-gでgwtペインに戻れる。

**この優先度の理由**: 複数ペイン間の操作性を確保するための基本機能。

**独立したテスト**: gwtからエージェントペインへフォーカス移動し、Ctrl-gで戻れることを確認する。

**受け入れシナリオ**:

1. **前提条件** ペイン一覧にエージェントが表示されている、**操作** ペインを選択してEnterを押す、**期待結果** そのエージェントペインにフォーカスが移動する
2. **前提条件** エージェントペインにフォーカスがある、**操作** Ctrl-gを押す、**期待結果** gwtペインにフォーカスが戻る
3. **前提条件** gwtペインにフォーカスがある、**操作** Tabを押す、**期待結果** ブランチ一覧とペイン一覧のフォーカスが切り替わる

---

### ユーザーストーリー 6 - ペインの終了管理 (優先度: P1)

開発者がgwt TUIから特定のエージェントペインを終了でき、終了前に確認ダイアログが表示される。

**この優先度の理由**: 誤操作によるエージェント終了を防止する安全機能。

**独立したテスト**: ペインを終了する際に確認ダイアログが表示され、確認後に終了することを確認する。

**受け入れシナリオ**:

1. **前提条件** ペイン一覧でエージェントを選択、**操作** X（終了キー）を押す、**期待結果** 「Terminate this agent?」確認ダイアログが表示される
2. **前提条件** 確認ダイアログが表示されている、**操作** OKを選択、**期待結果** エージェントペインが終了（SIGTERM）され、ペインが自動クローズされる
3. **前提条件** 確認ダイアログが表示されている、**操作** Cancelを選択、**期待結果** エージェントは終了せず、ダイアログが閉じる

---

### ユーザーストーリー 7 - エージェント終了時のペイン自動クローズ (優先度: P1)

エージェントが正常終了または異常終了したとき、そのペインが自動的にクローズされる。

**この優先度の理由**: ペインの自動管理による操作性向上。

**独立したテスト**: エージェントを終了し、ペインが自動クローズされることを確認する。

**受け入れシナリオ**:

1. **前提条件** エージェントが稼働中、**操作** エージェントを正常終了（exit）、**期待結果** ペインが自動クローズされる
2. **前提条件** エージェントが稼働中、**操作** エージェントが異常終了、**期待結果** ペインが自動クローズされる
3. **前提条件** エージェントが稼働中、**操作** Ctrl+Cで中断、**期待結果** ペインが自動クローズされる

---

### ユーザーストーリー 8 - gwt終了時のエージェント確認 (優先度: P1)

開発者がgwtペインを閉じようとしたとき、稼働中のエージェントがあれば確認ダイアログが表示される。

**この優先度の理由**: 誤操作によるエージェント終了を防止する安全機能。

**独立したテスト**: エージェント稼働中にgwtを終了しようとし、確認ダイアログが表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 複数のエージェントペインが稼働中、**操作** gwtでqキーを押す、**期待結果** 「N agents are running. Terminate all?」確認ダイアログが表示される
2. **前提条件** 確認ダイアログが表示されている、**操作** OKを選択、**期待結果** 全エージェントが終了され、gwtが終了する
3. **前提条件** 確認ダイアログが表示されている、**操作** Cancelを選択、**期待結果** gwtは終了せず、エージェントも継続する
4. **前提条件** エージェントペインがない、**操作** gwtでqキーを押す、**期待結果** 確認なしでgwtが終了する

---

### ユーザーストーリー 9 - ログキャプチャの継続 (優先度: P2)

tmuxモードでもエージェントのstderrがキャプチャされ、ログファイルに保存される。

**この優先度の理由**: デバッグとトラブルシューティングのための機能。

**独立したテスト**: tmuxモードでエージェントを起動し、ログファイルにstderrが記録されることを確認する。

**受け入れシナリオ**:

1. **前提条件** マルチモードでエージェントを起動、**操作** エージェントがstderrに出力、**期待結果** ログファイルにstderrが記録される
2. **前提条件** マルチモードでエージェントを起動、**操作** gwt logsコマンドを実行、**期待結果** キャプチャされたログが表示される

---

### エッジケース

- **tmux未インストール**: tmuxがインストールされていない環境では自動的にシングルモードで動作し、エラーは発生しない
- **tmuxセッション競合**: 同じリポジトリで複数のgwtセッションが存在する場合、番号付きで新規作成される
- **ペイン作成失敗**: tmux操作が失敗した場合、gwt TUIにエラーメッセージを表示し、継続操作可能
- **同一エージェント多重起動**: 同じworktreeで同じエージェントを複数起動する場合は警告を表示するが、ユーザー確認後は許可
- **gwtクラッシュ時**: gwtがクラッシュした場合、エージェントペインはそのまま稼働を継続する（オーファン化）

## 要件 *(必須)*

### 機能要件

#### 環境検出とモード切り替え

- **FR-001**: システムは、起動時にTMUX環境変数の有無を確認し、tmux環境の検出を行わ**なければならない**
- **FR-002**: システムは、tmux環境内で起動された場合、自動的にマルチモードで動作**しなければならない**
- **FR-003**: システムは、tmux環境外で起動された場合、シングルモード（従来の動作）で動作**しなければならない**
- **FR-004**: システムは、tmuxがインストールされていない環境でも正常に動作し、シングルモードで起動**しなければならない**

#### tmuxセッション管理

- **FR-010**: システムは、マルチモードでセッションを作成する際、`gwt-{リポジトリ名}` 形式のセッション名を使用**しなければならない**
- **FR-011**: システムは、同名のセッションが既に存在する場合、`gwt-{リポジトリ名}-N` 形式で番号を付与して新規作成**しなければならない**
- **FR-012**: システムは、gwt TUIをtmuxセッションのマスターペインとして配置**しなければならない**

#### ペイン起動

- **FR-020**: システムは、マルチモードでエージェントを起動する際、新しいtmuxペインを作成**しなければならない**
- **FR-021**: システムは、エージェントペインを作成する際、該当worktreeのディレクトリを作業ディレクトリとして設定**しなければならない**
- **FR-022**: システムは、エージェント起動後、新しいペインにフォーカスを移動**しなければならない**
- **FR-023**: システムは、全てのペインを同一ウィンドウ内に配置**しなければならない**
- **FR-024**: システムは、ペインのレイアウトをgwt優先で自動配置**しなければならない**

#### ペイン一覧と管理

- **FR-030**: システムは、gwt TUI内でブランチ一覧（上部）とペイン一覧（下部）を上下分割で表示**しなければならない**
- **FR-031**: システムは、ペイン一覧に各ペインのブランチ名、エージェント名、稼働時間を表示**しなければならない**
- **FR-032**: システムは、アクティブなペインを色（ハイライト）とマーカー（>）の両方で強調表示**しなければならない**
- **FR-033**: システムは、1秒間隔でtmuxをポーリングし、ペイン状態を更新**しなければならない**

#### フォーカス切り替え

- **FR-040**: システムは、ペイン一覧でEnterキーを押したとき、選択されたペインにフォーカスを移動**しなければならない**
- **FR-041**: システムは、Ctrl-gキーバインドでgwtペインへのフォーカス復帰を提供**しなければならない**
- **FR-042**: システムは、Tabキーでブランチ一覧とペイン一覧のフォーカスを切り替え**しなければならない**

#### ペイン終了

- **FR-050**: システムは、ペイン終了前に確認ダイアログを表示**しなければならない**
- **FR-051**: システムは、確認後にSIGTERMでエージェントプロセスを終了**しなければならない**
- **FR-052**: システムは、エージェントが終了（正常/異常）した際、ペインを自動クローズ**しなければならない**

#### gwt終了

- **FR-060**: システムは、稼働中のエージェントがある状態でgwtを終了しようとした場合、確認ダイアログを表示**しなければならない**
- **FR-061**: システムは、確認後に全エージェントを終了し、gwtを終了**しなければならない**

#### ログキャプチャ

- **FR-070**: システムは、マルチモードでもエージェントのstderrをキャプチャし、ログファイルに保存**しなければならない**

#### 多重起動

- **FR-080**: システムは、同一worktreeで同一エージェントを起動しようとした場合、警告ダイアログを表示**しなければならない**
- **FR-081**: システムは、ユーザーが警告を確認した場合、多重起動を許可**しなければならない**

#### エラーハンドリング

- **FR-090**: システムは、tmux操作が失敗した場合、gwt TUIにエラーメッセージを表示し、継続操作を可能に**しなければならない**

### キーバインド変更（SPEC-d2f4762a影響）

- **FR-100**: システムは、表示モード切り替え（All/Local/Remote）のキーバインドをTabから`m`に変更**しなければならない**
- **FR-101**: システムは、Tabキーをブランチ一覧とペイン一覧のフォーカス切り替えに割り当て**しなければならない**

### 主要エンティティ

- **TmuxSession**: gwtが管理するtmuxセッション。セッション名、ウィンドウID、ペインID、リポジトリパスを含む
- **AgentPane**: エージェントが実行中のtmuxペイン。ペインID、ブランチ名、エージェント種別、起動時刻、プロセスIDを含む
- **ExecutionMode**: シングルモード（従来）とマルチモード（tmux）の動作モード

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: tmux環境の検出は起動後100ms以内に完了する
- **SC-002**: エージェントペインの作成は500ms以内に完了する
- **SC-003**: ペイン一覧の更新は1秒ごとに実行され、100ms以内に完了する
- **SC-004**: Ctrl-gでのgwtペイン復帰は200ms以内に完了する
- **SC-005**: 開発者の90%が、初回使用時にマルチモードの操作を理解できる
- **SC-006**: ペイン終了の確認ダイアログでCancelを選択した場合、エージェントが終了しないことをテストで確認できる

## 制約と仮定 *(該当する場合)*

### 制約

- tmuxのバージョン2.0以上が必要
- Ctrl-gキーバインドはtmuxのセッション作成時に設定される（ユーザーの.tmux.confは変更しない）

### 仮定

- ユーザーはtmuxの基本操作（ペイン移動など）を理解している
- tmuxセッションは単一ユーザーによって使用される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- tmuxセッションのデタッチ/リアタッチ対応（将来検討）
- ペインのリサイズ機能（tmux標準操作で対応）
- カスタムキーバインド設定（.gwt.tomlでの変更）
- 複数ウィンドウへの分散配置

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- tmuxセッションはローカルユーザーのみがアクセス可能
- ログキャプチャされた内容はローカルファイルに保存され、外部に送信されない

## 依存関係 *(該当する場合)*

- tmux 2.0以上
- SPEC-d2f4762a: ブランチ選択画面（キーバインド変更の影響）
- SPEC-3b0ed29b: コーディングエージェント対応（エージェント起動ロジック）

## 参考資料 *(該当する場合)*

- [tmux公式ドキュメント](https://github.com/tmux/tmux/wiki)
- [tmux send-keys](https://man.openbsd.org/tmux#send-keys)
