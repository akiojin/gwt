# 機能仕様: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-19
**ステータス**: 実装中
**入力**: ユーザー説明: "tmux必須化により、シングルモードを廃止。gwtを司令塔として常駐させ、1ブランチ1ペインの制約でエージェントを管理する。PaneListパネルを廃止し、ブランチリストにエージェント情報を統合表示する。"

**BREAKING CHANGE**: シングルモードを廃止し、tmux環境必須に変更

## 概要

gwtはtmux環境必須で動作し、tmux外で起動された場合はエラー終了する。1ブランチに対して1ペインのみ許可し、ブランチリストの右側にエージェント情報（スピナー、エージェント名、稼働時間）を表示する。PaneListパネルは廃止し、ブランチリストに統合する。

gwtは左列に固定し、右側にエージェント用の列を配置する。エージェント列は列内で最大3ペインまでの水平分割（上下積み）を行い、4つ目以降は右側に新しい列を追加する。列数に応じて全体の幅を自動調整する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - tmux必須化 (優先度: P0)

開発者がgwtを起動したとき、tmux環境内でなければエラーメッセージを表示して終了する。

**この優先度の理由**: アーキテクチャの根幹となる制約。

**独立したテスト**: tmux内外でgwtを起動し、それぞれの動作を確認する。

**受け入れシナリオ**:

1. **前提条件** tmux環境外でgwtを起動、**操作** gwtを起動、**期待結果** エラーメッセージ「gwt requires tmux. Please run inside a tmux session.」を表示して終了
2. **前提条件** tmux環境内でgwtを起動、**操作** gwtを起動、**期待結果** 正常に起動し、ブランチリストが表示される
3. **前提条件** TMUX環境変数が設定されていない、**操作** gwtを起動、**期待結果** エラー終了する

---

### ユーザーストーリー 2 - 1ブランチ1ペイン制約 (優先度: P0)

開発者が同じブランチで2つ目のエージェントを起動しようとしたとき、起動済みのペインにフォーカスを移動する。

**この優先度の理由**: 1:1制約のコア機能。

**独立したテスト**: 同一ブランチで2度エージェント起動を試み、フォーカス移動を確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチAでエージェントが稼働中、**操作** ブランチAで再度Enterを押す、**期待結果** 既存のペインにフォーカスが移動する（新規起動しない）
2. **前提条件** ブランチAでエージェントが非表示（background）、**操作** ブランチAでEnterを押す、**期待結果** ペインを表示してフォーカスを移動し、tmuxのmouseが有効化される
3. **前提条件** ブランチAでエージェントが稼働していない、**操作** ブランチAでEnterを押す、**期待結果** ウィザードが起動する

---

### ユーザーストーリー 3 - ブランチリストへのエージェント情報統合 (優先度: P0)

開発者がブランチリストを確認したとき、稼働中のエージェント情報が同じ行の右側に表示される。

**この優先度の理由**: PaneList廃止後のメイン表示機能。

**独立したテスト**: エージェント起動後、ブランチリストに情報が表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチAでエージェントが稼働中、**操作** ブランチリストを確認、**期待結果** ブランチ行の右側に「[スピナー] エージェント名 稼働時間」が表示される
2. **前提条件** ブランチAでエージェントが稼働していない、**操作** ブランチリストを確認、**期待結果** ブランチ行の右側は空白
3. **前提条件** ブランチAでエージェントが非表示、**操作** ブランチリストを確認、**期待結果** ブランチ行の右側に「[BG] エージェント名 稼働時間」が表示される（グレーアウト）
4. **前提条件** Codex/Geminiのエージェントが稼働中、**操作** ブランチリストを確認、**期待結果** 表示名が「Codex」「Gemini」として表示される
5. **前提条件** スピナーアニメーション、**操作** 250ms経過、**期待結果** スピナーが次のフレームに更新される（`|/-\`ローテーション）

---

### ユーザーストーリー 4 - エージェントペインの起動 (優先度: P0)

開発者がブランチを選択してエージェントを起動したとき、新しいtmuxペインが作成されてエージェントが起動する。

**この優先度の理由**: エージェント管理のコア機能。

**独立したテスト**: ブランチでEnterを押し、ペインが作成されることを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチAでエージェント未起動、**操作** Enterを押してウィザードでエージェント選択、**期待結果** 新しいペインが右側に作成され、エージェントが起動する
2. **前提条件** 複数エージェント起動中（1〜3件）、**操作** 新しいブランチでエージェントを起動、**期待結果** 右側の列で水平分割（上下積み）され、高さが均等に配置される
3. **前提条件** 3件のエージェントが稼働中、**操作** 4件目のエージェントを起動、**期待結果** 右側に新しい列が追加され、全体が3列（gwt + 2列）で幅を自動調整する
4. **前提条件** ペイン作成完了、**操作** 自動、**期待結果** フォーカスが新しいペインに移動する

---

### ユーザーストーリー 5 - dキーによるペイン削除 (優先度: P1)

開発者がブランチリストでdキーを押したとき、確認ダイアログ後にペインが削除される。

**この優先度の理由**: エージェント終了の安全機能。

**独立したテスト**: dキーで確認ダイアログが表示され、ペインが削除されることを確認する。

**受け入れシナリオ**:

1. **前提条件** エージェント稼働中のブランチを選択、**操作** dキーを押す、**期待結果** 「Terminate this agent?」確認ダイアログが表示される
2. **前提条件** 確認ダイアログが表示されている、**操作** OKを選択、**期待結果** ペインがkill-paneで削除される
3. **前提条件** 確認ダイアログが表示されている、**操作** Cancelを選択、**期待結果** ペインは削除されず、ダイアログが閉じる
4. **前提条件** エージェント未起動のブランチを選択、**操作** dキーを押す、**期待結果** 何も起こらない

---

### ユーザーストーリー 6 - gwt終了時のペイン継続 (優先度: P1)

開発者がgwtを終了（Ctrl+C）したとき、エージェントペインは継続して稼働する。

**この優先度の理由**: エージェントの継続稼働を保証する機能。

**独立したテスト**: gwt終了後、エージェントペインが継続することを確認する。

**受け入れシナリオ**:

1. **前提条件** 複数のエージェントが稼働中、**操作** gwtでCtrl+Cを押す、**期待結果** gwtが終了し、エージェントペインは継続稼働する
2. **前提条件** エージェントが稼働中、**操作** gwtでqキーを押す、**期待結果** gwtが終了し、エージェントペインは継続稼働する

---

### ユーザーストーリー 7 - gwt再起動時のペイン再接続 (優先度: P1)

開発者がgwtを再起動したとき、稼働中のエージェントペインが自動的に再接続される。

**この優先度の理由**: セッション継続性の確保。

**独立したテスト**: gwt再起動後、既存ペインが再接続されることを確認する。

**受け入れシナリオ**:

1. **前提条件** エージェントが稼働中にgwtを終了、**操作** gwtを再起動、**期待結果** 稼働中のペインがブランチリストに表示される（作業ディレクトリで関連付け）
2. **前提条件** 複数エージェントが稼働中、**操作** gwtを再起動、**期待結果** 全てのペインが正しいブランチに関連付けられる

---

### ユーザーストーリー 8 - エージェント終了時のペイン自動クローズ (優先度: P1)

エージェントが正常終了または異常終了したとき、そのペインが自動的にクローズされる。

**この優先度の理由**: ペインの自動管理による操作性向上。

**独立したテスト**: エージェントを終了し、ペインが自動クローズされることを確認する。

**受け入れシナリオ**:

1. **前提条件** エージェントが稼働中、**操作** エージェントを正常終了（/exit等）、**期待結果** ペインが自動クローズされ、ブランチリストからエージェント情報が消える
2. **前提条件** エージェントが稼働中、**操作** エージェント内でCtrl+C、**期待結果** ペインが自動クローズされる

---

### ユーザーストーリー 9 - 稼働中ブランチの削除ブロック (優先度: P1)

開発者がエージェント稼働中のブランチを削除しようとしたとき、エラーでブロックされる。

**この優先度の理由**: データ整合性の保護。

**独立したテスト**: 稼働中ブランチの削除がブロックされることを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチAでエージェントが稼働中、**操作** ブランチAで削除（Delete/X）を試行、**期待結果** エラーメッセージが表示され、削除がブロックされる

---

### エッジケース

- **tmux未インストール**: gwtはエラーメッセージを表示して終了（シングルモードへのフォールバックなし）
- **ペイン消失検知**: ペインIDが存在しなくなった場合、ブランチリストからエージェント情報を即座に削除
- **作業ディレクトリ不一致**: gwt再起動時、作業ディレクトリでブランチを特定できない場合はエージェント情報を表示しない
- **tmux join-pane -P未対応**: ペイン再表示は`-P`/`-F`に依存せず成功し、pane_idは維持される

## 要件 *(必須)*

### 機能要件

#### tmux必須化

- **FR-001**: システムは、起動時にTMUX環境変数の有無を確認し、設定されていない場合はエラー終了**しなければならない**
- **FR-002**: システムは、tmux環境外で起動された場合、「gwt requires tmux. Please run inside a tmux session.」を表示して終了**しなければならない**
- **FR-003**: ~~システムは、tmux環境外で起動された場合、シングルモード（従来の動作）で動作しなければならない~~ **[廃止]**
- **FR-004**: ~~システムは、tmuxがインストールされていない環境でも正常に動作し、シングルモードで起動しなければならない~~ **[廃止]**

#### 1ブランチ1ペイン制約

- **FR-010**: システムは、1つのブランチに対して最大1つのエージェントペインのみ許可**しなければならない**
- **FR-011**: システムは、既にエージェントが稼働中のブランチでEnterを押した場合、既存ペインにフォーカスを移動**しなければならない**
- **FR-012**: システムは、非表示（background）のペインがある場合、表示してからフォーカスを移動**しなければならない**

#### ブランチリストへのエージェント情報統合

- **FR-020**: システムは、ブランチリストの各行の右側にエージェント情報を表示**しなければならない**
- **FR-021**: システムは、稼働中のエージェントを「[スピナー] エージェント名 稼働時間」形式で表示**しなければならない**
- **FR-022**: システムは、非表示のエージェントを「[BG] エージェント名 稼働時間」形式でグレーアウト表示**しなければならない**
- **FR-023**: システムは、エージェントが稼働していないブランチの右側を空白で表示**しなければならない**
- **FR-024**: システムは、スピナーを250ms間隔で更新**しなければならない**（`|/-\`ローテーション）
- **FR-026**: システムは、Codex CLI/Gemini CLIの表示名を「Codex」「Gemini」として表示**しなければならない**
- **FR-025**: ~~システムは、gwt TUI内でブランチ一覧（上部）とペイン一覧（下部）を上下分割で表示しなければならない~~ **[廃止]**

#### ペイン起動

- **FR-030**: システムは、エージェント起動時に新しいtmuxペインを右側に作成**しなければならない**
- **FR-031**: システムは、エージェントペインを該当worktreeのディレクトリを作業ディレクトリとして起動**しなければならない**
- **FR-032**: システムは、エージェント起動後、新しいペインにフォーカスを移動**しなければならない**
- **FR-033**: システムは、右側のエージェント列内でペインを水平分割（上下積み）し、最大3ペインまで均等配置**しなければならない**
- **FR-034**: システムは、右側列のペイン数が3に達した場合、次のエージェントを新しい列として右側に追加**しなければならない**
- **FR-035**: システムは、列数に応じて全体の幅を自動調整し、gwt列を含めた各列を均等幅で配置**しなければならない**

#### ペイン削除

- **FR-040**: システムは、dキーで選択中ブランチのエージェントペインを削除**しなければならない**
- **FR-041**: システムは、ペイン削除前に確認ダイアログを表示**しなければならない**
- **FR-042**: システムは、確認後にtmux kill-paneでペインを削除**しなければならない**
- **FR-043**: システムは、エージェント未起動のブランチでdキーを押しても何もしない**ことができる**

#### gwt終了

- **FR-050**: システムは、gwt終了時（Ctrl+C/q）にエージェントペインを終了せず継続させ**なければならない**
- **FR-051**: ~~システムは、稼働中のエージェントがある状態でgwtを終了しようとした場合、確認ダイアログを表示しなければならない~~ **[廃止]**

#### gwt再起動時の再接続

- **FR-060**: システムは、起動時に同一tmuxセッション内のペインを検出**しなければならない**
- **FR-061**: システムは、ペインの作業ディレクトリからブランチを特定し関連付け**しなければならない**
- **FR-062**: システムは、関連付けられたペインをブランチリストに表示**しなければならない**

#### エージェント終了時の自動クローズ

- **FR-070**: システムは、エージェント終了時にペインを自動クローズ**しなければならない**
- **FR-071**: システムは、ペイン消失を検知した場合、ブランチリストからエージェント情報を即座に削除**しなければならない**

#### ブランチ削除ブロック

- **FR-080**: システムは、エージェント稼働中のブランチ削除をブロック**しなければならない**
- **FR-081**: システムは、ブロック時にエラーメッセージを表示**しなければならない**

#### ペイン表示/非表示

- **FR-090**: システムは、vキーで選択中ブランチのペインを表示/非表示切り替え**しなければならない**
- **FR-091**: システムは、非表示ペインをtmux break-paneで別ウィンドウに移動**しなければならない**
- **FR-092**: システムは、表示時にtmux join-paneでgwtウィンドウに戻す**しなければならない**
- **FR-093**: システムは、ペイン表示時に`tmux set -g mouse on`を実行**しなければならない**
- **FR-094**: システムは、tmux join-paneの`-P`/`-F`が未対応でも再表示が失敗しないよう、pane_id取得を出力に依存しない**しなければならない**

#### 廃止機能

- **FR-100**: システムは、Ctrl-gキーバインドでgwtペインへのフォーカス復帰を提供しなければならない
- **FR-101**: ~~システムは、Tabキーでブランチ一覧とペイン一覧のフォーカスを切り替えしなければならない~~ **[廃止: PaneList廃止]**

### 主要エンティティ

- **AgentPane**: エージェントが実行中のtmuxペイン。ペインID、ブランチ名、エージェント種別、起動時刻、is_background、background_windowを含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: tmux環境の検出は起動後100ms以内に完了する
- **SC-002**: エージェントペインの作成は500ms以内に完了する
- **SC-003**: ブランチリストの更新は1秒ごとに実行され、100ms以内に完了する
- **SC-004**: スピナーは250msごとに更新される
- **SC-005**: gwt再起動時のペイン再接続は1秒以内に完了する

## 制約と仮定 *(該当する場合)*

### 制約

- tmuxのバージョン2.0以上が必要
- tmux環境必須（シングルモードは廃止）

### 仮定

- ユーザーはtmuxの基本操作（ペイン移動など）を理解している
- tmuxセッションは単一ユーザーによって使用される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- シングルモード（完全廃止）
- 自動tmuxセッション作成（tmux外からの--tmuxオプション起動）
- 1ブランチ複数エージェント（1:1制約により不可）
- Ctrl-gキーバインド（tmux標準操作を使用）
- ペインのリサイズ機能（tmux標準操作で対応）
- カスタムキーバインド設定（.gwt.tomlでの変更）
- 複数ウィンドウへの分散配置

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- tmuxセッションはローカルユーザーのみがアクセス可能

## 依存関係 *(該当する場合)*

- tmux 2.0以上
- SPEC-d2f4762a: ブランチ選択画面
- SPEC-3b0ed29b: コーディングエージェント対応

## 参考資料 *(該当する場合)*

- [tmux公式ドキュメント](https://github.com/tmux/tmux/wiki)
