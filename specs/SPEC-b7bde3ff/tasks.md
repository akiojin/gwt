# タスク一覧: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-20

## タスク依存関係

```text
T-001 ─┬─> T-002 ─┬─> T-003 ─┬─> T-004 ─┬─> T-005 ─> T-006 ─> T-007 ─┬─> T-020 ─> T-021
       │          │          │          │                              └─> T-022
       │          │          │          └─> T-008
       │          │          │
       │          │          └─> T-009
       │          │
       │          └─> T-010
       │
       └─> T-011 (SPEC-d2f4762a並行)

T-007 ─> T-024 ─> T-025
```

## フェーズ 1: 基盤（環境検出とモード切り替え）

### T-001: tmuxモジュール基盤作成

- **ファイル**: `crates/gwt-core/src/tmux/mod.rs`
- **内容**:
  - [x] tmuxサブモジュールのディレクトリ構造作成
  - [x] mod.rsでのモジュールエクスポート設定
  - [x] TmuxError列挙型の定義
- **依存**: なし
- **テスト**: T-TEST-001 ✅

### T-002: tmux環境検出

- **ファイル**: `crates/gwt-core/src/tmux/detector.rs`
- **内容**:
  - [x] TMUX環境変数の検出関数
  - [x] tmuxコマンドの存在確認
  - [x] tmuxバージョン取得（2.0以上チェック）
- **依存**: T-001
- **テスト**: T-TEST-002 ✅

### T-003: 実行モード列挙型

- **ファイル**: `crates/gwt-core/src/execution_mode.rs`
- **内容**:
  - [x] TmuxMode列挙型（Single/Multi）定義
  - [x] 環境からのモード自動判定関数
  - [x] CLI起動時のモード初期化
- **依存**: T-002
- **テスト**: T-TEST-003 ✅

---

## フェーズ 2: セッション管理

### T-004: セッション命名規則

- **ファイル**: `crates/gwt-core/src/tmux/naming.rs`
- **内容**:
  - [x] リポジトリ名からセッション名生成（gwt-{repo}）
  - [x] 既存セッション検出
  - [x] 番号付与ロジック（-2, -3...）
- **依存**: T-003
- **テスト**: T-TEST-004 ✅

### T-005: セッション管理API

- **ファイル**: `crates/gwt-core/src/tmux/session.rs`
- **内容**:
  - [x] TmuxSession構造体定義
  - [x] create_session()関数
  - [x] destroy_session()関数
  - [x] list_sessions()関数
- **依存**: T-004
- **テスト**: T-TEST-005 ✅

---

## フェーズ 3: ペイン起動

### T-006: ペイン管理API

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] AgentPane構造体定義
  - [x] create_pane()関数（split-window）
  - [x] list_panes()関数
  - [x] get_pane_info()関数
- **依存**: T-005
- **テスト**: T-TEST-006 ✅

### T-007: tmux用エージェント起動

- **ファイル**: `crates/gwt-core/src/tmux/launcher.rs`
- **内容**:
  - [x] launch_agent_in_pane()関数
  - [x] 作業ディレクトリ設定
  - [x] 環境変数の引き継ぎ
  - [x] フォーカス移動（select-pane）
- **依存**: T-006
- **テスト**: T-TEST-007 ✅

---

## 追加作業: シングルモード復活 (2026-01-19)

- [x] **T-026** `[P][共通]` `crates/gwt-cli/src/main.rs` でtmux必須チェックを廃止し、tmux環境外ではシングルモードでTUIを継続する
- [x] **T-TEST-026** `[Test]` `crates/gwt-cli/src/main.rs` でTMUX環境変数に応じてシングル/マルチ判定されることをテストする

## 追加作業: 再接続判別の強化 (2026-01-19)

- [x] **T-027** `[P][共通]` `crates/gwt-core/src/tmux/pane.rs` でpane_current_commandがシェルでも再接続対象に含める
- [x] **T-TEST-027** `[Test]` `crates/gwt-core/src/tmux/pane.rs` で判別不能時のフォールバック名を検証する
- [x] **T-028** `[P][共通]` `crates/gwt-cli/src/tui/app.rs` で再接続時に直近履歴のtoolIdを優先表示する
- [x] **T-TEST-028** `[Test]` `crates/gwt-cli/src/tui/app.rs` で再接続時の表示名補正を検証する

## フェーズ 4: TUI分割表示

### T-008: ペイン一覧コンポーネント

- **ファイル**: `crates/gwt-cli/src/tui/screens/pane_list.rs`
- **内容**:
  - [x] PaneListState構造体
  - [x] ペイン情報表示（ブランチ、エージェント、稼働時間）
  - [x] アクティブペインのハイライト
  - [x] 選択カーソル表示
- **依存**: T-006
- **テスト**: T-TEST-008 ✅

### T-009: 分割レイアウト

- **ファイル**: `crates/gwt-cli/src/tui/screens/split_layout.rs`
- **内容**:
  - [x] 上下分割レイアウト実装
  - [x] ブランチ一覧（上）とペイン一覧（下）の配置
  - [x] フォーカス状態の管理
- **依存**: T-008
- **テスト**: T-TEST-009 ✅

### T-010: ペイン状態ポーリング

- **ファイル**: `crates/gwt-core/src/tmux/poller.rs`
- **内容**:
  - [x] 1秒間隔のポーリングタスク
  - [x] ペイン状態の差分検出
  - [x] UI更新トリガー
- **依存**: T-006
- **テスト**: T-TEST-010 ✅

---

## フェーズ 5: キーバインドとフォーカス管理

### T-011: 既存キーバインド変更（SPEC-d2f4762a）

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] Tab → m への変更（表示モード切り替え）
  - [x] Tab キーの新規割り当て（フォーカス切り替え）
- **依存**: T-001（並行実装可能）
- **テスト**: T-TEST-011 ✅

### T-012: フォーカス切り替え実装

- **ファイル**: `crates/gwt-cli/src/tui/screens/split_layout.rs`
- **内容**:
  - [x] Tab: ブランチ一覧 ⇔ ペイン一覧切り替え
  - [x] Enter: 選択ペインへのフォーカス移動
  - [x] フォーカス状態の視覚的表示
- **依存**: T-009, T-011
- **テスト**: T-TEST-012 ✅

### T-013: Ctrl-gキーバインド設定

- **ファイル**: `crates/gwt-core/src/tmux/keybind.rs`
- **内容**:
  - [x] セッション作成時のCtrl-g設定
  - [x] gwtペイン（0番）への移動コマンド
- **依存**: T-005
- **テスト**: T-TEST-013 ✅

---

## フェーズ 6: ペイン終了管理

### T-014: 終了確認ダイアログ

- **ファイル**: `crates/gwt-cli/src/tui/screens/confirm.rs`
- **内容**:
  - [x] 単一ペイン終了確認UI
  - [x] gwt終了時の全エージェント確認UI
  - [x] OK/Cancelボタン処理
- **依存**: T-009
- **テスト**: T-TEST-014 ✅

### T-015: プロセス終了処理

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] SIGTERM送信関数
  - [x] ペインkill処理
  - [x] 終了待機とタイムアウト
- **依存**: T-006
- **テスト**: T-TEST-015 ✅

### T-016: 自動クローズ検出

- **ファイル**: `crates/gwt-core/src/tmux/poller.rs`
- **内容**:
  - [x] エージェント終了検出
  - [x] ペイン自動クローズ処理
  - [x] UI更新通知
- **依存**: T-010, T-015
- **テスト**: T-TEST-016 ✅

---

## フェーズ 7: ログキャプチャとエラーハンドリング

### T-017: tmuxモード用ログキャプチャ

- **ファイル**: `crates/gwt-core/src/tmux/logging.rs`
- **内容**:
  - [x] pipe-pane によるstderrキャプチャ
  - [x] ログファイルへの保存
  - [x] 既存ログシステムとの統合
- **依存**: T-007
- **テスト**: T-TEST-017 ✅

### T-018: エラーハンドリング

- **ファイル**: `crates/gwt-core/src/tmux/error.rs`
- **内容**:
  - [x] TmuxError型定義
  - [x] エラーメッセージのUI表示
  - [x] リカバリー処理
- **依存**: T-001
- **テスト**: T-TEST-018 ✅

### T-019: 多重起動警告

- **ファイル**: `crates/gwt-cli/src/tui/screens/confirm.rs`
- **内容**:
  - [x] 同一WT+同一エージェント検出
  - [x] 警告ダイアログUI
  - [x] ユーザー確認後の起動許可
- **依存**: T-006, T-014
- **テスト**: T-TEST-019 ✅

---

## フェーズ 8: エージェントペインの列/行レイアウト **[廃止: シングルアクティブ化]**

> **注**: シングルアクティブペイン制約により、複数ペインの列/行レイアウトは不要になりました。

### T-020: 右側列レイアウトの分割方向追加 **[廃止]**

- **ファイル**: `crates/gwt-core/src/tmux/launcher.rs`
- **内容**:
  - [x] ~~右側列内の上下分割（水平分割）起動API追加~~ [廃止: シングルアクティブ化]
  - [x] ~~既存の右側追加ロジックとの統合~~ [廃止: シングルアクティブ化]
- **依存**: T-007
- **テスト**: ~~T-TEST-020~~ [廃止]

### T-021: 列/行の再配置とサイズ均等化 **[廃止]**

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] ~~ペイン位置情報（left/top/width/height）の取得~~ [廃止: シングルアクティブ化]
  - [x] ~~列ごとの行数判定と最大3行制約~~ [廃止: シングルアクティブ化]
  - [x] ~~列数に応じた幅の均等化~~ [廃止: シングルアクティブ化]
  - [x] ~~列内の高さ均等化~~ [廃止: シングルアクティブ化]
- **依存**: T-020
- **テスト**: ~~T-TEST-021~~ [廃止]

### T-022: TUI起動/復元時のレイアウト適用 **[廃止]**

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] ~~新規ペイン追加時の列/行レイアウト適用~~ [廃止: シングルアクティブ化]
  - [x] ~~表示/非表示切り替え後の再配置~~ [廃止: シングルアクティブ化]
  - [x] ~~ペイン終了検知後の再配置~~ [廃止: シングルアクティブ化]
- **依存**: T-021
- **テスト**: ~~T-TEST-022~~ [廃止]

---

## フェーズ 8b: シングルアクティブペイン対応 (2026-01-20)

> **新機能**: アクティブペインは最大1つに制限。gwt + エージェント の最大2ペイン構成。

### T-029: ESCキーによるペイン非表示 ✅

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] gwtペインでESCキーハンドリング追加
  - [x] ESC押下時にアクティブペインを非表示にする処理
  - [x] アクティブペインがない場合は何もしない（空振り）
- **依存**: T-007
- **テスト**: T-TEST-029

### T-030: 新規起動/表示時の既存アクティブペイン自動非表示 ✅

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`, `crates/gwt-core/src/tmux/launcher.rs`
- **内容**:
  - [x] 新規エージェント起動時に既存アクティブペインを非表示にする
  - [x] 非表示ペイン表示時に既存アクティブペインを非表示にする
  - [x] シングルアクティブ制約の強制
- **依存**: T-029
- **テスト**: T-TEST-030

### T-031: vキー廃止 ✅

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] vキーハンドラの削除
  - [x] ヘルプ画面からvキーの説明を削除
- **依存**: T-029
- **テスト**: T-TEST-031

### T-032: 複数ペインレイアウトロジック削除 ✅

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`, `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] group_panes_by_left() 等の複数ペイン用ヘルパーを廃止または簡略化
  - [x] compute_equal_splits() の複数分割計算を削除
  - [x] 関連するテストの更新または削除
- **依存**: T-030
- **テスト**: T-TEST-032

---

## フェーズ 9: エージェント表示名の短縮

### T-023: Codex/Gemini 表示名の短縮 ✅

- **ファイル**: `crates/gwt-core/src/agent/mod.rs`, `crates/gwt-cli/src/tui/screens/wizard.rs`, `crates/gwt-core/src/config/session.rs`
- **内容**:
  - [x] Codex CLI → Codex の表示名統一（既に実装済み: `CodingAgent::label()`）
  - [x] Gemini CLI → Gemini の表示名統一（既に実装済み: `CodingAgent::label()`）
  - [x] 表示名に依存するテストの更新（後方互換性テストは維持）
- **依存**: なし
- **テスト**: T-TEST-023

---

## フェーズ 10: ペイン表示時のmouse有効化

### T-024: ペイン表示時にtmux mouseを有効化 ✅

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] `tmux set -g mouse on` 実行ヘルパー追加（`enable_mouse()`関数）
  - [x] ペイン表示前にmouseを有効化（`show_pane()`、`launch_in_pane()`で呼び出し）
- **依存**: T-007
- **テスト**: T-TEST-024

### T-025: join-pane 互換性対応 ✅

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`, `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] join-paneの`-P`/`-F`に依存しない再表示処理へ変更（未使用）
  - [x] show_pane/join_pane_to_targetの戻り値をpane_id維持に揃える（`Ok(pane_id.to_string())`）
  - [x] 呼び出し側のpane_id更新フローを維持（`show_and_focus_selected_pane`で対応）
- **依存**: T-024
- **テスト**: T-TEST-025

---

## テストタスク

### T-TEST-001: tmuxモジュール基盤テスト ✅

- [x] TmuxError型のテスト
- [x] モジュール構造の確認

### T-TEST-002: 環境検出テスト ✅

- [x] TMUX環境変数あり/なしのテスト
- [x] tmuxコマンド存在確認テスト
- [x] バージョンチェックテスト

### T-TEST-003: 実行モードテスト ✅

- [x] Single/Multiモード判定テスト
- [x] 環境に基づく自動判定テスト

### T-TEST-004: セッション命名テスト ✅

- [x] リポジトリ名からのセッション名生成テスト
- [x] 番号付与ロジックテスト

### T-TEST-005: セッション管理APIテスト ✅

- [x] セッション作成/削除テスト
- [x] セッション一覧取得テスト

### T-TEST-006: ペイン管理APIテスト ✅

- [x] ペイン作成テスト
- [x] ペイン一覧取得テスト

### T-TEST-007: エージェント起動テスト ✅

- [x] ペイン内エージェント起動テスト
- [x] 作業ディレクトリ設定テスト

### T-TEST-008: ペイン一覧UIテスト ✅

- [x] 表示内容のテスト
- [x] ハイライト表示テスト

### T-TEST-009: 分割レイアウトテスト ✅

- [x] レイアウト配置テスト
- [x] フォーカス状態テスト

### T-TEST-010: ポーリングテスト ✅

- [x] 状態更新テスト
- [x] 差分検出テスト

### T-TEST-011: キーバインド変更テスト ✅

- [x] m キーでモード切り替えテスト
- [x] Tab キーでフォーカス切り替えテスト

### T-TEST-012: フォーカス切り替えテスト ✅

- [x] ブランチ一覧⇔ペイン一覧切り替えテスト
- [x] ペイン選択フォーカス移動テスト

### T-TEST-013: Ctrl-gキーバインドテスト ✅

- [x] gwtペイン復帰テスト

### T-TEST-014: 終了確認ダイアログテスト ✅

- [x] 単一ペイン終了確認テスト
- [x] gwt終了時確認テスト

### T-TEST-015: プロセス終了テスト ✅

- [x] SIGTERM送信テスト
- [x] タイムアウトテスト

### T-TEST-016: 自動クローズテスト ✅

- [x] エージェント終了検出テスト
- [x] ペイン自動クローズテスト

### T-TEST-017: ログキャプチャテスト ✅

- [x] stderrキャプチャテスト
- [x] ログファイル保存テスト

### T-TEST-018: エラーハンドリングテスト ✅

- [x] エラー表示テスト
- [x] リカバリーテスト

### T-TEST-019: 多重起動警告テスト ✅

- [x] 検出テスト
- [x] 警告表示テスト

### T-TEST-020: 右側列分割APIテスト **[廃止]**

- [x] ~~分割方向の生成テスト~~ [廃止: シングルアクティブ化]
- [x] ~~起動パラメータ生成テスト~~ [廃止: シングルアクティブ化]

### T-TEST-021: 列/行均等化テスト **[廃止]**

- [x] ~~列数算出テスト~~ [廃止: シングルアクティブ化]
- [x] ~~高さ/幅均等化計算テスト~~ [廃止: シングルアクティブ化]

### T-TEST-022: レイアウト適用タイミングテスト **[廃止]**

- [x] ~~起動時レイアウト適用テスト~~ [廃止: シングルアクティブ化]
- [x] ~~表示/非表示切り替え後の再配置テスト~~ [廃止: シングルアクティブ化]
- [x] ~~ペイン終了後の再配置テスト~~ [廃止: シングルアクティブ化]

### T-TEST-029: ESCキー非表示テスト ✅

- [x] gwtペインでESC押下時にアクティブペインが非表示になること
- [x] アクティブペインがない状態でESC押下時に何も起こらないこと

### T-TEST-030: 自動非表示テスト ✅

- [x] 新規起動時に既存アクティブが非表示になること
- [x] 非表示ペイン表示時に既存アクティブが非表示になること
- [x] 同時に表示されるペインが最大1つであること

### T-TEST-031: vキー廃止テスト ✅

- [x] vキー押下時に何も起こらないこと
- [x] ヘルプ画面にvキーの説明がないこと

### T-TEST-032: 複数ペインロジック削除テスト ✅

- [x] シングルアクティブ制約が正しく動作すること
- [x] 不要なコードが削除されていること

### T-TEST-023: 表示名短縮テスト ✅

- [x] Codex表示名テスト（`CodingAgent::label()` = "Codex"）
- [x] Gemini表示名テスト（`CodingAgent::label()` = "Gemini"）

### T-TEST-024: ペイン表示時のmouse有効化テスト ✅

- [x] tmux set -g mouse on が実行されること（`enable_mouse()`）

### T-TEST-025: join-pane 互換性テスト ✅

- [x] join-paneの`-P`/`-F`未対応環境でも再表示が成功すること
- [x] pane_idが維持されること
