# タスク一覧: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-18

## タスク依存関係

```text
T-001 ─┬─> T-002 ─┬─> T-003 ─┬─> T-004 ─┬─> T-005 ─> T-006 ─> T-007
       │          │          │          │
       │          │          │          └─> T-008
       │          │          │
       │          │          └─> T-009
       │          │
       │          └─> T-010
       │
       └─> T-011 (SPEC-d2f4762a並行)
```

## フェーズ 1: 基盤（環境検出とモード切り替え）

### T-001: tmuxモジュール基盤作成

- **ファイル**: `crates/gwt-core/src/tmux/mod.rs`
- **内容**:
  - [ ] tmuxサブモジュールのディレクトリ構造作成
  - [ ] mod.rsでのモジュールエクスポート設定
  - [ ] TmuxError列挙型の定義
- **依存**: なし
- **テスト**: T-TEST-001

### T-002: tmux環境検出

- **ファイル**: `crates/gwt-core/src/tmux/detector.rs`
- **内容**:
  - [ ] TMUX環境変数の検出関数
  - [ ] tmuxコマンドの存在確認
  - [ ] tmuxバージョン取得（2.0以上チェック）
- **依存**: T-001
- **テスト**: T-TEST-002

### T-003: 実行モード列挙型

- **ファイル**: `crates/gwt-core/src/execution_mode.rs`
- **内容**:
  - [ ] ExecutionMode列挙型（Single/Multi）定義
  - [ ] 環境からのモード自動判定関数
  - [ ] CLI起動時のモード初期化
- **依存**: T-002
- **テスト**: T-TEST-003

---

## フェーズ 2: セッション管理

### T-004: セッション命名規則

- **ファイル**: `crates/gwt-core/src/tmux/naming.rs`
- **内容**:
  - [ ] リポジトリ名からセッション名生成（gwt-{repo}）
  - [ ] 既存セッション検出
  - [ ] 番号付与ロジック（-2, -3...）
- **依存**: T-003
- **テスト**: T-TEST-004

### T-005: セッション管理API

- **ファイル**: `crates/gwt-core/src/tmux/session.rs`
- **内容**:
  - [ ] TmuxSession構造体定義
  - [ ] create_session()関数
  - [ ] destroy_session()関数
  - [ ] list_sessions()関数
- **依存**: T-004
- **テスト**: T-TEST-005

---

## フェーズ 3: ペイン起動

### T-006: ペイン管理API

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [ ] AgentPane構造体定義
  - [ ] create_pane()関数（split-window）
  - [ ] list_panes()関数
  - [ ] get_pane_info()関数
- **依存**: T-005
- **テスト**: T-TEST-006

### T-007: tmux用エージェント起動

- **ファイル**: `crates/gwt-cli/src/agent_launcher_tmux.rs`
- **内容**:
  - [ ] launch_agent_in_pane()関数
  - [ ] 作業ディレクトリ設定
  - [ ] 環境変数の引き継ぎ
  - [ ] フォーカス移動（select-pane）
- **依存**: T-006
- **テスト**: T-TEST-007

---

## フェーズ 4: TUI分割表示

### T-008: ペイン一覧コンポーネント

- **ファイル**: `crates/gwt-cli/src/ui/pane_list.rs`
- **内容**:
  - [ ] PaneListWidget構造体
  - [ ] ペイン情報表示（ブランチ、エージェント、稼働時間）
  - [ ] アクティブペインのハイライト
  - [ ] 選択カーソル表示
- **依存**: T-006
- **テスト**: T-TEST-008

### T-009: 分割レイアウト

- **ファイル**: `crates/gwt-cli/src/ui/split_layout.rs`
- **内容**:
  - [ ] 上下分割レイアウト実装
  - [ ] ブランチ一覧（上）とペイン一覧（下）の配置
  - [ ] フォーカス状態の管理
- **依存**: T-008
- **テスト**: T-TEST-009

### T-010: ペイン状態ポーリング

- **ファイル**: `crates/gwt-cli/src/tmux_poller.rs`
- **内容**:
  - [ ] 1秒間隔のポーリングタスク
  - [ ] ペイン状態の差分検出
  - [ ] UI更新トリガー
- **依存**: T-006
- **テスト**: T-TEST-010

---

## フェーズ 5: キーバインドとフォーカス管理

### T-011: 既存キーバインド変更（SPEC-d2f4762a）

- **ファイル**: `crates/gwt-cli/src/ui/keybindings.rs`
- **内容**:
  - [ ] Tab → m への変更（表示モード切り替え）
  - [ ] Tab キーの新規割り当て（フォーカス切り替え）
- **依存**: T-001（並行実装可能）
- **テスト**: T-TEST-011

### T-012: フォーカス切り替え実装

- **ファイル**: `crates/gwt-cli/src/ui/focus_manager.rs`
- **内容**:
  - [ ] Tab: ブランチ一覧 ⇔ ペイン一覧切り替え
  - [ ] Enter: 選択ペインへのフォーカス移動
  - [ ] フォーカス状態の視覚的表示
- **依存**: T-009, T-011
- **テスト**: T-TEST-012

### T-013: Ctrl-gキーバインド設定

- **ファイル**: `crates/gwt-core/src/tmux/keybind.rs`
- **内容**:
  - [ ] セッション作成時のCtrl-g設定
  - [ ] gwtペイン（0番）への移動コマンド
- **依存**: T-005
- **テスト**: T-TEST-013

---

## フェーズ 6: ペイン終了管理

### T-014: 終了確認ダイアログ

- **ファイル**: `crates/gwt-cli/src/ui/dialogs/terminate_confirm.rs`
- **内容**:
  - [ ] 単一ペイン終了確認UI
  - [ ] gwt終了時の全エージェント確認UI
  - [ ] OK/Cancelボタン処理
- **依存**: T-009
- **テスト**: T-TEST-014

### T-015: プロセス終了処理

- **ファイル**: `crates/gwt-core/src/tmux/terminate.rs`
- **内容**:
  - [ ] SIGTERM送信関数
  - [ ] ペインkill処理
  - [ ] 終了待機とタイムアウト
- **依存**: T-006
- **テスト**: T-TEST-015

### T-016: 自動クローズ検出

- **ファイル**: `crates/gwt-cli/src/tmux_poller.rs`（更新）
- **内容**:
  - [ ] エージェント終了検出
  - [ ] ペイン自動クローズ処理
  - [ ] UI更新通知
- **依存**: T-010, T-015
- **テスト**: T-TEST-016

---

## フェーズ 7: ログキャプチャとエラーハンドリング

### T-017: tmuxモード用ログキャプチャ

- **ファイル**: `crates/gwt-core/src/tmux/logging.rs`
- **内容**:
  - [ ] pipe-pane によるstderrキャプチャ
  - [ ] ログファイルへの保存
  - [ ] 既存ログシステムとの統合
- **依存**: T-007
- **テスト**: T-TEST-017

### T-018: エラーハンドリング

- **ファイル**: `crates/gwt-core/src/tmux/error.rs`
- **内容**:
  - [ ] TmuxOperationError型定義
  - [ ] エラーメッセージのUI表示
  - [ ] リカバリー処理
- **依存**: T-001
- **テスト**: T-TEST-018

### T-019: 多重起動警告

- **ファイル**: `crates/gwt-cli/src/ui/dialogs/duplicate_warn.rs`
- **内容**:
  - [ ] 同一WT+同一エージェント検出
  - [ ] 警告ダイアログUI
  - [ ] ユーザー確認後の起動許可
- **依存**: T-006, T-014
- **テスト**: T-TEST-019

---

## テストタスク

### T-TEST-001: tmuxモジュール基盤テスト

- [ ] TmuxError型のテスト
- [ ] モジュール構造の確認

### T-TEST-002: 環境検出テスト

- [ ] TMUX環境変数あり/なしのテスト
- [ ] tmuxコマンド存在確認テスト
- [ ] バージョンチェックテスト

### T-TEST-003: 実行モードテスト

- [ ] Single/Multiモード判定テスト
- [ ] 環境に基づく自動判定テスト

### T-TEST-004: セッション命名テスト

- [ ] リポジトリ名からのセッション名生成テスト
- [ ] 番号付与ロジックテスト

### T-TEST-005: セッション管理APIテスト

- [ ] セッション作成/削除テスト
- [ ] セッション一覧取得テスト

### T-TEST-006: ペイン管理APIテスト

- [ ] ペイン作成テスト
- [ ] ペイン一覧取得テスト

### T-TEST-007: エージェント起動テスト

- [ ] ペイン内エージェント起動テスト
- [ ] 作業ディレクトリ設定テスト

### T-TEST-008: ペイン一覧UIテスト

- [ ] 表示内容のテスト
- [ ] ハイライト表示テスト

### T-TEST-009: 分割レイアウトテスト

- [ ] レイアウト配置テスト
- [ ] フォーカス状態テスト

### T-TEST-010: ポーリングテスト

- [ ] 状態更新テスト
- [ ] 差分検出テスト

### T-TEST-011: キーバインド変更テスト

- [ ] m キーでモード切り替えテスト
- [ ] Tab キーでフォーカス切り替えテスト

### T-TEST-012: フォーカス切り替えテスト

- [ ] ブランチ一覧⇔ペイン一覧切り替えテスト
- [ ] ペイン選択フォーカス移動テスト

### T-TEST-013: Ctrl-gキーバインドテスト

- [ ] gwtペイン復帰テスト

### T-TEST-014: 終了確認ダイアログテスト

- [ ] 単一ペイン終了確認テスト
- [ ] gwt終了時確認テスト

### T-TEST-015: プロセス終了テスト

- [ ] SIGTERM送信テスト
- [ ] タイムアウトテスト

### T-TEST-016: 自動クローズテスト

- [ ] エージェント終了検出テスト
- [ ] ペイン自動クローズテスト

### T-TEST-017: ログキャプチャテスト

- [ ] stderrキャプチャテスト
- [ ] ログファイル保存テスト

### T-TEST-018: エラーハンドリングテスト

- [ ] エラー表示テスト
- [ ] リカバリーテスト

### T-TEST-019: 多重起動警告テスト

- [ ] 検出テスト
- [ ] 警告表示テスト
