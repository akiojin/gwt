# タスク一覧: tmuxマルチモードサポート

**仕様ID**: `SPEC-b7bde3ff`
**作成日**: 2026-01-18
**更新日**: 2026-01-18

## タスク依存関係

```text
T-001 ─┬─> T-002 ─┬─> T-003 ─┬─> T-004 ─┬─> T-005 ─> T-006 ─> T-007
       │          │          │          │
       │          │          │          └─> T-008
       │          │          │
       │          │          └─> T-009
       │          │
       │          └─> T-010
       │
       └─> T-011 (SPEC-d2f4762a並行)
```

## フェーズ 1: 基盤（環境検出とモード切り替え）

### T-001: tmuxモジュール基盤作成

- **ファイル**: `crates/gwt-core/src/tmux/mod.rs`
- **内容**:
  - [x] tmuxサブモジュールのディレクトリ構造作成
  - [x] mod.rsでのモジュールエクスポート設定
  - [x] TmuxError列挙型の定義
- **依存**: なし
- **テスト**: T-TEST-001 ✅

### T-002: tmux環境検出

- **ファイル**: `crates/gwt-core/src/tmux/detector.rs`
- **内容**:
  - [x] TMUX環境変数の検出関数
  - [x] tmuxコマンドの存在確認
  - [x] tmuxバージョン取得（2.0以上チェック）
- **依存**: T-001
- **テスト**: T-TEST-002 ✅

### T-003: 実行モード列挙型

- **ファイル**: `crates/gwt-core/src/execution_mode.rs`
- **内容**:
  - [x] TmuxMode列挙型（Single/Multi）定義
  - [x] 環境からのモード自動判定関数
  - [x] CLI起動時のモード初期化
- **依存**: T-002
- **テスト**: T-TEST-003 ✅

---

## フェーズ 2: セッション管理

### T-004: セッション命名規則

- **ファイル**: `crates/gwt-core/src/tmux/naming.rs`
- **内容**:
  - [x] リポジトリ名からセッション名生成（gwt-{repo}）
  - [x] 既存セッション検出
  - [x] 番号付与ロジック（-2, -3...）
- **依存**: T-003
- **テスト**: T-TEST-004 ✅

### T-005: セッション管理API

- **ファイル**: `crates/gwt-core/src/tmux/session.rs`
- **内容**:
  - [x] TmuxSession構造体定義
  - [x] create_session()関数
  - [x] destroy_session()関数
  - [x] list_sessions()関数
- **依存**: T-004
- **テスト**: T-TEST-005 ✅

---

## フェーズ 3: ペイン起動

### T-006: ペイン管理API

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] AgentPane構造体定義
  - [x] create_pane()関数（split-window）
  - [x] list_panes()関数
  - [x] get_pane_info()関数
- **依存**: T-005
- **テスト**: T-TEST-006 ✅

### T-007: tmux用エージェント起動

- **ファイル**: `crates/gwt-core/src/tmux/launcher.rs`
- **内容**:
  - [x] launch_agent_in_pane()関数
  - [x] 作業ディレクトリ設定
  - [x] 環境変数の引き継ぎ
  - [x] フォーカス移動（select-pane）
- **依存**: T-006
- **テスト**: T-TEST-007 ✅

---

## フェーズ 4: TUI分割表示

### T-008: ペイン一覧コンポーネント

- **ファイル**: `crates/gwt-cli/src/tui/screens/pane_list.rs`
- **内容**:
  - [x] PaneListState構造体
  - [x] ペイン情報表示（ブランチ、エージェント、稼働時間）
  - [x] アクティブペインのハイライト
  - [x] 選択カーソル表示
- **依存**: T-006
- **テスト**: T-TEST-008 ✅

### T-009: 分割レイアウト

- **ファイル**: `crates/gwt-cli/src/tui/screens/split_layout.rs`
- **内容**:
  - [x] 上下分割レイアウト実装
  - [x] ブランチ一覧（上）とペイン一覧（下）の配置
  - [x] フォーカス状態の管理
- **依存**: T-008
- **テスト**: T-TEST-009 ✅

### T-010: ペイン状態ポーリング

- **ファイル**: `crates/gwt-core/src/tmux/poller.rs`
- **内容**:
  - [x] 1秒間隔のポーリングタスク
  - [x] ペイン状態の差分検出
  - [x] UI更新トリガー
- **依存**: T-006
- **テスト**: T-TEST-010 ✅

---

## フェーズ 5: キーバインドとフォーカス管理

### T-011: 既存キーバインド変更（SPEC-d2f4762a）

- **ファイル**: `crates/gwt-cli/src/tui/app.rs`
- **内容**:
  - [x] Tab → m への変更（表示モード切り替え）
  - [x] Tab キーの新規割り当て（フォーカス切り替え）
- **依存**: T-001（並行実装可能）
- **テスト**: T-TEST-011 ✅

### T-012: フォーカス切り替え実装

- **ファイル**: `crates/gwt-cli/src/tui/screens/split_layout.rs`
- **内容**:
  - [x] Tab: ブランチ一覧 ⇔ ペイン一覧切り替え
  - [x] Enter: 選択ペインへのフォーカス移動
  - [x] フォーカス状態の視覚的表示
- **依存**: T-009, T-011
- **テスト**: T-TEST-012 ✅

### T-013: Ctrl-gキーバインド設定

- **ファイル**: `crates/gwt-core/src/tmux/keybind.rs`
- **内容**:
  - [x] セッション作成時のCtrl-g設定
  - [x] gwtペイン（0番）への移動コマンド
- **依存**: T-005
- **テスト**: T-TEST-013 ✅

---

## フェーズ 6: ペイン終了管理

### T-014: 終了確認ダイアログ

- **ファイル**: `crates/gwt-cli/src/tui/screens/confirm.rs`
- **内容**:
  - [x] 単一ペイン終了確認UI
  - [x] gwt終了時の全エージェント確認UI
  - [x] OK/Cancelボタン処理
- **依存**: T-009
- **テスト**: T-TEST-014 ✅

### T-015: プロセス終了処理

- **ファイル**: `crates/gwt-core/src/tmux/pane.rs`
- **内容**:
  - [x] SIGTERM送信関数
  - [x] ペインkill処理
  - [x] 終了待機とタイムアウト
- **依存**: T-006
- **テスト**: T-TEST-015 ✅

### T-016: 自動クローズ検出

- **ファイル**: `crates/gwt-core/src/tmux/poller.rs`
- **内容**:
  - [x] エージェント終了検出
  - [x] ペイン自動クローズ処理
  - [x] UI更新通知
- **依存**: T-010, T-015
- **テスト**: T-TEST-016 ✅

---

## フェーズ 7: ログキャプチャとエラーハンドリング

### T-017: tmuxモード用ログキャプチャ

- **ファイル**: `crates/gwt-core/src/tmux/logging.rs`
- **内容**:
  - [x] pipe-pane によるstderrキャプチャ
  - [x] ログファイルへの保存
  - [x] 既存ログシステムとの統合
- **依存**: T-007
- **テスト**: T-TEST-017 ✅

### T-018: エラーハンドリング

- **ファイル**: `crates/gwt-core/src/tmux/error.rs`
- **内容**:
  - [x] TmuxError型定義
  - [x] エラーメッセージのUI表示
  - [x] リカバリー処理
- **依存**: T-001
- **テスト**: T-TEST-018 ✅

### T-019: 多重起動警告

- **ファイル**: `crates/gwt-cli/src/tui/screens/confirm.rs`
- **内容**:
  - [x] 同一WT+同一エージェント検出
  - [x] 警告ダイアログUI
  - [x] ユーザー確認後の起動許可
- **依存**: T-006, T-014
- **テスト**: T-TEST-019 ✅

---

## テストタスク

### T-TEST-001: tmuxモジュール基盤テスト ✅

- [x] TmuxError型のテスト
- [x] モジュール構造の確認

### T-TEST-002: 環境検出テスト ✅

- [x] TMUX環境変数あり/なしのテスト
- [x] tmuxコマンド存在確認テスト
- [x] バージョンチェックテスト

### T-TEST-003: 実行モードテスト ✅

- [x] Single/Multiモード判定テスト
- [x] 環境に基づく自動判定テスト

### T-TEST-004: セッション命名テスト ✅

- [x] リポジトリ名からのセッション名生成テスト
- [x] 番号付与ロジックテスト

### T-TEST-005: セッション管理APIテスト ✅

- [x] セッション作成/削除テスト
- [x] セッション一覧取得テスト

### T-TEST-006: ペイン管理APIテスト ✅

- [x] ペイン作成テスト
- [x] ペイン一覧取得テスト

### T-TEST-007: エージェント起動テスト ✅

- [x] ペイン内エージェント起動テスト
- [x] 作業ディレクトリ設定テスト

### T-TEST-008: ペイン一覧UIテスト ✅

- [x] 表示内容のテスト
- [x] ハイライト表示テスト

### T-TEST-009: 分割レイアウトテスト ✅

- [x] レイアウト配置テスト
- [x] フォーカス状態テスト

### T-TEST-010: ポーリングテスト ✅

- [x] 状態更新テスト
- [x] 差分検出テスト

### T-TEST-011: キーバインド変更テスト ✅

- [x] m キーでモード切り替えテスト
- [x] Tab キーでフォーカス切り替えテスト

### T-TEST-012: フォーカス切り替えテスト ✅

- [x] ブランチ一覧⇔ペイン一覧切り替えテスト
- [x] ペイン選択フォーカス移動テスト

### T-TEST-013: Ctrl-gキーバインドテスト ✅

- [x] gwtペイン復帰テスト

### T-TEST-014: 終了確認ダイアログテスト ✅

- [x] 単一ペイン終了確認テスト
- [x] gwt終了時確認テスト

### T-TEST-015: プロセス終了テスト ✅

- [x] SIGTERM送信テスト
- [x] タイムアウトテスト

### T-TEST-016: 自動クローズテスト ✅

- [x] エージェント終了検出テスト
- [x] ペイン自動クローズテスト

### T-TEST-017: ログキャプチャテスト ✅

- [x] stderrキャプチャテスト
- [x] ログファイル保存テスト

### T-TEST-018: エラーハンドリングテスト ✅

- [x] エラー表示テスト
- [x] リカバリーテスト

### T-TEST-019: 多重起動警告テスト ✅

- [x] 検出テスト
- [x] 警告表示テスト
