# 実装計画: divergence検知後のEnter待ち修正

**仕様ID**: `SPEC-40c7b4f1` | **日付**: 2025-12-09 | **仕様書**: [spec.md](./spec.md)

## 方針
- 入力待ち処理をターミナル抽象に寄せるリファクタリングでシンプルに解消。
- 回帰テストを先に書き、TTY/非TTYケースをカバー。

## ステップ
1. **TDD**: `waitForEnter` の振る舞いテストを追加（TTYで改行を流すと解決する、非TTYは即時解決する）。
2. **実装**: `waitForEnter` を共通モジュールに切り出し、`getTerminalStreams` の stdin/stdout を使うよう修正。EOF/SIGINTクリーンアップを追加。
3. **検証**: `bun run test`（必要なら対象テストフィルタ）を実行し、差分を確認。

## リスクと緩和
- **リスク**: readline によるストリーム状態破壊 → クリーンアップと raw モード解除で緩和。
- **リスク**: ESM モジュール境界でのモック失敗 → import をモック可能な分離モジュールにする。
