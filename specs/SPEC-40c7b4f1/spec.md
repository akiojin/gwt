# 機能仕様: ブランチ選択時のdivergence/FF失敗ハンドリング（起動継続）

**仕様ID**: `SPEC-40c7b4f1`
**作成日**: 2025-12-09
**更新日**: 2026-01-05
**ステータス**: ドラフト
**入力**: ユーザー説明: "FFできないからLLMを起動させないのは厳しい。divergenceでも起動は止めないでほしい。"

## 背景 / 問題

- fast-forward pull が失敗したり、ローカル/リモートが両方進んだブランチであっても、作業継続のためには起動を止めずに警告で済ませたい。
- 現行は divergence を検知すると起動がキャンセルされ、作業が中断される。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - divergenceでも起動できる (優先度: P1)

開発者は、ローカルとリモートが両方進んでいるブランチでも、警告を確認した上でそのままAIツールを起動できる。

**この優先度の理由**: 起動ブロックは作業停止に直結し、解消作業は起動後に進めることが多いため、最小限の中断で継続できることが重要。

**独立したテスト**: divergence（ahead/behind が両方 > 0）のブランチでCLI起動/ Web UI起動を実行し、警告表示があるが起動が継続することを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** ローカル・リモート双方に未解決の差分がある、**操作** CLIで該当ブランチを選択して起動、**期待結果** 警告が表示されるが起動は継続される
2. **前提条件** ローカル・リモート双方に未解決の差分がある、**操作** Web UIから起動、**期待結果** 警告は表示されるが「起動」操作はブロックされない

---

### ユーザーストーリー 2 - divergence検知失敗でも起動できる (優先度: P2)

開発者は、divergence判定がエラーになっても、起動が止まらずに作業を続行できる。

**この優先度の理由**: 一時的なgitエラーで起動が止まると復旧まで作業が中断されるため、警告のみで継続できる価値が高い。

**独立したテスト**: divergence検知処理が失敗するケースをモックし、警告が出るが起動処理が継続されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** divergence検知が失敗する、**操作** CLIで起動、**期待結果** 警告のみで起動は継続される

---

### エッジケース

- 非TTY環境でも警告表示は行いつつ起動継続する
- divergence判定対象ブランチが1つのみの場合でも、警告のみで起動は継続される

## 要件 *(必須)*

### 機能要件

- **FR-001**: CLIは fast-forward pull 失敗時に警告を表示し、起動を継続**しなければならない**
- **FR-002**: CLIは divergence が「local ahead > 0 かつ remote ahead > 0」の場合でも、警告表示後に起動を継続**しなければならない**
- **FR-003**: Web UIは divergence が「ahead > 0 かつ behind > 0」の場合でも起動操作をブロック**してはならない**
- **FR-004**: divergence検知処理が失敗した場合、警告を出した上で起動を継続**しなければならない**
- **FR-005**: CLIのユーザー向け出力は英語で表示**しなければならない**
- **FR-006**: divergenceの警告表示は維持し、警告文言は必要最小限の修正に留める**こと**
- **FR-007**: 自動テストを追加/更新し、divergenceでも起動がブロックされないことを検証**しなければならない**

### 主要エンティティ

- **BranchDivergence**: ahead/behind/upToDate を持つ divergence 情報

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: divergenceがあるブランチでもCLI起動がキャンセルされないことをテストで確認できる
- **SC-002**: Web UIで divergence 警告が表示されても「起動」ボタンが無効化されない
- **SC-003**: divergence検知失敗時でも起動が続行されることをテストで確認できる

## 制約と仮定 *(該当する場合)*

### 制約

- CLIの警告文は英語のまま維持する（日本語にしない）
- divergence判定ロジック自体は変更しない

### 仮定

- divergence判定の取得方法は現状のgitコマンド/ロジックを継続利用する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- divergence判定ロジックの変更や高速化
- rebase/merge の自動実行
- behind のみ（remote aheadのみ）の場合に対するブロック条件の変更
- git fetch 失敗時の挙動変更

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 追加のセキュリティ影響は想定しない

## 依存関係 *(該当する場合)*

- なし

## 参考資料 *(該当する場合)*

- [SPEC-d2f4762a: ブランチ選択画面](../SPEC-d2f4762a/spec.md)
