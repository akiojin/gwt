# 機能仕様: divergence検知後にUIへ確実に戻す

**仕様ID**: `SPEC-40c7b4f1`
**作成日**: 2025-12-09
**ステータス**: ドラフト
**入力**: ユーザー報告「divergence検知時にEnter待ち表示のままCLIが終了する」

## 背景 / 問題
- リモートとローカルが両方進んでいるブランチを選択すると、`Press Enter to return to the main menu...` が表示される。
- 本来はEnter入力後にブランチ一覧へ戻るべきだが、そのままプロセスが終了するケースがある。
- `waitForEnter` が Ink UI で使用している TTY とは異なる `process.stdin` を直接参照し、EOF を即時に受け取ってしまうため入力待ちが機能していないと推測。

## ユーザーストーリー（P1）
1. **前提**: 追跡ブランチにリモート・ローカル双方の進みがある。**操作**: gwt でそのブランチを選択。**期待結果**: Divergence 警告表示後、Enter を押すとブランチ一覧に戻り CLI は継続する。

## 受け入れ条件
- **AC-001**: divergence 警告後の Enter 入力で必ずブランチ一覧に戻り、プロセスが終了しない。
- **AC-002**: 非 TTY 環境では即時に処理をスキップするが、後続フローは継続する（落ちない）。
- **AC-003**: 回帰テストが追加され、`waitForEnter` が Ink と同じターミナルストリームを用い、EOF 時も安全に復帰することを確認できる。

## 機能要件
- **FR-001**: `waitForEnter` は `getTerminalStreams()` で取得した stdin/stdout を使用し、raw モード解除とクリーンアップを行うこと。
- **FR-002**: stdin が TTY でない場合は警告/終了をせず即時 resolve し、後続フローを継続させること。
- **FR-003**: EOF（stdin end/error）でもクリーンアップした上で resolve し、プロセス終了を引き起こさないこと。
- **FR-004**: 受け入れ条件を検証するテストを追加すること（Vitest）。

## 非機能要件 / 制約
- 既存の Ink UI 動作（raw mode管理）に影響を与えないこと。
- 追加ログは最小限とし、既存の UX を変えない。

## 範囲外
- divergence 検知ロジックの変更。
- UI 文言の変更。

