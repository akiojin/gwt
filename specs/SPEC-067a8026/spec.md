# 機能仕様: LLMベースリリースワークフロー

**仕様ID**: `SPEC-067a8026`
**作成日**: 2026-01-21
**更新日**: 2026-01-21
**ステータス**: ドラフト
**入力**: ユーザー説明: "/releaseコマンドをLLMベースに変更し、ローカルdevelop上でバージョン更新を行い、mainへのPRを作成する"

## 概要

現在GitHub Actions（`prepare-release.yml`）で実行しているリリース準備処理をLLM（Claude Codeエージェント）がローカルで実行するように変更する。LLMがdevelopブランチ上でバージョン判定、ファイル更新、CHANGELOG生成、コミット、プッシュ、PR作成までを担当し、mainへのマージ承認は人間が行う。リリース後のタグ作成・バイナリビルド・npm公開は既存の`release.yml`で継続する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 正常なリリースフロー (優先度: P0)

開発者が`/release`コマンドを実行すると、LLMがdevelopブランチ上でgit-cliffを使用してバージョンを判定し、必要なファイルを更新、リリースコミットを作成してプッシュし、mainへのPRを作成する。

**この優先度の理由**: リリースワークフローの中核機能であり、これが動作しなければ他の機能も意味をなさない。

**独立したテスト**: developブランチで`/release`を実行し、PRが作成されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** developブランチにチェックアウトしている、feat/fixコミットがある、**操作** `/release`を実行、**期待結果** git-cliffで次バージョンが判定される
2. **前提条件** バージョンが判定された、**操作** 処理を継続、**期待結果** Cargo.toml（ルート+crates/配下）、package.json、CHANGELOG.mdが更新される
3. **前提条件** ファイルが更新された、**操作** 処理を継続、**期待結果** `chore(release): vX.Y.Z`形式でコミットが作成され、developにプッシュされる
4. **前提条件** コミットがプッシュされた、**操作** 処理を継続、**期待結果** develop→mainのPRが`release`ラベル付きで作成される

---

### ユーザーストーリー 2 - ブランチ制約の検証 (優先度: P0)

開発者がdevelop以外のブランチで`/release`を実行した場合、エラーメッセージが表示され処理が中断される。

**この優先度の理由**: 誤ったブランチでのリリース実行は深刻な問題を引き起こすため、必須のガードレール。

**独立したテスト**: featureブランチで`/release`を実行し、エラーで中断されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** feature/xxxブランチにチェックアウトしている、**操作** `/release`を実行、**期待結果** 「developブランチでのみ実行可能です」というエラーメッセージが表示され中断
2. **前提条件** mainブランチにチェックアウトしている、**操作** `/release`を実行、**期待結果** 同様にエラーで中断

---

### ユーザーストーリー 3 - main同期の事前チェック (優先度: P1)

リリース処理前に、mainとdevelopの間に差異（mainにホットフィックスがあるなど）がないかチェックし、差異がある場合は警告を表示して中断する。

**この優先度の理由**: コンフリクトリスクを事前に検出し、PRマージ時の問題を防止するため。

**独立したテスト**: mainにdevelopにない変更がある状態で`/release`を実行し、警告が表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** mainにdevelopにマージされていないコミットがある、**操作** `/release`を実行、**期待結果** 「mainとdevelopに差異があります。先にmainをdevelopにマージしてください」と警告して中断
2. **前提条件** mainがdevelopに完全にマージ済み、**操作** `/release`を実行、**期待結果** 通常のリリース処理が続行される

---

### ユーザーストーリー 4 - 冪等性（既存リリースコミット検出） (優先度: P1)

既にリリースコミット（`chore(release):`形式）が存在する場合、重複リリースを防ぐためエラーで中断する。

**この優先度の理由**: `/release`の誤った複数回実行による混乱を防止するため。

**独立したテスト**: リリースコミット後に再度`/release`を実行し、エラーで中断されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** developのHEADが`chore(release): v1.2.3`コミット、**操作** `/release`を実行、**期待結果** 「既にリリースコミットが存在します」とエラーで中断
2. **前提条件** リリースコミット後に追加のfeat/fixコミットがある、**操作** `/release`を実行、**期待結果** 新しいリリースとして通常処理が続行される

---

### ユーザーストーリー 5 - 既存Release PR更新 (優先度: P1)

既にdevelop→mainのRelease PRが存在する場合、新しいPRを作成せずに既存PRを更新（developへのpushにより自動更新）する。

**この優先度の理由**: 重複PRを避け、クリーンなPR履歴を維持するため。

**独立したテスト**: 既存PRがある状態で`/release`を実行し、PRが更新されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** develop→mainのPRが既に存在、**操作** `/release`を実行、**期待結果** 新しいコミットがdevelopにプッシュされ、既存PRの内容が自動更新される
2. **前提条件** PRが存在しない、**操作** `/release`を実行、**期待結果** 新しいPRが作成される

---

### ユーザーストーリー 6 - chore/docsのみでのパッチリリース (優先度: P2)

feat/fixコミットがなくchore/docsのみの場合でも、パッチバージョンとしてリリースできる。

**この優先度の理由**: ドキュメント修正やビルド設定変更もリリースに含めたい場合がある。

**独立したテスト**: chore/docsコミットのみの状態で`/release`を実行し、パッチリリースされることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 前回タグ以降chore/docsコミットのみ、**操作** `/release`を実行、**期待結果** パッチバージョン（v1.2.3→v1.2.4）として処理が続行される
2. **前提条件** コミットが全くない、**操作** `/release`を実行、**期待結果** 「リリース対象のコミットがありません」とエラーで中断

---

### ユーザーストーリー 7 - push失敗時のリトライ (優先度: P2)

コミット後のpushが失敗した場合（ネットワークエラー等）、自動的にリトライする。

**この優先度の理由**: 一時的なネットワーク障害でリリースプロセス全体をやり直す必要がないようにするため。

**独立したテスト**: push時にエラーをシミュレートし、リトライが行われることで検証できる。

**受け入れシナリオ**:

1. **前提条件** コミットが作成された、**操作** pushが一時的に失敗、**期待結果** 最大3回までリトライが行われる
2. **前提条件** 3回リトライしても失敗、**操作** -、**期待結果** エラーメッセージと手動対応手順を表示して中断

---

## 技術仕様

### 前提条件

- **実行環境**: developブランチにチェックアウトしていること
- **必要ツール**: git-cliff（`cargo install git-cliff`で導入）、gh CLI（GitHub CLI）
- **設定ファイル**: cliff.toml（新規作成が必要）

### 処理フロー

```
1. ブランチ確認（develop以外ならエラー）
2. main同期チェック（git fetch && git merge-base --is-ancestor origin/main develop）
3. 既存リリースコミット確認（HEADがchore(release):で始まるか）
4. バージョン判定（git-cliff --bumped-version）
5. ファイル更新:
   - Cargo.toml（ルート + crates/配下すべて）
   - package.json（ルート）
   - Cargo.lock（cargo update -w）
   - CHANGELOG.md（git-cliff --unreleased --prepend）
6. リリースコミット作成（chore(release): vX.Y.Z）
7. developにpush（失敗時は最大3回リトライ）
8. PR作成または既存PR確認（gh pr create --base main --head develop --label release）
```

### バージョン判定ルール

git-cliffの`--bumped-version`オプションを使用:
- `feat:` → minor バージョンアップ
- `fix:` → patch バージョンアップ
- `type!:` または `BREAKING CHANGE:` → major バージョンアップ
- `chore:`/`docs:`のみ → patch バージョンアップ（デフォルト動作としてcliff.tomlで設定）

### 更新対象ファイル

| ファイル | 更新内容 |
|---------|---------|
| `Cargo.toml`（ルート） | `version = "X.Y.Z"` |
| `crates/*/Cargo.toml` | 各クレートの`version = "X.Y.Z"` |
| `package.json` | `"version": "X.Y.Z"` |
| `Cargo.lock` | `cargo update -w`で自動更新 |
| `CHANGELOG.md` | git-cliffで今回リリース分を先頭に追加 |

### コミット形式

```
chore(release): v1.2.3
```

この形式は既存の`release.yml`のトリガー条件（`startsWith(github.event.head_commit.message, 'chore(release):')`）と互換性を維持する。

### エラーハンドリング

| エラー条件 | メッセージ（日本語） | 対応 |
|-----------|-------------------|------|
| develop以外のブランチ | 「developブランチでのみ実行可能です」 | 中断 |
| mainとdevelopに差異 | 「mainとdevelopに差異があります」 | 中断 |
| 既存リリースコミット | 「既にリリースコミットが存在します」 | 中断 |
| リリース対象コミットなし | 「リリース対象のコミットがありません」 | 中断 |
| push失敗（リトライ超過） | 「pushに失敗しました。手動で対応してください」 | 中断 |

### 廃止対象

- `.github/workflows/prepare-release.yml` - 削除
- `.claude/commands/release.md` - 新しい内容に置き換え

### 新規作成

- `cliff.toml` - git-cliff設定ファイル
- Dockerfile更新（git-cliffインストール追加）

## 非機能要件

- **メッセージ言語**: スキル実行中のログ・エラーメッセージは日本語
- **PR body**: LLMがコミット履歴・変更内容を見て適切に生成
- **コミット範囲**: 前回リリースタグからの差分を対象

## 依存関係

- git-cliff: バージョン判定・CHANGELOG生成
- gh CLI: PR作成・操作
- 既存の`release.yml`: mainマージ後のタグ作成・ビルド・公開

## 参考: 既存ワークフローとの差分

| 項目 | 現在（GitHub Actions） | 新規（LLM） |
|------|----------------------|-------------|
| 実行トリガー | `gh workflow run` | `/release`コマンド |
| 実行環境 | GitHub Actions Runner | ローカル（Claude Code） |
| バージョン判定 | create-release-pr Action | git-cliff |
| 中間ブランチ | release/YYYYMMDD-HHMMSS | なし（develop直接） |
| main同期 | Sync PR作成 | エラーで中断 |
| PR作成 | 自動 | LLMが実行 |
| マージ承認 | 人間 | 人間（変更なし） |
