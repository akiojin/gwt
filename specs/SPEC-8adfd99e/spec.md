# 機能仕様: Web UI 環境変数編集機能

**仕様ID**: `SPEC-8adfd99e`
**作成日**: 2025-11-11
**ステータス**: ドラフト
**入力**: ユーザー説明: "環境変数をブラウザ上からも設定できるようにしたい"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - カスタムツールごとの環境変数を可視化 (優先度: P1)

開発者は Web UI の設定ページから、CLI で定義済みのカスタムAIツール一覧を開き、各ツールに紐づく環境変数のキーと説明を安全に確認できる。

**この優先度の理由**: 現状は `~/.claude-worktree/tools.json` を直接開かない限り、どのツールにどの環境変数が設定済みか把握できないため、ブラウザ上での可視化が第一歩となる。

**独立したテスト**: `gwt serve` を起動 → `/config` を開く → 任意ツールを選択し、サーバー上の `tools.json` に登録済みの環境変数が一覧表示されることを確認することで完全に検証できる。

**受け入れシナリオ**:

1. **前提条件** `tools.json` に `env` を含むツールが存在、**操作** `/config` ページでツールカードを開く、**期待結果** 登録済みキーがテーブル表示され、値はマスクされたトークンとして示される
2. **前提条件** `tools.json` に `env` を持たないツール、**操作** 同ページでカードを開く、**期待結果** 「環境変数が未設定です」という空状態表示と「変数を追加」ボタンが出る

---

### ユーザーストーリー 2 - キー/値の追加・編集 (優先度: P1)

開発者はブラウザから新しい環境変数を追加したり、既存値を編集して保存できる。保存後は即座に `tools.json` に反映され、次回の AI ツール起動で使用される。

**この優先度の理由**: 「ブラウザから設定したい」という要望の核であり、CLI で JSON を編集しなくても安全に値を登録できることが本機能の価値そのもの。

**独立したテスト**: `/config` → 任意ツール → 「変数を追加」でキー/値を入力 → 保存 → 再読込後に同じ値が表示され、BranchDetail 画面でもカスタムツールが利用できることを確認すれば機能を単独で検証できる。

**受け入れシナリオ**:

1. **前提条件** `/config`ページ表示中、**操作** 「変数を追加」を押し `API_TOKEN` / `sk-xxxx` を入力 → 「保存」、**期待結果** 成功トーストと共にテーブルへ反映・`tools.json` が更新される
2. **前提条件** 既存キー `OPENAI_API_KEY` を編集、**操作** 値を上書き → 「保存」、**期待結果** 新しい値が保存され、次回ツール起動時に `process.env` へ反映される
3. **前提条件** 空文字のキーまたは100文字超の値を入力、**操作** 保存、**期待結果** バリデーションエラーで保存されない

---

### ユーザーストーリー 3 - 機密値の閲覧制御と削除 (優先度: P2)

管理者は誤入力の修正や漏洩防止のため、単一キーを即座に削除でき、必要時のみワンクリックで値を一時表示（3秒タイムアウト）できる。

**この優先度の理由**: APIキー等の秘匿情報を扱うため、閲覧制御と削除フローが欠かせない。P2とするのは可視化・編集が先行価値であり、その後に安全策を追加するため。

**独立したテスト**: 既存キーの「👁 表示」ボタンを押して値が3秒で再マスクされること、および「削除」ボタンで個別行が即座に消え保存後ファイルからも消えることを確認すれば単独検証できる。

**受け入れシナリオ**:

1. **前提条件** 環境変数行が存在、**操作** 「表示」アイコンをクリック、**期待結果** 値が一時表示され3秒後に自動で再マスクされる
2. **前提条件** 削除したいキーが存在、**操作** 「削除」→確認ダイアログで確定、**期待結果** テーブルから即時消え保存後に `tools.json` からも除去される

---

### ユーザーストーリー 4 - CLI との一貫性検証 (優先度: P3)

開発者はブラウザで保存した環境変数が CLI (`gwt` や Codex/Claude 起動) からもそのまま利用されることを確認できる。

**この優先度の理由**: Web UI で設定した値が別チャネルで無効なら意味がない。後方互換検証は重要だが、追加実装は比較的軽いため P3。

**独立したテスト**: `/config` で `MY_TOOL` に `TOKEN=123` を保存 → CLI から同ツールを起動し `process.env.TOKEN` を出力 → 値が一致することを確認すれば成立。

**受け入れシナリオ**:

1. **前提条件** Web UI で保存済みの env が存在、**操作** CLI から対象ツールを `gwt` 経由で起動、**期待結果** ツールプロセス内で同じ env が利用可能

---

### エッジケース

- `~/.claude-worktree/tools.json` が存在しない / 破損している場合は、空状態 UI とエラーバナーを出し、復旧手順リンクを表示する
- 同じキーを重複入力した場合は即時バリデーションで阻止する
- 100個以上の環境変数を登録しようとした場合は警告し、最大数（デフォルト50個）を超えたら保存不可
- サーバーがファイルを書き込めない（権限不足、読み取り専用）場合は詳細メッセージを返却し保存フローをロールバックする
- 別プロセスが `tools.json` を同時更新した場合は ETag/updatedAt を比較し、競合ダイアログで「最新を再読み込み」か「上書き保存」を選ばせる

## 要件 *(必須)*

### 機能要件

- **FR-001**: Web ルーターに `/config` ページを追加し、ブランチ詳細からのリンクで遷移できるようにしなければならない
- **FR-002**: `GET /api/config` は `~/.claude-worktree/tools.json` の `customTools` セクションを読み込み、各 `env` を配列（key/value/lastUpdated）として返却しなければならない
- **FR-003**: UI はツールごとに環境変数テーブルを表示し、キー/値の行追加・削除・並び替えをサポートしなければならない
- **FR-004**: キーは `^[A-Z0-9_]{1,100}$`、値は 1〜500 文字までというバリデーションを即時に行い、違反時は保存ボタンを無効化しなければならない
- **FR-005**: 値はデフォルトでマスク表示し、「表示」アクション実行時のみ一定時間（最大10秒）平文を表示する仕組みを提供しなければならない
- **FR-006**: `PUT /api/config` は受け取ったツール配列をバリデーション後 `tools.json` に保存し、保存成功時には更新後データと `updatedAt` タイムスタンプを返さなければならない
- **FR-007**: 保存成功後、BranchDetail のツール選択やセッション起動で最新 env が即座に反映されるよう、React Query の `config` キャッシュを更新し `useConfig` の結果を再利用しなければならない
- **FR-008**: 保存失敗時には HTTP ステータスとともに UI で詳細メッセージを表示し、部分的な書き込みは行わずに旧データへロールバックしなければならない

### 主要エンティティ *(機能がデータを含む場合は含める)*

- **EnvironmentVariableDraft**: `{ id: string; key: string; value: string; masked: boolean; isDirty: boolean; lastUpdated: string; }`。UI 上で編集中の行を表し、API 送信時に `key`/`value` のみを使用
- **ConfigPayload**: `{ tools: CustomAITool[]; version: string; updatedAt: string; }`。`tools.json` への保存・取得で利用する永続化フォーマット

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーインタビューで、ブラウザから新しい環境変数を追加して保存する操作を 2 分以内に 90% 以上の参加者が完了できる
- **SC-002**: `/config` から保存された env が CLI で起動したツールに反映される検証ケースで 100% 一致する
- **SC-003**: 無効なキー/値を保存しようとした際、バリデーションで 100% 防止できる（手動テスト10件）
- **SC-004**: 値をマスクする UI により、ブラウザの DevTools ネットワークログに直接表示される平文シークレットを 0 件に抑える（PUT/GET 以外には出さない）

## 制約と仮定 *(該当する場合)*

### 制約

- `gwt serve` を実行している OS ユーザーが `~/.claude-worktree/tools.json` へ読み書きできる必要がある
- Web UI と CLI は同一マシン上の同一ファイルを共有するため、ファイルロックや同時編集の検知を実装する必要がある
- `env` 値は暗号化せずプレーンテキストで保存されるため、転送はローカルホスト HTTP のみに限定される（HTTPS やリモート公開は前提にしない）

### 仮定

- ユーザーは serve コマンドをローカルで実行し、ブラウザも同じマシン上でアクセスする
- カスタムツールの env 以外（defaultArgs, modeArgs 等）は既存 UI/CLI で設定済みであり、本機能では変更しない
- Env の変更頻度は低く、同時に複数ブラウザで編集するケースは例外的である

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- クラウドやリモートサーバー経由での環境変数同期・暗号化保管
- `.env` ファイルやシステム環境変数全体の編集機能
- ビルトインツール（Claude Code / Codex CLI）の既定環境変数の上書き設定
- 監査ログや変更履歴の自動記録

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 保存時は値をプレーンテキストで `tools.json` に書き込むため、ファイルパーミッション（600 推奨）と OS ユーザー隔離を必須とする
- UI ではマスク済み表示をデフォルトとし、コピー操作はユーザー明示の操作に限定する
- ネットワーク通信での CSRF を避けるため、既存の Fastify セッションチェック or CSRF トークンを PUT リクエストに付与する
- ログ出力時（サーバー側）に env 値を含まないよう構造化ログで `***masked***` に置き換える

## 依存関係 *(該当する場合)*

- 既存の Web サーバー (`gwt serve`) と React Router
- `configApi` (`GET /api/config`, `PUT /api/config`) および `src/config/tools.ts`
- `launchCustomAITool` が参照する `CustomAITool.env` ロジック（env 連携確認が必要）
- Spec: `SPEC-d5e56259` (Web UI) / `SPEC-30f6d724` (Custom AI Tool 定義)

## 参考資料 *(該当する場合)*

- [SPEC-d5e56259/spec.md](../SPEC-d5e56259/spec.md) - Web UI 全体仕様
- [SPEC-30f6d724/spec.md](../SPEC-30f6d724/spec.md) - カスタムAIツール仕様（env フィールドを含む）
- [src/config/tools.ts](../../src/config/tools.ts) - `tools.json` ロードと検証ロジック
