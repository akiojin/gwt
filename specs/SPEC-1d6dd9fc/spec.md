# 機能仕様: マルチターミナル（gwt内蔵ターミナルエミュレータ）

**仕様ID**: `SPEC-1d6dd9fc`
**作成日**: 2026-02-08
**ステータス**: ドラフト
**入力**: ユーザー説明: "tmuxやzellijのようなターミナル分割機能をgwt内部に実装。VT100互換ターミナルエミュレータを埋め込み、外部ツール不要でエージェント実行・監視・操作を完結させる。gwt特化型ペイン設計で、汎用マルチプレクサではなくエージェントオーケストレーションに最適化。"

## 設計概要

### アーキテクチャ

gwt内にVT100互換ターミナルエミュレータを埋め込み、各ペインで独立したPTYセッションを管理する。tmux/zellijへの外部依存を排除し、gwt単体でエージェントの実行・監視・操作を完結させる。

### レイアウトモデル

```text
+---------------------------+---------------------------+
|                           |                           |
|   gwt UI（左側）           |   エージェントペイン（右側）  |
|   ブランチリスト            |   エージェント出力          |
|   エージェントモード         |   [Tab1|Tab2|Tab3]        |
|   GitView等               |                           |
|   （既存画面そのまま）       |   ステータスバー           |
|                           |   branch [agent] Running  |
+---------------------------+---------------------------+
           50%                          50%
```

- **左側**: 既存gwt UI（変更なし）。マスターエージェントモード（Tab切替）も左側UIで動作
- **右側**: エージェントペイン（FR-047）。エージェント起動時に出現、全終了時に消えて全画面復帰
- **タブ管理**: 複数エージェントはタブ切り替え（一度に1つ表示）
- **フルスクリーン**: Ctrl+G → z で右側ペインを全画面トグル

### フォーカスと入力ルーティング

- **プレフィックスキー**: Ctrl+G（既存tmux統合と統一）
- **ペイン切替**: マウスクリック or Ctrl+Gでgwt UIに復帰
- **透過入力**: 右側ペインにフォーカス中、Ctrl+G以外の全入力をPTYに直送
- **Ctrl+G×2**: Ctrl+Gリテラルをアクティブペインに送信

### スクロールバック（全ファイル方式）

- 全出力を即座に`~/.gwt/terminals/{pane-id}.log`に書き込み
- メモリには表示領域分のみ保持
- Ctrl+G → [ でスクロールバックモード（ファイルから読み込み）

### ペイン間通信（IPC）

- Unixドメインソケット（`~/.gwt/gwt.sock`）でgwtデーモンと通信
- send-keys: 他ペインにキー入力送信
- pipe-pane: 他ペインの出力を標準入力に転送
- 共有チャネル: 名前付きチャネルでデータ交換
- 内部Rust APIとして提供（CLIコマンドは提供しない）

### 環境変数（拡張セット）

PTYでエージェント起動時に設定:

| 変数名 | 用途 |
| ------ | ---- |
| TERM | `xterm-256color` |
| GWT_PANE_ID | ペイン識別子 |
| GWT_BRANCH | ブランチ名 |
| GWT_AGENT | エージェント名 |
| GWT_SOCKET_PATH | IPC用Unixソケットパス |
| GWT_SESSION_ID | セッション識別子 |
| GWT_WORKTREE_PATH | worktreeディレクトリパス |
| GWT_LOG_FILE | スクロールバック用ログファイルパス |

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ブランチリストからエージェントを起動すると右側にターミナルペインが出現する (優先度: P1)

開発者がブランチリストでエージェントを起動すると、画面が左右50:50に分割され、右側にエージェントのターミナル出力がリアルタイムで表示される。エージェントはPTY上でworktreeディレクトリを作業ディレクトリとして直接実行される。

**この優先度の理由**: マルチターミナル機能の最も基本的なユースケース。これが動作しなければ他の機能は意味を持たない。

**独立したテスト**: ブランチを選択してエージェントを起動し、右側にターミナルペインが表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチリストが全画面表示されている、**操作** ブランチを選択してエージェントを起動、**期待結果** 画面が左右50:50に分割され、左にブランチリスト、右にターミナルペインが表示される
2. **前提条件** ターミナルペインが表示されている、**操作** エージェントが出力を生成、**期待結果** 右側ペインにリアルタイムで出力がストリーム表示される
3. **前提条件** ターミナルペインが表示されている、**操作** エージェントがANSIカラー付きで出力、**期待結果** カラーが正しく解釈・表示される
4. **前提条件** ターミナルペインが表示されている、**操作** ペインのステータスバーを確認、**期待結果** ブランチ名、エージェント名（カラー付き）、ステータス（Running）、経過時間が表示される
5. **前提条件** PTYのworking directoryを確認、**操作** ペイン内でpwdを実行、**期待結果** 対象ブランチのworktreeパスが表示される
6. **前提条件** エージェント起動、**操作** 環境変数を確認、**期待結果** GWT_PANE_ID, GWT_BRANCH, GWT_AGENT, GWT_SOCKET_PATH, GWT_SESSION_ID, GWT_WORKTREE_PATH, GWT_LOG_FILEが設定されている

---

### ユーザーストーリー 2 - ターミナルペインへのキー入力 (優先度: P1)

開発者がターミナルペインにフォーカスを移し、エージェント（Claude Code等）にプロンプトを入力したり、シェルコマンドを実行したりできる。

**この優先度の理由**: エージェントとの対話型操作はコア機能。監視だけでなく操作もできなければtmuxの完全な置き換えにならない。

**独立したテスト**: ターミナルペインにフォーカスを切り替え、キー入力がPTYに送信されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 左側gwt UIにフォーカスがある、**操作** マウスクリックで右側ペインをクリック、**期待結果** フォーカスが右側ペインに移り、フォーカスインジケータが表示される
2. **前提条件** 右側ペインにフォーカスがある、**操作** キー入力を行う、**期待結果** 入力がPTYに送信され、エージェントが受け取る
3. **前提条件** 右側ペインにフォーカスがある、**操作** Ctrl+Gを押す、**期待結果** gwt UIにフォーカスが戻る（Prefixキー動作）
4. **前提条件** 右側ペインにフォーカスがある、**操作** Ctrl+G → Ctrl+G を押す、**期待結果** Ctrl+Gリテラルがペインに送信される
5. **前提条件** 右側ペインでvim等のフルスクリーンTUIアプリが起動、**操作** カーソルキーやEscキーを入力、**期待結果** VT100エミュレーションにより正常にアプリが動作する

---

### ユーザーストーリー 3 - 複数エージェントのタブ切り替え (優先度: P1)

開発者が複数のブランチでエージェントを起動した場合、右側ペインをタブ切り替えして各エージェントの出力を確認できる。

**この優先度の理由**: 並行開発の監視は主要ユースケースの一つ。複数エージェントの同時管理が必要。

**独立したテスト**: 複数エージェントを起動し、タブ切り替えで各出力を表示できることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 2つのブランチでエージェントを起動済み、**操作** Ctrl+G → n で次タブに切り替え、**期待結果** 右側ペインが別のエージェントの出力に切り替わる
2. **前提条件** 2つ以上のタブが存在、**操作** Ctrl+G → p で前タブに切り替え、**期待結果** 前のタブに戻る
3. **前提条件** 3つのエージェントが実行中、**操作** ステータスバーを確認、**期待結果** 全エージェントのタブ一覧が表示され、アクティブなタブがハイライトされる
4. **前提条件** タブ切り替え後、**操作** 前のタブに戻る、**期待結果** スクロール位置や入力状態が保持されている
5. **前提条件** 1つのエージェントが完了（プロセス終了）、**操作** 自動動作を確認、**期待結果** 該当ペインが自動クローズし、残りのエージェントのタブが表示される
6. **前提条件** 非アクティブタブのエージェントが完了、**操作** ステータスバーを確認、**期待結果** タブのステータスが変更される（完了表示）

---

### ユーザーストーリー 4 - フルスクリーントグル (優先度: P1)

開発者が右側ターミナルペインを全画面に拡大し、作業スペースを最大化できる。再度トグルで元の50:50分割に戻る。

**この優先度の理由**: エージェント出力を広く見たいケースは頻出。実装コストが低い割にユーザー体験を大幅に向上させる。

**独立したテスト**: Ctrl+G → z でフルスクリーンに切り替わり、再度押すと戻ることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 左右分割表示中、**操作** Ctrl+G → z を押す、**期待結果** 右側ペインが全画面に拡大し、左側gwt UIが非表示になる
2. **前提条件** フルスクリーン中、**操作** Ctrl+G → z を再度押す、**期待結果** 50:50分割に復帰する
3. **前提条件** フルスクリーン中、**操作** VT100エミュレータのサイズを確認、**期待結果** フルスクリーンの幅・高さに更新され、PTYにWINSIZEが送信される

---

### ユーザーストーリー 5 - スクロールバック（ファイルベース） (優先度: P2)

開発者がエージェントの過去の出力を確認するために、スクロールバックで遡ることができる。出力は全てファイルに書き込まれ、メモリ消費を最小限に抑える。

**この優先度の理由**: エージェントの長時間実行で大量の出力が発生するため、過去の出力参照は必須。ファイルベースによりメモリ効率を確保。

**独立したテスト**: 大量の出力を生成後、スクロールバックで過去の出力にアクセスできることで検証できる。

**受け入れシナリオ**:

1. **前提条件** エージェントが10000行以上出力した、**操作** Ctrl+G → [ でスクロールバックモードに入る、**期待結果** 過去の出力をスクロールして閲覧できる
2. **前提条件** スクロールバック中、**操作** ファイル出力先を確認、**期待結果** `~/.gwt/terminals/{pane-id}.log`にraw出力が保存されている
3. **前提条件** 3つのペインが同時に出力中、**操作** メモリ使用量を確認、**期待結果** メモリ上には各ペインの表示領域分のみ保持されている
4. **前提条件** スクロールバック中にエージェントが新しい出力を生成、**操作** スクロール状態を確認、**期待結果** スクロール位置が固定され、新しい出力は画面下に蓄積される（自動スクロールしない）

---

### ユーザーストーリー 6 - ペイン間通信 (優先度: P2)

エージェント間、またはユーザーとエージェント間で、ペインを跨いだ通信ができる。マスターエージェントがサブエージェントに指示を送る、出力を監視するなどのユースケースに対応。Unixドメインソケット経由の内部APIで提供。

**この優先度の理由**: エージェントのオーケストレーション（SPEC-ba3f610c）にはペイン間通信が不可欠。単独ペインの監視だけでは協調作業に不十分。

**独立したテスト**: あるペインからsend-keysで別ペインにコマンドを送信し、受信側で実行されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 2つのペインが存在、**操作** ペインAからGWT_SOCKET_PATH経由でペインBにsend-keysコマンドを送信、**期待結果** ペインBでコマンドが入力として処理される
2. **前提条件** ペインBが出力を生成中、**操作** ペインAからペインBの出力をpipe-pane経由で読み取り、**期待結果** ペインBのPTY出力がペインAのプロセスの標準入力に渡される
3. **前提条件** マスターエージェント（左側UI）が実行中、**操作** サブエージェント（右側ペイン）の出力を監視、**期待結果** マスターエージェントが共有チャネル経由でサブエージェントの進捗を取得できる
4. **前提条件** 共有チャネルが作成済み、**操作** 名前付きチャネルにデータを書き込み、**期待結果** 購読しているペインがデータを受信する

---

### ユーザーストーリー 7 - コピー&ペースト (優先度: P2)

開発者がターミナルペインからテキストをコピーし、他のペインや外部アプリケーションに貼り付けられる。

**この優先度の理由**: ターミナル操作の基本機能。コピーできないターミナルは実用に耐えない。

**独立したテスト**: テキストをコピーモードで選択し、クリップボードに格納されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** ターミナルペインに出力がある、**操作** Ctrl+G → [ でコピーモードに入り、矢印キーでカーソル移動、Spaceで選択開始、Enter で選択確定、**期待結果** 選択されたテキストがarboard経由でシステムクリップボードにコピーされる
2. **前提条件** マウスが有効な環境、**操作** Shift+マウスドラッグでテキストを選択、**期待結果** ネイティブターミナルの選択がパススルーされ、OSのコピー機能が動作する
3. **前提条件** クリップボードにテキストがある、**操作** Ctrl+G → ] でペースト、**期待結果** クリップボードの内容がPTYに送信される

---

### ユーザーストーリー 8 - Docker統合 (優先度: P2)

開発者がDockerコンテナ内でエージェントを実行する場合も、内蔵ターミナルで表示・操作できる。

**この優先度の理由**: SPEC-f5f5657eで実装済みのDocker統合との互換性確保が必要。

**独立したテスト**: Dockerコンテナ内のエージェントが内蔵ターミナルで表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** Docker Compose環境が検出された、**操作** コンテナ内でエージェントを起動、**期待結果** docker exec経由のPTYが右側ペインに表示される
2. **前提条件** Dockerコンテナ内のエージェントが実行中、**操作** ペインにキー入力、**期待結果** docker exec PTY経由でコンテナ内のプロセスに入力が送信される
3. **前提条件** コンテナが停止、**操作** ペインの状態を確認、**期待結果** ペインが自動クローズされる

---

### ユーザーストーリー 9 - エージェント終了とgwt終了 (優先度: P1)

エージェントプロセスが終了したときにペインが自動的に閉じ、gwt終了時には全エージェントが終了する。

**この優先度の理由**: ライフサイクル管理の基本動作。リソースリーク防止に必須。

**独立したテスト**: エージェントが完了後にペインが閉じ、全ペインが閉じた後に全画面ブランチリストに戻ることで検証できる。

**受け入れシナリオ**:

1. **前提条件** 1つのエージェントが実行中、**操作** エージェントが完了（exit code 0）、**期待結果** ペインが自動クローズされ、全画面ブランチリストに戻る
2. **前提条件** 複数エージェントが実行中、**操作** 1つのエージェントが完了、**期待結果** 該当ペインが自動クローズ、残りのペインが表示される
3. **前提条件** エージェントが実行中、**操作** gwt終了（q/Ctrl+C）、**期待結果** 全エージェントプロセスにSIGTERMが送信され、gwt終了
4. **前提条件** エージェントがエラー（非ゼロexit code）で終了、**操作** ペインの状態を確認、**期待結果** ペインが自動クローズされる
5. **前提条件** エージェントが実行中、**操作** Ctrl+G → x でペインを手動クローズ、**期待結果** プロセスにSIGTERMが送信されペインが閉じる

---

### ユーザーストーリー 10 - ホストターミナルリサイズ (優先度: P1)

ホストターミナルのウィンドウサイズが変更された場合、VT100エミュレータとPTYが動的に更新される。

**この優先度の理由**: ターミナル操作の基本動作。リサイズに対応しなければ描画が崩壊する。

**独立したテスト**: ホストターミナルをリサイズし、ペイン内のTUIアプリが正しく再描画されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** ターミナルペインでvimを実行中、**操作** ホストターミナルをリサイズ、**期待結果** VT100エミュレータのサイズが更新され、PTYにWINSIZE変更が通知され、vimが正しく再描画される
2. **前提条件** 横幅80列以上で50:50分割中、**操作** 横幅を79列以下にリサイズ、**期待結果** フルスクリーンターミナルにフォールバック
3. **前提条件** フルスクリーンフォールバック中、**操作** 横幅を80列以上にリサイズ、**期待結果** 50:50分割に復帰

---

### エッジケース

- 端末ウィンドウの幅が極端に狭い（80列未満）場合、左右分割ではなく全画面ターミナルにフォールバックする
- 端末ウィンドウのリサイズ時、VT100エミュレータのサイズが動的に更新され、PTYにWINSIZE変更が送信される
- PTYの作成に失敗した場合（ulimit等）、エラーメッセージを表示してエージェント起動を中止する
- ターミナルペインの出力ファイルのディスク容量が不足した場合、古いログをローテーションまたは警告を表示する
- Ctrl+Gの2回連続押下は、Ctrl+Gリテラルをアクティブペインに送信する（tmuxのprefix+prefix相当）
- マウスイベント対応：ターミナル内のマウスイベント（vim等のマウスサポート）はVT100エミュレータが処理する
- 全エージェントが終了した状態で画面が全画面ブランチリストに戻った後、新しいエージェントを起動すると再び分割される
- スクロールバック用ファイルはgwt終了時にクリーンアップされる
- PTYのバッファフル時（プロセスが出力を停止しない場合）、バックプレッシャーをかけて制御する
- Docker環境のネットワーク切断時、ペインにエラー表示してクリーンアップする
- SSH経由のリモートターミナルでも動作する（crossterm対応）
- BEL文字（\x07）はホストターミナルにそのまま転送する
- DSR（Device Status Report: CSI 6n）リクエストを検出した場合、カーソル位置レスポンス（CSI row;col R）を自動応答する
- gwt内でのターミナルマルチプレクサのネスト（zellij等の起動）はスコープ外。ユーザーの自己責任
- エージェントコマンドはPTYで直接実行（シェルを介さない）。プロセス終了でペインが即閉じる
- 4ペイン上限に達した状態でさらにエージェントを起動しようとした場合、エラーメッセージを表示してブロック
- Unixドメインソケットの作成に失敗した場合（パーミッション等）、IPC機能のみ無効化して基本機能は動作する
- エージェント起動失敗、PTY読み取りエラー、PTY書き込みエラー等のターミナル関連エラーは、tracing crateを使用してエラーログに出力しなければならない

## 要件 *(必須)*

### 機能要件

#### VT100ターミナルエミュレータ

- **FR-001**: gwt内にxterm-256color互換のVT100ターミナルエミュレータを内蔵**しなければならない**
- **FR-002**: 各ターミナルペインは独立したPTY（擬似端末）を持た**なければならない**
- **FR-003**: VT100エミュレータはANSIカラー（256色+TrueColor）、カーソル制御、画面クリア、スクロール領域を処理**しなければならない**
- **FR-004**: vim/nano/htop等のフルスクリーンTUIアプリケーションがペイン内で正常動作**しなければならない**
- **FR-005**: VT100エミュレーション用のRust crateとして`vt100` (v0.16.2) を使用**すること**。PTY管理には`portable-pty` (v0.9.0) を使用**すること**
- **FR-006**: BEL文字（\x07）はホストターミナルにそのまま転送**しなければならない**
- **FR-007**: マウスイベント（vim等のマウスサポート）はVT100エミュレータが処理**しなければならない**

#### 技術選定結果

##### VT100エミュレーション: `vt100` crate v0.16.2

**選定理由**:

1. ratatui APIとの直接マッピング: `screen.cell(row,col)` → ratatui `Buffer` に1:1変換
2. カラー互換: `Color::Default`/`Idx(u8)`/`Rgb(r,g,b)` → ratatui `Color::Reset`/`Indexed(u8)`/`Rgb(r,g,b)`
3. BEL検出: `Callbacks` traitで `audible_bell()` コールバック対応
4. マウスサポート: `mouse_protocol_mode()`, `mouse_protocol_encoding()`
5. 軽量依存: vte, unicode-width, itoa の3つのみ
6. イベントループなし: 同期的に`process()`呼び出し → ratatuiのcrosstermイベント処理と競合しない
7. コミュニティ実証: tui-term（ratatui公式ターミナルWidget v0.3.1）がvt100を採用

**不採用: `alacritty_terminal`** — 内蔵イベントループがratatuiと競合、独自カラー型（非互換）、依存12+個（parking_lot, polling等）、スタンドアロン端末設計であり組み込み用途に不向き

##### PTY管理: `portable-pty` crate v0.9.0

**選定理由**:

1. wezterm作者による成熟したクロスプラットフォーム対応（macOS/Linux/Windows）
2. `resize()`でSIGWINCH自動送信
3. `try_clone_reader()` + `take_writer()`でスレッド安全I/O
4. `CommandBuilder`で環境変数・作業ディレクトリ設定対応

#### PTY管理

- **FR-008**: エージェントコマンドはPTYで直接実行**しなければならない**（シェルを介さない）
- **FR-009**: PTYの作業ディレクトリは対象ブランチのworktreeパスに設定**しなければならない**
- **FR-009a**: 以下の環境変数をPTY起動時に設定**しなければならない**: TERM=xterm-256color, GWT_PANE_ID, GWT_BRANCH, GWT_AGENT, GWT_SOCKET_PATH, GWT_SESSION_ID, GWT_WORKTREE_PATH, GWT_LOG_FILE

#### レイアウト

- **FR-010**: 画面は左右50:50の固定比率で分割**しなければならない**
- **FR-011**: 左側は既存のgwt UI（ブランチリスト等）をそのまま表示**しなければならない**
- **FR-012**: 右側はアクティブなターミナルペインを表示**しなければならない**
- **FR-013**: ターミナルペインはエージェント起動時に出現し、全エージェント終了時に消えて全画面ブランチリストに戻ら**なければならない**
- **FR-014**: 端末幅が80列未満の場合、左右分割ではなくフルスクリーンターミナルにフォールバック**しなければならない**
- **FR-015**: Ctrl+G → z でフルスクリーントグル（右側ペインの全画面表示/50:50復帰）を提供**しなければならない**
- **FR-015a**: フルスクリーントグル時にVT100エミュレータのサイズ更新とPTYへのWINSIZE通知を行わ**なければならない**

#### フォーカスと入力

- **FR-020**: フォーカスはマウスクリックで切り替え可能**でなければならない**
- **FR-021**: Ctrl+Gをプレフィックスキーとして、gwt UIへのフォーカス復帰やペイン操作コマンドに使用**しなければならない**
- **FR-022**: フォーカスが右側ペインにある場合、Ctrl+G以外のすべてのキー入力をPTYに透過的に送信**しなければならない**
- **FR-023**: Ctrl+Gの2回連続押下はCtrl+Gリテラルをアクティブペインに送信**しなければならない**
- **FR-024**: フォーカス中のペインを視覚的に識別できるインジケータを表示**しなければならない**
- **FR-049**: エージェントペインにフォーカス中、Ctrl+CはPTYにパススルー**しなければならない**（gwt終了はgwt UI側でのみ有効）

#### プレフィックスキーコマンド（Ctrl+G後）

- **FR-025**: `n` - 次のタブに切り替え**しなければならない**
- **FR-026**: `p` - 前のタブに切り替え**しなければならない**
- **FR-027**: `[` - スクロールバック/コピーモードに入ら**なければならない**
- **FR-028**: `]` - クリップボードからペースト**しなければならない**
- **FR-029**: `x` - 現在のペインを閉じる（プロセスにSIGTERM送信）**しなければならない**
- **FR-029a**: `z` - フルスクリーントグル**しなければならない**
- **FR-029b**: `Esc` - コマンドキャンセル（プレフィックスモード離脱）**しなければならない**
- **FR-029c**: `Ctrl+G` - Ctrl+Gリテラルをアクティブペインに送信**しなければならない**

#### タブ管理

- **FR-030**: 複数エージェント実行時、右側ペインはタブ切り替えで表示**しなければならない**
- **FR-031**: タブ一覧をステータスバーに表示し、アクティブタブをハイライト**しなければならない**
- **FR-032**: タブ切り替え時にスクロール位置や入力状態を保持**しなければならない**
- **FR-033**: 同時に開けるペイン数は最大4とする**こと**
- **FR-034**: 4ペイン上限到達時に新規エージェント起動を試みた場合、エラーメッセージを表示してブロック**しなければならない**
- **FR-035**: ブランチ選択でEnterを押した際、そのブランチに実行中のエージェントが存在する場合、ウィザードはrunning_pane_idxを正しく設定し「Focus agent pane」オプションを表示**しなければならない**
- **FR-036**: ウィザードの「Focus agent pane」選択時（FocusPane結果）、対応するペインをアクティブにしてフォーカスを切り替え**なければならない**

#### ステータスバー

- **FR-040**: 各ペインのステータスバーにブランチ名を表示**しなければならない**
- **FR-041**: エージェント名をSPEC-3b0ed29bのカラーコーディングに従って表示**しなければならない**
- **FR-042**: 実行ステータス（Running/Completed/Error）を表示**しなければならない**
- **FR-043**: 経過時間を表示**しなければならない**
- **FR-044**: 非アクティブタブのエージェント完了時、タブのステータス表示を更新**しなければならない**
- **FR-045**: ターミナルペインのタイトルは、アクティブなエージェント名を動的に表示**しなければならない**（エージェント未起動時は `No Agent` を表示）
- **FR-046**: エージェントペインは常時表示とし、エージェント未起動時は `No agent running` メッセージを表示**しなければならない**
- **FR-047**: 右側ペインの名称は「エージェントペイン (Agent Pane)」と**しなければならない**
- **FR-048**: エージェントペインにフォーカス中、マウススクロールを以下のように処理**しなければならない**:
  - PTY内アプリがマウスプロトコルを有効にしている場合: X10プロトコルのスクロールバイト列をPTYに送信
  - マウスプロトコル無効時: スクロールイベントは無視する（PTYへの送信は行わない）

#### スクロールバック

- **FR-050**: ターミナル出力は全て即座にファイルに書き込ま**なければならない**
- **FR-051**: 出力ファイルは`~/.gwt/terminals/{pane-id}.log`に保存**しなければならない**
- **FR-052**: メモリ上には表示領域分の内容のみ保持**しなければならない**
- **FR-053**: Ctrl+G → [ でスクロールバックモードに入り、ファイルから過去の出力を読み込んで表示**しなければならない**
- **FR-054**: スクロールバック中にエージェントが新出力を生成した場合、スクロール位置を固定**しなければならない**
- **FR-055**: gwt終了時にスクロールバック用ファイルをクリーンアップ**しなければならない**

#### ペイン間通信

- **FR-060**: send-keys機能：あるペインから別のペインにキー入力を送信**できなければならない**
- **FR-061**: pipe-pane機能：あるペインの出力を別のペインのプロセスの標準入力に転送**できなければならない**
- **FR-062**: 共有チャネル機能：名前付きチャネルでペイン間のデータ交換が**できなければならない**
- **FR-063**: ペイン間通信はgwt内部Rust APIとして提供**しなければならない**
- **FR-064**: IPCトランスポートとしてUnixドメインソケット（`~/.gwt/gwt.sock`）を使用**しなければならない**
- **FR-065**: Unixドメインソケットの作成に失敗した場合、IPC機能のみ無効化して基本機能は動作**しなければならない**

#### コピー&ペースト

- **FR-070**: Ctrl+G → [ → カーソル移動 → Space → 範囲選択 → Enter でシステムクリップボードにコピー**しなければならない**
- **FR-071**: arboard crateを使用してクリップボードアクセスを実装**しなければならない**
- **FR-072**: Shift+マウスドラッグでネイティブターミナルの選択をパススルー**しなければならない**
- **FR-073**: Ctrl+G → ] でクリップボードの内容をPTYに貼り付け**しなければならない**

#### Docker統合

- **FR-080**: Dockerコンテナ内のエージェント実行をサポート**しなければならない**
- **FR-081**: `docker exec`経由のPTYをターミナルペインに表示**しなければならない**
- **FR-082**: コンテナ停止時にペインを自動クローズ**しなければならない**

#### ライフサイクル

- **FR-090**: エージェントプロセス終了時にペインを自動クローズ**しなければならない**
- **FR-091**: 全ペイン閉鎖後、全画面ブランチリストに復帰**しなければならない**
- **FR-092**: gwt終了時に全エージェントプロセスにSIGTERMを送信**しなければならない**
- **FR-093**: 既存のtmux統合を完全に置き換える**こと**（段階的移行可）

#### ホストターミナルリサイズ

- **FR-095**: SIGWINCHシグナル受信時に全ペインのVT100エミュレータサイズを更新**しなければならない**
- **FR-096**: サイズ更新時にPTYにWINSIZE変更を通知**しなければならない**
- **FR-097**: リサイズ後にratatuiの再描画をトリガー**しなければならない**

#### tmux統合の廃止

- **FR-100**: 新しい内蔵ターミナルが安定した後、既存のtmux依存コード（`gwt-core/src/tmux/`）をdeprecated化**しなければならない**
- **FR-101**: 移行期間中は両方のモード（内蔵ターミナル/tmux）を設定で選択可能**にすべき**

#### マスターエージェントとの統合

- **FR-110**: マスターエージェント（SPEC-ba3f610c）は左側UIの専用モードとして動作**しなければならない**（ターミナルペインではない）
- **FR-111**: マスターエージェントはIPC経由でサブエージェント（右側ペイン）と通信**できなければならない**

### 非機能要件

- **NFR-001**: ターミナル描画は16ms（60fps）以内に完了**しなければならない**
- **NFR-002**: 各ペインのメモリ使用量は表示領域分（概算: 行数×列数×セル構造体サイズ）に収まる**こと**
- **NFR-003**: スクロールバック用ファイルへの書き込みは出力のリアルタイム表示をブロックしない**こと**
- **NFR-004**: PTY I/Oは非同期（tokio/async）で処理**しなければならない**
- **NFR-005**: ペイン間通信のレイテンシは10ms以下**であること**
- **NFR-006**: UIアニメーション（スピナー、フッタースクロール）はtick_rateに依存せず、実経過時間ベース（250ms間隔）で更新**しなければならない**

### 主要エンティティ

- **TerminalPane**: ターミナルペインを表す構造体。pane_id, pty_handle, vt100_state, branch_name, agent_name, agent_color, status, started_at, log_file_pathを持つ
- **PaneManager**: ペインのライフサイクルを管理する構造体。panes(Vec\<TerminalPane\>), active_index, max_panes(=4), is_fullscreenを持つ
- **PaneIpc**: ペイン間通信機構。unix_socket_path, send_keys, pipe_output, shared_channelsの各フィールド/メソッドを提供
- **ScrollbackFile**: ファイルベースのスクロールバック。file_path, write_handle, total_linesを持つ
- **PaneStatus**: ペインの状態を表すenum。Running, Completed(exit_code), Error(message)
- **PrefixCommand**: プレフィックスキー後のコマンドを表すenum。NextTab, PrevTab, CopyMode, Paste, ClosePane, FullscreenToggle, Cancel, SendPrefix

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: tmux/zellijが未インストールの環境でエージェントを起動・監視・操作できる
- **SC-002**: VT100エミュレーション精度: vim、nano、htopがペイン内で正常動作する
- **SC-003**: スクロールバックファイルにより10000行以上の出力を参照できる
- **SC-004**: ペイン間のsend-keysが1秒以内に受信側で実行される
- **SC-005**: 4ペイン同時実行時のメモリ使用量が表示領域分×4+管理構造体のみ（ファイルI/Oバッファ除く）
- **SC-006**: 既存のブランチリスト操作（検索、ソート、選択等）がターミナルペイン表示中も正常動作する
- **SC-007**: Docker環境でのエージェント実行が内蔵ターミナルで正常に動作する
- **SC-008**: ホストターミナルリサイズ時にペイン内アプリが正しく再描画される

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のgwt-core/gwt-cliモジュール分担に従う
- ratatui 0.30フレームワーク上でターミナル描画を実装する
- PTY操作には`portable-pty` crate (v0.9.0) を使用する
- 外部ターミナルマルチプレクサ（tmux/zellij）に依存しない
- CLIのユーザー向け出力は英語のみ
- 汎用マルチプレクサではなくgwt特化型ペイン設計

### 仮定

- ユーザーの端末はxterm-256colorをサポートしている
- ユーザーの端末は最低80列×24行の解像度を持つ
- エージェントプロセスはPTY経由で正常に動作する（ほとんどのCLIツールはPTY対応）
- Dockerがインストールされている場合、docker execが正常に動作する
- Unix系OS（Linux, macOS）を対象とする（Windowsサポートは範囲外）

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 汎用ターミナルマルチプレクサ機能（gwtに特化したペイン設計のみ）
- セッション永続化/デタッチ機能（gwt終了=全エージェント終了）
- ユーザーによる分割比率の動的変更（50:50固定）
- 右側ペインのさらなる上下分割（複数同時表示は今回のスコープ外）
- 5ペイン以上の同時管理
- リモートサーバーへのSSH接続管理
- ターミナルテーマ/フォント設定のカスタマイズ
- ターミナル録画/リプレイ機能
- ペインのウィンドウ外への分離（ポップアウト）
- Windows OSサポート
- ネストされたターミナルマルチプレクサの検出・対応
- CLIコマンド経由のペイン間通信（内部APIのみ）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- PTY経由で実行されるプロセスは、gwtを実行しているユーザーの権限で動作する
- ターミナル出力ファイル（`~/.gwt/terminals/`）にはエージェントの全出力が記録されるため、機密情報が含まれる可能性がある。gwt終了時にクリーンアップする
- ペイン間通信のsend-keys機能は悪意あるプロセスが他のペインにコマンドを注入する可能性があるため、ペインの所有者（gwt自身）のみが使用可能とする
- Unixドメインソケットのパーミッションをユーザー限定（0700）に設定する
- Docker exec経由のPTYはコンテナの権限レベルで動作する

## 依存関係 *(該当する場合)*

- **SPEC-3b0ed29b**: エージェントカラーコーディング（ステータスバー表示）
- **SPEC-ba3f610c**: エージェントモード（マスターエージェントのペイン間通信）
- **SPEC-f5f5657e**: Docker環境統合（コンテナ内エージェント実行）
- **ratatui 0.30**: TUIフレームワーク
- **crossterm 0.29**: ターミナル制御
- **arboard**: クリップボードアクセス
- **portable-pty 0.9.0**: PTY管理（クロスプラットフォーム）
- **vt100 0.16.2**: VT100ターミナルエミュレーション
- **tokio**: 非同期PTY I/O

## 参考資料 *(該当する場合)*

- [zellij アーキテクチャ](https://github.com/zellij-org/zellij) - VT100エミュレータ内蔵のRustターミナルマルチプレクサ
- [alacritty_terminal crate](https://crates.io/crates/alacritty_terminal) - 成熟したVT100エミュレーション
- [vt100 crate](https://crates.io/crates/vt100) - 軽量VT100パーサ
- [portable-pty crate](https://crates.io/crates/portable-pty) - クロスプラットフォームPTY管理
- [既存tmux統合](../../crates/gwt-core/src/tmux/) - 置き換え対象
