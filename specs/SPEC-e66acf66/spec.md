# 機能仕様: エラーポップアップ・ログ出力システム

**仕様ID**: `SPEC-e66acf66`
**作成日**: 2026-01-22
**ステータス**: ドラフト
**カテゴリ**: Porting

**入力**: ユーザー説明: "エラーポップアップ・ログ出力システム: エラーログをブランチ詳細画面ではなくポップアップに表示し、全てのエラーをログファイルに出力する。背景クリックでポップアップを閉じる、[l]キーでログ画面へジャンプ、[c]キーでクリップボードコピー、エラーコード体系（GWT-EXXX形式）、サジェスチョン機能、複数エラーはキューで順次表示"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - エラーポップアップの表示 (優先度: P0)

開発者がWorktree作成、Gitコマンド実行、プロファイル設定保存などの操作でエラーが発生した場合、画面中央にエラーポップアップが表示される。ポップアップにはエラーコード、メッセージ、詳細、サジェスチョンが含まれる。

**この優先度の理由**: エラーをユーザーに確実に通知する基本機能であり、本仕様の中核となる。

**独立したテスト**: エラーが発生する操作を実行し、ポップアップが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面が表示されている、**操作** 存在しないブランチ名でWorktree作成を試みる、**期待結果** 画面中央にエラーポップアップが表示される
2. **前提条件** エラーポップアップが表示されている、**操作** ポップアップ内容を確認、**期待結果** エラーコード（E1001形式）、メッセージ、詳細セクション、サジェスチョンセクションが表示される
3. **前提条件** エラーポップアップが表示されている、**操作** Enterキーを押す、**期待結果** ポップアップが閉じて元の画面に戻る
4. **前提条件** エラーポップアップが表示されている、**操作** Escキーを押す、**期待結果** ポップアップが閉じて元の画面に戻る
5. **前提条件** エラーポップアップが表示されている、**操作** ポップアップ外の領域をマウスクリック、**期待結果** ポップアップが閉じて元の画面に戻る

---

### ユーザーストーリー 2 - ログ画面へのジャンプ (優先度: P0)

エラーポップアップ表示中に[l]キーを押すと、ログビューアー画面に遷移する。

**この優先度の理由**: エラーの詳細な履歴や文脈を確認するためのナビゲーションとして必須。

**独立したテスト**: エラーポップアップで[l]キーを押し、ログ画面に遷移することを確認できる。

**受け入れシナリオ**:

1. **前提条件** エラーポップアップが表示されている、**操作** [l]キーを押す、**期待結果** ログビューアー画面に遷移する
2. **前提条件** ログビューアーでエラーを確認中、**操作** Escキーで戻る、**期待結果** 元のブランチ一覧画面に戻る

---

### ユーザーストーリー 3 - 全エラーのログ出力 (優先度: P0)

エラーが発生すると、ポップアップ表示とは別に、ログファイルに記録される。ログにはエラーコード、カテゴリ、メッセージ、詳細が含まれる。

**この優先度の理由**: エラーの永続化と後からのデバッグのために必須。

**独立したテスト**: エラー発生後にログファイルを確認し、該当エラーが記録されていることを検証できる。

**受け入れシナリオ**:

1. **前提条件** gwtが起動している、**操作** エラーを発生させる操作を実行、**期待結果** ログファイル（gwt.jsonl.YYYY-MM-DD）にエラーが記録される
2. **前提条件** エラーが記録された、**操作** ログファイルを確認、**期待結果** エラーコード、カテゴリ（"worktree"等）、メッセージがJSON形式で記録されている
3. **前提条件** 複数のエラーが発生した、**操作** ログファイルを確認、**期待結果** 全てのエラーがタイムスタンプ順に記録されている

---

### ユーザーストーリー 4 - エラーのクリップボードコピー (優先度: P1)

エラーポップアップ表示中に[c]キーを押すと、エラー情報（コード、メッセージ、詳細、サジェスチョン）がJSON形式でクリップボードにコピーされる。

**この優先度の理由**: バグレポートや問題共有のために便利だが、基本機能の後に実装可能。

**独立したテスト**: エラーポップアップで[c]キーを押し、クリップボードからペーストしてJSON形式であることを確認できる。

**受け入れシナリオ**:

1. **前提条件** エラーポップアップが表示されている、**操作** [c]キーを押す、**期待結果** 「Copied to clipboard」のステータスメッセージが表示される
2. **前提条件** [c]キーでコピーした、**操作** テキストエディタにペースト、**期待結果** エラー情報がJSON形式で貼り付けられる
3. **前提条件** エラーにサジェスチョンが含まれている、**操作** [c]キーでコピーしてペースト、**期待結果** サジェスチョンもJSONに含まれる

---

### ユーザーストーリー 5 - 複数エラーのキュー処理 (優先度: P1)

エラーポップアップ表示中に新たなエラーが発生した場合、キューに追加され、現在のポップアップを閉じると次のエラーが表示される。

**この優先度の理由**: 連続エラー発生時のUX向上のため重要だが、基本機能の後に実装可能。

**独立したテスト**: 複数エラーを連続発生させ、キューで順次表示されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** エラーポップアップが表示されている、**操作** 別のエラーが発生、**期待結果** 新しいエラーはキューに追加され、現在のポップアップは維持される
2. **前提条件** キューにエラーが複数ある、**操作** Enterキーで現在のポップアップを閉じる、**期待結果** 次のエラーポップアップが表示される
3. **前提条件** キューの最後のエラーを閉じた、**操作** Enterキーを押す、**期待結果** ポップアップが閉じて元の画面に戻る
4. **前提条件** キューにエラーが複数ある、**操作** ポップアップのタイトルを確認、**期待結果** 「Error (1/3)」のようにキュー位置が表示される

---

### ユーザーストーリー 6 - マウス操作サポート (優先度: P1)

エラーポップアップはマウス操作に対応し、フッターのショートカットをクリックで実行、詳細セクションをホイールでスクロールできる。

**この優先度の理由**: マウスユーザーへのアクセシビリティ向上のため重要。

**独立したテスト**: マウスでショートカットをクリックし、対応する機能が実行されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** エラーポップアップが表示されている、**操作** フッターの「[l] Logs」をクリック、**期待結果** ログ画面に遷移する
2. **前提条件** エラーポップアップが表示されている、**操作** フッターの「[c] Copy」をクリック、**期待結果** エラー情報がクリップボードにコピーされる
3. **前提条件** 詳細セクションがスクロール可能、**操作** マウスホイールで下スクロール、**期待結果** 詳細セクションがスクロールする
4. **前提条件** ポップアップ外の領域にマウスがある、**操作** クリック、**期待結果** ポップアップが閉じる

---

### ユーザーストーリー 7 - サジェスチョン表示 (優先度: P1)

エラーポップアップには、エラー解決のためのサジェスチョン（具体的なコマンド例を含む）が表示される。

**この優先度の理由**: ユーザーが問題を自己解決できるよう支援するために重要。

**独立したテスト**: エラー発生時にサジェスチョンセクションが表示されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** ブランチが存在しないエラーが発生、**操作** サジェスチョンを確認、**期待結果** 「Check if branch exists」「Try: git fetch --all」などの具体的な解決策が表示される
2. **前提条件** 権限エラーが発生、**操作** サジェスチョンを確認、**期待結果** 「Check file permissions」「Try: chmod +x ...」などの解決策が表示される
3. **前提条件** サジェスチョンが複数ある、**操作** ポップアップを確認、**期待結果** 全てのサジェスチョンが箇条書きで表示される

---

### エッジケース

- 非常に長いエラーメッセージの場合、ポップアップ内でワードラップされる
- エラーキューが空のときにポップアップを閉じると、元の画面に戻る
- クリップボードへのコピーに失敗した場合、エラーメッセージが表示される
- ログディレクトリが存在しない場合、自動的に作成される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは全エラー（Worktree作成失敗、Gitコマンド失敗、プロファイル設定エラー等）をポップアップで表示**しなければならない**
- **FR-002**: ポップアップは画面中央に幅最大70文字のダイアログとして表示**しなければならない**
- **FR-003**: エラーコードはEXXXX形式（例: E1001, E2001）で付与**しなければならない**（カテゴリ別: E1xxx=Git, E2xxx=Worktree, E3xxx=Config, E4xxx=Agent, E5xxx=WebApi, E9xxx=General）
- **FR-004**: エラーカテゴリ（worktree, git, config, ai）を各エラーに割り当て**なければならない**
- **FR-005**: [Enter]キーと[Esc]キーでポップアップを閉じることができ**なければならない**
- **FR-006**: [l]キーでログ画面へ遷移でき**なければならない**
- **FR-007**: [c]キーでエラー情報をJSON形式でクリップボードにコピーでき**なければならない**
- **FR-008**: ポップアップ外のマウスクリックでポップアップを閉じることができ**なければならない**
- **FR-009**: フッターのショートカット（[l], [c]）をマウスクリックで実行でき**なければならない**
- **FR-010**: 詳細セクションをマウスホイールでスクロールでき**なければならない**
- **FR-011**: 複数エラー発生時はキューに追加し、順次表示**しなければならない**
- **FR-012**: キュー内の位置をタイトルに表示**しなければならない**（例: Error (1/3)）
- **FR-013**: 全エラーをログファイル（gwt.jsonl.YYYY-MM-DD）に出力**しなければならない**
- **FR-014**: ログにはエラーコード、カテゴリ、メッセージ、詳細を含め**なければならない**
- **FR-015**: エラー種別ごとにサジェスチョン（解決策・コマンド例）を表示**しなければならない**
- **FR-016**: エラーの重大度に応じて色分け表示**しなければならない**（Error=赤、Warning=黄、Info=青）

### 主要エンティティ

- **ErrorCode**: エラーの一意識別子（EXXXX形式）、カテゴリとサジェスチョンを持つ
- **ErrorState**: 表示用エラー状態、コード・メッセージ・詳細・サジェスチョン・重大度を保持
- **ErrorQueue**: 複数エラーを順次処理するキュー、FIFO順序で管理

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 全エラー発生時にポップアップが100ms以内に表示される
- **SC-002**: エラー発生後、ログファイルに該当エラーが記録されている
- **SC-003**: ユーザーが[l]キーで即座にログ画面へ遷移し、エラー詳細を確認できる
- **SC-004**: キーボードのみで全操作が完了できる（アクセシビリティ）

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のErrorStateとrender_error関数を拡張して実装する
- 既存のログシステム（tracing + JSON Lines）を使用する
- ASCII文字のみでアイコンを表示する（絵文字不可）

### 仮定

- ユーザーはキーボードまたはマウスで操作する
- ログディレクトリへの書き込み権限がある
- クリップボード機能が利用可能な環境で実行される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- セッションサマリー取得失敗のポップアップ表示（従来通りセッションタブに表示）
- エラー発生時の自動リトライ機能
- エラー通知のシステム通知連携（macOS通知センター等）
- エラーの自動レポート機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- エラーログに認証情報（APIキー等）を含めない
- クリップボードコピー時に機密情報をマスクする

## 依存関係 *(該当する場合)*

- 既存のログシステム（gwt-core/src/logging/）
- 既存のエラー画面（gwt-cli/src/tui/screens/error.rs）
- クリップボード機能（cli-clipboard等のクレート）
