# 実装計画: Worktreeクリーンアップ選択機能

**仕様ID**: `SPEC-55fe506f` | **日付**: 2025-11-10 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/SPEC-55fe506f/spec.md` からの機能仕様

## 概要

ブランチ一覧画面でスペースキーによる複数選択機能を実装し、選択されたブランチのみをクリーンアップできるようにする。開発者が視覚的に確認しながら安全にブランチをクリーンアップでき、プッシュされていないブランチは赤色マーカーで警告される。既存のEnterキーによるブランチ切り替え機能は維持される。

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.8.x / React 19
**主要な依存関係**:
- Ink 6.3.1 (ターミナルUI)
- chalk 5.4.1 (色付け)
- execa 9.6.0 (Git操作)
- string-width 7.2.0 (文字列幅計算)

**ストレージ**: N/A（ローカルGit操作のみ）
**テスト**: Vitest 4.0.8 + @testing-library/react 16.3.0 + happy-dom 20.0.8
**ターゲットプラットフォーム**: ターミナル（Linux/macOS/Windows WSL）
**プロジェクトタイプ**: 単一CLIアプリケーション
**パフォーマンス目標**:
- 選択状態の更新: <16ms (60fps相当)
- 大量ブランチ(100+)でもスムーズな操作

**制約**:
- Inkの制約内で実装（ターミナルUIフレームワーク）
- 既存のキーバインディングと競合しないこと
- 既存のBranchListScreen/Selectコンポーネントを活用

**スケール/範囲**:
- 100+ブランチでも動作
- 同時選択数: 制限なし（実用上は数十個程度を想定）

## 原則チェック

*ゲート: フェーズ0の調査前に合格する必要があります。フェーズ1の設計後に再チェック。*

**注**: constitution.mdがテンプレート状態のため、プロジェクト固有の原則は未定義です。一般的なベストプラクティスに従います：

- ✅ **既存コードの尊重**: 既存のUI構造（BranchListScreen、Select）を活用
- ✅ **後方互換性**: Enterキーの既存動作を維持
- ✅ **テストファースト**: 各機能に対してテストを先に作成
- ✅ **シンプルさ**: 最小限の変更で機能を実現

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-55fe506f/
├── plan.md              # このファイル（/speckit.plan コマンド出力）
├── research.md          # フェーズ0出力（/speckit.plan コマンド）
├── data-model.md        # フェーズ1出力（/speckit.plan コマンド）
├── quickstart.md        # フェーズ1出力（/speckit.plan コマンド）
└── tasks.md             # フェーズ2出力（/speckit.tasks コマンド）
```

### ソースコード（リポジトリルート）

```text
src/
├── ui/
│   ├── components/
│   │   ├── App.tsx                          # [変更] 選択状態管理追加
│   │   ├── common/
│   │   │   └── Select.tsx                   # [変更] スペースキー・ESCキー処理追加
│   │   └── screens/
│   │       └── BranchListScreen.tsx         # [変更] 選択UI実装
│   └── types.ts                             # [変更] Props型定義追加
├── worktree.ts                              # [参照] 既存のクリーンアップロジック
└── git.ts                                   # [参照] Git操作

tests/
├── ui/
│   ├── components/
│   │   ├── App.test.tsx                     # [新規] 選択状態管理テスト
│   │   ├── common/
│   │   │   └── Select.test.tsx              # [変更] スペースキー・ESCキーテスト
│   │   └── screens/
│   │       └── BranchListScreen.test.tsx    # [変更] 選択UIテスト
```

## フェーズ0: 調査（技術スタック選定）

**目的**: 要件に基づいて技術スタックを決定し、既存のコードパターンを理解する

**出力**: `specs/SPEC-55fe506f/research.md`

### 調査項目

1. **既存のコードベース分析**
   - 現在の選択状態管理方法（App.tsxのステート管理）
   - BranchListScreenの既存Props構造とイベントハンドリング
   - Selectコンポーネントのキー入力処理とカスタマイズ方法
   - 既存のクリーンアップロジック（getMergedPRWorktrees、handleCleanupCommand）

2. **技術的決定**
   - 選択状態の管理方法（Set<string> vs Array<string> vs Map<string, boolean>）
   - `*`マーカーの表示位置と色分けロジック
   - 保護ブランチ判定ロジックの実装場所
   - 警告対象ブランチの判定基準（hasUnpushedCommits、マージ状態）

3. **制約と依存関係**
   - InkのuseInputフックの動作仕様
   - Reactのステート更新とInkの再レンダリング
   - chalkによる色付けとターミナル互換性

## フェーズ1: 設計（アーキテクチャと契約）

**目的**: 実装前に技術設計を定義する

**出力**:
- `specs/SPEC-55fe506f/data-model.md`
- `specs/SPEC-55fe506f/quickstart.md`

### 1.1 データモデル設計

**ファイル**: `data-model.md`

主要なエンティティとその関係を定義：
- **ブランチ選択状態**: Set<string>型、選択されたブランチ名のコレクション
- **BranchItem拡張**: 既存のBranchItem型に選択関連の情報を追加する必要性の検討
- **選択マーカー**: 表示ロジック（通常/警告の判定条件）
- **保護ブランチリスト**: 定数定義（main, master, develop）

### 1.2 クイックスタートガイド

**ファイル**: `quickstart.md`

開発者向けの簡潔なガイド：
- セットアップ手順（依存関係のインストール）
- 開発ワークフロー（テスト → 実装）
- テスト実行方法（unit / integration）
- デバッグ方法（Ink Devtools）

### 1.3 契約/インターフェース

本機能はUIのみであり、外部APIは不要。
内部コンポーネント間のProps型定義をdata-model.mdに含める。

## フェーズ2: タスク生成

**次のステップ**: `/speckit.tasks` コマンドを実行

**入力**: このプラン + 仕様書 + 設計ドキュメント

**出力**: `specs/SPEC-55fe506f/tasks.md` - 実装のための実行可能なタスクリスト

## 実装戦略

### 優先順位付け

ユーザーストーリーの優先度に基づいて実装：
1. **P1 - ストーリー1**: 複数ブランチの選択とクリーンアップ
2. **P1 - ストーリー2**: 選択状態の視覚的フィードバック
3. **P2 - ストーリー3**: 選択解除と修正
4. **P1 - ストーリー4**: 既存のブランチ切り替え機能の維持（最初に検証）

### 独立したデリバリー

各ユーザーストーリーは独立して実装・テスト・デプロイ可能：
- ストーリー4（後方互換性）→ 基本的なテストで検証
- ストーリー1（選択機能）→ 最小限の選択UIで動作確認
- ストーリー2（視覚フィードバック）→ マーカー表示を追加
- ストーリー3（選択解除）→ ESCキー機能を追加

## テスト戦略

### ユニットテスト

- **Select.tsx**: スペースキー・ESCキー処理のテスト
- **BranchListScreen.tsx**: renderBranchRowのマーカー表示テスト
- **App.tsx**: 選択状態管理ロジックのテスト

### 統合テスト

- **選択フロー**: スペースキーで複数選択 → クリーンアップ実行 → 選択ブランチのみ削除
- **保護ブランチ**: main/developが選択できないことを確認
- **警告表示**: プッシュされていないブランチが赤色マーカーで表示
- **後方互換性**: Enterキーでのブランチ切り替えが正常動作

### エンドツーエンドテスト

- **実際のGitリポジトリ**: テスト用リポジトリでの動作確認
- **大量ブランチ**: 100+ブランチでのパフォーマンステスト

### パフォーマンステスト

- 選択状態更新の遅延測定（目標: <16ms）
- 大量ブランチ表示時のレンダリング時間

## リスクと緩和策

### 技術的リスク

1. **Inkの再レンダリングパフォーマンス**
   - **緩和策**: React.memoの活用、不要な再レンダリングの防止

2. **ターミナルでの色表示の互換性**
   - **緩和策**: chalkのサポート確認、フォールバック実装

3. **キーバインディングの競合**
   - **緩和策**: 既存のキー（r, m, c, q）を避ける設計、明示的な優先順位付け

### 依存関係リスク

1. **Ink 6.x API変更**
   - **緩和策**: 既にInk 6.3.1を使用中、大きな変更はなし

2. **既存コンポーネントの破壊的変更**
   - **緩和策**: Props拡張時は既存のPropsを維持、オプショナル型で追加

## 次のステップ

1. ⏭️ フェーズ0: 調査と技術スタック決定（research.md生成）
2. ⏭️ フェーズ1: 設計とアーキテクチャ定義（data-model.md、quickstart.md生成）
3. ⏭️ `/speckit.tasks` を実行してタスクを生成
4. ⏭️ `/speckit.implement` で実装を開始
