# 機能仕様: Worktreeクリーンアップ選択機能

**仕様ID**: `SPEC-55fe506f`
**作成日**: 2025-11-10
**ステータス**: ドラフト
**入力**: ユーザー説明: "Worktreeクリーンアップ選択機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 複数ブランチの選択とクリーンアップ (優先度: P1)

開発者が、ブランチ一覧画面で不要になった複数のブランチを視覚的に確認しながら選択し、一括でクリーンアップできる機能です。開発者はスペースキーで個別にブランチを選択/解除し、選択したブランチのみをクリーンアップ対象にできます。

**この優先度の理由**: 本機能のコア価値。現状は全自動クリーンアップのため、開発者が制御できず、予期しないブランチが削除されるリスクがあります。選択機能により、開発者が主導権を持ちながら効率的にクリーンアップできます。

**独立したテスト**: ブランチ一覧を表示し、スペースキーで複数ブランチを選択し、実行することで完全にテストでき、手動選択によるクリーンアップという価値を提供します。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面が表示されている、**操作** スペースキーを押す、**期待結果** カーソル位置のブランチに`*`マーカーが表示され、選択状態になる
2. **前提条件** ブランチが1つ選択されている、**操作** 同じブランチでスペースキーを押す、**期待結果** `*`マーカーが消え、選択が解除される
3. **前提条件** 複数のブランチが選択されている、**操作** クリーンアップを実行する、**期待結果** 選択されたブランチのみがクリーンアップされ、選択されていないブランチは残る
4. **前提条件** ブランチ一覧画面が表示されている、**操作** 保護ブランチ(main/develop)にカーソルを合わせてスペースキーを押す、**期待結果** 選択されず、`*`マーカーも表示されない

---

### ユーザーストーリー 2 - 選択状態の視覚的フィードバック (優先度: P1)

開発者が、どのブランチが選択されているか、また警告が必要なブランチ(プッシュされていない/マージされていない)かどうかを、一目で判別できる視覚的フィードバックを得られる機能です。

**この優先度の理由**: 誤削除を防ぐための重要な安全機構です。特にプッシュされていないコミットがあるブランチを誤って削除すると、作業内容が失われるため、視覚的な警告が不可欠です。

**独立したテスト**: 選択状態の異なるブランチ(通常/警告対象)を表示し、マーカーの色と位置を確認することで完全にテストでき、視覚的安全性という価値を提供します。

**受け入れシナリオ**:

1. **前提条件** 通常のブランチが選択されている、**操作** 画面を確認する、**期待結果** 白色の`*`マーカーが表示される
2. **前提条件** プッシュされていないコミットがあるブランチが選択されている、**操作** 画面を確認する、**期待結果** 赤色の`*`マーカーが表示される
3. **前提条件** マージされていないブランチが選択されている、**操作** 画面を確認する、**期待結果** 赤色の`*`マーカーが表示される
4. **前提条件** 複数のブランチが選択されている、**操作** 画面下部を確認する、**期待結果** "選択中: N個のブランチ"というメッセージがリアルタイムで表示される

---

### ユーザーストーリー 3 - 選択解除と修正 (優先度: P2)

開発者が、誤って選択したブランチを個別に解除したり、ESCキーで全選択を一括解除したりして、選択内容を柔軟に修正できる機能です。

**この優先度の理由**: ユーザビリティの向上。誤操作の修正を容易にすることで、開発者が安心して機能を使用できます。

**独立したテスト**: 複数ブランチを選択後、個別解除とESCキーによる全解除を実行することで完全にテストでき、柔軟な選択修正という価値を提供します。

**受け入れシナリオ**:

1. **前提条件** 複数のブランチが選択されている、**操作** 選択済みブランチでスペースキーを押す、**期待結果** そのブランチのみ選択が解除され、他の選択は維持される
2. **前提条件** 複数のブランチが選択されている、**操作** ESCキーを押す、**期待結果** 全ての選択が解除され、`*`マーカーが全て消える
3. **前提条件** 何も選択されていない、**操作** ESCキーを押す、**期待結果** 何も変化せず、エラーも表示されない

---

### ユーザーストーリー 4 - 既存のブランチ切り替え機能の維持 (優先度: P1)

開発者が、Enterキーによる既存のブランチ切り替え(worktree切り替え)機能を、選択機能追加後も引き続き使用できる機能です。

**この優先度の理由**: 後方互換性の維持。既存のワークフローを壊さないことは、ユーザー体験の継続性において極めて重要です。

**独立したテスト**: ブランチを選択せずにEnterキーを押すことで、従来通りのworktree切り替えが動作することを確認でき、後方互換性という価値を提供します。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面でカーソルが任意のブランチにある、**操作** Enterキーを押す、**期待結果** 従来通り、そのブランチのworktreeに切り替わる
2. **前提条件** 複数のブランチが選択されている状態でカーソルが別のブランチにある、**操作** Enterキーを押す、**期待結果** 選択状態に関係なく、カーソル位置のブランチのworktreeに切り替わる

---

### エッジケース

- 0個のブランチが選択されている状態でクリーンアップを実行した場合、"クリーンアップ対象が選択されていません"という警告メッセージを表示し、処理を中断する
- 保護ブランチ(main/develop)は選択できないようにする(スペースキーを押しても反応しない)
- クリーンアップ実行中に選択状態を変更できないようにする(入力ロック)
- ブランチ一覧が空の場合、選択機能は無効化される
- 選択されたブランチのworktreeが既に削除されている場合、ブランチのみ削除を試行する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはブランチ一覧画面でスペースキーによる複数選択機能を提供**しなければならない**
- **FR-002**: システムは選択されたブランチを視覚的に識別できる`*`マーカーを表示**しなければならない**
- **FR-003**: システムはプッシュされていないコミットがあるブランチ、またはマージされていないブランチを選択した場合、赤色の`*`マーカーで警告**しなければならない**
- **FR-004**: システムは通常のブランチを選択した場合、白色の`*`マーカーを表示**しなければならない**
- **FR-005**: システムは保護ブランチ(main/develop)を選択対象から除外**しなければならない**
- **FR-006**: システムはESCキーによる全選択解除機能を提供**しなければならない**
- **FR-007**: システムは画面下部に選択中のブランチ数をリアルタイムで表示**しなければならない**
- **FR-008**: システムはクリーンアップ実行時に0個選択の場合、警告メッセージを表示して処理を中断**しなければならない**
- **FR-009**: システムは選択されたブランチのみをクリーンアップ対象とし、選択されていないブランチは保持**しなければならない**
- **FR-010**: システムはEnterキーによる既存のブランチ切り替え機能を維持**しなければならない**
- **FR-011**: システムはworktreeが存在するブランチの場合、worktreeとブランチ両方を削除**しなければならない**
- **FR-012**: システムはworktreeが存在しないブランチの場合、ローカルブランチのみを削除**しなければならない**

### 主要エンティティ *(機能がデータを含む場合は含める)*

- **ブランチ選択状態**: どのブランチが選択されているかを管理する状態。ブランチ名のコレクションとして保持される
- **ブランチアイテム**: ブランチ名、最終コミット日時、状態(プッシュ済み/未プッシュ、マージ済み/未マージ)、worktree存在有無などの情報を持つ
- **選択マーカー**: 選択状態を視覚的に表現する記号(`*`)。通常は白色、警告対象は赤色で表示される

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者は3秒以内に複数のブランチを選択できる
- **SC-002**: 開発者は選択状態(選択済み/警告対象)を1秒以内に視覚的に判別できる
- **SC-003**: 誤選択(保護ブランチの選択、0個選択での実行)が100%防止される
- **SC-004**: 既存のブランチ切り替え機能(Enterキー)が選択機能追加後も100%の互換性を維持する
- **SC-005**: 開発者の90%が初回使用時に説明なしで選択機能を使用できる(スペースキーとESCキーの操作が直感的)
- **SC-006**: プッシュされていないブランチの誤削除が視覚的警告により80%減少する

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のブランチ一覧UIと選択UIを活用する必要がある
- ターミナル UIの制約内で実装する必要がある
- キーバインディングは既存のショートカットキー(r: リフレッシュ、m: worktree管理、c: クリーンアップ)と競合しないようにする必要がある

### 仮定

- ユーザーはターミナル操作に慣れており、スペースキー・ESCキーによる選択操作が直感的に理解できる
- ブランチ一覧は既存のロジックで正しく取得されている
- プッシュ済み/未プッシュ、マージ済み/未マージの判定は既存のロジックで正確に行われている

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です:

- リモートブランチの削除(ローカルブランチとworktreeのみが対象)
- ブランチの一括自動選択機能(例: "全てのマージ済みブランチを自動選択")
- 選択状態の永続化(セッション間での選択状態の保存)
- クリーンアップ実行のアンドゥ機能
- カスタムフィルタ機能(例: "feature/*のみ表示")

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 保護ブランチ(main/develop)は選択できないようにすることで、重要なブランチの誤削除を防止する必要がある
- プッシュされていないコミットがあるブランチは赤色の警告マーカーで明示することで、データ損失のリスクを開発者に通知する必要がある

## 依存関係 *(該当する場合)*

- 既存のブランチ一覧取得ロジック
- 既存のworktree管理機能
- 既存のブランチ削除機能
- ターミナル UIフレームワーク
- 既存の選択コンポーネント
- 既存のブランチ一覧画面コンポーネント
