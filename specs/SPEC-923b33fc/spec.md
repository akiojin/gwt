# 機能仕様: 全操作時の断続フリーズ抑止（System Monitor 負荷制御）

**仕様ID**: `SPEC-923b33fc`
**作成日**: 2026-02-14
**更新日**: 2026-02-14
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- `SPEC-a1b2c3d4`（StatusBar / About の system monitor 導入）
- `SPEC-0f8e9c12`（Sidebar 切替キャッシュ最適化）

**入力**: ユーザー説明: "Worktreeだけではなく、すべての操作で、ちょくちょく固まります。"

## 背景

- Worktree フィルター切替以外でも、操作全般で断続的な引っかかりが発生している
- 現行の `createSystemMonitor()` は `get_system_info` を 1 秒間隔で実行し、in-flight 重複抑止がない
- さらに可視状態復帰のたびにウォームアップ 2 回呼び出しが再実行され、操作系コマンドと競合しやすい

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 操作中の引っかかりを減らしたい (優先度: P0)

開発者として、ブランチ操作やエージェント操作の最中に、system monitor の定期取得で入力応答が阻害されないようにしたい。

**独立したテスト**: ポーリング中に `get_system_info` が未完了でも追加呼び出しが発生しないこと

**受け入れシナリオ**:

1. **前提条件** monitor 起動後に `get_system_info` が未完了、**操作** ポーリング間隔を複数回経過させる、**期待結果** 追加の `get_system_info` が発行されない
2. **前提条件** monitor 稼働中、**操作** 5 秒未満待機する、**期待結果** 次回ポーリングは実行されない

---

### ユーザーストーリー 2 - 可視状態復帰で過剰取得したくない (優先度: P0)

開発者として、ウィンドウ復帰時に不要なウォームアップが繰り返されず、必要最小限の再取得だけが走ってほしい。

**独立したテスト**: hidden→visible 復帰時にウォームアップが再実行されないこと

**受け入れシナリオ**:

1. **前提条件** 起動直後に 1 回ウォームアップ済み、**操作** hidden→visible を往復、**期待結果** 復帰時は通常ポーリング 1 回のみ実行される
2. **前提条件** hidden 中、**操作** ポーリング間隔を経過させる、**期待結果** `get_system_info` が実行されない

## エッジケース

- `get_system_info` 失敗時も monitor は停止せず、最後の正常値を維持して次周期で再試行する
- stop/destroy 後に in-flight リクエストが完了しても、次周期タイマーが再登録されない
- `visibilitychange` リスナーが多重登録されない

## 要件 *(必須)*

### 機能要件

- **FR-001**: `createSystemMonitor` はポーリング間隔を 5000ms にしなければならない
- **FR-002**: `get_system_info` 呼び出しは常に 1 件まで（同時 in-flight 禁止）でなければならない
- **FR-003**: ウォームアップ呼び出しは monitor ライフサイクル中に 1 回のみ実行しなければならない
- **FR-004**: `document.hidden === true` の間はポーリングを停止し、`false` 復帰時に再開しなければならない
- **FR-005**: ポーリング失敗時も monitor の公開状態（CPU/MEM/GPU の最後の値）を保持しなければならない

### 非機能要件

- **NFR-001**: 定常時の `get_system_info` 発行レートは 1 ウィンドウあたり最大 0.2 req/sec（5秒1回）であること
- **NFR-002**: 上記挙動は `gwt-gui/src/lib/systemMonitor.svelte.test.ts` の自動テストで検証可能であること

## 制約と仮定

- system monitor は StatusBar / About の表示用途であり、秒単位未満の高頻度更新は不要とする
- バックエンドコマンド名やレスポンス形式（`get_system_info`）は変更しない
- フリーズ改善は「高頻度呼び出しの抑制」と「重複呼び出し排除」を優先して達成する

## 成功基準 *(必須)*

- **SC-001**: in-flight 中にタイマーを進めても `get_system_info` の重複呼び出しが発生しない
- **SC-002**: 5 秒未満では追加ポーリングが発生せず、5 秒到達で 1 回のみ発生する
- **SC-003**: hidden→visible 復帰時にウォームアップが再実行されない
- **SC-004**: `pnpm -s vitest run src/lib/systemMonitor.svelte.test.ts` が成功する
