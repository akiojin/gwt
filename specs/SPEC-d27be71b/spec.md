# SPEC-d27be71b: Ink.js から OpenTUI への移行

## Status: Future / Under Investigation

## Overview

現在の CLI UI フレームワーク（Ink.js + React）を OpenTUI + SolidJS に移行する将来計画。
OpenTUI は OpenCode チームが開発するターミナル UI ライブラリで、Zig ベースの高性能レンダリングエンジンを持つ。

## Background

### 現在の構成

- **UIフレームワーク**: Ink.js v6.3.1
- **Reactバージョン**: React 19.2.0
- **コンポーネント数**: 15スクリーン + 10以上の共通コンポーネント
- **テスト数**: 307+

### 移行先

- **UIフレームワーク**: OpenTUI (@opentui/core, @opentui/solid)
- **リアクティビティ**: SolidJS
- **レンダリングエンジン**: Zig ネイティブバイナリ

## Motivation

### 1. パフォーマンス向上

- Zig ベースのネイティブレンダリングにより高速化
- 大量のブランチ表示時のスムーズなスクロール
- 入力レイテンシの削減

### 2. OpenCode エコシステムとの親和性

- OpenCode と同じ UI フレームワークを使用
- 将来的な機能統合や連携が容易

### 3. モダンなアーキテクチャ

- SolidJS の細粒度リアクティビティ
- 効率的な再レンダリング
- 小さいバンドルサイズ

### 4. オーバーレイ/ポップアップ機能（Ink.js の制限解消）

Ink.js は行ベースのレンダリングを採用しており、既存コンテンツの上にUIを重ねることができない。
OpenTUI は Zig ベースのレンダリングエンジンにより真のレイヤー描画をサポートする。

#### Ink.js の制限

```text
┌────────────────────────┐
│ Header                 │  ← 行1
│ Content Line 1         │  ← 行2
│ Content Line 2         │  ← 行3
│ Footer                 │  ← 行4
└────────────────────────┘
※ 重ね合わせ不可、画面遷移で対応するしかない
```

#### OpenTUI で可能になること

```text
┌────────────────────────┐
│ Background Content     │
│                        │
│    ┌──────────────┐    │  ← オーバーレイ/ポップアップ
│    │  Modal       │    │
│    │  Content     │    │
│    └──────────────┘    │
│                        │
└────────────────────────┘
```

#### 移行後に実現可能なUI改善

| 機能               | 現在 (Ink.js)    | OpenTUI 移行後         |
| ------------------ | ---------------- | ---------------------- |
| 削除確認           | 画面遷移         | インラインポップアップ |
| エラー表示         | 画面下部テキスト | モーダルダイアログ     |
| ヘルプ表示         | 別画面           | オーバーレイ           |
| クイックアクション | フッターのみ     | コンテキストメニュー   |
| フィルター選択     | 画面モード切替   | ドロップダウン         |
| 通知               | 未対応           | トースト通知           |
| ツールチップ       | 未対応           | ホバーツールチップ     |

## Technical Details

### OpenTUI アーキテクチャ

```text
┌─────────────────────────────────────────┐
│  TypeScript (UI コンポーネント)          │
│  - SolidJS / React / Vue                │
├─────────────────────────────────────────┤
│  @opentui/core (TypeScript バインディング)│
├─────────────────────────────────────────┤
│  Zig コアエンジン                        │
│  - ターミナルレンダリング                 │
│  - 入力処理                              │
│  - レイアウト計算                         │
└─────────────────────────────────────────┘
```

### 依存関係

```json
{
  "@opentui/core": "^0.1.x",
  "@opentui/solid": "^0.1.x",
  "solid-js": "^1.x"
}
```

### ビルド要件

- Zig コンパイラのインストールが必要
- CI/CD パイプラインへの Zig セットアップ追加

## Migration Strategy

### Phase 1: 並行評価（2週間）

- OpenTUI でプロトタイプスクリーンを実装
- パフォーマンス比較テスト
- Zig ビルドのパイプライン検証

### Phase 2: 抽象化レイヤー導入

- UI フレームワーク非依存のロジック分離
- ビジネスロジックとUIの分離を強化
- 将来の移行コスト削減

### Phase 3: 段階的移行（OpenTUI 安定後）

- OpenTUI v1.0 リリース後に本格移行開始
- 新規スクリーンを優先的に OpenTUI で実装
- 既存スクリーンを順次移行

## Risks and Mitigations

### リスク 1: 成熟度

**問題**: OpenTUI は公式に「not ready for production use」と宣言
**対策**: v1.0 リリースまで本格移行を待機

### リスク 2: Zig 依存

**問題**: ビルド時に Zig コンパイラが必要
**対策**: CI/CD パイプラインのテスト、Docker イメージへの Zig 追加

### リスク 3: 学習コスト

**問題**: React から SolidJS への移行学習
**対策**: 段階的移行、ドキュメント整備

### リスク 4: テスト書き換え

**問題**: 307+ のテストの移行
**対策**: 抽象化レイヤーによるロジックテストの保持

## Estimated Effort

| 作業項目                           | 工数目安    |
| ---------------------------------- | ----------- |
| 調査・プロトタイプ                 | 1週間       |
| コンポーネント移行（15スクリーン） | 2-3週間     |
| カスタムフック移行（7フック）      | 1週間       |
| ユーティリティ移行                 | 3日         |
| テストの書き換え                   | 2週間       |
| 統合テスト・バグ修正               | 1週間       |
| **合計**                           | **6-8週間** |

## Prerequisites

本仕様の実装開始前に以下の条件を満たす必要がある:

1. **OpenTUI v1.0 のリリース**
   - プロダクション対応の宣言
   - API の安定化

2. **App.tsx のリファクタリング完了**
   - ビジネスロジックと UI の分離

3. **テーマシステムの集約完了**
   - 色・アイコン定義の一元化

## References

- [OpenTUI GitHub](https://github.com/anomalyco/opentui)
- [OpenCode GitHub](https://github.com/anomalyco/opencode)
- [SolidJS Documentation](https://www.solidjs.com/docs/latest)
- [Zig Language](https://ziglang.org)
- [Ink.js (現行)](https://github.com/vadimdemedes/ink)

## Decision Log

| 日付       | 決定事項                   |
| ---------- | -------------------------- |
| 2026-01-04 | 将来計画として仕様策定開始 |

## Notes

- この仕様は将来計画であり、実装着手時期は OpenTUI の成熟度に依存する
- OpenTUI の更新を定期的にウォッチし、v1.0 リリース時に再評価する
- 現時点では Ink.js ベースでの改善（App.tsx 分割等）を優先する
