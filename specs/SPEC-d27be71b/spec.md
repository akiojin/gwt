# SPEC-d27be71b: Ink.js から OpenTUI への移行

**仕様ID**: `SPEC-d27be71b`
**作成日**: 2026-01-04
**更新日**: 2026-01-10
**ステータス**: 実装中

## Overview

現在の CLI UI フレームワーク（Ink.js + React）を OpenTUI + SolidJS に移行する計画。
開発は段階的に進めるが、リリースでは Ink.js を残さず OpenTUI に統一する。
OpenTUI v1.0 前でも移行を開始する。
OpenTUI は OpenCode チームが開発するターミナル UI ライブラリで、Zig ベースの高性能レンダリングエンジンを持つ。

**移行範囲**: CLI UI と Web UI の両方を SolidJS に統一し、コンポーネント共有を可能にする。

## Background

### 現在の構成

- **UIフレームワーク**: Ink.js v6.3.1
- **Reactバージョン**: React 19.2.0
- **コンポーネント数**: 15スクリーン + 10以上の共通コンポーネント
- **テスト数**: 307+

### 移行先

- **UIフレームワーク**: OpenTUI (@opentui/core, @opentui/solid)
- **リアクティビティ**: SolidJS
- **レンダリングエンジン**: Zig ネイティブバイナリ

### 参考: OpenCode の採用状況

- OpenCode 1.0 の TUI は OpenTUI（Zig + SolidJS）へ移行済み
- OpenCode はインストールスクリプト/パッケージマネージャ/リリースバイナリで配布される

## Motivation

### 1. パフォーマンス向上

- Zig ベースのネイティブレンダリングにより高速化
- 大量のブランチ表示時のスムーズなスクロール
- 入力レイテンシの削減

### 2. OpenCode エコシステムとの親和性

- OpenCode と同じ UI フレームワークを使用
- 将来的な機能統合や連携が容易

### 3. モダンなアーキテクチャ

- SolidJS の細粒度リアクティビティ
- 効率的な再レンダリング
- 小さいバンドルサイズ

### 4. オーバーレイ/ポップアップ機能（Ink.js の制限解消）

Ink.js は行ベースのレンダリングを採用しており、既存コンテンツの上にUIを重ねることができない。
OpenTUI は Zig ベースのレンダリングエンジンにより真のレイヤー描画をサポートする。

#### Ink.js の制限

```text
┌────────────────────────┐
│ Header                 │  ← 行1
│ Content Line 1         │  ← 行2
│ Content Line 2         │  ← 行3
│ Footer                 │  ← 行4
└────────────────────────┘
※ 重ね合わせ不可、画面遷移で対応するしかない
```

#### OpenTUI で可能になること

```text
┌────────────────────────┐
│ Background Content     │
│                        │
│    ┌──────────────┐    │  ← オーバーレイ/ポップアップ
│    │  Modal       │    │
│    │  Content     │    │
│    └──────────────┘    │
│                        │
└────────────────────────┘
```

#### 移行後に実現可能なUI改善

| 機能               | 現在 (Ink.js)    | OpenTUI 移行後         |
| ------------------ | ---------------- | ---------------------- |
| 削除確認           | 画面遷移         | インラインポップアップ |
| エラー表示         | 画面下部テキスト | モーダルダイアログ     |
| ヘルプ表示         | 別画面           | オーバーレイ           |
| クイックアクション | フッターのみ     | コンテキストメニュー   |
| フィルター選択     | 画面モード切替   | ドロップダウン         |
| 通知               | 未対応           | トースト通知           |
| ツールチップ       | 未対応           | ホバーツールチップ     |

## Technical Details

### OpenTUI アーキテクチャ

```text
┌─────────────────────────────────────────┐
│  TypeScript (UI コンポーネント)          │
│  - SolidJS / React / Vue                │
├─────────────────────────────────────────┤
│  @opentui/core (TypeScript バインディング)│
├─────────────────────────────────────────┤
│  Zig コアエンジン                        │
│  - ターミナルレンダリング                 │
│  - 入力処理                              │
│  - レイアウト計算                         │
└─────────────────────────────────────────┘
```

### 依存関係

```json
{
  "@opentui/core": "^0.1.x",
  "@opentui/solid": "^0.1.x",
  "solid-js": "^1.x"
}
```

## 非機能要件

- OpenTUI の内蔵コンソールは使用しない。CLI 実行中に「Console」オーバーレイを表示しない。
- エラー発生時もコンソールを自動表示しない（画面出力とログ出力の役割分担は SPEC-b9f5c4a1 に従う）。

### 対象プラットフォーム

- **macOS**: 全ターミナル（Terminal.app, iTerm2, Warp, etc.）
- **Linux**: 全ターミナル（GNOME Terminal, Konsole, Alacritty, etc.）
- **Windows**: Windows Terminal, PowerShell 7+ のみ
  - **cmd.exe は対象外**（VT100エスケープシーケンスの制限により除外）
  - WSL 環境は Linux 扱いでサポート

### ビルド要件

- 開発/CI 環境で Zig コンパイラが必要
- CI/CD パイプラインへの Zig セットアップ追加
- 配布物は OpenTUI のネイティブバイナリ同梱でユーザーの Zig インストールは不要

### 配布方針

OpenCode と同様に複数の配布チャネルを持つ:

- **インストールスクリプト**: `curl -fsSL https://gwt.io/install | bash`（将来構想）
- **npm**: `npm install -g @akiojin/gwt`（現行継続）
- **GitHub Releases**: スタンドアロンバイナリ（Zig 同梱）
- **パッケージマネージャー**: Homebrew, Scoop, Chocolatey（将来構想）

**調査事項**: npm パッケージにプラットフォーム別バイナリを同梱する方法

- optionalDependencies（@gwt/darwin-arm64 等）
- postinstall スクリプトでのダウンロード
- OpenCode の具体的な実装を追加調査が必要

### 品質ゲート

- 既存の自動テストはすべて維持し、移行後も同等の自動テストを必須とする
  - **テストカバレッジ 100% 維持必須**（307+ テストすべてを SolidJS 用に書き換え）
- 性能ベンチマークの合格を必須とする
  - 対象シナリオ: 5000+ ブランチ一覧表示、連続スクロール、入力反映
  - 指標: 平均フレーム時間、入力反映遅延
  - 合格条件: **厳密な数値目標**（Ink.js の現行ベースライン以上）
    - スクロール: 60fps 以上
    - 入力レイテンシ: 16ms 以下
    - 起動時間: 調査後に設定
  - **仮想スクロール**: OpenTUI 側の機能に依存。未対応の場合は自前実装を検討
- Windows ネイティブ環境での動作確認を必須とする（Windows Terminal, PowerShell 7+）

## Migration Strategy

### Phase 1: 並行評価（2週間）

- OpenTUI でプロトタイプスクリーンを実装
- Ink.js のベースライン性能計測
- パフォーマンス比較テスト
- Zig ビルドのパイプライン検証

### Phase 2: 抽象化レイヤー導入

- UI フレームワーク非依存のロジック分離
- ビジネスロジックとUIの分離を強化
- 将来の移行コスト削減

### Phase 3: 段階的移行（v1.0 前でも実施）

- OpenTUI v1.0 前でも本格移行を開始
- 移行はスクリーン単位で順次実施するが、リリースでは Ink.js を残さない
- 既存スクリーンを順次移行し、完了後に Ink.js 依存を削除
- **移行期間中のユーザー影響は許容可能**（不安定さをユーザーに伝えても OK）

#### 移行優先順位

1. **BranchListScreen**（最優先）: 最も使用頻度が高いメイン画面
2. 共通コンポーネント（Header, Footer, ScrollableList）
3. 他のスクリーンを順次移行

### 最優先 UI 改善

- **ヘルプオーバーレイ**: キーバインドや操作説明を背景に重ねて表示
  - OpenTUI のレイヤー描画機能を活用した最初の実装対象

## Risks and Mitigations

### リスク 1: 成熟度

**問題**: OpenTUI は公式に「not ready for production use」と宣言
**対策**: 品質ゲート（自動テスト/性能ベンチ）を必須化し、**各 Phase 完了時に Go/No-Go を判断**

### リスク 2: Zig 依存

**問題**: ビルド時に Zig コンパイラが必要
**対策**: CI/CD でのビルドと配布物へのバイナリ同梱を検証

### リスク 3: 学習コスト

**問題**: React から SolidJS への移行学習
**対策**: 段階的移行、ドキュメント整備。**状態管理はリファクタリング機会として活用**し、SolidJS の特性を活かした設計へ全面見直し

### リスク 4: テスト書き換え

**問題**: 307+ のテストの移行
**対策**: **100% 維持必須**。抽象化レイヤーによるロジックテストの保持

### リスク 5: Windows 互換性

**問題**: Windows ネイティブ環境での動作保証が必要
**対策**: Windows Terminal, PowerShell 7+ での動作確認を移行判定に含める（cmd.exe は対象外）

### リスク 6: OpenTUI プロジェクト放棄

**問題**: OpenTUI が放棄された場合の対応
**対策**: **OpenTUI をフォーク**して自前メンテナンスを行う

- **Zig コアはブラックボックス**として扱い、TypeScript レイヤーのみをメンテナンス
- Zig コアのバグは上流（OpenTUI / OpenCode チーム）への Issue 報告で対応
- 長期的な技術負債リスクを許容する決定

## Estimated Effort

| 作業項目                           | 工数目安    |
| ---------------------------------- | ----------- |
| 調査・プロトタイプ                 | 1週間       |
| コンポーネント移行（15スクリーン） | 2-3週間     |
| カスタムフック移行（7フック）      | 1週間       |
| ユーティリティ移行                 | 3日         |
| テストの書き換え                   | 2週間       |
| 統合テスト・バグ修正               | 1週間       |
| **合計**                           | **6-8週間** |

## Prerequisites

本仕様の本格移行（Phase 3 / リリース）前に以下の条件を満たす必要がある:

1. **性能ベースラインの取得**
   - Ink.js の現行ベンチマーク計測完了

2. **Zig ビルド/配布の検証完了**
   - CI/CD での Zig ビルド成功
   - 配布物へのバイナリ同梱が成立

3. **App.tsx のリファクタリング完了**
   - ビジネスロジックと UI の分離

4. **テーマシステムの集約完了**
   - 色・アイコン定義の一元化

## References

- [OpenTUI GitHub](https://github.com/anomalyco/opentui)
- [OpenCode GitHub](https://github.com/anomalyco/opencode)
- [OpenCode Docs: Migrating to 1.0](https://opencode.ai/docs/1-0/)
- [OpenCode Docs: Intro / Install](https://opencode.ai/docs)
- [SolidJS Documentation](https://www.solidjs.com/docs/latest)
- [Zig Language](https://ziglang.org)
- [Ink.js (現行)](https://github.com/vadimdemedes/ink)

## Decision Log

| 日付 | 決定事項 |
| ---- | -------- |
| 2026-01-04 | 将来計画として仕様策定開始 |
| 2026-01-04 | v1.0 前でも移行を開始し、早期に OpenTUI へ全面置換 |
| 2026-01-04 | Windows ネイティブ対応を対象に含める |
| 2026-01-04 | 撤退戦略: OpenTUI フォークを採用（Zig コアはブラックボックス、TS レイヤーのみメンテ） |
| 2026-01-04 | テストカバレッジ 100% 維持必須 |
| 2026-01-04 | 性能目標: 5000+ ブランチで 60fps スクロール、入力 16ms 以下 |
| 2026-01-04 | cmd.exe は対象外（VT100 制限により除外） |
| 2026-01-04 | 仮想スクロール: OpenTUI 側機能に依存 |
| 2026-01-04 | 状態管理: SolidJS 移行時にリファクタリング機会として活用 |
| 2026-01-04 | CLI + Web UI 両方を SolidJS に統一 |
| 2026-01-04 | Go/No-Go 判定: 各 Phase 完了時に実施 |
| 2026-01-04 | 移行優先順位: BranchListScreen から開始 |
| 2026-01-04 | 最優先 UI: ヘルプオーバーレイ |
| 2026-01-04 | 移行期間中のユーザー影響は許容可能 |
| 2026-01-04 | テストFW: OpenTUI/OpenCode のテスト方法を調査してから決定 |
| 2026-01-04 | i18n: 英語のみ継続（多言語対応は不要） |
| 2026-01-04 | Ink.js 依存: 移行完了と同時に即座削除 |
| 2026-01-04 | アクセシビリティ: 考慮不要（CLI のため） |
| 2026-01-04 | デバッグ: Solid DevTools 導入 + pino ログ強化 |
| 2026-01-04 | フィルター機能: 現状維持（既存機能をそのまま移植） |
| 2026-01-04 | 完了基準: 自動テスト全パス + ユーザーテスト完了 |
| 2026-01-05 | UI アイコンは ASCII に統一し、Unicode/絵文字を使わない |
| 2026-01-05 | TUI の表示記号は ASCII のみに統一（チェック/Worktree/安全判定/スピナー/罫線） |
| 2026-01-07 | ブランチ一覧の選択/Worktree/安全アイコンはASCII（`[*]`/`[ ]`、`w`/`.`/`x`、`!`/`o`）に整理し、アイコン間はスペース区切り、カーソル記号は表示しない |
| 2026-01-08 | 未コミットは安全アイコン`!`（赤）、未プッシュは`!`（黄）、未マージは`*`（黄）、安全は明るい緑の`o`で表現する |
| 2026-01-08 | 安全判定の取得中は安全アイコン位置にスピナーを表示し、リモートブランチは安全アイコンを空白で表示する |

## Completion Criteria

移行完了とみなすための基準:

1. **全スクリーン移行完了**: 15スクリーン + 共通コンポーネントすべてが OpenTUI/SolidJS に移行済み
2. **テスト全パス**: 307+ テストすべてが SolidJS 版でパス
3. **性能ベンチマーク合格**: 5000+ ブランチで 60fps スクロール、入力レイテンシ 16ms 以下
4. **ユーザーテスト完了**: 実際のユーザーによる動作確認が完了
5. **Ink.js 依存削除**: React/Ink.js 関連の依存をすべて削除済み

## Notes

- v1.0 を待たずに段階的移行を進めるが、OpenTUI の更新は定期的にウォッチする
- Ink.js 側の改善は必要最低限の保守に留める
- テストフレームワークは OpenTUI/OpenCode の方法を調査してから決定
- デバッグ体験向上のため Solid DevTools 導入 + pino ログ強化を実施
