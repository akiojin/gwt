# 機能仕様: GUI Session Summary のスクロールバック要約（実行中対応）

**仕様ID**: `SPEC-3a1b7c2d`
**作成日**: 2026-02-12
**更新日**: 2026-02-12
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- `SPEC-90217e33`（GUI: Session Summary / Quick Start）

**入力**: ユーザー説明: "エージェント起動中（タブが存在する）WorktreeのAI要約が表示されない。セッションファイルではなくスクロールバックを要約に使いたい。"

## 背景

- GUI の Session Summary は `session_id` が履歴に保存された後のみ要約生成できるため、
  **エージェント起動中（タブが存在する）では常に `No session` になる**。
- 実行中でも状況把握が必要なため、**スクロールバック（pane 単位）からの要約**を
  セッション確定前の代替入力として採用する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 実行中のエージェントでも要約が表示される (優先度: P0)

開発者として、エージェントが起動中でも Session Summary で AI 要約を確認したい。

**独立したテスト**: `get_branch_session_summary` が session_id 未保存でも
スクロールバック要約に進むことをユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** Worktreeに起動中のエージェント（pane）がある、session_id は未保存
   **操作** Summary を開く
   **期待結果** `Generating...` が表示された後、スクロールバック由来の AI 要約が表示される
2. **前提条件** 同上、**操作** Summary を開く
   **期待結果** `Live (pane summary)` と表示され、session_id 表示は行われない

### ユーザーストーリー 2 - 複数paneがある場合、最新出力のpaneが対象 (優先度: P1)

**受け入れシナリオ**:

1. **前提条件** 同一Worktreeに複数paneが起動中
   **操作** Summary を開く
   **期待結果** **最終出力が新しいpane** が要約対象になる

### ユーザーストーリー 3 - session_id確定後は既存フローに戻る (優先度: P1)

**受け入れシナリオ**:

1. **前提条件** 既に session_id が履歴に保存済み
   **操作** Summary を開く
   **期待結果** 既存のセッションファイル要約フローで表示される（スクロールバックは使用しない）

## エッジケース

- 同一Worktreeで pane が急速に増減した場合に、最新出力 pane が正しく選ばれるか
- scrollback が取得できない場合は既存の `No session` 扱いになるか

## 要件 *(必須)*

### 機能要件

- **FR-001**: Session Summary は session_id が無い場合でも、
  Worktree に起動中の pane が存在する場合はスクロールバックを要約入力として使用しなければ**ならない**。
- **FR-002**: 同一Worktreeに複数paneがある場合、
  **最終出力時刻が最新のpane** を要約対象にしなければ**ならない**。
- **FR-003**: スクロールバック要約時の表示は `Live (pane summary)` を含め、
  session_id 表示は行わない。
- **FR-004**: session_id が確定した後は、既存のセッションファイル要約に**切り替え**なければならない。
- **FR-005**: スクロールバック要約は **読み取り専用** とし、設定/履歴ファイルの書き込みを行っては**ならない**。

### 非機能要件

- **NFR-001**: UI 表示は英語のみ（CLAUDE.md 準拠）。
- **NFR-002**: スクロールバックは ANSI 除去済みテキストを使用する。

## 制約と仮定

- pane は `pane_id` 単位でスクロールバックが保存される。
- `capture_scrollback_tail` で取得できる範囲を要約入力とする。
- Summary の表示は 1 つのみであり、複数paneの同時表示は行わない。

## 成功基準 *(必須)*

- **SC-001**: 起動中エージェントの Summary が `No session` にならず、要約が表示される。
- **SC-002**: 複数paneのある Worktree で最新出力 pane が要約対象になる。
- **SC-003**: session_id 確定後は既存フローへ切り替わる。
