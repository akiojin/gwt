# 機能仕様: GUI Worktree Summary のスクロールバック要約（実行中対応）

**仕様ID**: `SPEC-3a1b7c2d`
**作成日**: 2026-02-12
**更新日**: 2026-02-15
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- `SPEC-90217e33`（GUI: Session Summary / Quick Start）

**入力**: ユーザー説明: "エージェント起動中（タブが存在する）WorktreeのAI要約が表示されない。セッションファイルではなくスクロールバックを要約に使いたい。"

## 背景

- GUI の Session Summary は `session_id` が履歴に保存された後のみ要約生成できるため、
  **エージェント起動中（タブが存在する）では常に `No session` になる**。
- 実行中でも状況把握が必要なため、**スクロールバック（pane 単位）からの要約**を
  セッション確定前の代替入力として採用する。
- さらに、ブランチ単位で「今どんな作業をしているか / 後で何をしていたか」を振り返りたいが、
  生成済みの要約が**即座に表示されない**、また要約が**大幅に変わって見える**ことがある。
  これは要約入力が `session` と `scrollback` で切り替わること、入力の更新（mtime）やサンプリングにより
  出力が変動し得ることが要因になり得る。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 実行中のエージェントでも要約が表示される (優先度: P0)

開発者として、エージェントが起動中でも Worktree Summary パネルで AI 要約を確認したい。

**独立したテスト**: `get_branch_session_summary` が session_id 未保存でも
スクロールバック要約に進むことをユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** Worktreeに起動中のエージェント（pane）がある、session_id は未保存
   **操作** Worktree を選択する
   **期待結果** `Generating...` が表示された後、スクロールバック由来の AI 要約が表示される
2. **前提条件** 同上、**操作** Worktree を選択する
   **期待結果** `Live (pane summary)` と表示され、session_id 表示は行われない

### ユーザーストーリー 2 - 複数paneがある場合、最新出力のpaneが対象 (優先度: P1)

**受け入れシナリオ**:

1. **前提条件** 同一Worktreeに複数paneが起動中
   **操作** Worktree を選択する
   **期待結果** **最終出力が新しいpane** が要約対象になる

### ユーザーストーリー 3 - session_id確定後は既存フローに戻る (優先度: P1)

**受け入れシナリオ**:

1. **前提条件** 既に session_id が履歴に保存済み
   **操作** Worktree を選択する
   **期待結果** 既存のセッションファイル要約フローで表示される（スクロールバックは使用しない）

### ユーザーストーリー 4 - ブランチの作業状況を後で確認できる (優先度: P0)

開発者として、ブランチで「何をしていたか」と「現在どのような作業をしているか」を、
後からすぐに確認したい。

**独立したテスト**: 永続キャッシュが存在する場合、`get_branch_session_summary` が即座に
キャッシュ内容を返すことをユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** あるブランチで要約が一度生成されている、**操作** アプリを再起動して同ブランチを選択する、
   **期待結果** 要約が即座に表示される（LLM生成待ちで空にならない）
2. **前提条件** 対象ブランチにタブが存在しない、**操作** ブランチを選択する、
   **期待結果** 要約はキャッシュ済みの内容のみを表示し、自動更新は行われない

### ユーザーストーリー 5 - Liveの更新頻度が適切で、変更がない限り更新しない (優先度: P0)

開発者として、Live要約は必要な頻度で更新される一方、スクロールバックに変更がない場合は更新されない状態で扱いたい。

**受け入れシナリオ**:

1. **前提条件** 対象ブランチにタブが存在し、かつフォーカスされている、**操作** Summary を表示する、
   **期待結果** 15秒単位で更新チェックされる
2. **前提条件** 対象ブランチにタブが存在するがフォーカスされていない、**操作** Summary を表示する、
   **期待結果** 60秒単位で更新チェックされる
3. **前提条件** Live要約の対象 pane のスクロールバックに変更がない、**操作** 更新チェックが走る、
   **期待結果** 要約は再生成されない（更新しない）

### ユーザーストーリー 6 - 何を要約しているかが分かる (優先度: P0)

開発者として、表示中の要約が「何を要約しているか」を把握し、要約の変動理由を追えるようにしたい。

**受け入れシナリオ**:

1. **前提条件** Summary が表示されている、**操作** Summary のヘッダ情報を見る、
   **期待結果** 要約ソース（session / Live）、識別子（toolId + sessionId / paneId）、入力の更新時刻が表示される

## エッジケース

- 同一Worktreeで pane が急速に増減した場合に、最新出力 pane が正しく選ばれるか
- scrollback が取得できない場合は既存の `No session` 扱いになるか

## 要件 *(必須)*

### 機能要件

- **FR-001**: Worktree Summary パネルは session_id が無い場合でも、
  Worktree に起動中の pane が存在する場合はスクロールバックを要約入力として使用しなければ**ならない**。
- **FR-002**: 同一Worktreeに複数paneがある場合、
  **最終出力時刻が最新のpane** を要約対象にしなければ**ならない**。
- **FR-003**: スクロールバック要約時の表示は `Live (pane summary)` を含め、
  session_id 表示は行わない。
- **FR-004**: session_id が確定した後は、既存のセッションファイル要約に**切り替え**なければならない。
- **FR-005**: スクロールバック要約は **読み取り専用** とし、設定/履歴ファイルの書き込みを行っては**ならない**。
- **FR-006**: 生成済み要約はアプリ再起動後も即座に表示できるよう、ブランチ単位の要約キャッシュを永続化しなければ**ならない**。
- **FR-007**: 対象ブランチにタブが存在しない場合、要約はキャッシュ済みの内容のみを表示し、自動更新を行っては**ならない**。
- **FR-008**: 対象ブランチにタブが存在し、かつフォーカスされている場合、要約は15秒単位で更新チェックされなければ**ならない**。
- **FR-009**: 対象ブランチにタブが存在するがフォーカスされていない場合、要約は60秒単位で更新チェックされなければ**ならない**。
- **FR-010**: Live要約は、スクロールバックに変更がない場合は再生成しては**ならない**。
- **FR-011**: Summary は「何を要約しているか」（入力ソース/識別子/入力更新時刻）が分かる情報を表示しなければ**ならない**。

### 非機能要件

- **NFR-001**: UI 表示は英語のみ（CLAUDE.md 準拠）。
- **NFR-002**: スクロールバックは ANSI 除去済みテキストを使用する。

## 制約と仮定

- pane は `pane_id` 単位でスクロールバックが保存される。
- `capture_scrollback_tail` で取得できる範囲を要約入力とする。
- Summary の表示は 1 つのみであり、複数paneの同時表示は行わない。

## 成功基準 *(必須)*

- **SC-001**: 起動中エージェントの Summary が `No session` にならず、要約が表示される。
- **SC-002**: 複数paneのある Worktree で最新出力 pane が要約対象になる。
- **SC-003**: session_id 確定後は既存フローへ切り替わる。
- **SC-004**: アプリ再起動後も、生成済みの要約が即座に表示される。
- **SC-005**: タブ無しはキャッシュ表示のみ、Liveフォーカスは15秒、Live非フォーカスは60秒で挙動が分かれる。
- **SC-006**: スクロールバックに変更がない場合、Live要約は再生成されない。
- **SC-007**: Summary から入力ソース/識別子/入力更新時刻が確認できる。
