# 機能仕様: AIツール終了時の未コミット警告と未プッシュ確認

**仕様ID**: `SPEC-b0b1b0b1`
**作成日**: 2025-12-20
**ステータス**: 実装済み
**入力**: ユーザー説明: "AIツールの終了時に未コミット/未プッシュがある場合は警告を表示し、3秒待機後にブランチ一覧へ戻るようにしたい。push確認や自動pushは行わない。"

## ユーザーシナリオとテスト *(必須)*

<!--
  重要: ユーザーストーリーは重要度順に優先順位付けする必要があります。
  各ユーザーストーリー/ジャーニーは独立してテスト可能である必要があります。
  つまり、1つだけ実装しても、価値を提供する実行可能なMVP（Minimum Viable Product）が得られる必要があります。

  各ストーリーに優先度（P1、P2、P3など）を割り当てます。P1が最も重要です。
  各ストーリーを、独立して以下が可能な機能のスライスとして考えてください：
  - 独立した開発
  - 独立したテスト
  - 独立したデプロイ
  - ユーザーへの独立したデモンストレーション
-->

### ユーザーストーリー 1 - 終了時の未コミット警告と未プッシュ確認 (優先度: P1)

開発者がAIツールのセッションを終了した直後、作業ツリーに未コミット/未プッシュが残っていることを把握し、警告を確認した上で自動的にブランチ一覧へ戻れる。

**この優先度の理由**: セッション終了直後の状態確認は誤忘れを防ぐ重要ポイントであり、戻る前に可視化されることが最も価値が高い。

**独立したテスト**: `handleAIToolWorkflow` の終了処理に対して、未コミット時の警告表示と未プッシュ時の確認分岐（push/no push）をユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** ワークツリーに未コミット変更がある、**操作** AIツールを終了、**期待結果** 未コミット警告が表示され、3秒待機後にブランチ一覧へ戻る
2. **前提条件** ワークツリーに未プッシュコミットがある、**操作** AIツールを終了、**期待結果** 未プッシュ警告が表示され、3秒待機後にブランチ一覧へ戻る
3. **前提条件** 未コミット変更と未プッシュコミットが両方ある、**操作** AIツールを終了、**期待結果** 警告が順に表示され、3秒待機後にブランチ一覧へ戻る

---

### ユーザーストーリー 2 - 非対話環境でも停止しない (優先度: P2)

非TTYや自動化環境でも、終了時チェックが入力待ちで停止せずに安全に終了する。

**この優先度の理由**: CI/自動化でのハングは致命的なため、対話不可時の安全動作が必要。

**独立したテスト**: 非TTY条件でプロンプト関数が即時終了することをユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** stdinが非TTY、**操作** AIツールを終了、**期待結果** 追加入力待ちなく終了処理が完了する（3秒待機のみ）

---

### エッジケース

- Git状態取得に失敗した場合、警告を出してスキップし、終了処理は継続する
- 未コミットと未プッシュが同時に存在する場合でも、警告を順に表示してから戻る

## 要件 *(必須)*

<!--
  対応必要: このセクションの内容はプレースホルダーです。
  適切な機能要件を記入してください。
-->

### 機能要件

- **FR-001**: システムはAIツール終了後、対象ワークツリーの未コミット変更と未プッシュコミットの有無を判定**しなければならない**
- **FR-002**: 未コミット変更がある場合、終了時に警告メッセージを表示**しなければならない**
- **FR-003**: 未プッシュコミットがある場合、終了時に警告メッセージを表示**しなければならない**
- **FR-004**: 未コミット変更または未プッシュコミットが存在する場合、警告表示後に3秒待機してブランチ一覧へ戻る**しなければならない**
- **FR-005**: 終了時チェックはユーザー入力を要求せず、push確認や自動pushを行って**はならない**
- **FR-006**: stdinが非TTYの場合でも入力待ちで停止**してはならない**（3秒待機のみ）

### 主要エンティティ

- **PostSessionCheck**: AIツール終了後に行うGit状態確認とユーザー確認の一連処理

## 成功基準 *(必須)*

<!--
  対応必要: 測定可能な成功基準を定義してください。
  これらは技術に依存せず、測定可能である必要があります。
-->

### 測定可能な成果

- **SC-001**: 未コミット/未プッシュがある場合に終了時警告が必ず表示される（ユニットテストで検証）
- **SC-002**: 未コミット/未プッシュがある場合に3秒待機後にブランチ一覧へ戻る（ユニットテストで検証）
- **SC-003**: 非TTY環境でも入力待ちで停止せず、処理が完了する（ユニットテストで検証）

## 制約と仮定 *(該当する場合)*

<!--
  対応必要: 技術的制約、ビジネス制約、または重要な仮定を記載してください。
-->

### 制約

- 既存の`handleAIToolWorkflow`終了処理を維持する（3秒待機のタイミングは維持）
- Web UI ではなくCLIの終了時処理のみ対象

### 仮定

- `worktreePath` と `branch` はAIツール起動時に確定している

## 範囲外 *(必須)*

<!--
  対応必要: この機能の範囲外であることを明確にしてください。
-->

次の項目は、この機能の範囲外です：

- 未コミット変更の自動コミット/自動スタッシュ
- push確認や自動pushの再導入
- Web UIでの同等の確認ダイアログ

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 追加のセキュリティ考慮事項はなし（本フローでpushは行わない）

## 依存関係 *(該当する場合)*

- `src/git.ts` のGit状態判定関数（未コミット/未プッシュ）

## 参考資料 *(該当する場合)*

- [既存実装: AIツール終了処理](../../src/index.ts)
