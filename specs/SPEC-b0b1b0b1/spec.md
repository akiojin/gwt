# 機能仕様: AIツール終了時の未コミット警告と未プッシュ確認

**仕様ID**: `SPEC-b0b1b0b1`
**作成日**: 2025-12-20
**ステータス**: 実装済み
**入力**: ユーザー説明: "AIツールの終了時に、未プッシュがある状態の場合、プッシュするかどうか尋ねるようにしたい。未コミットがある場合は、警告で未コミットがある点を表示。終了時に3秒の待機があると思うので、その段階で表示。未プッシュは尋ねた後に、3秒のウェイト"

## ユーザーシナリオとテスト *(必須)*

<!--
  重要: ユーザーストーリーは重要度順に優先順位付けする必要があります。
  各ユーザーストーリー/ジャーニーは独立してテスト可能である必要があります。
  つまり、1つだけ実装しても、価値を提供する実行可能なMVP（Minimum Viable Product）が得られる必要があります。

  各ストーリーに優先度（P1、P2、P3など）を割り当てます。P1が最も重要です。
  各ストーリーを、独立して以下が可能な機能のスライスとして考えてください：
  - 独立した開発
  - 独立したテスト
  - 独立したデプロイ
  - ユーザーへの独立したデモンストレーション
-->

### ユーザーストーリー 1 - 終了時の未コミット警告と未プッシュ確認 (優先度: P1)

開発者がAIツールのセッションを終了した直後、作業ツリーに未コミット/未プッシュが残っていることを把握し、必要ならその場でプッシュ判断を行える。

**この優先度の理由**: セッション終了直後の状態確認は誤忘れを防ぐ重要ポイントであり、戻る前に可視化されることが最も価値が高い。

**独立したテスト**: `handleAIToolWorkflow` の終了処理に対して、未コミット時の警告表示と未プッシュ時の確認分岐（push/no push）をユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** ワークツリーに未コミット変更がある、**操作** AIツールを終了、**期待結果** 未コミット警告が表示され、3秒待機後にメインメニューへ戻る
2. **前提条件** ワークツリーに未プッシュコミットがある、**操作** AIツールを終了して「pushする」を選択、**期待結果** push処理が走り、結果が表示され、3秒待機後にメインメニューへ戻る
3. **前提条件** ワークツリーに未プッシュコミットがある、**操作** AIツールを終了して「pushしない」を選択、**期待結果** pushは実行されず、3秒待機後にメインメニューへ戻る

---

### ユーザーストーリー 2 - 非対話環境でも停止しない (優先度: P2)

非TTYや自動化環境でも、終了時チェックが入力待ちで停止せずに安全に終了する。

**この優先度の理由**: CI/自動化でのハングは致命的なため、対話不可時の安全動作が必要。

**独立したテスト**: 非TTY条件でプロンプト関数が即時終了することをユニットテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** stdinが非TTY、**操作** AIツールを終了、**期待結果** 追加入力待ちなく終了処理が完了する

---

### エッジケース

- Git状態取得に失敗した場合、警告を出してスキップし、終了処理は継続する
- pushに失敗した場合、警告を表示して戻る（中断しない）
- 未コミットと未プッシュが同時に存在する場合でも、警告と確認を順に行う

## 要件 *(必須)*

<!--
  対応必要: このセクションの内容はプレースホルダーです。
  適切な機能要件を記入してください。
-->

### 機能要件

- **FR-001**: システムはAIツール終了後、対象ワークツリーの未コミット変更と未プッシュコミットの有無を判定**しなければならない**
- **FR-002**: 未コミット変更がある場合、終了時に警告メッセージを表示**しなければならない**
- **FR-003**: 未プッシュコミットがある場合、終了時にプッシュ確認（Yes/No）を表示**しなければならない**
- **FR-004**: ユーザーがYesを選択した場合、対象ブランチを`origin`へpush（必要ならupstream設定）**しなければならない**
- **FR-005**: push失敗時は警告を表示し、終了処理を中断**してはならない**
- **FR-006**: 未プッシュ確認はAIツール終了直後に行い、3秒待機は確認後に実行**しなければならない**
- **FR-007**: stdinが非TTYの場合は確認をスキップし、デフォルトでNoとして扱い**停止してはならない**
- **FR-008**: 確認入力はInkと同じターミナルストリームを使い、rawモード解除を行い**なければならない**

### 主要エンティティ

- **PostSessionCheck**: AIツール終了後に行うGit状態確認とユーザー確認の一連処理

## 成功基準 *(必須)*

<!--
  対応必要: 測定可能な成功基準を定義してください。
  これらは技術に依存せず、測定可能である必要があります。
-->

### 測定可能な成果

- **SC-001**: 未コミット/未プッシュがある場合に終了時メッセージが必ず表示される（ユニットテストで検証）
- **SC-002**: 未プッシュ確認でYesを選んだ場合に1回だけpushが実行される（ユニットテストで検証）
- **SC-003**: 非TTY環境でプロンプトが即時終了し、処理が停止しない（ユニットテストで検証）

## 制約と仮定 *(該当する場合)*

<!--
  対応必要: 技術的制約、ビジネス制約、または重要な仮定を記載してください。
-->

### 制約

- 既存の`handleAIToolWorkflow`終了処理（3秒待機）を維持する
- Web UI ではなくCLIの終了時処理のみ対象

### 仮定

- `worktreePath` と `branch` はAIツール起動時に確定している

## 範囲外 *(必須)*

<!--
  対応必要: この機能の範囲外であることを明確にしてください。
-->

次の項目は、この機能の範囲外です：

- 未コミット変更の自動コミット/自動スタッシュ
- Web UIでの同等の確認ダイアログ

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- pushはユーザーの明示的な確認後にのみ実行する

## 依存関係 *(該当する場合)*

- `src/git.ts` のGit状態判定関数（未コミット/未プッシュ）
- `src/utils/terminal.ts` のターミナルストリーム取得

## 参考資料 *(該当する場合)*

- [既存実装: AIツール終了処理](../../src/index.ts)
