# 機能仕様: Terminal ANSI Diagnostics（GUI）

**仕様ID**: `SPEC-5b7a0f9c`  
**作成日**: 2026-02-09  
**ステータス**: ドラフト  
**カテゴリ**: GUI / Terminal

**入力**: ユーザー説明: "xterm のカラー表示が対応されていないように見える。エージェントが PTY を認識していない可能性がある。"

## 背景

gwt GUI は、エージェント（Codex / Claude Code / Gemini など）を PTY 上で起動し、出力を xterm.js へストリーム表示する。

しかし、ユーザー視点では「色が出ない」現象が発生し得る。原因は大きく以下の2つに分かれる。

- **A. 出力に ANSI カラー（SGR）自体が含まれていない**
  - 例: エージェントが内部で `git diff` 等を capture/pipeline しており、ツールが非TTY扱いで色を落とす
  - 例: エージェント/依存 CLI が色を出さない設定・出力形態になっている
- **B. ANSI カラーは含まれるが、表示経路（xterm 書き込み/レンダラ/設定）が解釈できていない**

現状はどちらかを UI 上で即断できず、調査に時間がかかる。よって、**アプリ内で ANSI/カラーの有無を診断できる機能**を提供する。

併せて、`branch -> paneId` のインデックスがリポジトリを跨いで衝突しないよう、保存先をリポジトリ単位に分離する。

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - アクティブなターミナルの ANSI/カラー有無を診断する (優先度: P1)

開発者として、表示中のエージェントターミナルが ANSI カラーを出しているのか（SGR の色指定が流れているのか）を、GUI 内で即座に知りたい。

**受け入れシナリオ**:

1. **前提条件** エージェントターミナルタブがアクティブ、**操作** メニューから「Terminal Diagnostics」を実行、**期待結果** 対象ペインの `paneId` と、ANSI/SGR/カラーSGRの検出結果が表示される
2. **前提条件** 出力に色SGRが含まれない、**操作** Diagnostics を実行、**期待結果** 「この出力には色コードが含まれていない」旨と、代表的な対処（例: `git -c color.ui=always`、`rg --color=always`）が表示される
3. **前提条件** 出力に色SGRが含まれる、**操作** Diagnostics を実行、**期待結果** 「色コードが検出された」旨が表示され、表示経路側を疑うための次のステップが示される

### エッジケース

- ログファイルが存在しない/読み取れない場合でも、UI が固まらずエラー表示になること
- ログが巨大でも、診断は末尾の一定バイト数のみを読み取り高速に完了すること
- プロジェクトを跨いで同名ブランチが存在しても、branch->paneId の保存先が衝突しないこと

## 要件

### 機能要件

- **FR-450**: システムは、指定 `paneId` のスクロールバックログ末尾を解析し、ANSI/SGR/カラーSGR の検出結果を返さなければ**ならない**
- **FR-451**: GUI は、アクティブなエージェントタブに対して Diagnostics を実行できなければ**ならない**
- **FR-452**: Diagnostics は、色SGR が検出されない場合に代表的な対処コマンドを提示しなければ**ならない**
- **FR-453**: branch->paneId のインデックスはリポジトリ単位で保存され、他リポジトリと衝突しては**ならない**

### 非機能要件

- **NFR-450**: Diagnostics はログ全体を読み込まず、末尾 N bytes（例: 256KB）だけで判定しなければ**ならない**

## インターフェース（フロント/バック間）

### Tauri Commands

- `probe_terminal_ansi(pane_id: string) -> TerminalAnsiProbe`
  - `TerminalAnsiProbe` は少なくとも `pane_id`, `bytes_scanned`, `esc_count`, `sgr_count`, `color_sgr_count`, `has_256_color`, `has_true_color` を含む

### UI

- メニュー: `Agent -> Terminal Diagnostics`

## 範囲外

- エージェントや個別 CLI の色出力を gwt が強制すること（副作用が大きいため）
- xterm.js のテーマやレンダラ最適化（本仕様では診断の提供に限定）

