# 機能仕様: gwt GUI プロジェクト管理 Phase 2 追加機能

**仕様ID**: `SPEC-dfb1611a`
**作成日**: 2026-02-08
**ステータス**: ドラフト
**依存仕様**: `SPEC-d6210238`（TUI→Tauri GUI完全移行 Phase 1: 基盤構築）
**入力**: ユーザー説明: "gwt GUI プロジェクト管理機能 Phase 2"

## 背景

SPEC-d6210238 で定義された Phase 1（基盤構築）の Open Project（FR-228〜FR-230）、
ブランチリスト（FR-225）、メニューバー・タブ・ステータスバー等は既に実装済み。

本仕様は Phase 1 の上に構築する追加機能を定義する：

- 新規プロジェクト作成（GitHub bare clone）
- システムトレイ常駐
- エラーの UI 表示改善
- Recent Projects のパス検証と自動除外

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - 新規プロジェクト作成 (優先度: P1)

GitHubリポジトリのURLを指定し、親ディレクトリを選択すると、
親ディレクトリ配下に`<repo>.git`としてbare cloneを実行し、
完了後に自動的にプロジェクトとして開く。

**この優先度の理由**: gwt はbare リポジトリ前提の設計であり、新規プロジェクトのセットアップを
GUI から行えないと、常にCLIに戻る必要がある。

**独立したテスト**: GitHubリポジトリURLと親ディレクトリを指定し、bare clone完了後に
プロジェクトとして開かれ、ブランチ一覧が表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** OpenProject画面が表示されている、**操作** 「New Project」ボタンをクリックし、GitHubリポジトリURL（`https://github.com/owner/repo`）を入力、親ディレクトリを選択して「Create」をクリック、**期待結果** `<親ディレクトリ>/repo.git`としてbare cloneが実行され、完了後にプロジェクトとして開かれる
2. **前提条件** New Projectフォームが表示されている、**操作** 無効なURLを入力して「Create」をクリック、**期待結果** UIにエラーメッセージ「Invalid repository URL」が表示される
3. **前提条件** New Projectフォームが表示されている、**操作** clone中にネットワークエラーが発生、**期待結果** UIにエラーメッセージが表示され、不完全なディレクトリはクリーンアップされる
4. **前提条件** New Projectフォームが表示されている、**操作** clone中にプログレスを確認、**期待結果** clone進行状況がUIに表示される（完了まで待つ必要があることが分かる）

---

### ユーザーストーリー 2 - システムトレイ常駐 (優先度: P1)

ウィンドウの閉じるボタンを押してもアプリは終了せず、システムトレイに常駐する。
アプリの完全終了はシステムトレイのコンテキストメニューから「Quit」を選択した場合のみ。

**この優先度の理由**: エージェントの長時間実行中にウィンドウを誤って閉じてもプロセスが継続し、
ターミナルセッションが失われない。

**独立したテスト**: ウィンドウを閉じた後にシステムトレイアイコンからウィンドウを再表示できることで検証。

**受け入れシナリオ**:

1. **前提条件** gwt GUIが起動している、**操作** ウィンドウの閉じるボタン（x）をクリック、**期待結果** ウィンドウが非表示になるがアプリは終了せず、システムトレイにアイコンが残る
2. **前提条件** ウィンドウが非表示でシステムトレイにアイコンがある、**操作** システムトレイアイコンをクリック、**期待結果** ウィンドウが再表示され、以前の状態（開いていたプロジェクト、タブ等）が維持される
3. **前提条件** システムトレイにアイコンがある、**操作** システムトレイアイコンを右クリックし「Quit」を選択、**期待結果** アプリが完全に終了する（プロセスもなくなる）

---

### ユーザーストーリー 3 - エラーの UI 表示 (優先度: P1)

バックエンドコマンドの失敗時に、console.errorだけでなくUI上にエラーメッセージを表示する。
ユーザーが問題を理解し対処できる情報を提供する。

**この優先度の理由**: エラーがサイレントに失敗するとユーザーは何が起きたか分からず、
機能が壊れているように見える。

**独立したテスト**: 無効なパスでプロジェクトを開こうとし、UIにエラーメッセージが表示されることで検証。

**受け入れシナリオ**:

1. **前提条件** OpenProject画面が表示されている、**操作** Gitリポジトリでないディレクトリを開こうとする、**期待結果** UIにエラーメッセージがインラインで表示される
2. **前提条件** Recent Projectsに存在しないパスのエントリがある、**操作** そのエントリをクリック、**期待結果** UIにエラーメッセージが表示され、当該エントリがリストから自動除外される
3. **前提条件** プロジェクトが開かれている、**操作** ブランチ一覧の取得に失敗する、**期待結果** サイドバーにエラーメッセージが表示される（空リストではなくエラー理由が分かる）

---

### エッジケース

- bareリポジトリのパスが`<repo>.git`形式でなく通常のディレクトリ名の場合でも正常に開けること
- worktreeディレクトリ（`.git`がファイルで本体を指すもの）を開いた場合の動作
- プロジェクトを開いた後にディレクトリが外部で削除された場合の動作
- bare clone中にウィンドウを閉じた場合（システムトレイ常駐によりプロセスは継続するか）
- ネットワーク接続がない状態で New Project を試みた場合
- 同名のディレクトリが既に存在する場合の bare clone

## 要件

### 機能要件

- **FR-300**: GitHubリポジトリURLからbare cloneで新規プロジェクトを作成できなければ**ならない**
- **FR-301**: bare cloneは`<親ディレクトリ>/<repo>.git`の形式で作成**しなければならない**
- **FR-302**: clone中は進行状況をUIに表示**しなければならない**
- **FR-303**: clone失敗時は不完全なディレクトリをクリーンアップ**しなければならない**
- **FR-304**: clone完了後、自動的にプロジェクトとして開か**なければならない**
- **FR-310**: ウィンドウの閉じるボタンでアプリは終了せず、システムトレイに常駐**しなければならない**
- **FR-311**: システムトレイのコンテキストメニューから「Quit」で完全終了**しなければならない**
- **FR-312**: システムトレイアイコンのクリックでウィンドウを再表示**しなければならない**
- **FR-313**: ウィンドウ再表示時に以前の状態（プロジェクト、タブ等）が維持**されなければならない**
- **FR-320**: バックエンドコマンド失敗時にUI上にエラーメッセージを表示**しなければならない**
- **FR-321**: Recent Projectsの存在しないパスはクリック時にエラー表示し、リストから自動除外**しなければならない**
- **FR-322**: ブランチ一覧取得失敗時にサイドバーにエラーメッセージを表示**しなければならない**

### 主要エンティティ

- **NewProjectRequest**: 新規プロジェクト作成リクエスト。リポジトリURL、親ディレクトリパスを持つ
- **CloneProgress**: clone進行状況。段階（receiving/resolving）、進捗率を持つ
- **AppError**: UIに表示するエラー。メッセージ、エラー種別（path/network/git）を持つ

## 成功基準

### 測定可能な成果

- **SC-001**: New Projectから3ステップ以内にbare cloneが開始される
- **SC-002**: ウィンドウを閉じてもシステムトレイから再表示でき、状態が100%維持される
- **SC-003**: エラー発生時に100%のケースでUIにエラーメッセージが表示される
- **SC-004**: 存在しないRecent Projectエントリが自動的にリストから除外される

## 制約と仮定

### 制約

- SPEC-d6210238 で構築された gwt-tauri / gwt-gui の既存構造上に構築する
- macOS / Windows / Linux クロスプラットフォーム対応が必要

### 仮定

- ユーザーのシステムにGitがインストールされている
- GitHubリポジトリへのネットワークアクセスが可能（New Project機能）
- Tauri v2 のシステムトレイ API が利用可能

## 範囲外

次の項目は、この機能の範囲外です：

- GitHubリポジトリの認証管理（SSH鍵・トークン）
- ターミナル統合（xterm.js）の詳細仕様（別スペック）
- エージェント起動・管理の詳細仕様（別スペック）
- 設定画面の詳細仕様（別スペック）

## 依存関係

- SPEC-d6210238: Phase 1 基盤（Open Project、ブランチリスト、レイアウト）
- gwt-core: Git操作API（Branch, Repository等）
- tauri-plugin-dialog: ファイルダイアログ
- tauri-plugin-store: 履歴永続化
- tauri v2 tray API: システムトレイ
