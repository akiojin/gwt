# 機能仕様: Project Version History（タグ単位のAI要約 + 簡易CHANGELOG）

**仕様ID**: `SPEC-133bf64f`
**作成日**: 2026-02-10
**ステータス**: 実装完了
**カテゴリ**: GUI / Git / AI
**依存仕様**: `SPEC-4470704f`（Nativeメニュー）, `SPEC-a3f4c9df`（Profiles/AI設定）
**入力**: ユーザー説明: "CHANGELOGを見るのではなく、AI設定が有効な場合に、メニューにバージョン単位の変更履歴が表示される。バージョン単位で要約と簡単なCHANGELOGが含められる。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - バージョン単位の更新履歴を確認したい (優先度: P0)

開発者として、リポジトリの更新内容をバージョン単位（`vX.Y.Z` タグ単位）で素早く確認したい。
CHANGELOG.md はコミットログ粒度で情報量が多くなるため、AI要約と簡易CHANGELOGで概要を把握できるようにしたい。

**独立したテスト**: AI設定を有効にした状態でプロジェクトを開き、`Git > Version History...` から `Version History` タブを開けることを確認できる。

**受け入れシナリオ**:

1. **前提条件** プロジェクトが開かれている、AI設定が構成済み、**操作** ネイティブメニュー `Git` を開く、**期待結果** `Version History...` が表示される
2. **前提条件** `Version History...` が表示されている、**操作** `Version History...` をクリックする、**期待結果** `Version History` タブが開き、`Unreleased (HEAD)` と `v*` タグが一覧表示される
3. **前提条件** `Version History` タブが開いている、**期待結果** 各バージョン項目に対して生成状態（generating）が表示され、完了後に AI要約（英語）と簡易CHANGELOGが表示される

---

### ユーザーストーリー 2 - タグが無いプロジェクトでも直近変更を要約したい (優先度: P1)

開発者として、タグがまだ切られていないリポジトリでも、直近の変更（`HEAD`）を要約して把握したい。

**受け入れシナリオ**:

1. **前提条件** `v*` タグが存在しないプロジェクトを開く、AI設定が構成済み、**操作** `Git > Version History...` を開く、**期待結果** `Unreleased (HEAD)` のみが表示され、要約と簡易CHANGELOGが生成される

---

### ユーザーストーリー 3 - 失敗しても簡易CHANGELOGだけは見たい (優先度: P1)

開発者として、AI要約が失敗しても、コミット由来の簡易CHANGELOGで最低限の変更点を確認したい。

**受け入れシナリオ**:

1. **前提条件** AI APIが一時的に失敗する（認証/レート制限/ネットワーク等）、**操作** `Version History` を開く、**期待結果** エラーが表示されるが、簡易CHANGELOGは表示される

### エッジケース

- `v*` タグは `--sort=-v:refname` により新しい順で扱われること
- 対象コミット数が多い場合、簡易CHANGELOGの各グループは最大表示件数を持ち、超過分は `(+N more)` として省略されること
- UI表示文字列は英語のみとする。ただし、コミットメッセージは外部入力のため日本語を含む可能性がある（そのまま表示して良い）
- bareリポジトリ（gwtプロジェクト形式）でも動作すること（gitコマンドは bare でも動く範囲のみ使用）
- 生成中にプロジェクトを切り替えた場合、古いプロジェクトの結果でUIが汚染されないこと

## 要件 *(必須)*

### 機能要件

- **FR-600**: システムは、AI設定が構成済みでプロジェクトが開かれている場合に限り `Git > Version History...` を表示**しなければならない**
- **FR-601**: `Git > Version History...` を選択すると `Version History` タブを開く**ことができなければならない**
- **FR-602**: `Version History` タブは、`Unreleased (HEAD)` と最新 `v*` タグ（最大9件）を一覧表示**しなければならない**
- **FR-603**: システムは、プロジェクトのCHANGELOG.mdを読み取っては**ならない**。バージョン履歴は Gitタグとコミットログから生成**しなければならない**
- **FR-604**: システムは、各バージョン範囲に対して簡易CHANGELOG（コミットsubject由来のグルーピング）を生成**しなければならない**
- **FR-605**: システムは、AIにより各バージョン範囲の要約を英語Markdownで生成**しなければならない**
- **FR-606**: AI要約の出力は `## Summary` と `## Highlights` を含み、Highlightsは箇条書き（3-5件）でなければ**ならない**
- **FR-607**: 生成処理はUIスレッドをブロックせず、バックグラウンドで実行**しなければならない**
- **FR-608**: バージョン生成結果はキャッシュされ、同一コミット範囲（OID一致）で再生成しない**ことが望ましい**
- **FR-609**: AI要約が失敗した場合でも、簡易CHANGELOGを表示**しなければならない**

### 非機能要件

- **NFR-600**: gitコマンドは対話プロンプトを出さず（`GIT_TERMINAL_PROMPT=0`）、失敗時はユーザーにエラーを提示する
- **NFR-601**: AIへの入力はサイズ上限を持ち、極端に長い履歴でもタイムアウト/メモリ過多になりにくいこと

## 成功基準 *(必須)*

- **SC-600**: `v*` タグが存在するプロジェクトで、10件分のバージョン履歴が `Version History` タブに表示される
- **SC-601**: 各バージョンで AI要約（英語）と簡易CHANGELOGが表示される（失敗時は簡易CHANGELOGのみ）
- **SC-602**: CHANGELOG.mdを参照せずに表示が成立する

## 制約と仮定 *(該当する場合)*

### 制約

- Tauri v2 + Svelte 5 構成を維持する
- UI表示文字列は英語のみ（日本語を表示しない）

### 仮定

- バージョンは `v*` タグによって表現される（SemVerの完全検証までは行わない）

## 範囲外 *(必須)*

- gwt自身のリリースノート（本SPECでは扱わない）
- プロジェクトの `CHANGELOG.md` をそのまま表示する機能
- GitHub Release本文の取得（ネットワーク前提の機能）
- メニュー内にバージョン一覧を展開表示する機能（メニューはトリガーのみ）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- AI要約生成では、対象範囲のコミットsubject等が外部AIエンドポイントへ送信され得るため、ユーザーがAI設定を明示的に有効化していることを前提とする

## 依存関係 *(該当する場合)*

- Git（`git tag`, `git log`, `git rev-list`, `git rev-parse`）
- Profiles/AI設定（`~/.gwt/profiles.toml`）
- Tauri menu / event / invoke
