# 機能仕様: Worktree作成進捗モーダル

**仕様ID**: `SPEC-bf7fb63e`
**作成日**: 2026-01-25
**ステータス**: 策定中
**入力**: ユーザー説明: "コーディングエージェント起動時にWorktreeを作成する場合に、Preparing worktreeで停止状態になっているので、進捗状況を画面に出したい。"
**関連仕様**: SPEC-3b0ed29b（コーディングエージェント対応）

## 概要

Worktree作成処理の進捗をセンターモーダルで表示し、各ステップの状態をチェックマーク形式で視覚化する機能。現在3箇所に冗長表示されている「Preparing worktree」メッセージを1箇所（モーダル）に統一し、処理が動いていることを明確にフィードバックする。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 進捗モーダルでWorktree作成状況を確認 (優先度: P1)

開発者がコーディングエージェントを起動する際、Worktree作成処理の各ステップがモーダル内のチェックマーク形式リストで表示され、現在どの処理が進行中かを把握できる。

**この優先度の理由**: 処理が停止しているように見える問題の根本解決であり、ユーザー体験の改善に直結する。

**独立したテスト**: Worktree作成を開始し、モーダルが表示されること、各ステップが順次進行すること、完了時にサマリが表示されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチを選択してエージェント起動を確定、**操作** Worktree作成処理が開始、**期待結果** 画面中央に半透明オーバーレイ付きのモーダルが表示され、ステップリストが表示される
2. **前提条件** モーダルが表示中、**操作** 各ステップが進行、**期待結果** 完了ステップに[x]、進行中ステップに[>]、待機中ステップに[ ]が表示される
3. **前提条件** 全ステップ完了、**操作** 処理完了、**期待結果** サマリ（Completed in X.Xs）が表示され、エージェント起動に遷移する

---

### ユーザーストーリー 2 - 長時間処理時の経過時間表示 (優先度: P1)

開発者がWorktree作成中に3秒以上かかるステップがある場合、経過時間が表示され、処理が継続中であることを確認できる。

**この優先度の理由**: 大規模リポジトリでgit worktree addが長時間かかる場合に、フリーズと誤認されることを防ぐ。

**独立したテスト**: 3秒以上かかるステップをシミュレートし、経過時間が表示されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** git worktree addが実行中、**操作** 3秒経過、**期待結果** 進行中ステップに経過時間（例: 5.2s）が表示される
2. **前提条件** ステップが3秒未満で完了、**操作** ステップ完了、**期待結果** 経過時間は表示されず、チェックマークのみ表示される

---

### ユーザーストーリー 3 - ESCキーでキャンセル (優先度: P2)

開発者がWorktree作成を中断したい場合、ESCキーでキャンセルでき、ブランチ一覧に戻れる。

**この優先度の理由**: 誤操作や長時間の待機を避けるためのエスケープハッチとして有用。

**独立したテスト**: Worktree作成中にESCキーを押し、処理がキャンセルされてブランチ一覧に戻ることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** モーダル表示中、**操作** ESCキーを押す、**期待結果** 処理がキャンセルされ、モーダルが閉じ、ブランチ一覧に戻る
2. **前提条件** git worktree addが実行中、**操作** ESCキーを押す、**期待結果** git操作が中断され、不完全なworktreeがあれば警告表示

---

### ユーザーストーリー 4 - エラー発生時のステップ明示 (優先度: P1)

開発者がWorktree作成中にエラーが発生した場合、どのステップで失敗したかが明示され、問題の特定が容易になる。

**この優先度の理由**: エラー発生時のトラブルシューティングを迅速化し、ユーザーの自己解決を促進する。

**独立したテスト**: ネットワークエラーやgitエラーをシミュレートし、失敗ステップが[!]マークで表示されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** git fetch中にネットワークエラー発生、**操作** エラー発生、**期待結果** 失敗ステップに[!]マーク、エラーメッセージが表示される
2. **前提条件** エラー発生後、**操作** 画面を確認、**期待結果** 完了済みステップは[x]のまま維持、失敗ステップのみ[!]表示

---

### ユーザーストーリー 5 - 冗長表示の排除 (優先度: P1)

開発者がWorktree作成中に、進捗表示が1箇所（モーダル）のみに表示され、ステータスバー・ブランチ詳細・セッション要約への重複表示がなくなる。

**この優先度の理由**: 現在の3箇所表示は冗長で、UIの一貫性を損なっている。

**独立したテスト**: Worktree作成中に他のUI領域を確認し、「Preparing worktree」が表示されていないことを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** モーダル表示中、**操作** ブランチ詳細エリアを確認、**期待結果** 「Preparing worktree」ではなく通常のブランチ情報が表示される
2. **前提条件** モーダル表示中、**操作** セッション要約エリアを確認、**期待結果** 「Preparing worktree」ではなく通常のセッション情報が表示される

---

### エッジケース

- git fetchがタイムアウトした場合、即座に失敗としてエラー表示する（リトライしない）
- worktreeパスが競合した場合、パス競合チェックステップで失敗を明示する
- キャンセル時に不完全なworktreeが残った場合、クリーンアップを試みる
- モーダル表示中はブランチリストのスクロールやカーソル移動を無効化する

## 要件 *(必須)*

### 機能要件

#### モーダル表示要件

- **FR-001**: Worktree作成開始時、システムは画面中央にモーダルを表示**しなければならない**
- **FR-002**: モーダルは半透明オーバーレイで背景を覆い、背景のブランチリストがうっすら見える状態に**しなければならない**
- **FR-003**: モーダルの幅は80文字以上とし、全ステップが1行で表示できる**しなければならない**
- **FR-004**: モーダルのタイトルは現在のステップに応じて動的に変化**しなければならない**

#### ステップ表示要件

- **FR-010**: ステップはチェックマーク形式で表示**しなければならない**（[x] 完了、[>] 進行中、[ ] 待機中、[!] 失敗）
- **FR-011**: 表示するステップは以下の6段階とする**しなければならない**:
  1. Fetching remote... (git fetch)
  2. Validating branch... (ブランチ検証)
  3. Generating path... (パス生成)
  4. Checking conflicts... (競合チェック)
  5. Creating worktree... (git worktree add)
  6. Checking dependencies... (依存関係チェック)
- **FR-012**: 進行中ステップが3秒以上継続した場合、経過時間を表示**しなければならない**（例: [>] Creating worktree... 5.2s）
- **FR-013**: 完了済みステップは緑色、進行中ステップは黄色、待機中ステップは灰色、失敗ステップは赤色で表示**しなければならない**

#### 完了・エラー表示要件

- **FR-020**: 全ステップ完了時、サマリを表示**しなければならない**（例: Completed in 8.2s (6 steps)）
- **FR-021**: エラー発生時、失敗したステップを明示し、エラーメッセージを表示**しなければならない**
- **FR-022**: ネットワークエラー（git fetch失敗等）は即座に失敗として処理し、リトライしてはならない

#### キャンセル要件

- **FR-030**: モーダル表示中、ESCキーでキャンセル可能に**しなければならない**
- **FR-031**: キャンセル時、進行中のgit操作を中断**しなければならない**
- **FR-032**: キャンセル後、ブランチ一覧に戻る**しなければならない**

#### 冗長排除要件

- **FR-040**: モーダル表示中、ステータスバーに「Preparing worktree」を表示してはならない
- **FR-041**: モーダル表示中、ブランチ詳細エリアに「Preparing worktree」を表示してはならない
- **FR-042**: モーダル表示中、セッション要約エリアに「Preparing worktree」を表示してはならない
- **FR-043**: モーダル表示中、他のUI操作（ブランチリストスクロール等）を無効化**しなければならない**

### 主要エンティティ

- **WorktreeProgressModal**: Worktree作成進捗を表示するモーダルコンポーネント
- **ProgressStep**: 各ステップの状態（pending/running/completed/failed）と経過時間を保持
- **ProgressStepKind**: ステップの種類（Fetch/ValidateBranch/GeneratePath/CheckConflicts/CreateWorktree/CheckDependencies）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: Worktree作成開始から1秒以内にモーダルが表示されることを確認できる
- **SC-002**: 各ステップの状態変化がリアルタイムで反映されることを確認できる
- **SC-003**: 3秒以上かかるステップで経過時間が表示されることを確認できる
- **SC-004**: 「Preparing worktree」の3箇所表示が1箇所（モーダル）に統一されることを確認できる
- **SC-005**: ESCキーでキャンセルが可能で、ブランチ一覧に戻れることを確認できる
- **SC-006**: エラー発生時に失敗ステップが明示されることを確認できる

## 制約と仮定 *(該当する場合)*

### 制約

- Ratatuiのモーダル描画機能を使用する
- 端末描画で使用するアイコンはASCIIに統一（[x], [>], [ ], [!]）
- CLIのユーザー向け出力は英語のみ

### 仮定

- ユーザーはESCキーでキャンセルできることを認知している
- Worktree作成処理は各ステップが順次実行される（並列処理なし）
- 既存のLaunchProgress列挙型を拡張または置換する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です:

- リトライ機能（エラー時の自動再試行）
- 見積もり時間表示（残り何秒かの予測）
- プログレスバー形式の表示（チェックマーク形式のみ）
- Web UIでの同等機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 追加のセキュリティ考慮事項はなし

## 依存関係 *(該当する場合)*

- SPEC-3b0ed29b: コーディングエージェント対応（起動フローの一部として統合）
- ratatui: TUIフレームワーク
- crossterm: 端末操作

## 参考資料 *(該当する場合)*

- [既存実装: LaunchProgress列挙型](../../crates/gwt-cli/src/main.rs)
- [既存実装: start_launch_preparation](../../crates/gwt-cli/src/tui/app.rs)
