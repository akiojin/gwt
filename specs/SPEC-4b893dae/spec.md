# 機能仕様: ブランチサマリーパネル

**仕様ID**: `SPEC-4b893dae`
**作成日**: 2026-01-19
**更新日**: 2026-01-20
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ選択画面のフッター領域を拡張し、選択中ブランチの詳細情報を常時表示するパネル"

## 概要

ブランチ選択画面において、現在のWorktreeパス表示を拡張し、選択中ブランチの詳細情報（コミットログ、変更統計、メタデータ、セッション要約）を常時表示する情報パネルを提供する。開発者がブランチの作業状況を一目で把握でき、適切なブランチ選択とコンテキストスイッチを支援する。

パネルはTabキーで「ブランチ詳細」タブと「セッション要約」タブを切り替えて表示できる。セッション要約は、エージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）のセッション内容（会話履歴 + ツール実行履歴）をAIで要約し、**Markdown形式**で返却された内容をそのまま表示する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - コミットログの確認 (優先度: P0)

開発者がブランチ選択画面でブランチを選択すると、そのブランチの直近コミット履歴（3-5件）がパネルに表示される。各コミットはハッシュ（7桁）とメッセージで表示され、ブランチで何が行われたかを素早く把握できる。

**この優先度の理由**: コミットログはブランチの作業内容を理解する最も基本的な情報であり、この機能の中核となる。

**独立したテスト**: ブランチを選択し、パネルにコミットログが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ選択画面が表示されている、**操作** Worktreeを持つブランチにカーソルを移動、**期待結果** パネルの`Commits:`セクションに直近3-5件のコミットがハッシュ+メッセージ形式で表示される
2. **前提条件** コミットログが表示されている、**操作** 別のブランチにカーソルを移動、**期待結果** パネルのコミットログが新しいブランチの内容に更新される
3. **前提条件** コミットが1件しかないブランチを選択、**操作** パネルを確認、**期待結果** 1件のコミットのみが表示される
4. **前提条件** コミットメッセージが長い場合、**操作** パネルを確認、**期待結果** メッセージは表示幅に収まるよう末尾が省略される（`...`）

---

### ユーザーストーリー 2 - 変更統計の確認 (優先度: P0)

開発者がブランチを選択すると、そのブランチの変更統計（変更ファイル数、追加/削除行数、未コミット/未プッシュ状態）がパネルに表示される。既存の安全ブランチ確認機能と同じデータを使用し、ブランチの作業状態を定量的に把握できる。

**この優先度の理由**: 変更統計はブランチの作業量と安全性を判断する重要な指標であり、既存機能とのデータ共有で効率的に実装できる。

**独立したテスト**: 変更があるブランチを選択し、パネルに統計情報が表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** 変更があるブランチを選択、**操作** パネルを確認、**期待結果** `Stats:`セクションに変更ファイル数と行数が表示される（例: `5 files, +120/-45 lines`）
2. **前提条件** 未コミット変更があるブランチを選択、**操作** パネルを確認、**期待結果** 未コミット状態が表示される（例: `Uncommitted changes`）
3. **前提条件** 未プッシュコミットがあるブランチを選択、**操作** パネルを確認、**期待結果** 未プッシュ状態が表示される（例: `Unpushed commits`）
4. **前提条件** 既存の安全性判定が完了している、**操作** パネルを確認、**期待結果** 安全性判定結果と統計が一致している

---

### ユーザーストーリー 3 - ブランチメタデータの確認 (優先度: P1)

開発者がブランチを選択すると、そのブランチのメタデータ（ahead/behind、ベースブランチ、最終コミット日時）がパネルに表示される。upstreamとの同期状態や最後の作業日時を把握できる。

**この優先度の理由**: メタデータはブランチの同期状態を理解するために重要だが、コミットログと統計より優先度は低い。

**独立したテスト**: upstreamが設定されたブランチを選択し、パネルにメタデータが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** upstreamが設定されたブランチを選択、**操作** パネルを確認、**期待結果** `Meta:`セクションにahead/behind数が表示される（例: `↑3 ↓2 from origin/main`）
2. **前提条件** ブランチを選択、**操作** パネルを確認、**期待結果** 最終コミット日時が相対表示される（例: `Last commit: 2 days ago`）
3. **前提条件** upstreamが設定されていないブランチを選択、**操作** パネルを確認、**期待結果** ahead/behindは表示されず、最終コミット日時のみ表示される
4. **前提条件** ベースブランチ情報が取得可能、**操作** パネルを確認、**期待結果** ベースブランチ名が表示される

---

### ユーザーストーリー 4 - セッション要約の確認 (優先度: P0)

開発者がブランチを選択してTabキーを押すと、セッション要約タブに切り替わり、そのブランチで稼働中または最後に使用されたエージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）のセッション内容がAIで要約されて表示される。セッション要約には、タスクと進捗状況、短文要約、バレットポイント一覧、メトリクス（トークン数、ツール実行数、経過時間）が含まれる。

**この優先度の理由**: エージェントの作業状況をリアルタイムで把握するために必須の機能であり、ブランチ詳細と同等に重要。

**独立したテスト**: AI設定が有効なプロファイルでWorktreeを持つブランチを選択し、Tabキーでセッション要約タブに切り替えて表示を確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** AI設定が有効なプロファイルでgwtを起動、**操作** Worktreeを持つブランチを選択しTabキーを押す、**期待結果** セッション要約タブに切り替わり、タスク概要・短文要約・バレットポイント・メトリクスが表示される
2. **前提条件** セッション要約タブが表示されている、**操作** Tabキーを再度押す、**期待結果** ブランチ詳細タブ（コミット履歴等）に戻る
3. **前提条件** AI設定が無効（エンドポイントまたはモデル未設定）、**操作** セッション要約タブに切り替え、**期待結果** 「Configure AI in Profiles to enable session summary」のような設定促進メッセージが表示される
4. **前提条件** セッションが存在しないブランチ、**操作** セッション要約タブに切り替え、**期待結果** 「No session」と表示される
5. **前提条件** エージェントが作業中でセッション要約が表示されている、**操作** 30秒待機、**期待結果** セッション要約が自動更新される
6. **前提条件** セッション要約が既に表示されている、**操作** ポーリング更新が発生、**期待結果** 既存要約は表示されたまま、更新完了時に新しい要約へ差し替わる
7. **前提条件** セッション要約が長文、**操作** パネル表示を確認、**期待結果** 折り返しまたはスクロールで全文が確認できる
8. **前提条件** セッション内容が日本語、**操作** セッション要約を生成、**期待結果** 要約が日本語で表示される
9. **前提条件** セッション内容が非常に長い、**操作** セッション要約を生成、**期待結果** 入力を上限で切り詰めたうえで要約が生成される
10. **前提条件** セッション要約が生成済み、**操作** セッション要約タブを確認、**期待結果** Markdownの「目的」「要約」「ハイライト（箇条書き）」が同一順序・同一構造で表示される

---

### ユーザーストーリー 4a - Tabキーによるタブ切り替え (優先度: P0)

開発者がブランチ詳細パネルでTabキーを押したとき、「ブランチ詳細」タブと「セッション要約」タブを切り替えることができる。

**この優先度の理由**: ブランチ詳細（コミット履歴等）とセッション要約を両方確認したいユースケースに対応するため。

**独立したテスト**: Tabキーでタブ切り替えが機能することを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ詳細タブが表示されている、**操作** Tabキーを押す、**期待結果** セッション要約タブに切り替わり、パネルタイトルが`[branch_name] Session`に変更される
2. **前提条件** セッション要約タブが表示されている、**操作** Tabキーを押す、**期待結果** ブランチ詳細タブに切り替わり、パネルタイトルが`[branch_name] Details`に変更される
3. **前提条件** ブランチAでセッション要約タブを表示中、**操作** ブランチBにカーソルを移動後、ブランチAに戻る、**期待結果** ブランチAはセッション要約タブのまま表示される（ブランチ単位で記憶）
4. **前提条件** ブランチ詳細またはセッション要約タブが表示されている、**操作** パネル枠を確認、**期待結果** Tabキーで切り替えできる旨のヒントが表示される（例: `Tab: Switch`）
5. **前提条件** ブランチAでセッション要約タブを表示中、**操作** rキーでリフレッシュ、**期待結果** ブランチAのセッション要約タブが維持される
6. **前提条件** ブランチAでセッション要約タブを表示中、**操作** Worktree作成などの操作後に自動更新が発生、**期待結果** ブランチAのセッション要約タブが維持される
7. **前提条件** まだ選択したことのないブランチが存在、**操作** そのブランチにカーソルを移動、**期待結果** ブランチ詳細タブ（Details）がデフォルトで表示される

---

### ユーザーストーリー 4b - セッションパーサーによる会話履歴解析 (優先度: P0)

開発者がセッション要約を表示したとき、システムはgwtのsession_idを使用して該当エージェントのセッションファイルを特定し、会話履歴（user/assistantメッセージ）とツール実行履歴（tool_use/tool_result）を解析する。

**この優先度の理由**: セッション要約の正確性を確保するため、正しいセッションを特定して解析することが必須。

**独立したテスト**: 各エージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）のセッションファイルを正しく解析できることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** Claude Codeでセッションが存在、**操作** セッション要約を表示、**期待結果** `~/.claude/projects/*/`配下のセッションファイルが正しく解析される
2. **前提条件** Codex CLIでセッションが存在、**操作** セッション要約を表示、**期待結果** Codex CLIのセッションファイルが正しく解析される
3. **前提条件** Gemini CLIでセッションが存在、**操作** セッション要約を表示、**期待結果** Gemini CLIのセッションファイルが正しく解析される
4. **前提条件** OpenCodeでセッションが存在、**操作** セッション要約を表示、**期待結果** OpenCodeのセッションファイルが正しく解析される

---

### ユーザーストーリー 5 - パネルの常時表示 (優先度: P0)

開発者がブランチ選択画面を表示すると、選択中ブランチの詳細パネルが常にフッター領域に表示される。トグル操作なしで情報を確認でき、ブランチ選択のたびに自動更新される。

**この優先度の理由**: 常時表示はこの機能の基本的なUI要件であり、最優先で実装する必要がある。

**独立したテスト**: ブランチ選択画面を表示し、パネルが常に表示されていることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** gwtを起動、**操作** ブランチ選択画面を表示、**期待結果** フッター領域に`[branch_name] Details`タイトルのパネルが表示される
2. **前提条件** パネルが表示されている、**操作** ブランチを切り替える、**期待結果** パネルのタイトルと内容が新しいブランチに更新される
3. **前提条件** パネルが表示されている、**操作** パネルの高さを確認、**期待結果** 10-15行の固定高さで表示される
4. **前提条件** パネルが表示されている、**操作** 枠内の余白を確認、**期待結果** 枠線の内側に左右1文字分の余白があり、テキストが枠に密着しない
5. **前提条件** ターミナルサイズが小さい、**操作** パネルを確認、**期待結果** ブランチリスト表示領域が減少し、パネルは固定高さを維持する

---

### ユーザーストーリー 6 - プロファイルへのAI設定追加 (優先度: P0)

開発者がプロファイル設定またはグローバルAI設定でAIサマリー機能を有効化できる。設定はウィザード形式で行い、保存前にAPI疎通チェック（モデル一覧取得）を必須とする。疎通チェックが成功しない場合は設定を保存できない。

**この優先度の理由**: AI機能の設定はAIサマリー機能の前提条件であり、疎通チェックにより設定ミスを防止する。

**独立したテスト**: プロファイル設定画面でAI設定ウィザードを起動し、疎通チェック成功後に設定が保存されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** プロファイル設定画面を表示、**操作** AI設定の編集ボタンを押下、**期待結果** AI設定ウィザードが起動し、URL入力画面が表示される
2. **前提条件** グローバルAI設定画面を表示、**操作** 編集ボタンを押下、**期待結果** 同じAI設定ウィザードが起動する
3. **前提条件** AI設定を入力しウィザードを完了、**操作** 保存を確認、**期待結果** 設定が永続化される
4. **前提条件** AI設定済みプロファイルを選択、**操作** ブランチ選択画面を表示、**期待結果** そのプロファイルのAI設定がサマリー生成に使用される
5. **前提条件** 既存のAI設定がある、**操作** 編集ボタンを押下、**期待結果** 既存値がプリセットされた状態でウィザードが起動する

---

### ユーザーストーリー 6a - AI設定ウィザード (優先度: P0)

開発者がAI設定を行う際、ウィザード形式のUIで設定を進める。URLとAPIキーを入力後、GET /modelsでモデル一覧を取得し、取得したモデルから選択する。疎通チェック（モデル一覧取得）が成功しない限り、保存できない。

**この優先度の理由**: 疎通チェックにより設定ミスを事前に検出し、ユーザー体験を向上させる。

**独立したテスト**: ウィザードの各ステップを操作し、疎通チェックの成功/失敗に応じた動作を確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** AI設定ウィザードを起動、**操作** URL入力画面でEnterを押下、**期待結果** APIキー入力画面に遷移する
2. **前提条件** APIキー入力画面、**操作** 空のままEnterを押下、**期待結果** モデル一覧取得を試行する（ローカルLLM想定）
3. **前提条件** APIキー入力画面、**操作** APIキーを入力してEnterを押下、**期待結果** モデル一覧取得を試行する
4. **前提条件** モデル一覧取得中、**操作** 画面を確認、**期待結果** 「Fetching models...」のようなローディングテキストが表示される
5. **前提条件** モデル一覧取得成功、**操作** 画面を確認、**期待結果** モデル選択画面（リスト形式）が表示され、上下キーで選択可能
6. **前提条件** モデル選択画面、**操作** モデルを選択してEnterを押下、**期待結果** 設定が保存され、ウィザードが終了する
7. **前提条件** モデル一覧取得失敗（401/403）、**操作** 画面を確認、**期待結果** 詳細なエラーメッセージ（例: `401 Unauthorized`）が表示され、URL入力画面に戻る
8. **前提条件** モデル一覧取得失敗（接続エラー）、**操作** 画面を確認、**期待結果** 詳細なエラーメッセージ（例: `Connection refused`）が表示され、URL入力画面に戻る
9. **前提条件** モデル一覧取得失敗（タイムアウト）、**操作** 10秒以上待機、**期待結果** タイムアウトエラーが表示され、URL入力画面に戻る
10. **前提条件** 各ウィザードステップ、**操作** Escキーを押下、**期待結果** 前のステップに戻る（URL入力画面でEscならウィザードをキャンセル）
11. **前提条件** 既存のAI設定がある、**操作** ウィザードを起動、**期待結果** URL/APIキー/モデルの既存値がプリセットされる
12. **前提条件** AI設定が存在する、**操作** 削除ボタンを押下、**期待結果** AI設定が削除される

---

### ユーザーストーリー 6b - AI設定の削除 (優先度: P1)

開発者がAI設定を削除できる。削除後はAIサマリー機能が無効化される。

**この優先度の理由**: 設定変更の柔軟性を確保するため。

**独立したテスト**: AI設定削除後、AIサマリー機能が無効化されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** AI設定が存在するプロファイル、**操作** 削除ボタンを押下、**期待結果** 確認なしでAI設定が削除される
2. **前提条件** AI設定削除後、**操作** セッション要約タブを確認、**期待結果** 「Configure AI in Profiles to enable session summary」が表示される

---

### エッジケース

- **Worktreeがないブランチ**: Worktreeがないブランチを選択した場合、ブランチ詳細タブではコミットログのみ表示し、セッション要約タブでは「No session」と表示する
- **コミットがないブランチ**: 新規作成直後でコミットがないブランチの場合、`No commits yet`と表示する
- **detached HEAD**: detached HEAD状態のWorktreeの場合、ブランチ名の代わりにコミットハッシュをタイトルに表示する
- **リモートブランチ**: リモートブランチが選択された場合、パネルは`(Remote branch - limited info)`と表示する
- **データ取得中**: コミットログや統計の取得中は、該当セクションにローディング表示（ASCIIスピナー）を表示する
- **データ取得失敗**: 取得に失敗した場合、該当セクションに`(Failed to load)`と表示し、他のセクションは正常に表示する
- **表示幅が狭い**: ターミナル幅が狭い場合、コンテンツは末尾省略（`...`）で対応する
- **Worktreeアクセス不可**: Worktreeディレクトリにアクセスできない場合、キャッシュされた情報があれば表示し、なければエラー表示する
- **セッションファイルが巨大（数MB）**: バックグラウンドスレッドで読み込み、UIブロックを防ぐ
- **セッションファイルが破損**: エラーを表示し、他の機能は正常動作を継続
- **複数のセッションファイルが存在**: gwtのsession_idを使用して最新のものを特定
- **エージェントが作業中にセッションファイルが更新**: ファイルロックに注意し、読み取り失敗時は前回キャッシュを表示
- **長いセッション（1000ターン以上）**: 動的サンプリングにより、最初・途中・最後の部分を抽出して要約
- **ブランチ削除時のタブ記憶**: 削除されたブランチのタブ記憶は即座にメモリから削除し、リソースリークを防ぐ
- **選択中ブランチの削除**: 選択中のブランチが削除された場合、先頭のブランチに選択を移動し、そのブランチのタブ記憶を適用（なければDetails）
- **AI設定無効時のSession記憶**: AI設定が無効でもSession選択記憶は維持し、AI有効化時にSession表示に復元できるようにする

## 要件 *(必須)*

### 機能要件

#### パネル表示（基本）

- **FR-001**: システムは、ブランチ選択画面のフッター領域に詳細パネルを常時表示**しなければならない**
- **FR-002**: システムは、パネルのタイトルを`[branch_name] Details`形式で表示**しなければならない**
- **FR-003**: システムは、パネルの高さを10-15行の固定値で表示**しなければならない**
- **FR-004**: システムは、パネルを枠線で囲んで表示**しなければならない**
- **FR-004a**: システムは、パネル内コンテンツに左右1文字分の余白を設け、枠線に密着しないよう表示**しなければならない**
- **FR-005**: システムは、ブランチ選択が変更されるたびにパネル内容を更新**しなければならない**
- **FR-006**: システムは、既存の`Worktree: <path>`表示をパネルに統合**しなければならない**

#### コミットログセクション

- **FR-010**: システムは、`Commits:`ラベル行の下に直近3-5件のコミットを表示**しなければならない**
- **FR-011**: システムは、各コミットを`<hash(7桁)> <message>`形式で表示**しなければならない**
- **FR-012**: システムは、コミットメッセージが表示幅を超える場合、末尾を省略（`...`）**しなければならない**
- **FR-013**: システムは、コミットがない場合、`No commits yet`と表示**しなければならない**

#### 変更統計セクション

- **FR-020**: システムは、`Stats:`ラベル行の下に変更統計を表示**しなければならない**
- **FR-021**: システムは、変更ファイル数と行数を`N files, +X/-Y lines`形式で表示**しなければならない**
- **FR-022**: システムは、未コミット変更がある場合、`Uncommitted changes`を表示**しなければならない**
- **FR-023**: システムは、未プッシュコミットがある場合、`Unpushed commits`を表示**しなければならない**
- **FR-024**: システムは、既存の安全性判定機能（SPEC-d2f4762a）と同じデータを使用**しなければならない**

#### ブランチメタデータセクション

- **FR-030**: システムは、`Meta:`ラベル行の下にブランチメタデータを表示**しなければならない**
- **FR-031**: システムは、upstreamがある場合、ahead/behind数を`↑N ↓M from <upstream>`形式で表示**しなければならない**
- **FR-032**: システムは、最終コミット日時を相対表示（例: `2 days ago`）**しなければならない**
- **FR-033**: システムは、ベースブランチ情報が取得可能な場合、表示**しなければならない**
- **FR-034**: システムは、upstreamが設定されていない場合、ahead/behindを表示しては**ならない**

#### リンクセクション

- **FR-035**: システムは、ブランチ詳細タブにGitHubブランチのリンクを表示**しなければならない**
- **FR-036**: システムは、最新PRが存在する場合、PRリンクを表示**しなければならない**
- **FR-037**: システムは、リンクをマウスクリックしたときにブラウザで開く**しなければならない**

#### セッション要約タブ

- **FR-040**: システムは、セッション要約タブにおいて、エージェントセッションのAI要約を表示**しなければならない**
- **FR-041**: システムは、セッション要約を**Markdown形式**で表示**しなければならない**（JSONは不可）
- **FR-041a**: システムは、セッション要約のMarkdownを以下のフォーマットで表示**しなければならない**: `目的`、`要約`、`ハイライト（箇条書き）`
- **FR-041b**: システムは、LLMから返されたMarkdownを**最小限の解析**で表示可能なテキストに変換し、**内容は改変せず**に表示**しなければならない**
- **FR-042**: システムは、AI設定が無効（エンドポイントまたはモデル未設定）の場合、`Configure AI in Profiles to enable session summary`のような設定促進メッセージを表示**しなければならない**
- **FR-043**: システムは、セッションが存在しない場合、`No session`と表示**しなければならない**
- **FR-044**: システムは、セッション要約の取得中は、ローディングスピナーを表示**しなければならない**
- **FR-045**: システムは、セッション要約をセッション中メモリにキャッシュ**しなければならない**
- **FR-046**: システムは、セッション要約のテキストが表示幅で切り捨てられないよう、折り返しまたはスクロールで全文を確認できるように**しなければならない**
- **FR-047**: システムは、既存のセッション要約がある場合、再生成中も要約を表示し続け、生成完了時に差し替え**しなければならない**
- **FR-048**: システムは、セッション内容から要約の言語を推測し、その言語で要約を生成**しなければならない**
- **FR-049**: システムは、セッション要約の入力サイズを上限で制御し、極端に長いセッションでも要約生成が失敗しないように**しなければならない**

#### タブ切り替え機能

- **FR-070**: システムは、Tabキーを押すことで「ブランチ詳細」タブと「セッション要約」タブを切り替え**しなければならない**
- **FR-071**: システムは、ブランチ詳細タブのタイトルを`[branch_name] Details`形式で表示**しなければならない**
- **FR-072**: システムは、セッション要約タブのタイトルを`[branch_name] Session`形式で表示**しなければならない**
- **FR-073**: システムは、ブランチ詳細/セッション要約パネル枠にTabキーで切り替えできる旨のヒントを表示**しなければならない**
- **FR-074**: システムは、ブランチごとに最後に選択されたタブ状態を記憶**しなければならない**
- **FR-074a**: システムは、Tab切り替え時に即座に該当ブランチのタブ記憶を更新**しなければならない**
- **FR-074b**: システムは、rキーによるリフレッシュや操作後の自動更新でブランチ単位のタブ記憶を維持**しなければならない**
- **FR-074c**: システムは、ブランチが削除された場合、そのブランチのタブ記憶を即座に破棄**しなければならない**
- **FR-074d**: システムは、AI設定が無効な場合でもSession記憶を維持し、AI有効化時に復元**しなければならない**
- **FR-074e**: システムは、選択中のブランチが削除された場合、先頭のブランチに選択を移動**しなければならない**
- **FR-075**: システムは、まだ選択されたことのないブランチのデフォルトタブをブランチ詳細タブとして表示**しなければならない**

#### セッションパーサー

- **FR-080**: システムは、gwtのsession_idを使用して該当エージェントのセッションを特定**しなければならない**
- **FR-081**: システムは、Claude Codeのセッションファイル（`~/.claude/projects/*/`配下JSONL）を解析**できなければならない**
- **FR-082**: システムは、Codex CLIのセッションファイルを解析**できなければならない**
- **FR-083**: システムは、Gemini CLIのセッションファイルを解析**できなければならない**
- **FR-084**: システムは、OpenCodeのセッションファイルを解析**できなければならない**
- **FR-085**: システムは、会話履歴（user/assistantメッセージ）とツール実行履歴（tool_use/tool_result）を抽出**しなければならない**
- **FR-086**: システムは、長いセッション（1000ターン以上）の場合、動的サンプリング（最初・途中・最後）を適用**しなければならない**
- **FR-087**: システムは、共通のSessionParserトレイトを定義し、各エージェント別に実装**しなければならない**

#### ポーリング更新

- **FR-090**: システムは、セッション要約タブ表示中、30秒間隔でセッションファイルの更新をポーリング**しなければならない**
- **FR-091**: システムは、セッションファイルの変更を検出した場合、自動的に要約を再生成**しなければならない**
- **FR-092**: システムは、ポーリング中にエラーが発生した場合、前回のキャッシュを表示し続け**しなければならない**
- **FR-093**: システムは、セッション要約タブが非表示のとき、ポーリングを停止**しなければならない**

#### AI設定（プロファイル連携）

- **FR-050**: システムは、プロファイルにAI設定セクション（APIエンドポイント、APIキー、モデル名）を追加**しなければならない**
- **FR-051**: システムは、OpenAI互換APIをサポート**しなければならない**
- **FR-052**: ~~システムは、プロファイルのAPIキーが空の場合、環境変数（`OPENAI_API_KEY`等）をフォールバックとして使用**しなければならない**~~ **【廃止】環境変数フォールバックは使用しない**
- **FR-053**: システムは、APIエンドポイントのデフォルト値として`https://api.openai.com/v1`を使用**しなければならない**
- **FR-054**: システムは、AI要約の生成にResponses API（`/responses`）を使用**しなければならない**

#### AI設定ウィザード（疎通チェック）

- **FR-100**: システムは、AI設定をウィザード形式で設定**しなければならない**
- **FR-101**: システムは、ウィザードのステップ1でAPIエンドポイントURL入力画面を表示**しなければならない**
- **FR-102**: システムは、ウィザードのステップ2でAPIキー入力画面を表示**しなければならない**
- **FR-103**: システムは、APIキー入力後にGET /modelsでモデル一覧を取得**しなければならない**
- **FR-104**: システムは、モデル一覧取得に10秒のタイムアウトを設定**しなければならない**
- **FR-105**: システムは、モデル一覧取得成功時、リスト形式でモデルを表示し、上下キーで選択可能に**しなければならない**
- **FR-106**: システムは、モデル一覧取得失敗時、詳細なエラーメッセージ（例: `401 Unauthorized`, `Connection refused`）を表示**しなければならない**
- **FR-107**: システムは、モデル一覧取得失敗時、URL入力画面に戻**らなければならない**
- **FR-108**: システムは、モデル選択後にのみ設定を保存可能に**しなければならない**（疎通チェック成功が保存の前提条件）
- **FR-109**: システムは、各ウィザードステップでEscキーを押すと前のステップに戻**らなければならない**
- **FR-110**: システムは、URL入力画面でEscキーを押すとウィザードをキャンセル**しなければならない**
- **FR-111**: システムは、既存のAI設定を編集する場合、URL/APIキー/モデルの既存値をプリセット**しなければならない**
- **FR-112**: システムは、グローバルAI設定とプロファイルAI設定で同一のウィザードUIを使用**しなければならない**
- **FR-113**: システムは、AI設定の削除ボタンを提供**しなければならない**
- **FR-114**: システムは、モデル一覧取得中に「Fetching models...」のようなローディングテキストを表示**しなければならない**
- **FR-115**: システムは、APIキー入力を空で許可**しなければならない**（ローカルLLM対応）

#### データ取得

- **FR-060**: システムは、コミットログ取得をバックグラウンドで実行**しなければならない**
- **FR-061**: システムは、データ取得中は該当セクションにローディング表示（ASCIIスピナー）を表示**しなければならない**
- **FR-062**: システムは、データ取得失敗時は該当セクションに`(Failed to load)`を表示**しなければならない**
- **FR-063**: システムは、Worktreeがないブランチの場合、コミットログのみ表示**しなければならない**

### 主要エンティティ

- **BranchSummary**: 選択中ブランチの詳細情報を保持するデータ構造（コミットログ、統計、メタデータ、セッション要約）
- **CommitEntry**: 個々のコミット情報（ハッシュ、メッセージ、日時、著者）
- **ChangeStats**: 変更統計情報（ファイル数、追加行数、削除行数、未コミット/未プッシュ状態）
- **SessionSummary**: エージェントセッションの要約情報（タスク概要、短文要約、バレットポイント、メトリクス）
- **SessionSummaryCache**: セッション要約のメモリキャッシュ（ブランチ名をキーとする）
- **SessionMetrics**: セッションのメトリクス情報（トークン数、ツール実行数、経過時間）
- **SessionParser trait**: エージェントセッションファイルを解析する共通インターフェース
- **ClaudeCodeParser**: Claude Code用のセッションパーサー実装
- **CodexCliParser**: Codex CLI用のセッションパーサー実装
- **GeminiCliParser**: Gemini CLI用のセッションパーサー実装
- **OpenCodeParser**: OpenCode用のセッションパーサー実装
- **DetailPanelTab enum**: パネルのタブ状態（Details / Session）
- **BranchTabCache**: ブランチ名をキーとしたタブ状態のメモリキャッシュ（HashMap<String, DetailPanelTab>）
- **AISettings**: プロファイルに追加されるAI設定（エンドポイント、APIキー、モデル名）
- **AISettingsWizardStep enum**: ウィザードのステップ状態（UrlInput / ApiKeyInput / FetchingModels / ModelSelect）
- **AISettingsWizardState**: ウィザードの状態管理（現在のステップ、入力値、エラーメッセージ、モデル一覧）
- **ModelInfo**: APIから取得したモデル情報（id, created, owned_by等）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ブランチ選択後200ms以内にパネルのタイトルと枠が表示される
- **SC-002**: コミットログは取得開始から500ms以内に表示を開始する
- **SC-003**: 統計情報は既存の安全性判定と同時に表示される（追加遅延なし）
- **SC-004**: セッション要約はキャッシュ済みの場合、即座に表示される（100ms以内）
- **SC-005**: パネル表示によりブランチリスト領域が10-15行分減少し、リストのスクロールは引き続き滑らかに動作する
- **SC-006**: AI API呼び出しエラーが発生しても、他のセクションの表示に影響しない
- **SC-007**: ユーザーの80%が、パネルを見てブランチの作業状況を理解できる
- **SC-008**: Tabキーを押してから50ms以内にタブ切り替えが完了する
- **SC-009**: セッション要約の30秒ポーリングが正確に動作する（誤差±5秒以内）
- **SC-010**: 全4エージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）のセッションファイルが正しく解析される
- **SC-011**: 1000ターン以上のセッションでも、動的サンプリングにより3秒以内に要約が生成される
- **SC-012**: AI設定ウィザードでモデル一覧取得が10秒以内にタイムアウトする
- **SC-013**: ウィザードのステップ遷移（Enter/Esc）が50ms以内に完了する
- **SC-014**: モデル一覧取得成功時、モデルリストが即座に表示される（100ms以内）
- **SC-015**: 疎通チェック失敗時、詳細なエラーメッセージがユーザーに表示される

## 制約と仮定 *(該当する場合)*

### 制約

- CLI UIはRatatui（Rust TUIフレームワーク）を使用する
- ターミナルの表示領域が限られているため、パネル高さは固定値とする
- AIサマリー機能はネットワーク接続が必要

### 仮定

- 開発者はコミットメッセージにConventional Commits形式を使用している（AIサマリーの品質向上のため）
- ブランチのコミット数は通常数件〜数百件の範囲
- OpenAI互換APIを提供するサービス（OpenAI、Azure OpenAI、Ollama等）が利用可能
- エージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）のセッションファイルは既知の場所に保存されている
- gwtのsession_idを使用してエージェントセッションを特定できる
- 各エージェントのセッションファイル形式はJSONLまたはJSON形式である

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- パネルのリサイズ（ドラッグによる高さ調整）
- パネルの表示/非表示トグル
- コミットログのスクロール（表示件数以上のコミット閲覧）
- ファイル単位の変更詳細表示
- セッション要約のカスタムプロンプト設定
- セッション要約のファイル永続化
- コミットの差分表示
- 複数エージェントの同時セッション管理（ブランチごとに1セッションのみ）
- セッション内の個別ターン詳細表示
- エージェントセッションファイルの編集/削除機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- APIキーはプロファイルファイルに平文で保存されるため、ファイルのパーミッション管理が必要
- APIキーは環境変数での設定を推奨
- エージェントセッション内容（会話履歴、ツール実行結果）がAI APIに送信されることをユーザーに明示する必要がある
- セッションには機密情報（APIキー、パスワード等）が含まれる可能性があるため、AI送信前にフィルタリングを検討
- ローカルLLM（Ollama等）を使用する場合、データは外部に送信されない
- エージェントセッションファイルへのアクセスはユーザー権限に基づく（他ユーザーのセッションは参照不可）

## 依存関係 *(該当する場合)*

- SPEC-d2f4762a: ブランチ選択画面（安全性判定データの共有）
- 既存のBranch構造体（ahead/behind/commit_timestamp）
- 既存のプロファイル機能（設定保存）
- OpenAI互換API（セッション要約機能）
- 既存のsession_id検出機能（main.rsの`detect_claude_session_id_at`等）
- 既存のts_session.rs（gwtセッション履歴とsession_id管理）
- エージェントセッションファイルの仕様（Claude Code, Codex CLI, Gemini CLI, OpenCode）

## 参考資料 *(該当する場合)*

- [Ratatui ドキュメント](https://ratatui.rs/)
- [OpenAI API リファレンス](https://platform.openai.com/docs/api-reference)
