# 機能仕様: ブランチサマリーパネル

**仕様ID**: `SPEC-4b893dae`
**作成日**: 2026-01-19
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ選択画面のフッター領域を拡張し、選択中ブランチの詳細情報を常時表示するパネル"

## 概要

ブランチ選択画面において、現在のWorktreeパス表示を拡張し、選択中ブランチの詳細情報（コミットログ、変更統計、メタデータ、AIサマリー）を常時表示する情報パネルを提供する。開発者がブランチの作業状況を一目で把握でき、適切なブランチ選択とコンテキストスイッチを支援する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - コミットログの確認 (優先度: P0)

開発者がブランチ選択画面でブランチを選択すると、そのブランチの直近コミット履歴（3-5件）がパネルに表示される。各コミットはハッシュ（7桁）とメッセージで表示され、ブランチで何が行われたかを素早く把握できる。

**この優先度の理由**: コミットログはブランチの作業内容を理解する最も基本的な情報であり、この機能の中核となる。

**独立したテスト**: ブランチを選択し、パネルにコミットログが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ選択画面が表示されている、**操作** Worktreeを持つブランチにカーソルを移動、**期待結果** パネルの`Commits:`セクションに直近3-5件のコミットがハッシュ+メッセージ形式で表示される
2. **前提条件** コミットログが表示されている、**操作** 別のブランチにカーソルを移動、**期待結果** パネルのコミットログが新しいブランチの内容に更新される
3. **前提条件** コミットが1件しかないブランチを選択、**操作** パネルを確認、**期待結果** 1件のコミットのみが表示される
4. **前提条件** コミットメッセージが長い場合、**操作** パネルを確認、**期待結果** メッセージは表示幅に収まるよう末尾が省略される（`...`）

---

### ユーザーストーリー 2 - 変更統計の確認 (優先度: P0)

開発者がブランチを選択すると、そのブランチの変更統計（変更ファイル数、追加/削除行数、未コミット/未プッシュ状態）がパネルに表示される。既存の安全ブランチ確認機能と同じデータを使用し、ブランチの作業状態を定量的に把握できる。

**この優先度の理由**: 変更統計はブランチの作業量と安全性を判断する重要な指標であり、既存機能とのデータ共有で効率的に実装できる。

**独立したテスト**: 変更があるブランチを選択し、パネルに統計情報が表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** 変更があるブランチを選択、**操作** パネルを確認、**期待結果** `Stats:`セクションに変更ファイル数と行数が表示される（例: `5 files, +120/-45 lines`）
2. **前提条件** 未コミット変更があるブランチを選択、**操作** パネルを確認、**期待結果** 未コミット状態が表示される（例: `Uncommitted changes`）
3. **前提条件** 未プッシュコミットがあるブランチを選択、**操作** パネルを確認、**期待結果** 未プッシュ状態が表示される（例: `Unpushed commits`）
4. **前提条件** 既存の安全性判定が完了している、**操作** パネルを確認、**期待結果** 安全性判定結果と統計が一致している

---

### ユーザーストーリー 3 - ブランチメタデータの確認 (優先度: P1)

開発者がブランチを選択すると、そのブランチのメタデータ（ahead/behind、ベースブランチ、最終コミット日時）がパネルに表示される。upstreamとの同期状態や最後の作業日時を把握できる。

**この優先度の理由**: メタデータはブランチの同期状態を理解するために重要だが、コミットログと統計より優先度は低い。

**独立したテスト**: upstreamが設定されたブランチを選択し、パネルにメタデータが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** upstreamが設定されたブランチを選択、**操作** パネルを確認、**期待結果** `Meta:`セクションにahead/behind数が表示される（例: `↑3 ↓2 from origin/main`）
2. **前提条件** ブランチを選択、**操作** パネルを確認、**期待結果** 最終コミット日時が相対表示される（例: `Last commit: 2 days ago`）
3. **前提条件** upstreamが設定されていないブランチを選択、**操作** パネルを確認、**期待結果** ahead/behindは表示されず、最終コミット日時のみ表示される
4. **前提条件** ベースブランチ情報が取得可能、**操作** パネルを確認、**期待結果** ベースブランチ名が表示される

---

### ユーザーストーリー 4 - AIサマリーの確認 (優先度: P2)

開発者がブランチを選択すると、AIがコミット履歴を分析して生成した2-3行の箇条書きサマリーがパネルに表示される。コミットメッセージを読まなくても作業内容の概要を把握できる。

**この優先度の理由**: AIサマリーは付加価値機能であり、基本機能が安定した後に追加する。外部API依存があるため優先度を下げる。

**独立したテスト**: AI設定が有効なプロファイルでブランチを選択し、パネルにサマリーが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** AI設定が有効なプロファイルでgwtを起動、**操作** Worktreeを持つブランチを選択、**期待結果** `Summary:`セクションに2-3行の箇条書きサマリーが表示される
2. **前提条件** AI設定が無効（APIキー未設定）、**操作** ブランチを選択、**期待結果** `Summary:`セクションは表示されない
3. **前提条件** API呼び出しがエラーになる、**操作** ブランチを選択、**期待結果** `Summary:`セクションは表示されず、他のセクションは正常に表示される
4. **前提条件** gwt起動時、**操作** Worktreeを持つブランチのサマリーを確認、**期待結果** 起動時にバッチプリフェッチされたサマリーが即座に表示される

---

### ユーザーストーリー 5 - パネルの常時表示 (優先度: P0)

開発者がブランチ選択画面を表示すると、選択中ブランチの詳細パネルが常にフッター領域に表示される。トグル操作なしで情報を確認でき、ブランチ選択のたびに自動更新される。

**この優先度の理由**: 常時表示はこの機能の基本的なUI要件であり、最優先で実装する必要がある。

**独立したテスト**: ブランチ選択画面を表示し、パネルが常に表示されていることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** gwtを起動、**操作** ブランチ選択画面を表示、**期待結果** フッター領域に`[branch_name] Details`タイトルのパネルが表示される
2. **前提条件** パネルが表示されている、**操作** ブランチを切り替える、**期待結果** パネルのタイトルと内容が新しいブランチに更新される
3. **前提条件** パネルが表示されている、**操作** パネルの高さを確認、**期待結果** 10-15行の固定高さで表示される
4. **前提条件** ターミナルサイズが小さい、**操作** パネルを確認、**期待結果** ブランチリスト表示領域が減少し、パネルは固定高さを維持する

---

### ユーザーストーリー 6 - プロファイルへのAI設定追加 (優先度: P2)

開発者がプロファイル設定でAIサマリー機能を有効化できる。OpenAI互換APIのエンドポイントとAPIキーをプロファイルに設定し、プロジェクトごとに異なるAI設定を使用できる。

**この優先度の理由**: AI機能の設定はAIサマリー機能の前提条件だが、基本機能より優先度は低い。

**独立したテスト**: プロファイル設定画面でAI設定を追加し、その設定がサマリー生成に使用されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** プロファイル設定画面を表示、**操作** AI設定セクションを確認、**期待結果** APIエンドポイント、APIキー、モデル名の設定項目が表示される
2. **前提条件** AI設定を入力、**操作** プロファイルを保存、**期待結果** 設定が永続化される
3. **前提条件** AI設定済みプロファイルを選択、**操作** ブランチ選択画面を表示、**期待結果** そのプロファイルのAI設定がサマリー生成に使用される
4. **前提条件** 環境変数でAPIキーが設定されている、**操作** プロファイルのAPIキーを空のまま保存、**期待結果** 環境変数のAPIキーがフォールバックとして使用される

---

### エッジケース

- **Worktreeがないブランチ**: Worktreeがないブランチを選択した場合、コミットログのみ表示し、統計とAIサマリーは表示しない
- **コミットがないブランチ**: 新規作成直後でコミットがないブランチの場合、`No commits yet`と表示する
- **detached HEAD**: detached HEAD状態のWorktreeの場合、ブランチ名の代わりにコミットハッシュをタイトルに表示する
- **リモートブランチ**: リモートブランチが選択された場合、パネルは`(Remote branch - limited info)`と表示する
- **データ取得中**: コミットログや統計の取得中は、該当セクションにローディング表示（ASCIIスピナー）を表示する
- **データ取得失敗**: 取得に失敗した場合、該当セクションに`(Failed to load)`と表示し、他のセクションは正常に表示する
- **表示幅が狭い**: ターミナル幅が狭い場合、コンテンツは末尾省略（`...`）で対応する
- **Worktreeアクセス不可**: Worktreeディレクトリにアクセスできない場合、キャッシュされた情報があれば表示し、なければエラー表示する

## 要件 *(必須)*

### 機能要件

#### パネル表示（基本）

- **FR-001**: システムは、ブランチ選択画面のフッター領域に詳細パネルを常時表示**しなければならない**
- **FR-002**: システムは、パネルのタイトルを`[branch_name] Details`形式で表示**しなければならない**
- **FR-003**: システムは、パネルの高さを10-15行の固定値で表示**しなければならない**
- **FR-004**: システムは、パネルを枠線で囲んで表示**しなければならない**
- **FR-005**: システムは、ブランチ選択が変更されるたびにパネル内容を更新**しなければならない**
- **FR-006**: システムは、既存の`Worktree: <path>`表示をパネルに統合**しなければならない**

#### コミットログセクション

- **FR-010**: システムは、`Commits:`ラベル行の下に直近3-5件のコミットを表示**しなければならない**
- **FR-011**: システムは、各コミットを`<hash(7桁)> <message>`形式で表示**しなければならない**
- **FR-012**: システムは、コミットメッセージが表示幅を超える場合、末尾を省略（`...`）**しなければならない**
- **FR-013**: システムは、コミットがない場合、`No commits yet`と表示**しなければならない**

#### 変更統計セクション

- **FR-020**: システムは、`Stats:`ラベル行の下に変更統計を表示**しなければならない**
- **FR-021**: システムは、変更ファイル数と行数を`N files, +X/-Y lines`形式で表示**しなければならない**
- **FR-022**: システムは、未コミット変更がある場合、`Uncommitted changes`を表示**しなければならない**
- **FR-023**: システムは、未プッシュコミットがある場合、`Unpushed commits`を表示**しなければならない**
- **FR-024**: システムは、既存の安全性判定機能（SPEC-d2f4762a）と同じデータを使用**しなければならない**

#### ブランチメタデータセクション

- **FR-030**: システムは、`Meta:`ラベル行の下にブランチメタデータを表示**しなければならない**
- **FR-031**: システムは、upstreamがある場合、ahead/behind数を`↑N ↓M from <upstream>`形式で表示**しなければならない**
- **FR-032**: システムは、最終コミット日時を相対表示（例: `2 days ago`）**しなければならない**
- **FR-033**: システムは、ベースブランチ情報が取得可能な場合、表示**しなければならない**
- **FR-034**: システムは、upstreamが設定されていない場合、ahead/behindを表示しては**ならない**

#### AIサマリーセクション

- **FR-040**: システムは、AI設定が有効な場合、`Summary:`ラベル行の下にAIサマリーを表示**しなければならない**
- **FR-041**: システムは、AIサマリーを2-3行の箇条書き形式で表示**しなければならない**
- **FR-042**: システムは、AI設定が無効な場合、`Summary:`セクションを表示しては**ならない**
- **FR-043**: システムは、API呼び出しがエラーの場合、`Summary:`セクションを非表示にし、他のセクションは正常表示**しなければならない**
- **FR-044**: システムは、起動時にWorktreeを持つブランチのサマリーをバッチプリフェッチ**しなければならない**
- **FR-045**: システムは、サマリーをセッション中メモリにキャッシュ**しなければならない**

#### AI設定（プロファイル連携）

- **FR-050**: システムは、プロファイルにAI設定セクション（APIエンドポイント、APIキー、モデル名）を追加**しなければならない**
- **FR-051**: システムは、OpenAI互換APIをサポート**しなければならない**
- **FR-052**: システムは、プロファイルのAPIキーが空の場合、環境変数（`OPENAI_API_KEY`等）をフォールバックとして使用**しなければならない**
- **FR-053**: システムは、APIエンドポイントのデフォルト値として`https://api.openai.com/v1`を使用**しなければならない**

#### データ取得

- **FR-060**: システムは、コミットログ取得をバックグラウンドで実行**しなければならない**
- **FR-061**: システムは、データ取得中は該当セクションにローディング表示（ASCIIスピナー）を表示**しなければならない**
- **FR-062**: システムは、データ取得失敗時は該当セクションに`(Failed to load)`を表示**しなければならない**
- **FR-063**: システムは、Worktreeがないブランチの場合、コミットログのみ表示**しなければならない**

### 主要エンティティ

- **BranchSummary**: 選択中ブランチの詳細情報を保持するデータ構造（コミットログ、統計、メタデータ、AIサマリー）
- **CommitEntry**: 個々のコミット情報（ハッシュ、メッセージ、日時、著者）
- **ChangeStats**: 変更統計情報（ファイル数、追加行数、削除行数、未コミット/未プッシュ状態）
- **AISummaryCache**: AIサマリーのメモリキャッシュ（ブランチ名をキーとする）
- **AISettings**: プロファイルに追加されるAI設定（エンドポイント、APIキー、モデル名）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ブランチ選択後200ms以内にパネルのタイトルと枠が表示される
- **SC-002**: コミットログは取得開始から500ms以内に表示を開始する
- **SC-003**: 統計情報は既存の安全性判定と同時に表示される（追加遅延なし）
- **SC-004**: AIサマリーはプリフェッチ済みの場合、即座に表示される（100ms以内）
- **SC-005**: パネル表示によりブランチリスト領域が10-15行分減少し、リストのスクロールは引き続き滑らかに動作する
- **SC-006**: AI API呼び出しエラーが発生しても、他のセクションの表示に影響しない
- **SC-007**: ユーザーの80%が、パネルを見てブランチの作業状況を理解できる

## 制約と仮定 *(該当する場合)*

### 制約

- CLI UIはRatatui（Rust TUIフレームワーク）を使用する
- ターミナルの表示領域が限られているため、パネル高さは固定値とする
- AIサマリー機能はネットワーク接続が必要

### 仮定

- 開発者はコミットメッセージにConventional Commits形式を使用している（AIサマリーの品質向上のため）
- ブランチのコミット数は通常数件〜数百件の範囲
- OpenAI互換APIを提供するサービス（OpenAI、Azure OpenAI、Ollama等）が利用可能

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- パネルのリサイズ（ドラッグによる高さ調整）
- パネルの表示/非表示トグル
- コミットログのスクロール（表示件数以上のコミット閲覧）
- ファイル単位の変更詳細表示
- AIサマリーのカスタムプロンプト設定
- AIサマリーのファイル永続化
- コミットの差分表示

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- APIキーはプロファイルファイルに平文で保存されるため、ファイルのパーミッション管理が必要
- APIキーは環境変数での設定を推奨
- コミット情報やブランチ名がAI APIに送信されることをユーザーに明示する必要がある
- ローカルLLM（Ollama等）を使用する場合、データは外部に送信されない

## 依存関係 *(該当する場合)*

- SPEC-d2f4762a: ブランチ選択画面（安全性判定データの共有）
- 既存のBranch構造体（ahead/behind/commit_timestamp）
- 既存のプロファイル機能（設定保存）
- OpenAI互換API（AIサマリー機能）

## 参考資料 *(該当する場合)*

- [Ratatui ドキュメント](https://ratatui.rs/)
- [OpenAI API リファレンス](https://platform.openai.com/docs/api-reference)
