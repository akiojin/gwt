# 機能仕様: Web UI システムトレイ統合

**仕様ID**: `SPEC-1f56fd80`
**作成日**: 2025-12-12
**更新日**: 2025-12-14
**ステータス**: 実装済み
**入力**: ユーザー説明: "WebUI をシステムトレイに常駐させ、ダブルクリックでブラウザを開けるようにしてほしい。"

## 変更履歴

- **2025-12-14**: CLI/Web UI 分離に伴い、FR-004（CLI URL 表示）を削除、FR-006 を `gwt serve` コマンド専用に変更

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Web UI をトレイから素早く開く (優先度: P1)

開発者が `gwt serve` を起動すると Web UI サーバーが起動し、同時にシステムトレイへ gwt のアイコンが表示される。
開発者はそのアイコンを **ダブルクリック** するだけで、既定ブラウザが Web UI の URL を開く。

**この優先度の理由**: Web UI を毎回 URL 入力せずに素早く開けることで、ブラウザ操作をストレスなく行えるため。

**独立したテスト**: `gwt serve` 起動 → トレイにアイコンが表示されることを確認 → トレイアイコンをダブルクリック → 既定ブラウザで `http://localhost:3000`（または PORT 指定値） が開く。

**受け入れシナリオ**:

1. **前提条件** `gwt serve` を起動、**操作** 起動完了を待つ、**期待結果** Web UI サーバー起動後にトレイへアイコンが表示される
2. **前提条件** トレイアイコンが表示済み、**操作** アイコンをダブルクリック、**期待結果** 既定ブラウザが Web UI を開く
3. **前提条件** `PORT=8080 gwt serve` で起動、**操作** トレイアイコンをダブルクリック、**期待結果** `http://localhost:8080` が開く

---

### エッジケース

- GUI を持たない環境（CI/SSH/WSL など）では、トレイ機能が利用できない可能性がある
  - その場合でも Web UI の起動は継続し、トレイ初期化失敗は警告ログのみで処理する
- トレイ機能が OS/デスクトップ環境でサポートされない場合でも、アプリはクラッシュしない
- **現行のトレイ実装がサポートしない OS（例: macOS/Linux）では、トレイ初期化をスキップし、Web UI の起動は継続する**
- **指定ポートが既に使用中の場合、`gwt serve` はエラーメッセージを表示して終了する**

## 要件 *(必須)*

### 機能要件

- **FR-001**: Web UI サーバーが起動完了した後、システムはシステムトレイへ gwt アイコンを表示**しなければならない**
- **FR-002**: トレイアイコンのダブルクリック（アクション）により、既定ブラウザで Web UI URL (`http://localhost:{port}`) を開く**しなければならない**
- **FR-003**: トレイ初期化が失敗/非対応の場合、Web UI の動作を阻害せず警告ログのみで継続**しなければならない**
- ~~**FR-004**: CLI の BranchListScreen は Web UI の URL を 1 行で表示**しなければならない**~~ *(2025-12-14 廃止: CLI/Web UI 分離により削除)*
- **FR-005**: 表示/起動に使う URL は `PORT` 環境変数（未設定時は 3000）と一致**しなければならない**
- **FR-006**: `gwt serve` コマンドで指定ポートが使用中の場合、エラーメッセージを表示して終了**しなければならない**

### 主要エンティティ

- **SystemTray**: Web UI 常駐のためのトレイ表示コンポーネント（サーバー起動後に初期化）

## 成功基準 *(必須)*

- **SC-001**: Web UI 起動後、トレイがサポートされる OS（現行実装では Windows）で 90% 以上の環境でトレイアイコンが表示される
- **SC-002**: トレイダブルクリックで 100% 正しい URL が開く（手動テスト 10 ケース）
- **SC-003**: トレイ未対応/失敗環境でも Web UI がクラッシュしない
- **SC-004**: ポート使用中の場合、`gwt serve` が適切なエラーメッセージを表示して終了する

## 制約と仮定 *(該当する場合)*

### 制約

- gwt は CLI ツールであり、Electron のような重いランタイム追加は避ける
- トレイ機能は OS の GUI 環境に依存するため、ヘッドレスでは無効化され得る

### 仮定

- Web UI はローカルマシン上でのみ利用され、既定ブラウザも同一マシンに存在する
- Web UI サーバーは `gwt serve` コマンドで明示的に起動される

## 範囲外 *(必須)*

- トレイアイコンの右クリックメニュー/設定 UI
- リモートホスト公開や HTTPS 対応
- トレイからのサーバー停止/再起動操作
- CLI 起動時の自動 Web UI サーバー起動（SPEC-c8e7a5b2 廃止済み）

## 依存関係 *(該当する場合)*

- ~~既存仕様: SPEC-c8e7a5b2 (CLI 起動時 Web UI 自動起動)~~ *(廃止済み)*
- 既存実装: `src/web/server/index.ts`（Web UI サーバー）
- 既存実装: `src/web/server/tray.ts`（システムトレイ）
