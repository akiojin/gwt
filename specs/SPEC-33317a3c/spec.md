# 機能仕様: 共通環境変数とローカル環境取り込み機能

**仕様ID**: `SPEC-33317a3c`
**作成日**: 2025-11-11
**ステータス**: ドラフト
**入力**: ユーザー説明: "shareEnv->envにして、起動時にローカルに設定されている環境変数を自動追加したい"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 共通環境変数を一元管理 (優先度: P1)

開発者は Web UI の設定ページで、カスタム/ビルトインを問わずすべての AI ツールが参照できる共通環境変数を編集できる。これにより PAT やプロキシ設定を一度だけ入力すればよくなる。

**この優先度の理由**: 共有値が各ツールに散在するとミスや使い回しが困難で、もっとも早く解決すべき痛点。

**独立したテスト**: `/config` の「共通環境変数」セクションで `GITHUB_TOKEN` を保存 → どのツールを起動しても `process.env.GITHUB_TOKEN` が設定されることを確認すれば成立。

**受け入れシナリオ**:

1. **前提条件** 初期状態、**操作** 共通セクションで `GITHUB_TOKEN` を追加、**期待結果** 保存直後に一覧へ反映され、`tools.json` の `env` ルートに書き込まれる
2. **前提条件** CLI から任意ツールを起動、**操作** `env` を出力、**期待結果** 共通変数が `tool.env` と同じ優先度で利用可能

---

### ユーザーストーリー 2 - ローカル環境変数の自動取り込み (優先度: P1)

開発者が `gwt serve` を起動すると、指定されたキー（OPENAI_API_KEY など）が OS の環境に存在すれば、共通セクションへ自動的に候補として追加される。UI ではインポート済みであることが分かる。

**この優先度の理由**: 既に端末に設定済みのシークレットを再入力したくないという要望を解消するため。

**独立したテスト**: サーバー起動前に `export OPENAI_API_KEY=foo` → `/config` を開く → 共通 env に `OPENAI_API_KEY` が自動表示されることを確認すれば単体で価値を提供。

**受け入れシナリオ**:

1. **前提条件** OS 環境に `OPENAI_API_KEY` が存在、`tools.json` には未登録、**操作** serve 起動→ `/config` を表示、**期待結果** 共通 env に「ローカルからインポート済み」状態で表示される
2. **前提条件** 同じキーが `tools.json` に既に存在、**操作** serve 起動、**期待結果** 既存値を上書きせず、差分があれば UI に「ローカルと不一致」バッジを表示

---

### ユーザーストーリー 3 - 上書き優先度と競合解決 (優先度: P2)

管理者は共通 env とツール固有 env の優先度、およびローカル取り込みとの競合を明確に把握できる。UI では優先順位の説明と、衝突時の解決アクション（共通を優先/ツール固有を優先/ローカル値に置き換える）が提供される。

**この優先度の理由**: 共通化によって生じる衝突を放置すると誤動作やシークレット漏洩につながるため。

**独立したテスト**: 共通 env に `API_TOKEN=common`、ツール env に `API_TOKEN=tool` を設定 → ツール起動時に指定した優先順位通りの値が使われることを確認すれば検証可能。

**受け入れシナリオ**:

1. **前提条件** 共通と個別で同じキーが存在、**操作** UI で優先順位を切り替え→保存、**期待結果** 起動ログに優先度が記録され、実際の値も切り替わる
2. **前提条件** ローカル環境値が異なる、**操作** 「ローカル値で置換」アクションを実行、**期待結果** 共通 env が更新され履歴に記録

---

### ユーザーストーリー 4 - 監査と再利用 (優先度: P3)

開発者は共通 env の変更履歴（いつ/誰が/どの値を変更したかのメタデータのみ）を確認でき、CLI や他プロジェクトへのエクスポート（例: `.env` 形式ダウンロード）が可能。

**この優先度の理由**: シークレット管理では監査性とポータビリティが求められるが、P1/P2 を満たした後の追加価値として扱う。

**独立したテスト**: 共通 env を変更 → `/config` で履歴が更新 → 「.env としてエクスポート」を押してファイルをダウンロードし、内容が一致することを確認。

---

### エッジケース

- OS 環境に数百個の変数がある場合、対象キーリストでフィルタリングし UI が過負荷にならないようページング/検索を提供
- 取り込み後に OS 側で値が削除された場合、Web UI では「ローカル未検出」と表示しても自動削除はしない
- Windows / macOS / Linux で PATH 区切りや大文字小文字差異があるため、キー比較はケースセンシティブで行うが UI に注意書きを表示
- 共有 env にバイナリ文字列を入れた場合は base64 のみ許可（テキスト以外はエラー）

## 要件 *(必須)*

### 機能要件

- **FR-001**: `tools.json` のスキーマを拡張し、ルートに `env: Record<string,string>` を追加、`customTools[].env` とともに API で返却しなければならない
- **FR-002**: Fastify サーバー起動時にホワイトリスト化された環境変数（OPENAI_API_KEY など）を検出し、`tools.json` に存在しないキーのみ共通 env に自動追加しなければならない（自動保存）
- **FR-003**: Web UI `/config` に「共通環境変数」セクションを追加し、行追加/編集/削除/並び替え/インポート状態表示を提供しなければならない
- **FR-004**: 優先度は「ツール固有 env ＞ 共通 env ＞ プロセス環境」の順で評価し、UI とドキュメントに明示しなければならない
- **FR-005**: 競合発生時にはダイアログで差異を表示し、共通/個別/ローカル値から選択できる解決アクションを提供しなければならない
- **FR-006**: 共通 env の変更は `tools.json` に即時保存し、履歴メタデータ（キー、タイムスタンプ、操作種別）を `~/.claude-worktree/env-history.json` に追記しなければならない
- **FR-007**: 「ローカルから再インポート」ボタンを押した際は再度 OS 環境を走査し、差分のみ提示 → 適用できるようにしなければならない
- **FR-008**: CLI (`gwt` コマンド) でも共通 env を自動読み込み、既存ツール起動ロジックに影響がないことを保証しなければならない

### 主要エンティティ

- **SharedEnvironment**: `{ env: Record<string,string>; updatedAt: string; history: HistoryEntry[] }`
- **HistoryEntry**: `{ key: string; action: "add"|"update"|"delete"|"import"; timestamp: string; source: "ui"|"os" }`

## 成功基準 *(必須)*

- **SC-001**: 既存ユーザーの 90% が PAT のような共通値を 1 回の編集で全ツールに適用できる（サポート問い合わせゼロ）
- **SC-002**: OS 環境からの自動取り込みで対象キーの 95% 以上が初回表示時に反映される（手動入力不要）
- **SC-003**: 競合ダイアログを経由した変更で誤上書きゼロ（手動テスト 20 ケース）
- **SC-004**: CLI/ Web UI 双方で同じ優先順位が適用され、E2E テストで 100% 一致

## 制約と仮定

### 制約

- 取り込み対象キーはホワイトリスト方式（セキュリティ上、任意の OS env を勝手に保存しない）
- `tools.json` はローカルディスク上にプレーンテキスト保存のまま（暗号化は別仕様）
- Fastify サーバーが動作する OS ユーザーと CLI ユーザーは同一であること

### 仮定

- ユーザーは serve 起動前に必要な環境変数を OS に設定済み
- 共通 env の数は 50 個程度に収まる（UI/性能前提）

## 範囲外 *(必須)*

- クラウド KMS・Secrets Manager との連携
- 複数ユーザーでの同時編集やロールベースアクセス制御
- Web UI から OS 環境変数そのものを削除/追加する機能

## セキュリティとプライバシーの考慮事項

- 自動取り込み時にログへ平文を出さない（***masked*** 表記）
- .env エクスポート時はダウンロードリンクを一度きりの署名 URL にし、1 分で期限切れにする
- `env-history.json` にも値は保存せず、キー名と操作種別のみを記録

## 依存関係

- 既存の `SPEC-8adfd99e`（Web UI 環境変数編集）
- `src/config/tools.ts`（設定ロード/保存）
- `src/web/server/routes/config.ts`（REST API）
- `src/launcher.ts`（CLI ツール起動ロジック）

## 参考資料

- [SPEC-8adfd99e/spec.md](../SPEC-8adfd99e/spec.md)
- [src/config/builtin-tools.ts](../../src/config/builtin-tools.ts)
- [src/config/tools.ts](../../src/config/tools.ts)
