# 実装計画: ログ運用統一（pino構造化ログ・7日ローテーション）

**仕様ID**: `SPEC-b9f5c4a1` | **日付**: 2025-12-11 | **仕様書**: [specs/SPEC-b9f5c4a1/spec.md](./spec.md)
**入力**: `/specs/SPEC-b9f5c4a1/spec.md` からの機能仕様

## 概要

- 画面出力とログを明確に分離し、ログは pino による構造化JSONで1系統に出力する。
- category フィールドでコンポーネントを区別し、ファイルは分けない。
- 出力先は固定で `~/.gwt/logs/<cwd basename>/<YYYY-MM-DD>.jsonl`（環境変数によるパス上書きなし）。
- ローテーションはアプリ起動時に7日より古いファイルを削除（1日上限なし）。
- シークレットは既存方針どおりマスク、TDDでログ仕様を検証する。

## 技術コンテキスト

<!--
  対応必要: このセクションの内容をプロジェクトの技術詳細で置き換えてください。
  ここで示されている構造は、反復プロセスをガイドするための助言的な役割を果たします。
-->

**言語/バージョン**: TypeScript (ESM) / Bun 1.x
**主要な依存関係**: pino（新規導入）、Fastify（既存Web UIサーバー）、Ink/CLI（画面出力側）
**ストレージ**: N/A（ログはローカルファイル）
**テスト**: vitest（単体・ローテーション処理の時間依存テストは固定日時モック）
**ターゲットプラットフォーム**: Bun/Node 環境（macOS/Linux想定）
**プロジェクトタイプ**: 単一リポジトリ（CLI + Webサーバー）
**パフォーマンス目標**: ログ出力で顕著なレイテンシ増を生まない（pino標準設定を基本）
**制約**: TDD必須、シークレットは***masked***、コンポーネント別ファイル分割禁止、出力パス固定（環境変数での変更不可）
**スケール/範囲**: ローカル利用前提（ログ容量は日上限なし・7日保持・パス固定）

## 原則チェック

*ゲート: フェーズ0の調査前に合格する必要があります。フェーズ1の設計後に再チェック。*

[原則ファイルに基づいて決定されたゲート]

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-b9f5c4a1/
├── plan.md              # このファイル（/speckit.plan コマンド出力）
├── research.md          # フェーズ0出力（/speckit.plan コマンド）
├── data-model.md        # フェーズ1出力（/speckit.plan コマンド）
├── quickstart.md        # フェーズ1出力（/speckit.plan コマンド）
├── contracts/           # フェーズ1出力（/speckit.plan コマンド）
└── tasks.md             # フェーズ2出力（/speckit.tasks コマンド - /speckit.planでは作成されません）
```

### ソースコード（リポジトリルート）

```text
[プロジェクトタイプに基づいて決定 - 単一/Web/モバイル]

単一プロジェクトの例:
src/
├── [機能モジュール]/
tests/
├── [テストファイル]

Webアプリの例:
backend/src/
frontend/src/

モバイルの例:
api/src/
ios/src/ または android/src/
```

## フェーズ0: 調査（技術スタック選定）

**目的**: 要件に基づいて技術スタックを決定し、既存のコードパターンを理解する

**出力**: `specs/SPEC-b9f5c4a1/research.md`

### 調査項目

1. **既存のコードベース分析**
   - 現在の技術スタック（言語、フレームワーク、ライブラリ）
   - 既存のパターンとアーキテクチャ
   - 統合ポイント

2. **技術的決定**
   - [決定1、例: 認証ライブラリの選択]
   - [決定2、例: データベース層のアプローチ]
   - [決定3、例: テストフレームワーク]

3. **制約と依存関係**
   - [制約1、例: 既存システムとの互換性]
   - [制約2、例: パフォーマンス要件]

## フェーズ1: 設計（アーキテクチャと契約）

**目的**: 実装前に技術設計を定義する

**出力**:
- `specs/SPEC-b9f5c4a1/data-model.md`（ログ設定の構成エンティティを簡潔に）
- `specs/SPEC-b9f5c4a1/quickstart.md`（pinoロガー設定手順とパス規則）
- `specs/SPEC-b9f5c4a1/contracts/` （不要想定。API契約なしなら空のまま）

### 1.1 データモデル設計

**ファイル**: `data-model.md`

主要なエンティティとその関係を定義：
- エンティティ構造
- 属性とタイプ
- 関係と制約
- 検証ルール

### 1.2 クイックスタートガイド

**ファイル**: `quickstart.md`

開発者向けの簡潔なガイド：
- セットアップ手順
- 開発ワークフロー
- よくある操作
- トラブルシューティング

> ⚠️ Markdown整形ヒント  
> - 入れ子のリストは 2 スペースでインデントする（`-` の後に 2 スペース）  
> - URL は必ず `[表示名](https://example.com)` の形式で記述し、裸URLは避ける  
> - コードブロックやコマンド例には適切な言語ラベルを付ける（例: ```bash）  

### 1.3 契約/インターフェース（該当する場合）

**ディレクトリ**: `contracts/`

該当する場合に技術契約を定義：
- APIエンドポイント（OpenAPI/Swagger）
- イベントスキーマ
- メッセージフォーマット
- プロトコル定義

## フェーズ2: タスク生成

**次のステップ**: `/speckit.tasks` コマンドを実行

**入力**: このプラン + 仕様書 + 設計ドキュメント

**出力**: `specs/[SPEC-xxxxxxxx]/tasks.md` - 実装のための実行可能なタスクリスト

## 実装戦略

### 優先順位付け

ユーザーストーリーの優先度に基づいて実装：
1. **P1**: 最も重要 - 最初に実装
2. **P2**: 重要 - P1の後
3. **P3**: 補完的 - 最後に

### 独立したデリバリー

各ユーザーストーリーは独立して実装・テスト・デプロイ可能：
- ストーリー1を完了 → デプロイ可能なMVP
- ストーリー2を追加 → 拡張MVP
- ストーリー3を追加 → 完全な機能

## テスト戦略

[機能仕様のテスト要件に基づく]

- **ユニットテスト**: ログフォーマット（timestamp/level/message/category）、ローテーション処理（起動時に7日超を削除）、categoryの付与、デフォルト出力パス規則（~/.gwt/logs/<cwd>/<YYYY-MM-DD>.jsonl）。
- **統合テスト**: CLI/サーバー起動時にpinoロガーが初期化されることのスモーク（可能なら）。
- **エンドツーエンドテスト**: なし（ログのみのため）。
- **パフォーマンステスト**: なし（標準pino性能を信頼）。

## リスクと緩和策

### 技術的リスク

1. **[リスク1]**: [説明]
   - **緩和策**: [対処方法]

2. **[リスク2]**: [説明]
   - **緩和策**: [対処方法]

### 依存関係リスク

1. **[依存関係1]**: [説明]
   - **緩和策**: [対処方法]

## 次のステップ

1. ✅ フェーズ0完了: 調査と技術スタック決定
2. ✅ フェーズ1完了: 設計とアーキテクチャ定義
3. ⏭️ `/speckit.tasks` を実行してタスクを生成
4. ⏭️ `/speckit.implement` で実装を開始
