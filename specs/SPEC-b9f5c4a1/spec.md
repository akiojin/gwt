# ログ運用統一仕様

**仕様ID**: `SPEC-b9f5c4a1`
**作成日**: 2025-12-11
**更新日**: 2026-01-09
**ステータス**: 改訂中

## 背景
- 画面に表示するメッセージと、永続的に保管するログの区別が曖昧だった。
- 構造化ログの出力方式が機能ごとにばらついているため、ツール全体で統一する。

## 定義
- **画面出力**: 標準出力・標準エラーに表示されるメッセージ。ログとは呼ばない。
- **ログ**: ファイルに書き出す永続的な記録。構造化（JSON）形式とする。

## 必須要件
1. **ロガー実装**: ログ出力は pino を用いること（構造化ログ, JSON）。
2. **出力先**: ログはファイルへ書き出すこと（画面出力と混在させない）。コンポーネント別にファイルを分けず、1系統のログに「category」フィールドで区別する。
3. **配置規則**: 出力パスは固定で `~/.gwt/logs/<カレントディレクトリ名>/<YYYY-MM-DD>.jsonl` とする（環境変数によるパス上書きは行わない）。サブディレクトリが存在しない場合は自動作成する。
4. **区別**: 画面出力で「ログ」「log」という語を使わず、ガイダンス/通知など適切な文言にすること。
5. **共通フォーマット**: タイムスタンプ・level・message を必須フィールドとし、追加フィールドはオブジェクトで付与する。
6. **ローテーション**: ログファイルは 7 日間でローテーション（保持）し、1 日あたりのサイズ上限は設けない。ログファイル名は `YYYY-MM-DD`（JST）とし、削除基準はファイルの最終更新時刻（mtime）を用いる。起動時点の現在時刻（JST）から `keepDays` 日を超えて古い mtime のファイルを削除して実現する。
7. **追記の継続**: ログファイルは起動のたびにリセットせず、同日のログファイルへ追記し続ける。ログの明示的なリセットはログビューア（SPEC-c1d5bad7）でのみ実行する。
8. **同時書き込み**: 同一ログファイルに複数プロセスが追記する場合でもログが破損しないよう、追記の原子性を担保し、必要に応じて排他制御を行う。
9. **TDD**: ログ機能を追加・変更する際は、先にテストを作成（Red）し、仕様遵守を検証する。最低限以下を自動テストで担保すること:
   - JSON構造（必須フィールド: timestamp/level/message/category）が出力される。
   - category が指定値で出力される。
   - ローテーション処理が起動時に7日超のファイルを削除する。
   - 起動をまたいでもログが追記され、既存のログ行が上書きされない。

## ログレベル運用規則

| レベル | 用途 | 例 |
| ------ | ---- | --- |
| `fatal` | アプリケーション継続不能な致命的エラー | 初期化失敗、必須リソース不足 |
| `error` | 操作失敗、例外発生（復旧可能） | API呼び出し失敗、ファイル書き込み失敗 |
| `warn` | 非推奨機能使用、リトライ動作、部分的失敗 | 古い設定形式の検出、ネットワーク再試行 |
| `info` | 正常な操作の開始・完了（既定値） | CLI起動、セッション開始、ブランチ作成完了 |
| `debug` | 開発・トラブルシューティング用の詳細情報 | 引数の値、内部状態、処理フロー |

- `LOG_LEVEL` 環境変数でフィルタリング可能（既定: `info`）
- 本番環境では `info` 以上を推奨、デバッグ時のみ `debug` を使用

## PII/シークレットマスキング

### マスク対象
- 環境変数の値（`GITHUB_TOKEN`, `ANTHROPIC_API_KEY` 等）
- APIキー、アクセストークン、パスワード
- ファイルパスに含まれるユーザー名（ホームディレクトリ以外）

### マスク形式
- `***masked***` に置き換える
- ログ出力時に後処理でマスク（pino の redact 機能は使用しない）

### 実装方法
- `src/logging/mask.ts` にマスク関数を実装
- 環境変数名パターン: `/TOKEN|KEY|SECRET|PASSWORD|CREDENTIAL/i`
- ログ出力前に対象フィールドをマスク

## エラーハンドリング

### ログディレクトリ作成失敗時
- 権限エラー（EACCES）: 警告を stderr に出力し、ログ出力をスキップ（CLI動作は継続）
- パス不正: 同上

### ログ書き込み失敗時
- pino の非同期書き込みに依存（再試行ロジックは実装しない）
- バッファオーバーフロー: pino 標準動作に従う（ドロップ）

### ディスク容量不足時
- 特別な処理は行わない（OS/pino 標準動作に従う）
- ローテーション処理で古いファイルを削除することで緩和

## タイムゾーン対応

### ファイル名生成（JST固定）
```typescript
function formatDateJST(date: Date): string {
  return date.toLocaleDateString('ja-JP', {
    timeZone: 'Asia/Tokyo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '-');
}
```

### 注意事項
- CI環境（UTC）でも JST でファイル名を生成
- ローテーション判定（mtime）は UTC ベースだが、ファイル名は JST
- `TZ` 環境変数に依存しない

## マルチプロセス対応詳細

### 原子性の担保
- pino の `pino/file` transport を使用（`append: true`）
- Node.js の `fs.appendFile` による行単位の原子性に依存
- 各ログエントリは1行のJSONL形式（改行で区切り）

### 制限事項
- ファイルロック機構は実装しない（pino 標準動作）
- 極端な高負荷（秒間数千レコード）では順序保証なし
- ローテーション処理中の新規書き込みは、新しいファイルに書き込まれる

### テスト要件（追加）
- 複数プロセスからの同時書き込みでログが破損しないことを検証
- 各行が有効なJSONであることを確認

## 非機能
- 機能追加に伴うパフォーマンス劣化を最小化する（pino 標準設定を基本とする）。
- PII/シークレットは上記マスキング規則に従う。

## 対象範囲
- gwt CLI / Web UI / サーバーコンポーネントの全ログ。

## 移行ガイド
- 既存の console ベースのログ出力は、画面出力とログファイル出力に役割分担する。
- 段階的移行を許容するが、新規機能は本仕様に従うこと。
