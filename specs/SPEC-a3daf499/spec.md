# 機能仕様: 起動時アプリ更新チェックの取りこぼし防止（遅延 + 再試行）

**仕様ID**: `SPEC-a3daf499`
**作成日**: 2026-02-13
**更新日**: 2026-02-13
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- SPEC-ab9b7d08（About / バージョン表示）
- SPEC-b7f7b9ad（メニュー操作）

**入力**: ユーザー説明: "Windows版では自動更新が起動時に表示されませんでした。解決して下さい。"

## 背景

- 起動時の更新チェックはベストエフォート1回実行で、失敗時は無通知で終了する。
- Windows で起動直後のタイミングに失敗が発生すると、更新が存在していても起動時通知が表示されない。
- 起動時通知に失敗しても、手動チェックは成功するケースがあり、体験が不安定になる。
- プラットフォーム個別分岐ではなく全OS共通で堅牢化し、再発防止する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 起動直後でも更新通知を取りこぼさない (優先度: P0)

ユーザーとして、アプリ起動時に更新が存在する場合は、起動タイミングの揺らぎに関係なく更新通知を受け取りたい。

**独立したテスト**: 起動時チェックで `failed` / 例外が続いた後に `available` が返る条件を再現し、通知が1回だけ表示されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 起動時チェックが1回目で `available` を返す、**操作** アプリを起動する、**期待結果** 3秒遅延後に更新トーストが表示される
2. **前提条件** 起動時チェックが `failed` または例外を返した後に `available` になる、**操作** アプリを起動する、**期待結果** 3秒間隔の再試行内で更新トーストが表示される
3. **前提条件** 起動時チェックが全試行で失敗する、**操作** アプリを起動する、**期待結果** 失敗トーストは表示されず、UI起動は継続する

---

### ユーザーストーリー 2 - 既存更新フローとの互換性を維持する (優先度: P1)

ユーザーとして、起動時通知の改善後も既存の手動更新チェックと適用フローを従来どおり使いたい。

**独立したテスト**: メニューの `Check for Updates` 実行時に、`up_to_date` / `available` / `failed` の既存分岐が維持されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 起動時通知改善を適用済み、**操作** メニューの手動更新チェックを実行する、**期待結果** 既存の表示仕様（最新・更新あり・失敗）が変わらない
2. **前提条件** バックエンド起動時イベント `app-update-state` が配信される、**操作** フロントエンドでイベント受信する、**期待結果** 更新通知が重複せず1回のみ表示される

## エッジケース

- 起動直後に画面遷移やアンマウントが発生した場合、遅延/再試行タイマーが適切に停止すること。
- 再試行中に他経路（イベント通知や手動チェック）で同一バージョン通知済みの場合、重複表示しないこと。
- `asset_url` がない更新は、既存仕様どおり「手動ダウンロード必要」トーストにフォールバックすること。

## 要件 *(必須)*

### 機能要件

- **FR-700**: システムは、起動時更新チェックをアプリ起動から3秒遅延して開始しなければならない。
- **FR-701**: システムは、起動時更新チェックが `failed` または例外で失敗した場合、3秒間隔で最大3回再試行しなければならない。
- **FR-702**: システムは、起動時再試行中に `available` を取得した場合、更新通知トーストを1回だけ表示しなければならない。
- **FR-703**: システムは、起動時チェックが全試行失敗した場合、ユーザー向け失敗トーストを表示してはならない。
- **FR-704**: システムは、起動時チェック失敗時にフロントエンドとバックエンドのログへ失敗情報を記録しなければならない。
- **FR-705**: システムは、既存の手動更新チェックコマンド (`check_app_update` / `apply_app_update`) の公開インターフェースを変更してはならない。

### 非機能要件

- **NFR-700**: 起動時更新チェック改善はUI初期表示をブロックしないこと（非同期実行）。
- **NFR-701**: 改修は全OS共通で適用し、Windows専用分岐に依存しないこと。

## 制約と仮定

- 起動時の更新可否判定は既存の `check_app_update(force=false)` を利用し、新規APIは追加しない。
- 遅延・再試行パラメータは設定画面に露出せず、実装内の固定値（3秒, 3回）とする。
- `app-update-state` イベント経路は削除せず、後方互換のため維持する。

## 成功基準 *(必須)*

- **SC-700**: 起動時更新チェックヘルパーのユニットテストで、成功・再試行成功・再試行枯渇・キャンセルの各ケースがパスする。
- **SC-701**: `gwt-gui` のテスト実行（`pnpm --dir gwt-gui test`）で回帰が発生しない。
- **SC-702**: Rust テスト実行（`cargo test -p gwt-tauri`）で回帰が発生しない。
