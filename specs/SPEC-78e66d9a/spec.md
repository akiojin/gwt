# 機能仕様: semantic-release リリースワークフローの安定化

**仕様ID**: `SPEC-78e66d9a`  
**作成日**: 2025-11-05  
**ステータス**: ドラフト  
**入力**: ユーザー説明: "semantic-releaseリリースの失敗を解消する"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - リリース失敗の再発防止 (優先度: P1)

リリース担当者として、semantic-release を実行する GitHub Actions ワークフローが、タイミング依存のユニットテストに左右されず安定して完了してほしい。そうすれば、メインブランチにマージされた変更が確実に公開できる。

**この優先度の理由**: リリースワークフローの失敗は公開停止につながり、製品提供に直接影響するため最優先で解決する必要がある。

**独立したテスト**: `bun run test` を CI (GitHub Actions) とローカルで実行し、想定通りに全テストが成功することを確認する。

**受け入れシナリオ**:

1. **前提条件** GitHub Actions の release ワークフローが semantic-release を実行している、**操作** ワークフローがユニットテストを実行、**期待結果** タイマー分解能に依存するテストが安定し全ジョブが成功する。
2. **前提条件** ローカル開発環境で `bun run test` を実行、**操作** LoadingIndicator の回転テストが実行、**期待結果** 期待するスピナーのフレーム遷移が確認できテストが成功する。

---

### ユーザーストーリー 2 - スピナー挙動の検証可能性向上 (優先度: P2)

開発者として、LoadingIndicator のスピナーフレーム遷移が遅延や低速環境でも検証しやすく、将来の回帰テストで信頼できる形にしたい。

**この優先度の理由**: テストの検証手段を安定化させることで、回帰を防ぎつつ開発者体験を維持できる。

**独立したテスト**: テストで疑似タイマーを利用して任意の経過時間を再現し、フレーム遷移やメッセージ表示が期待通りであることを確認する。

**受け入れシナリオ**:

1. **前提条件** 疑似タイマーを有効化したテスト環境、**操作** タイマーを順次進めながらフレームを取得、**期待結果** フレームが定義済み配列内で循環し重複せずに遷移する。
2. **前提条件** delay が 0 の構成、**操作** タイマーを delay+interval だけ進める、**期待結果** 可視状態が有効化されフレームとメッセージが描画される。

### エッジケース

- フレーム配列が 1 要素のみの場合でもインターバル処理が停止せず動作し続ける。
- delay が大きい場合でも delay 経過前に表示されない。
- isLoading が false に戻った際にタイマーが正しくクリーンアップされる。

## 要件 *(必須)*

### 機能要件

- **FR-001**: テストはタイマー分解能の低い環境でもスピナーフレームの遷移を検証できなければならない。
- **FR-002**: LoadingIndicator は delay 経過後に確実に可視化され、interval ごとにフレームインデックスを更新しなければならない。
- **FR-003**: テストは疑似タイマーを使用して deterministic に経過時間を制御し、期待値を評価しなければならない。
- **FR-004**: 既存のパブリック API (props) を変更せずに回帰を防止しなければならない。
- **FR-005**: release ワークフローでのユニットテスト実行ログにフレーム遷移が安定していることを記録する検証ステップを提供しなければならない。

### 主要エンティティ

- **LoadingIndicator コンポーネント**: `isLoading`, `delay`, `interval`, `frames`, `message` を受け取り Ink の `Text` コンポーネントでスピナーとメッセージを描画する。
- **LoadingIndicator テストスイート**: Vitest + happy-dom 環境で UI コンポーネントのレンダリングとタイマー挙動を検証する。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: GitHub Actions の release ワークフローが連続 3 回 (手動再実行含む) で失敗なく完了する。
- **SC-002**: `bun run test src/ui/__tests__/components/common/LoadingIndicator.test.tsx` を 10 回連続実行しても失敗しない。
- **SC-003**: LoadingIndicator のテストは 500ms 未満で完了し、テスト時間が大幅に増加しない。
- **SC-004**: Release ワークフローのテストログにタイマー関連の flaky エラーが再発しない（過去 7 日間）。

## 制約と仮定 *(該当する場合)*

### 制約

- Bun 1.0+ および Vitest 2.x を使用する開発・CI 環境に対応する。
- semantic-release ワークフローの構成は既存の `.github/workflows/release.yml` を前提とする。

### 仮定

- GitHub Actions 環境ではタイマーの解像度が 1ms 以上に制限される可能性がある。
- LoadingIndicator の props インターフェースは他コンポーネントから利用されており互換性を保持する必要がある。

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 新しいスピナー UI やカスタム描画スタイルの導入。
- semantic-release 自体の設定変更や公開対象レジストリの拡張。

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- ユニットテストの安定化のみを扱うため追加のセキュリティ・プライバシー影響はない。

## 依存関係 *(該当する場合)*

- Vitest のタイマー制御 API (`vi.useFakeTimers`, `vi.advanceTimersByTime`)。
- @testing-library/react / happy-dom のレンダリングエンジン。

## 参考資料 *(該当する場合)*

- [semantic-release release workflow run 19107220150](https://github.com/akiojin/claude-worktree/actions/runs/19107220150)
- [Vitest Timer Mocks ドキュメント](https://vitest.dev/api/vi.html#vi-usefaketimers)
