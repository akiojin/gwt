# ログ一覧・詳細表示・クリップボードコピー機能

**仕様ID**: `SPEC-c1d5bad7`
**作成日**: 2025-12-25
**更新日**: 2026-01-08
**ステータス**: 改訂中

## 背景

- 構造化ログ（JSONL形式）が `~/.gwt/logs/<cwd>/<YYYY-MM-DD>.jsonl` に出力されるようになった（SPEC-b9f5c4a1）
- しかし、ログを確認するにはファイルを直接開く必要があり、ユーザビリティが低い
- CLI上でログを簡単に確認・コピーできる機能が必要
- ブランチ一覧のカーソルとログ対象ディレクトリが一致せず、「No logs available」になるケースが発生した

## 定義

- **ログ一覧画面**: 構造化ログをリスト形式で表示する画面
- **ログ詳細表示**: 選択したログエントリの全フィールドをJSON形式で表示
- **クリップボードコピー**: 選択したログエントリをクリップボードにコピー
- **ログ対象ディレクトリ**: ログ読み込みの基準となるディレクトリ
- **ログソース**: gwt 本体ログ、コーディングエージェントの stdout/stderr を含むログの種類

## 必須要件

### 1. ログ一覧画面への遷移・対象の決定

- ブランチ選択画面で `l` キーを押すとログ一覧画面に遷移する
- 遷移時、**カーソル位置のブランチ**を対象にログ対象ディレクトリを決定する
- ログ対象ディレクトリは、対象ブランチの **worktree パスの basename** を用いて `~/.gwt/logs/<basename>/` を参照する
- 対象ブランチに worktree が無い、またはアクセス不可の場合は「ログがありません」と表示する
  - **要確認**: 現在ブランチで worktree が無い場合のみ、起動ディレクトリをフォールバックとして扱うか
- ログ一覧画面に **Branch** と **Source**（ログ対象ディレクトリ）を表示する

### 2. ログ一覧画面の表示

- 最新のログファイル（当日分）を読み込み、新しい順に表示する
- 当日分が空または存在しない場合は、**同じログ対象ディレクトリ内の最新ログ**へフォールバックする
- 各行は以下の形式で表示する:
  ```
  [HH:MM:SS] [LEVEL] [CATEGORY] message
  ```
- 表示件数は最大100件（パフォーマンス考慮）
- 上下キーでログエントリを選択できる
- `Esc` または `q` でブランチ選択画面に戻る

### 3. ログ詳細表示

- ログ一覧画面でログエントリを選択し、`Enter` を押すと詳細表示モードに遷移する
- 詳細表示では、選択したログエントリの全JSONフィールドを整形して表示する
- `Esc` または `q` でログ一覧画面に戻る

### 4. クリップボードコピー

- ログ一覧画面でログエントリを選択し、`c` を押すと、選択中のログエントリをクリップボードにコピーする
- コピー形式はJSON（整形済み）
- コピー成功時、画面下部に「クリップボードにコピーしました」と通知を表示する

### 5. 日付選択（オプション）

- ログ一覧画面で `d` を押すと、ログファイル（日付）を選択できる
- 過去7日分のログファイルをリスト表示し、選択した日付のログを表示する

### 6. コーディングエージェント stdout/stderr の取り込み

- gwt から起動したコーディングエージェントの stdout/stderr をログとして取り込む
- 取り込みログは JSONL として `~/.gwt/logs/<basename>/<YYYY-MM-DD>.jsonl` に追記する
- stdout/stderr は `category` を分けて識別できるようにする
  - 例: `agent.stdout`, `agent.stderr`
- **要確認**: 取り込みは常時有効か、明示的な opt-in（環境変数/設定）にするか

## キーバインド一覧

| 画面 | キー | 動作 |
| ---- | ---- | ---- |
| ブランチ選択 | `l` | ログ一覧画面へ遷移 |
| ログ一覧 | `↑` / `↓` | ログエントリを選択 |
| ログ一覧 | `Enter` | ログ詳細表示へ遷移 |
| ログ一覧 | `c` | 選択中のログをクリップボードにコピー |
| ログ一覧 | `d` | 日付選択モードへ遷移 |
| ログ一覧 | `Esc` / `q` | ブランチ選択画面へ戻る |
| ログ詳細 | `c` | 表示中のログをクリップボードにコピー |
| ログ詳細 | `Esc` / `q` | ログ一覧画面へ戻る |

## 非機能要件

- ログファイルの読み込みは非同期で行い、UIをブロックしない
- 大量のログ（1000件以上）がある場合も、最新100件のみ表示してパフォーマンスを確保
- PII/シークレットはマスク済みで表示される（SPEC-b9f5c4a1のマスキング仕様に従う）
- stdout/stderr 取り込み時も、インタラクティブな TTY 体験を損なわない

## 対象範囲

- gwt CLI のブランチ選択画面（OpenTUI/SolidJS）

## 依存仕様

- SPEC-b9f5c4a1: ログ運用統一仕様（ログファイルのパス・形式）

## テスト要件

1. `l` キーでログ一覧画面に遷移することを確認
2. カーソルブランチの worktree に対応するログディレクトリを参照することを確認
3. ログエントリが正しい形式で表示されることを確認
4. `Enter` でログ詳細が表示されることを確認
5. `c` でクリップボードにコピーされることを確認
6. `Esc` / `q` で前の画面に戻ることを確認
7. （stdout/stderr 取り込みが有効な場合）エージェント出力がログとして表示されることを確認
