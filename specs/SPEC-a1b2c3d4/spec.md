# 機能仕様: エージェント起動統計・システムモニター・About強化

**仕様ID**: `SPEC-a1b2c3d4`
**作成日**: 2026-02-14
**更新日**: 2026-02-14
**ステータス**: ドラフト
**カテゴリ**: GUI

**入力**: ユーザー説明: "各エージェントの起動回数を保存してAboutで表示。ブランチ（ワークツリー）作成回数も記録。AboutではCPU/メモリ/GPU情報をリアルタイム表示。ステータスバーにもCPU/メモリを常時表示"

## 背景

- 現在の gwt はエージェント起動やワークツリー作成の累計をどこにも記録していない
- About ダイアログはバージョン情報のみの最小実装で、利用状況やシステム状態が確認できない
- 開発者がエージェントの利用傾向やシステムリソースの状況を把握するための仕組みがない
- ステータスバーにシステム負荷が見えないため、エージェント実行中のリソース状態が不明

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - エージェント起動回数の記録 (優先度: P0)

ユーザーとして、エージェントを起動するたびに起動回数がエージェント種別×モデル別に自動的に記録されてほしい。

**独立したテスト**: エージェントを起動し、`~/.gwt/stats.toml` に起動回数がインクリメントされていること

**受け入れシナリオ**:

1. **前提条件** stats.toml が存在しない初回起動、**操作** Claude Code (claude-sonnet) を起動、**期待結果** `~/.gwt/stats.toml` が作成され、`claude-code.claude-sonnet` のグローバル起動回数が 1、現在のリポジトリの起動回数が 1 になる
2. **前提条件** stats.toml に claude-code の記録が既にある、**操作** 同じリポジトリで Claude Code を再度起動、**期待結果** グローバルとリポジトリ別の起動回数がそれぞれ +1 される
3. **前提条件** stats.toml に記録がある、**操作** 別のリポジトリで Claude Code を起動、**期待結果** グローバルは +1、新しいリポジトリの起動回数が 1 になる
4. **前提条件** サブエージェント対応のエージェントが起動中、**操作** サブエージェントが起動される、**期待結果** サブエージェントの種別×モデルでもカウントされる

---

### ユーザーストーリー 2 - ワークツリー作成回数の記録 (優先度: P0)

ユーザーとして、gwt 経由でワークツリーを作成するたびに作成回数が記録されてほしい。

**独立したテスト**: gwt GUI からワークツリーを作成し、stats.toml にワークツリー作成回数がインクリメントされていること

**受け入れシナリオ**:

1. **前提条件** stats.toml が存在しない、**操作** gwt GUI からエージェント起動時に新規ワークツリーが作成される、**期待結果** グローバルとリポジトリ別のワークツリー作成回数がそれぞれ 1 になる
2. **前提条件** ワークツリー記録がある、**操作** 追加のワークツリーを作成、**期待結果** カウントが +1 される
3. **前提条件** ユーザーがターミナル内で手動 `git worktree add`、**操作** 手動実行、**期待結果** カウントされない（gwt 経由のみ）

---

### ユーザーストーリー 3 - ステータスバーにCPU/メモリ表示 (優先度: P0)

ユーザーとして、ステータスバーでCPU使用率とメモリ使用量をリアルタイムに確認したい。

**独立したテスト**: アプリ起動後にステータスバーにCPU/メモリ情報がASCIIバー+テキストで表示されること

**受け入れシナリオ**:

1. **前提条件** アプリが起動している、**操作** ステータスバーを確認、**期待結果** spacer の右側に `CPU [||||    ] 45%  MEM [||||||  ] 78%` のようなASCIIバー+テキストが表示される
2. **前提条件** CPU使用率が70%未満、**操作** ステータスバーを確認、**期待結果** バーとテキストが緑色（`--green`）で表示される
3. **前提条件** CPU使用率が70%以上90%未満、**操作** ステータスバーを確認、**期待結果** バーとテキストが黄色（`--yellow`）で表示される
4. **前提条件** メモリ使用率が90%以上、**操作** ステータスバーを確認、**期待結果** バーとテキストが赤色（`--red`）で表示される
5. **前提条件** アプリウィンドウが最小化されている、**操作** 最小化中のポーリング状態を確認、**期待結果** ポーリングが停止している

---

### ユーザーストーリー 4 - ステータスバーからAboutを開く (優先度: P0)

ユーザーとして、ステータスバーのCPU/メモリ表示部分をクリックして、Aboutダイアログの System タブを直接開きたい。

**独立したテスト**: ステータスバーのシステム情報表示をクリックし、About の System タブが表示されること

**受け入れシナリオ**:

1. **前提条件** アプリが起動している、**操作** ステータスバーのCPU/MEM表示をクリック、**期待結果** About ダイアログが開き、System タブがアクティブになる
2. **前提条件** About ダイアログが開いている、**操作** メニューから About を選択、**期待結果** 既に開いているので何も起きない（二重表示しない）

---

### ユーザーストーリー 5 - About General タブ (優先度: P0)

ユーザーとして、About の General タブでバージョン情報と検出済みエージェント一覧を確認したい。

**独立したテスト**: メニューから About を開き、General タブにバージョンとエージェント一覧が表示されること

**受け入れシナリオ**:

1. **前提条件** アプリが起動している、**操作** メニューから About を選択、**期待結果** About ダイアログが General タブをデフォルトで表示し、アプリ名・バージョン・検出済みエージェント一覧が表示される

---

### ユーザーストーリー 6 - About System タブ (優先度: P0)

ユーザーとして、About の System タブでCPU/メモリ/GPU情報をリアルタイムに確認したい。

**独立したテスト**: About の System タブにCPU/メモリ/GPU情報がリアルタイム更新で表示されること

**受け入れシナリオ**:

1. **前提条件** About の System タブが表示中、**操作** 1秒待つ、**期待結果** CPU使用率・メモリ使用量/総量が更新される
2. **前提条件** NVIDIA GPU搭載マシン（nvidia-smi あり）、**操作** System タブを確認、**期待結果** GPU名・VRAM・GPU使用率が表示される
3. **前提条件** Apple Silicon Mac、**操作** System タブを確認、**期待結果** GPUモデル名が表示される（使用率は非表示）
4. **前提条件** About を閉じる、**操作** About を閉じた後のポーリング状態を確認、**期待結果** About 用のポーリングが停止している（ステータスバーのポーリングは継続）

---

### ユーザーストーリー 7 - About Statistics タブ (優先度: P0)

ユーザーとして、About の Statistics タブでエージェント起動回数とワークツリー作成回数をテーブル形式で確認したい。

**独立したテスト**: About の Statistics タブにエージェント起動回数テーブルとワークツリー作成回数が表示されること

**受け入れシナリオ**:

1. **前提条件** エージェント起動記録がある、**操作** Statistics タブを開く、**期待結果** デフォルトでグローバル累計のテーブル（Agent | Model | Count）が表示される
2. **前提条件** 複数リポジトリでエージェント起動記録がある、**操作** リポジトリフィルタドロップダウンで特定リポジトリを選択、**期待結果** そのリポジトリの起動回数のみが表示される
3. **前提条件** stats.toml が存在しない、**操作** Statistics タブを開く、**期待結果** 「No statistics yet」のようなメッセージが表示される
4. **前提条件** ワークツリー作成記録がある、**操作** Statistics タブを確認、**期待結果** ワークツリー作成回数がグローバル累計で表示される

## エッジケース

- stats.toml が破損している場合 → パースエラーを無視し、空の統計データとして扱う。次の書き込みで再作成
- stats.toml が読み取り専用の場合 → 書き込みエラーをログに記録し、アプリ動作は継続
- リポジトリパスに特殊文字（スペース、日本語）がある場合 → TOML のキーとして正しくエスケープ
- sysinfo の CPU 取得が失敗する場合 → ステータスバーに `CPU: --` と表示
- nvml-wrapper が初期化失敗（NVIDIAドライバなし）→ GPU セクションを非表示にし、静的情報のみ表示
- アプリ起動直後の CPU 値 → sysinfo は初回取得で0%を返すことがあるため、2回目以降の値を使用
- stats.toml の書き込み中にアプリがクラッシュ → アトミック書き込み（temp+rename）により中間状態なし
- カスタムエージェント名が非常に長い場合 → TOML キーとして有効な範囲でトランケート

## 要件 *(必須)*

### 機能要件

- **FR-001**: `~/.gwt/stats.toml` に統計データを永続化する
- **FR-002**: エージェント起動時に、エージェント種別×モデル別の起動回数をグローバルおよびリポジトリ別にインクリメントする
- **FR-003**: サブエージェント・ユーザーカスタムエージェントの起動もカウントに含める
- **FR-004**: 起動要求時点（launch_agent 呼び出し時）でカウントする（成功/失敗を問わない）
- **FR-005**: gwt 経由のワークツリー作成時に、作成回数をグローバルおよびリポジトリ別にインクリメントする
- **FR-006**: 既存のステータスバー（spacer の右側）に CPU 使用率と メモリ使用量を ASCII バー + テキストで表示する
- **FR-007**: ステータスバーの高さを 24px から 28px に拡張する
- **FR-008**: CPU/メモリの色分け: 70%未満=green, 70-90%=yellow, 90%以上=red
- **FR-009**: ステータスバーのシステム情報クリックで About ダイアログの System タブを開く
- **FR-010**: About ダイアログを3タブ構成にする（General / System / Statistics）
- **FR-011**: メニューからの About は General タブ、ステータスバーからは System タブをデフォルト表示する
- **FR-012**: System タブに CPU 使用率・メモリ使用量/総量・GPU 情報をリアルタイム表示する
- **FR-013**: NVIDIA GPU は nvml-wrapper crate で使用率・VRAM 使用量を取得する
- **FR-014**: 非NVIDIA環境では GPU の静的情報（モデル名）のみ表示する
- **FR-015**: Statistics タブにエージェント起動回数テーブル（Agent | Model | Count）を表示する
- **FR-016**: Statistics タブにリポジトリフィルタドロップダウンを設置し、デフォルトはグローバル累計
- **FR-017**: Statistics タブにワークツリー作成回数を表示する
- **FR-018**: stats.toml の書き込みはアトミック（temp ファイル + rename）で行う

### 非機能要件

- **NFR-001**: システム情報ポーリング間隔は1秒。ウィンドウ非表示時はポーリングを停止する
- **NFR-002**: stats.toml への書き込みはエージェント起動のクリティカルパスをブロックしない（非同期で行う）
- **NFR-003**: sysinfo crate は必要な機能フラグのみ有効化し、バイナリサイズ増加を最小限にする
- **NFR-004**: ステータスバーのレンダリングは16ms以内（60fps維持）

## 制約と仮定

- sysinfo crate を使用して CPU/メモリ情報を取得する（クロスプラットフォーム対応）
- nvml-wrapper crate を使用して NVIDIA GPU 情報を取得する（NVIDIA環境のみ）
- Apple Silicon Mac では GPU 使用率のリアルタイム取得は行わない（静的情報のみ）
- stats.toml は TOML 形式で保存する（既存設定ファイルとの統一感）
- カウントの記録タイミングはエージェント起動要求時（プロセス起動成功の確認は待たない）
- gwt はシングルプロセスだが、将来の複数ウィンドウ対応を見据えてアトミック書き込みを採用する

## 成功基準 *(必須)*

- **SC-001**: エージェント起動のたびに stats.toml の起動回数が正しくインクリメントされる
- **SC-002**: ワークツリー作成のたびに stats.toml の作成回数が正しくインクリメントされる
- **SC-003**: ステータスバーに CPU/メモリが ASCII バー + テキスト + 色分けで表示され、1秒間隔で更新される
- **SC-004**: ステータスバーのシステム情報クリックで About の System タブが開く
- **SC-005**: About の3タブが正しく動作し、各タブの内容が仕様通りに表示される
- **SC-006**: NVIDIA 環境で GPU 使用率がリアルタイム表示される
- **SC-007**: stats.toml が破損してもアプリが正常に動作する
