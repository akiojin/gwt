# タスク: Claude Code プラグインマーケットプレイス自動登録

**入力**: `/specs/SPEC-f8dab6e2/` からの設計ドキュメント
**前提条件**: spec.md（必須）、plan.md（必須）

## フォーマット: `[ID] [P?] [ストーリー] 説明`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[ストーリー]**: このタスクが属するユーザーストーリー（例: US1、US2、US3）

## Lint最小要件

- `cargo clippy --all-targets --all-features -- -D warnings`
- `cargo fmt --check`
- `cargo test`

## フェーズ1: セットアップ（TDDテスト作成）

**目的**: TDDに従い、テストを先に作成

### テストタスク

- [x] **T001** [P] [共通] `crates/gwt-core/src/config/claude_plugins.rs` に新規ファイルを作成し、テストモジュールを追加
- [x] **T002** [P] [共通] `crates/gwt-core/src/config/mod.rs` に `claude_plugins` モジュールを追加
- [x] **T003** [共通] T001の後に FR-001〜FR-010 に対応するテストケースを作成（全テストは失敗状態）

## フェーズ2: ユーザーストーリー1 - マーケットプレイス未登録時の自動登録 (優先度: P1)

**ストーリー**: 未登録時に確認ダイアログを表示し、同意後にマーケットプレイスとプラグインを登録

**価値**: worktree-protection-hooksプラグインが自動的に利用可能になる

### データ層

- [x] **T101** [US1] `crates/gwt-core/src/config/claude_plugins.rs` に `KnownMarketplaces` 構造体を定義
- [x] **T102** [US1] T101の後に `get_known_marketplaces_path()` 関数を実装
- [x] **T103** [US1] T102の後に `load_known_marketplaces()` 関数を実装
- [x] **T104** [US1] T103の後に `save_known_marketplaces()` 関数を実装

### ビジネスロジック

- [x] **T105** [US1] T104の後に `is_gwt_marketplace_registered()` 関数を実装
- [x] **T106** [US1] T105の後に `register_gwt_marketplace()` 関数を実装
- [x] **T107** [US1] T106の後に `enable_worktree_protection_plugin()` 関数を実装
- [x] **T108** [US1] T107の後に `setup_gwt_plugin()` 関数を実装（一括実行）

### UI/確認ダイアログ

- [x] **T109** [US1] `crates/gwt-cli/src/tui/screens/confirm.rs` に `plugin_setup()` メソッドを追加
- [x] **T110** [US1] T109の後に Claude Code起動フローに確認ダイアログ呼び出しを追加

### テスト検証

- [x] **T111** [US1] T110の後に US1関連のテストがすべて成功することを確認

**✅ MVP1チェックポイント**: US1完了後、基本的なプラグイン自動登録が動作

## フェーズ3: ユーザーストーリー2 - マーケットプレイス登録済み時のスキップ (優先度: P1)

**ストーリー**: 登録済みの場合は確認ダイアログを表示しない

**価値**: 登録済みユーザーの操作を妨げない

### ビジネスロジック

- [x] **T201** [US2] Claude Code起動フローで `is_gwt_marketplace_registered()` を呼び出し、登録済みならスキップ

### テスト検証

- [x] **T202** [US2] T201の後に US2関連のテストがすべて成功することを確認

**✅ MVP2チェックポイント**: US2完了後、登録済み時のスキップが動作

## フェーズ4: ユーザーストーリー3 - Codex選択時は登録をスキップ (優先度: P2)

**ストーリー**: Codex起動時はプラグイン登録の確認ダイアログを表示しない

**価値**: Codexユーザーに不要な確認を表示しない

### ビジネスロジック

- [x] **T301** [US3] エージェント選択でCodexが選ばれた場合、プラグイン登録フローをスキップする条件を追加

### テスト検証

- [x] **T302** [US3] T301の後に US3関連のテストがすべて成功することを確認

**✅ MVP3チェックポイント**: US3完了後、Codex起動時のスキップが動作

## フェーズ5: ユーザーストーリー4 - ファイル/ディレクトリの自動作成 (優先度: P2)

**ストーリー**: `~/.claude/plugins/`やファイルが存在しない場合に自動作成

**価値**: 新規ユーザーでもスムーズに設定可能

### ビジネスロジック

- [x] **T401** [US4] `register_gwt_marketplace()` 内でディレクトリ自動作成ロジックを追加

### テスト検証

- [x] **T402** [US4] T401の後に US4関連のテストがすべて成功することを確認

**✅ 完全な機能**: US4完了後、すべての要件が満たされます

## フェーズ6: 統合とポリッシュ

**目的**: すべてのストーリーを統合し、プロダクション準備を整える

### 統合

- [x] **T501** [統合] `cargo test` ですべてのテストが成功することを確認
- [x] **T502** [統合] `cargo clippy --all-targets --all-features -- -D warnings` が成功することを確認
- [x] **T503** [統合] `cargo fmt --check` が成功することを確認
- [ ] **T504** [統合] エッジケース（不正JSON、権限エラー等）のテストを追加

### ドキュメント

- [ ] **T505** [P] [ドキュメント] `CLAUDE.md` にプラグイン自動登録機能の説明を追加

### コミット

- [ ] **T506** [デプロイ] すべての変更をコミット＆プッシュ

## タスク凡例

**優先度**:
- **P1**: 最も重要 - MVP1/MVP2に必要
- **P2**: 重要 - 完全な機能に必要

**ストーリータグ**:
- **[US1]**: マーケットプレイス未登録時の自動登録
- **[US2]**: マーケットプレイス登録済み時のスキップ
- **[US3]**: Codex選択時は登録をスキップ
- **[US4]**: ファイル/ディレクトリの自動作成
- **[共通]**: すべてのストーリーで共有
- **[統合]**: 複数ストーリーにまたがる
- **[ドキュメント]**: ドキュメント専用
- **[デプロイ]**: デプロイメント専用

## 進捗追跡

- **完了したタスク**: `[x]` でマーク
- **進行中のタスク**: タスクIDの横にメモを追加
- **ブロックされたタスク**: ブロッカーを文書化
