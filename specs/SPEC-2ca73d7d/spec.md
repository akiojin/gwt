# 機能仕様: エージェント履歴の永続化

**仕様ID**: `SPEC-2ca73d7d`
**作成日**: 2026-01-22
**更新日**: 2026-01-22
**ステータス**: 草案
**入力**: ユーザー説明: "Worktreeがないブランチでも直近使用したエージェント情報を表示するため、エージェント履歴をgwt独自で永続化する機能"

## 概要

gwtは、エージェント起動時にブランチとエージェントの関連情報を永続化し、Worktreeが削除された後もブランチ一覧画面で「直近使用したエージェント」を表示できるようにする。これにより、開発者はWorktreeの有無に関係なく、どのブランチでどのエージェントを使用したかを視覚的に確認できる。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Worktreeなしブランチでの履歴表示 (優先度: P1)

開発者がWorktreeを削除した後も、そのブランチで最後に使用したエージェント名がブランチ一覧に表示され、過去の作業履歴を確認できる。

**この優先度の理由**: Worktreeを削除してもブランチは残ることが多く、過去にどのエージェントで作業していたかを知ることは、作業再開時の判断に有用である。

**独立したテスト**: Worktreeを作成→エージェント起動→Worktree削除→ブランチ一覧を確認し、エージェント名が表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** feature/testブランチでClaude Codeを起動した履歴がある、**操作** Worktreeを削除し、ブランチ一覧を表示、**期待結果** feature/testブランチに`Claude@latest`形式でエージェント名が表示される
2. **前提条件** エージェント履歴がないブランチ、**操作** ブランチ一覧を表示、**期待結果** エージェント情報は空白で表示される
3. **前提条件** 同じブランチで複数のエージェントを使用した履歴がある、**操作** ブランチ一覧を表示、**期待結果** 最後に使用したエージェントのみが表示される

---

### ユーザーストーリー 2 - エージェント起動時の自動記録 (優先度: P1)

開発者がgwtからエージェントを起動すると、ブランチ名とエージェント情報が自動的に永続化され、明示的な操作なしに履歴が蓄積される。

**この優先度の理由**: 開発者の操作を増やさずに履歴を蓄積することで、自然な利用フローを維持しながら機能を提供できる。

**独立したテスト**: gwtからエージェントを起動し、~/.config/gwt/agent-history.jsonに記録が追加されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** ~/.config/gwt/agent-history.jsonが存在しない、**操作** gwtからClaude Codeを起動、**期待結果** ファイルが作成され、リポジトリパス・ブランチ名・エージェント情報が記録される
2. **前提条件** 既存の履歴ファイルがある、**操作** 別のブランチでCodexを起動、**期待結果** 既存の履歴は維持され、新しいエントリが追加される
3. **前提条件** 同じブランチで既に履歴がある、**操作** 異なるエージェントを起動、**期待結果** そのブランチの履歴が最新のエージェント情報で上書きされる

---

### ユーザーストーリー 3 - 複数リポジトリの履歴管理 (優先度: P2)

開発者が複数のリポジトリでgwtを使用する場合、各リポジトリの履歴は独立して管理され、異なるリポジトリの履歴が混在しない。

**この優先度の理由**: 実務では複数のリポジトリを扱うことが多く、履歴の混在は混乱を招く。

**独立したテスト**: 2つのリポジトリで異なるブランチ・エージェントを使用し、各リポジトリで正しい履歴が表示されることで検証できる。

**受け入れシナリオ**:

1. **前提条件** リポジトリAとBでそれぞれ異なるエージェントを使用した履歴がある、**操作** リポジトリAでgwtを起動、**期待結果** リポジトリAの履歴のみが表示され、リポジトリBの履歴は表示されない
2. **前提条件** リポジトリAで履歴を記録、**操作** リポジトリBでgwtを起動、**期待結果** リポジトリBでは履歴が表示されず、リポジトリAの履歴ファイルは影響を受けない

---

### エッジケース

- 履歴ファイルが破損している場合、空の履歴として扱い、既存の動作に影響を与えない
- ディスク容量不足で書き込みに失敗した場合、エラーをログに記録するが、エージェント起動自体は継続する
- リポジトリパスが変更された場合（移動・リネーム）、新しいパスとして扱われ、古いパスの履歴は参照されない
- ブランチ名に特殊文字（スラッシュ、スペース等）が含まれる場合も正しく処理される

## 要件 *(必須)*

### 機能要件

#### 履歴記録要件

- **FR-001**: gwtは、エージェント起動時にブランチ名とエージェント情報（エージェント名、バージョン）を永続化**しなければならない**
- **FR-002**: 履歴データは`~/.config/gwt/agent-history.json`に保存**しなければならない**
- **FR-003**: 履歴データはリポジトリの絶対パスをキーとしたJSON構造で管理**しなければならない**
- **FR-004**: 同一ブランチで複数回エージェントを起動した場合、最新のエントリのみを保持**しなければならない**
- **FR-005**: 履歴の保存は永久とし、自動削除は行わ**ない**

#### 履歴表示要件

- **FR-010**: ブランチ一覧画面は、Worktreeの有無に関係なく履歴からエージェント情報を取得**しなければならない**
- **FR-011**: Worktreeがあるブランチでは、実行中エージェント情報を履歴より優先して表示**しなければならない**
- **FR-012**: 履歴から取得したエージェント情報は、`{AgentName}@{version}`形式で表示**しなければならない**（例: `Claude@latest`）
- **FR-013**: 履歴がないブランチでは、エージェント情報を空白で表示**しなければならない**

#### データ構造要件

- **FR-020**: 履歴JSONは以下の構造を持た**なければならない**:

```json
{
  "repos": {
    "/absolute/path/to/repo": {
      "branches": {
        "branch-name": {
          "agent_id": "claude-code",
          "agent_label": "Claude@latest",
          "updated_at": "2026-01-22T10:30:00Z"
        }
      }
    }
  }
}
```

- **FR-021**: `agent_id`はエージェントの識別子（`claude-code`, `codex-cli`, `gemini-cli`, `opencode`）を保存**しなければならない**
- **FR-022**: `agent_label`は表示用のラベル（`Claude@latest`形式）を保存**しなければならない**
- **FR-023**: `updated_at`は最終更新日時をISO 8601形式で保存**しなければならない**

#### 耐障害性要件

- **FR-030**: 履歴ファイルの読み込みに失敗した場合、空の履歴として扱い、エラーをログに記録**しなければならない**
- **FR-031**: 履歴ファイルの書き込みに失敗した場合、エージェント起動自体は継続**しなければならない**
- **FR-032**: 履歴ファイルが存在しない場合、初回書き込み時に自動作成**しなければならない**
- **FR-033**: `~/.config/gwt/`ディレクトリが存在しない場合、自動作成**しなければならない**

### 主要エンティティ

- **AgentHistoryEntry**: ブランチごとのエージェント履歴エントリ。agent_id（文字列）、agent_label（文字列）、updated_at（日時）を含む
- **AgentHistoryStore**: リポジトリごとの履歴ストア。repos（キー: リポジトリパス、値: ブランチ履歴マップ）を含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: Worktree削除後も、履歴のあるブランチで100%エージェント情報が表示される
- **SC-002**: エージェント起動から履歴記録までの遅延が100ms以内である
- **SC-003**: 1000ブランチの履歴を持つリポジトリでも、起動時の読み込みが500ms以内である
- **SC-004**: 履歴ファイル破損時も、ブランチ一覧画面は正常に表示される

## 制約と仮定 *(該当する場合)*

### 制約

- `~/.config/`ディレクトリへの書き込み権限が必要
- ファイルシステムがJSON書き込みに対応している必要がある

### 仮定

- リポジトリパスは一意であり、同一パスが複数のリポジトリを指すことはない
- ユーザーは`~/.config/gwt/`を手動で操作しないことを想定

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 履歴のエクスポート・インポート機能
- 履歴の手動編集UI
- 履歴のクラウド同期
- 履歴の有効期限設定

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 履歴ファイルにはリポジトリの絶対パスとブランチ名が含まれるが、機密情報（コード内容、APIキー等）は含まれない
- ファイルパーミッションは600（所有者のみ読み書き可能）で作成する

## 依存関係 *(該当する場合)*

- serde/serde_json: JSON シリアライズ/デシリアライズ
- dirs: ホームディレクトリ取得
- chrono: 日時処理

## 参考資料 *(該当する場合)*

- SPEC-3b0ed29b: コーディングエージェント対応
- SPEC-d2f4762a: ブランチ選択画面仕様
