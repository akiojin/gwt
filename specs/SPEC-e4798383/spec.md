# 機能仕様: GitHub Issue連携によるブランチ作成

**仕様ID**: `SPEC-e4798383`
**作成日**: 2025-01-25
**ステータス**: US1-US6完了（97%）、T604-T605のみオプション
**入力**: ユーザー説明: "ブランチタイプでbugfixを指定した場合に、GitHubのIssue番号を指定してブランチを作成する機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - GitHub Issueを選択してブランチを作成できる (優先度: P1)

開発者がブランチ作成時にGitHub Issueを選択し、Issue番号を含む命名規則に従ったブランチを自動生成できる。

**この優先度の理由**: Issue駆動開発において、ブランチとIssueの紐付けは最も基本的なワークフロー。手動でのブランチ名入力はミスや不一致の原因となる。

**独立したテスト**: ウィザードでIssueを選択し、`{type}/issue-{number}`形式のブランチ名が自動入力されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** ユーザーがブランチタイプ（feature）を選択済み、**操作** 「GitHub Issue」ステップに進む、**期待結果** リポジトリのopen Issueが一覧表示される
2. **前提条件** Issue一覧が表示されている、**操作** Issue #42「Fix login bug」を選択、**期待結果** ブランチ名入力欄に`feature/issue-42`が自動入力される
3. **前提条件** ブランチ名が自動入力されている、**操作** 確認画面に進む、**期待結果** 確認画面にIssue情報（#42: Fix login bug）が表示される

---

### ユーザーストーリー 2 - Issue選択をスキップして従来通りブランチを作成できる (優先度: P1)

開発者がIssue連携を使わず、従来通り手動でブランチ名を入力して作成できる。

**この優先度の理由**: 全ての作業がIssueに紐づくわけではなく、柔軟性を確保する必要がある。

**独立したテスト**: Issue選択ステップで空Enterを押し、ブランチ名入力画面に遷移することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 「GitHub Issue」ステップが表示されている、**操作** 何も選択せずにEnterを押す、**期待結果** ブランチ名入力ステップに進み、入力欄は空のまま
2. **前提条件** ブランチ名入力欄が空、**操作** 手動で「my-feature」と入力、**期待結果** `feature/my-feature`として正常に処理される

---

### ユーザーストーリー 3 - インクリメンタル検索でIssueを絞り込める (優先度: P2)

開発者がIssue一覧から目的のIssueをキーワード入力で素早く見つけられる。

**この優先度の理由**: Issueが多数ある場合、スクロールだけでは非効率。検索機能により作業効率が向上する。

**独立したテスト**: Issue一覧画面で文字を入力し、タイトルに一致するIssueのみが表示されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** Issue一覧（100件）が表示されている、**操作** 「login」と入力、**期待結果** タイトルに「login」を含むIssueのみが表示される
2. **前提条件** 検索結果が絞り込まれている、**操作** バックスペースで検索文字を削除、**期待結果** 全Issueが再表示される

---

### ユーザーストーリー 4 - 全ブランチタイプでIssue連携が使える (優先度: P1)

feature、bugfix、hotfix、releaseの全ブランチタイプでIssue連携機能が利用できる。

**この優先度の理由**: Issue連携はブランチタイプに関係なく有用。特定タイプに限定する理由がない。

**独立したテスト**: 各ブランチタイプを選択し、Issue選択ステップに進めることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** bugfixタイプを選択、**操作** Issue #10を選択、**期待結果** `bugfix/issue-10`が自動入力される
2. **前提条件** hotfixタイプを選択、**操作** Issue #5を選択、**期待結果** `hotfix/issue-5`が自動入力される

---

### ユーザーストーリー 5 - 同一Issueで重複ブランチを防止できる (優先度: P2)

開発者が既にブランチが存在するIssueを選択しようとした場合、重複作成を防止する。

**この優先度の理由**: 同一Issueに複数ブランチが存在すると混乱を招く。重複防止により一貫性を確保。

**独立したテスト**: 既存ブランチがあるIssueを選択し、ブロックされることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** `feature/issue-42`ブランチが既に存在する、**操作** featureタイプでIssue #42を選択、**期待結果** エラーメッセージが表示され選択がブロックされる

---

### ユーザーストーリー 6 - GitHub上でIssueとブランチを自動連携できる (優先度: P2)

開発者がブランチ作成時に、GitHub上でIssueとブランチが正式にリンクされ、Issueの「Development」セクションに表示される。

**この優先度の理由**: GitHub上での追跡性が向上し、PRを作成した際の自動クローズ連携も機能する。

**独立したテスト**: `gh issue develop`コマンドでブランチを作成し、GitHub上でIssueの「Development」セクションにブランチが表示されることで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** Issue #42を選択してブランチ作成、**操作** ウィザードを完了、**期待結果** GitHub上のIssue #42の「Development」セクションに作成したブランチがリンクされる
2. **前提条件** リンクされたブランチからPRを作成、**操作** PRをマージ、**期待結果** Issue #42が自動的にクローズされる（PR説明に"Fixes #42"を含む場合）
3. **前提条件** `gh issue develop`が失敗（権限不足等）、**操作** エラー発生、**期待結果** 従来のローカルブランチ作成にフォールバックし、警告を表示

---

### エッジケース

- gh CLIがインストールされていない場合、Issue選択ステップは自動的にスキップされる
- GitHubに接続できない（オフライン、認証エラー）場合、エラーメッセージを表示してフローを中止
- 指定されたIssue番号が存在しない場合、警告を表示するが続行可能
- Issue一覧が0件の場合、Issue選択をスキップしてブランチ名入力へ遷移する
- Issueタイトルに特殊文字（引用符、改行等）が含まれる場合でも正常に表示される

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはWizardStepに`IssueSelect`ステップを追加**しなければならない**
- **FR-002**: Issue選択ステップは「GitHub Issue」というタイトルで表示**しなければならない**
- **FR-003**: ウィザードフローは`BranchTypeSelect` → `IssueSelect` → `BranchNameInput`の順序で進行**しなければならない**
- **FR-004**: Issue選択ステップは空Enterでスキップ可能**でなければならない**
- **FR-005**: システムはgh CLIを使用してopen状態のIssue一覧を取得**しなければならない**
- **FR-005a**: Issue取得件数は最大50件とする**こと**
- **FR-005b**: Issue取得中は「Loading issues...」を表示**しなければならない**
- **FR-005c**: Issue一覧が0件の場合、Issue選択ステップを自動的にスキップしてブランチ名入力へ遷移**しなければならない**
- **FR-006**: Issue一覧は更新日時の降順でソート**しなければならない**
- **FR-007**: 各Issueは`#番号: タイトル`形式（例: `#42: Fix login bug`）で表示**しなければならない**
- **FR-008**: システムはタイトルによるインクリメンタル検索を提供**しなければならない**
- **FR-008a**: 検索結果が0件の場合、「No matching issues」を表示する**こと**
- **FR-008b**: 長いタイトルは端末幅に応じて切り捨て、末尾に「...」を表示する**こと**
- **FR-009**: Issue選択時、ブランチ名は`{type}/issue-{number}`形式で自動生成**しなければならない**
- **FR-010**: 自動生成されたブランチ名はユーザーが編集可能**でなければならない**
- **FR-010a**: ブランチタイプのプレフィックス（例: feature/）は固定とし、それ以降の部分（例: issue-42）を編集可能とする**こと**
- **FR-011**: 同一Issue番号のブランチが既に存在する場合、選択をブロック**しなければならない**
- **FR-011a**: 重複時のエラーメッセージは「Branch for issue #N already exists」とする**こと**
- **FR-012**: gh CLIが未インストールの場合、Issue選択ステップを自動スキップ**しなければならない**
- **FR-013**: GitHub API呼び出し失敗時（オフライン、認証エラー）はエラーメッセージを表示して中止**しなければならない**
- **FR-014**: 確認画面にはIssue情報（番号、タイトル）を表示**しなければならない**
- **FR-015**: 存在しないIssue番号が指定された場合、警告を表示するが続行を許可**しなければならない**
- **FR-016**: Issueを選択した場合、`gh issue develop`コマンドでGitHubにリンクされたブランチを作成**しなければならない**
- **FR-016a**: `gh issue develop`コマンドは`--name`オプションでブランチ名を指定する**こと**
- **FR-016b**: `gh issue develop`コマンドは`--checkout=false`オプションでチェックアウトを抑制する**こと**（worktree作成後にチェックアウトするため）
- **FR-017**: `gh issue develop`が失敗した場合、従来のローカルブランチ作成にフォールバック**しなければならない**
- **FR-017a**: フォールバック時は警告メッセージ「GitHub linking failed, creating local branch」を表示する**こと**
- **FR-018**: Issueをスキップした場合（selected_issue=None）は従来のローカルブランチ作成を使用**しなければならない**
- **FR-019**: `gh issue develop`の成功時、ログに「Branch linked to issue #N on GitHub」を出力**しなければならない**

### 非機能要件

- **NFR-001**: Issue一覧取得は3秒以内に完了**しなければならない**（100件未満の場合）
- **NFR-002**: インクリメンタル検索は100ms以内に結果を更新**しなければならない**

### 主要エンティティ

- **WizardStep**: ウィザードのステップを表すenum。既存のBranchTypeSelect、BranchNameInputに加えてIssueSelectを追加
- **GitHubIssue**: GitHub Issueを表す構造体。number(u64)、title(String)、updated_at(String)を持つ
- **WizardState**: ウィザード状態を表す構造体。selected_issue(Option<GitHubIssue>)フィールドを追加
- **IssueSelectState**: Issue選択ステップの状態。issues(Vec<GitHubIssue>)、filtered_issues(Vec<GitHubIssue>)、search_query(String)、selected_index(usize)を持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはIssue選択から10秒以内にブランチ名を自動生成できる
- **SC-002**: システムは`{type}/issue-{number}`形式のブランチ名を100%正確に生成できる
- **SC-003**: 重複ブランチの作成は100%ブロックされる
- **SC-004**: gh CLIがない環境でも、既存のブランチ作成フローが正常に動作する（Issue選択ステップがスキップされる）
- **SC-005**: 既存のウィザードフロー（Agent選択、Model選択等）に影響を与えない

## 制約と仮定 *(該当する場合)*

### 制約

- gh CLI（GitHub CLI）がインストール・認証済みであることを前提とする（未インストール時はスキップ）
- Issue取得はgh CLIの`gh issue list`コマンドに依存する
- 既存のWizardState構造体を拡張する形で実装する（破壊的変更を避ける）

### 仮定

- ユーザーはGitHub Issueを活用したワークフローを採用している
- リポジトリのIssue数は1000件未満である（ページネーション未実装）
- ブランチ名に含まれるIssue番号は一意性を保証するのに十分である

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- GitHub以外のIssueトラッカー（GitLab、Jira等）のサポート
- closed状態のIssueの選択
- Issue作成機能
- Issueへのコメント追加機能
- Issueのlabel、assignee、milestoneによるフィルタリング
- Issue情報のworktreeメタデータへの永続化
- 複数Issueを1ブランチに紐付ける機能
- PR作成時の自動クローズキーワード挿入（ユーザーがPR説明に"Fixes #N"を記載する必要あり）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- gh CLIの認証情報はgh CLI自体が管理し、本アプリケーションは保持しない
- Issue情報（タイトル等）はメモリ上でのみ保持し、永続化しない

## 依存関係 *(該当する場合)*

- **gh CLI**: GitHub CLIツール。Issue一覧取得に使用
- **既存ウィザード実装**: crates/gwt-cli/src/tui/screens/wizard.rs
- **既存ブランチタイプ定義**: WizardState.branch_type、BranchType enum

## 参考資料 *(該当する場合)*

- [GitHub CLI Issue List](https://cli.github.com/manual/gh_issue_list)
- [GitHub CLI Issue Develop](https://cli.github.com/manual/gh_issue_develop) - ブランチをIssueにリンクして作成
- [既存ウィザード実装](../../crates/gwt-cli/src/tui/screens/wizard.rs)
