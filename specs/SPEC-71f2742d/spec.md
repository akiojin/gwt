# 機能仕様: カスタムコーディングエージェント登録機能

**仕様ID**: `SPEC-71f2742d`
**作成日**: 2026-01-26
**ステータス**: ドラフト
**入力**: ユーザー説明: "カスタムコーディングエージェント登録機能: ビルトインエージェント（Claude Code, Codex CLI, Gemini CLI, OpenCode）に加えて、ユーザーが独自のコーディングエージェントを ~/.gwt/tools.json に定義して利用できる機能。customCodingAgents配列でid, displayName, type, command, defaultArgs, modeArgs, permissionSkipArgs, envを指定可能。登録されたカスタムエージェントはWizardのエージェント選択画面に表示され、ビルトインと同様に起動できる。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - tools.jsonからのカスタムエージェント読み込み (優先度: P1)

開発者がグローバル（~/.gwt/tools.json）またはプロジェクトローカル（.gwt/tools.json）にカスタムエージェントを定義すると、gwtのWizard画面でエージェント選択時にビルトインエージェントと共に表示される。

**この優先度の理由**: カスタムエージェント機能の基盤であり、他のすべての機能がこの読み込み機能に依存する。

**独立したテスト**: tools.jsonファイルを作成し、Wizardでカスタムエージェントが表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ~/.gwt/tools.jsonに有効なカスタムエージェントが定義されている、**操作** Wizardのエージェント選択ステップを開く、**期待結果** ビルトイン4種の後にセパレータを挟んでカスタムエージェントが表示される
2. **前提条件** プロジェクト.gwt/tools.jsonとグローバル~/.gwt/tools.jsonの両方に異なるカスタムエージェントが定義されている、**操作** Wizardを開く、**期待結果** 両方のカスタムエージェントがマージされて表示される
3. **前提条件** 同一IDのカスタムエージェントがローカルとグローバルの両方に存在、**操作** Wizardを開く、**期待結果** ローカル定義が優先される
4. **前提条件** tools.jsonのversion フィールドがない、**操作** 読み込み、**期待結果** エラーとしてスキップされる

---

### ユーザーストーリー 2 - カスタムエージェントの起動 (優先度: P1)

開発者がWizardでカスタムエージェントを選択し、設定を完了すると、定義されたcommandとargsでエージェントが起動する。modeArgs、env、permissionSkipArgs等がビルトインエージェントと同様に適用される。

**この優先度の理由**: エージェントを表示できても起動できなければ価値がない。表示と起動は一体で最優先。

**独立したテスト**: カスタムエージェントを選択して起動し、正しいコマンドと引数で実行されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** type: "command"のカスタムエージェントが定義されている、**操作** 選択して起動、**期待結果** commandがdefaultArgsと共に実行される
2. **前提条件** type: "path"のカスタムエージェントが定義されている、**操作** 選択して起動、**期待結果** 絶対パスで実行される
3. **前提条件** type: "bunx"のカスタムエージェントが定義されている、**操作** 選択して起動、**期待結果** bunx経由で実行される
4. **前提条件** modeArgsにcontinueが定義されている、**操作** Continueモードで起動、**期待結果** modeArgs.continueの引数が追加される
5. **前提条件** envが定義されている、**操作** 起動、**期待結果** 定義された環境変数が設定される

---

### ユーザーストーリー 3 - TUIからのカスタムエージェント登録・編集 (優先度: P1)

開発者がTUIの設定画面からカスタムエージェントを新規登録、編集、削除できる。JSONを手動編集しなくてもGUI的に管理できる。

**この優先度の理由**: TUIでの登録機能はユーザビリティの核心であり、JSON手動編集のみでは開発者体験が大幅に低下する。

**独立したテスト**: 設定画面からカスタムエージェントを追加し、Wizardで表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** 設定画面を開いている、**操作** 新規エージェント追加を選択、**期待結果** 全フィールド入力フォームが表示される
2. **前提条件** id, displayName, commandを入力、**操作** 保存、**期待結果** tools.jsonに保存され、Wizardで選択可能になる
3. **前提条件** 既存カスタムエージェントがある、**操作** 編集を選択、**期待結果** 既存値が表示され編集可能
4. **前提条件** 既存カスタムエージェントがある、**操作** 削除を選択、**期待結果** 確認後にtools.jsonから削除される

---

### ユーザーストーリー 4 - 設定画面のタブ統合 (優先度: P2)

開発者がTabキーでブランチモード→エージェントモード→設定画面を切り替えできる。設定画面にはカスタムエージェント管理と既存のProfile設定が統合される。Profileは名前、説明、環境変数のみを管理し、AI設定は既存のAISettingsWizardで個別に管理される。

**この優先度の理由**: 設定画面のタブ統合はUX向上だが、カスタムエージェントの基本機能が先に必要。

**独立したテスト**: Tabキーを複数回押して3つの画面を順に切り替えられることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチモード表示中、**操作** Tabを押す、**期待結果** エージェントモードに切り替わる
2. **前提条件** エージェントモード表示中、**操作** Tabを押す、**期待結果** 設定画面に切り替わる
3. **前提条件** 設定画面表示中、**操作** Tabを押す、**期待結果** ブランチモードに戻る
4. **前提条件** 設定画面を開いている、**操作** カスタムエージェントセクションとProfileセクションを確認、**期待結果** 両方のセクションが表示される
5. **前提条件** Profileカテゴリを開いている、**操作** プロファイルを追加/編集、**期待結果** 名前、説明のみ編集可能で、AI設定フィールドは表示されない
6. **前提条件** 設定画面を開いている、**操作** 「AI」タブに切り替えてEnterを押す、**期待結果** AISettingsWizardが開く

---

### ユーザーストーリー 5 - モデル選択とバージョン取得 (優先度: P2)

カスタムエージェントでもビルトインと同様にモデル選択とバージョン取得ができる。models配列とversionCommandで定義される。

**この優先度の理由**: 詳細設定機能であり、基本的な起動機能の後に実装すべき。

**独立したテスト**: models配列を定義したカスタムエージェントでモデル選択画面が表示されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** modelsが定義されたカスタムエージェント、**操作** モデル選択ステップに進む、**期待結果** 定義されたモデル一覧が表示される
2. **前提条件** modelsが未定義のカスタムエージェント、**操作** Wizardを進める、**期待結果** モデル選択ステップはスキップされる
3. **前提条件** versionCommandが定義されている、**操作** バージョン選択ステップに進む、**期待結果** コマンド実行結果からバージョンが取得・表示される
4. **前提条件** versionCommandが未定義、**操作** Wizardを進める、**期待結果** バージョン選択ステップはスキップされる

---

### ユーザーストーリー 6 - セッション履歴とQuick Start (優先度: P2)

カスタムエージェントもビルトインと同様にセッション履歴が保存され、Quick Start機能で前回の設定を再利用できる。

**この優先度の理由**: 履歴機能は利便性向上だが、基本機能の後に実装すべき。

**独立したテスト**: カスタムエージェントを使用後、Quick Startで同じ設定が提案されることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** カスタムエージェントで作業を完了、**操作** 同じブランチでWizardを開く、**期待結果** Quick Startに前回の設定が表示される
2. **前提条件** Quick Startにカスタムエージェントの履歴がある、**操作** 選択、**期待結果** 前回と同じ設定でエージェントが起動できる

---

### エッジケース

- tools.jsonに構文エラーがある場合、どうなるか？→ パースエラーで全カスタムエージェントが無効化、警告ログを出力
- commandがPATH上に存在しない場合、どうなるか？→ グレーアウト表示で選択不可、"Not installed"ラベル
- ビルトインIDと同じIDをカスタムで使った場合、どうなるか？→ カスタム定義が優先され上書き
- modeArgsにないモード（例：Resume）を選択した場合、どうなるか？→ そのモードはWizardで非表示
- tools.json編集後、gwt再起動なしで反映されるか？→ Wizard開始時に毎回再読み込み

## 詳細仕様

### tools.json スキーマ

```json
{
  "version": "1.0.0",
  "customCodingAgents": [
    {
      "id": "aider",
      "displayName": "Aider",
      "type": "command",
      "command": "aider",
      "defaultArgs": ["--no-git"],
      "modeArgs": {
        "normal": [],
        "continue": ["--resume"],
        "resume": ["--resume"]
      },
      "permissionSkipArgs": ["--yes"],
      "env": {
        "OPENAI_API_KEY": "sk-..."
      },
      "models": [
        {"id": "gpt-4", "label": "GPT-4", "arg": "--model gpt-4"},
        {"id": "claude", "label": "Claude", "arg": "--model claude-3-opus"}
      ],
      "versionCommand": "aider --version"
    }
  ]
}
```

### 必須フィールド

- `version`: スキーマバージョン（"1.0.0"形式）- 必須
- `customCodingAgents[].id`: 一意の識別子（英数字とハイフン）- 必須
- `customCodingAgents[].displayName`: 表示名 - 必須
- `customCodingAgents[].type`: "command" | "path" | "bunx" - 必須
- `customCodingAgents[].command`: 実行コマンドまたはパス - 必須

### オプションフィールド

- `defaultArgs`: デフォルト引数配列
- `modeArgs`: モード別引数 {normal, continue, resume}
- `permissionSkipArgs`: パーミッションスキップ時の追加引数
- `env`: 環境変数（平文、セキュリティはユーザー責任）
- `models`: モデル一覧 [{id, label, arg}]
- `versionCommand`: バージョン取得コマンド

### 読み込み優先順位

1. プロジェクトローカル: `.gwt/tools.json`（最優先）
2. グローバル: `~/.gwt/tools.json`

同一IDは優先度の高い方で上書き、異なるIDはマージ。

### エージェント色の自動割り当て

ビルトイン4色（黄、シアン、マゼンタ、緑）以外から登録順に自動割り当て：

- カスタム1: Blue
- カスタム2: Red
- カスタム3: White
- 以降: Gray（デフォルト）

### バリデーションルール

- version未定義 → エラー、全カスタムエージェント無効
- 必須フィールド欠損 → 該当エントリのみスキップ、警告ログ
- 無効なtype → 該当エントリのみスキップ
- 重複ID → 後の定義で上書き（同ファイル内）
- JSONパースエラー → 全カスタムエージェント無効、警告ログ

### タブ切り替え順序

Tab押下で以下を循環：

1. ブランチモード
2. エージェントモード
3. 設定画面（カスタムエージェント管理 + Profile設定）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは~/.gwt/tools.jsonからカスタムエージェント定義を読み込め**なければならない**
- **FR-002**: システムは.gwt/tools.json（プロジェクトローカル）からもカスタムエージェント定義を読み込め**なければならない**
- **FR-003**: システムはローカルとグローバルの定義をマージし、同一IDはローカル優先で上書き**しなければならない**
- **FR-004**: システムはWizardでビルトインエージェントの後にセパレータを挟んでカスタムエージェントを表示**しなければならない**
- **FR-005**: システムはtype: "command"のエージェントをPATH検索で実行**しなければならない**
- **FR-006**: システムはtype: "path"のエージェントを絶対パスで実行**しなければならない**
- **FR-007**: システムはtype: "bunx"のエージェントをbunx経由で実行**しなければならない**
- **FR-008**: システムはmodeArgsで定義されていないモードをWizardで非表示に**しなければならない**
- **FR-009**: システムはenv定義を起動時の環境変数として設定**しなければならない**
- **FR-010**: システムはpermissionSkipArgsが未定義の場合、Skip Permissionsオプションを非表示に**しなければならない**
- **FR-011**: システムはmodelsが定義されている場合、モデル選択ステップを表示**しなければならない**
- **FR-012**: システムはversionCommandが定義されている場合、バージョン取得に使用**しなければならない**
- **FR-013**: システムはコマンドがPATH上に存在しない場合、グレーアウト表示で"Not installed"ラベルを付け**なければならない**
- **FR-014**: システムはビルトインIDと同じIDのカスタム定義でビルトインを上書き**しなければならない**
- **FR-015**: システムはカスタムエージェントの使用履歴をビルトインと同様に保存**しなければならない**
- **FR-016**: システムはWizard開始時にtools.jsonを再読み込み**しなければならない**
- **FR-017**: システムは無効なエントリをスキップし、有効なエントリのみ読み込め**なければならない**
- **FR-018**: システムはversionフィールドが未定義の場合、ファイル全体をエラーとして扱わ**なければならない**
- **FR-019**: システムはカスタムエージェントに自動で色を割り当て**なければならない**
- **FR-020**: システムはTabキーでブランチモード→エージェントモード→設定画面を循環**しなければならない**
- **FR-021**: システムはTUIの設定画面でカスタムエージェントの追加・編集・削除ができ**なければならない**
- **FR-022**: システムは設定画面でカスタムエージェント管理とProfile設定を統合表示**しなければならない**
- **FR-023**: システムはProfile設定で名前、説明、環境変数のみを管理し、AI設定は含め**てはならない**
- **FR-024**: システムはAI設定をAISettingsWizard（既存）またはdefault_ai設定で個別管理**しなければならない**
- **FR-025**: システムは設定画面に専用の「AI」タブを表示し、Enterキーで既存のAISettingsWizardを開け**なければならない**
- **FR-026**: システムは「AI」タブに現在のAI設定（エンドポイント、APIキー（マスク表示）、モデル）を表示**しなければならない**
- **FR-027**: システムはAI設定が未設定の場合、「No AI settings configured.」と設定ボタンを表示**しなければならない**

### 主要エンティティ

- **CustomCodingAgent**: カスタムエージェントの定義。id、displayName、type、command、引数設定、環境変数、モデル一覧を持つ
- **ToolsConfig**: tools.jsonの全体構造。バージョンとカスタムエージェント配列を持つ
- **AgentColor**: エージェントに割り当てられる色。ビルトインは固定、カスタムは自動割り当て

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはtools.jsonに定義後、Wizard再表示でカスタムエージェントが即座に利用可能になる
- **SC-002**: カスタムエージェントの起動成功率は、正しく定義されたエージェントで100%である
- **SC-003**: TUIからのカスタムエージェント登録は5ステップ以内で完了できる
- **SC-004**: 無効なtools.json定義があっても、有効な定義は正常に読み込まれる
- **SC-005**: Tab切り替えは1秒以内に完了する

## 制約と仮定 *(該当する場合)*

### 制約

- 環境変数envは平文保存のみ、セキュリティはユーザー責任
- type は "command"、"path"、"bunx" の3種類のみ対応（docker、ssh等は範囲外）
- 完了検出はtmux複合方式のみ（Hook非対応）
- エージェントモード（SPEC-ba3f610c）との統合は本仕様の範囲外

### 仮定

- ユーザーはカスタムエージェントのコマンドを事前にインストール済み
- tools.jsonはユーザーが適切な権限で管理する
- bunxがインストール済み（type: "bunx"使用時）

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- docker、ssh等の追加type
- 環境変数の$VAR_NAME参照展開
- カスタムエージェントのHook完了検出
- エージェントモード（SPEC-ba3f610c）でのカスタムエージェント利用
- ファイル監視によるtools.jsonホットリロード（Wizard開始時の再読み込みのみ）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- tools.jsonに平文でAPIキーを保存する場合、ファイルパーミッションは600を推奨
- env定義はプロセス環境変数として子プロセスに継承される
- カスタムコマンドは任意のコードを実行可能なため、信頼できる定義のみ使用すべき

## 依存関係 *(該当する場合)*

- 既存のWizard画面（wizard.rs）
- 既存のCodingAgent enum
- 既存のセッション履歴機能（ts_session.rs）
- 既存のProfile設定機能（profile.rs）

## 参考資料 *(該当する場合)*

- [既存README.mdのカスタムエージェント説明](../../../README.md#custom-coding-agents)
- [エージェントモード仕様](../SPEC-ba3f610c/spec.md)
