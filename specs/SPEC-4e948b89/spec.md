# 機能仕様: main/developブランチのWorktree作成禁止とルート切替専用化

**仕様ID**: `SPEC-4e948b89`
**作成日**: 2025-11-06
**ステータス**: ドラフト
**入力**: ユーザー説明: "mainやdevelopブランチをWorktreeに追加できないようにし、ルートブランチ切替専用とする"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ルートブランチ選択の安全化 (優先度: P1)

CLI利用者として、`main` または `develop` ブランチを選択したときに新規Worktree作成オプションが表示されず、そのままルートブランチでの作業フローに進みたい。誤って重要ブランチをWorktreeに切り出してしまう事故を防ぎたい。

**この優先度の理由**: 本番系の基幹ブランチ保護は最優先のガードであり、誤操作によるWorktree分岐を即座に封じる必要がある。

**独立したテスト**: Ink UIで`main`/`develop`を選択した際に「新規ブランチ作成」が出現しないこと、選択後にルート利用フローへ遷移することをレンダリングテストで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧に`main`が表示されている、**操作** `main`を選択、**期待結果** アクション選択画面を経由せずAIツール選択画面へ遷移し、新規Worktree作成オプションは提示されない
2. **前提条件** ブランチ一覧に`origin/develop`が表示されている、**操作** `origin/develop`を選択、**期待結果** ローカル名`develop`として処理され、新規Worktree作成オプションは表示されずルート利用フローに入る

---

### ユーザーストーリー 2 - API経由のWorktree作成ガード (優先度: P1)

開発者として、アプリ内のどの経路からでも`main`/`develop`/`master`をWorktree作成対象にできないようにし、即時に分かりやすいエラーを受け取りたい。これによりスクリプトやテスト経由でも保護が機能する。

**この優先度の理由**: UI以外のサービス層・自動処理からの誤呼び出しを防がないと事故が再発するため、同じ優先度で実装する。

**独立したテスト**: `createWorktree`ユニットテストで対象ブランチを指定し、`WorktreeError`がスローされることを確認できる。

**受け入れシナリオ**:

1. **前提条件** `createWorktree`に`branchName: "main"`を渡せる、**操作** 関数を呼び出す、**期待結果** `WorktreeError`がスローされメッセージに保護理由が含まれる
2. **前提条件** `createWorktree`に`branchName: "develop"`を渡せる、**操作** 関数を呼び出す、**期待結果** 上記と同様に即時エラーが返る

---

### ユーザーストーリー 3 - 操作ログと成功判定 (優先度: P2)

管理者として、保護ブランチでWorktree作成を試みた際にコンソールへ警告ログが出力され、利用者へ行動指針が伝わるようにしたい。これにより問い合わせ対応が容易になる。

**この優先度の理由**: ガードが働いたときのUX改善であり、機能自体はP1だが案内がないと混乱する可能性があるため次点で実装する。

**独立したテスト**: 受け入れテストで保護ブランチ選択時に案内文が表示されることをSnapshot/DOM検証で確認できる。

**受け入れシナリオ**:

1. **前提条件** `main`を選択し保護ガードが起動する、**操作** 選択直後の画面を観察、**期待結果** 画面下部に「ルートブランチはWorktree化できません」等の案内テキストが表示される

### エッジケース

- リモート表記（`origin/main`、`origin/develop`）を選択した場合でもローカル名に正規化され、保護が適用されるか
- `master`ブランチ（互換名称）が存在する場合も同じ扱いになるか
- `main`/`develop`への新規ブランチ作成（`-b main`など）要求を遮断できるか

## 要件 *(必須)*

### 機能要件

- **FR-001**: UIは`main`/`develop`/`master`を選択した際、Worktree作成系アクション（新規ブランチ作成・Worktree追加）を表示せず、既存ルート利用フローへ即時遷移しなければならない
- **FR-002**: `createWorktree`（およびそれをラップするサービス）は保護ブランチを対象とする要求を受けた場合に`WorktreeError`をスローし、理由を含むメッセージを返さなければならない
- **FR-003**: 保護ブランチ選択時にはCLIのフッターもしくは画面上に「ルートブランチはWorktree化できません」旨の説明を表示しなければならない
- **FR-004**: 保護ブランチが現在Worktreeに割り当てられている場合、UI統計や一覧からそのWorktreeが消えていることを確認できなければならない
- **FR-005**: 仕様適用後のテストスイートは既存ケースとともに新規ガードテストをすべて通過しなければならない

### 主要エンティティ

- **SelectedBranchState**: UIで選択したブランチの状態。保護判定のため`branchCategory`（`main`/`develop`等）属性を追加する
- **ProtectedBranchPolicy**: `main`/`develop`/`master`を列挙した保護対象集合。UIレイヤーとWorktreeロジックの双方で共有する

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: E2Eテストで`main`/`develop`選択時にWorktreeディレクトリが新規作成されないことを検証できる
- **SC-002**: `createWorktree`単体テストで保護対象ブランチがすべてエラーになることを確認できる
- **SC-003**: 手動操作で`main`選択→AIツール選択画面遷移が3秒以内に完了する

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のPROTECTED_BRANCHES定義を活用し、重複定義を避ける
- UI変更はInkコンポーネントの既存スタイルに倣い、追加ライブラリを導入しない

### 仮定

- `develop`ブランチは常にローカルに存在する
- 既存Worktree一覧には保護ブランチを含めない運用が継続される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 新しい保護対象ブランチの設定UI追加
- Gitリモート側の保護ルール設定変更
- Worktree削除機能の新規開発（既存コマンドを利用）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 保護ブランチに対する失敗ログは開発用途の標準出力にのみ表示し、外部送信しない

## 依存関係 *(該当する場合)*

- `src/worktree.ts` の `PROTECTED_BRANCHES`
- Ink UIコンポーネント群 (`BranchActionSelectorScreen`, `App.tsx`)

## 参考資料 *(該当する場合)*

- [CLAUDE.md](../../CLAUDE.md) - 開発ガイドライン
- [docs/architecture.md](../../docs/architecture.md) - Worktree管理アーキテクチャ
