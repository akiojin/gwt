# 機能仕様: ブランチ選択画面（Branch Selection Screen）

**仕様ID**: `SPEC-d2f4762a`
**作成日**: 2025-11-18
**ステータス**: 実装済み
**入力**: ユーザー説明: "ブランチ選択画面の全体仕様（既存機能＋フィルター・検索モード追加）"

## 概要

ブランチ選択画面は、gwtツールのメイン画面であり、開発者がローカル・リモートブランチを一覧表示し、ブランチを選択してワークツリーを作成したり、ブランチ管理操作を実行したりするためのインターフェースです。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 0 - ブランチ選択の基本操作（既存機能） (優先度: P0)

開発者がgwtを起動すると、ブランチ選択画面が表示されます。画面には、ローカル・リモートブランチがアイコン付きで一覧表示され、矢印キーでカーソルを移動し、`Enter`キーでブランチを選択できます。選択したブランチに対してワークツリー作成やツール起動などのアクションが実行されます。

また、以下のキーバインドで各種操作が可能です：
- `r`: Git情報のリフレッシュ（再取得）
- `space`: ブランチの選択状態をトグル（複数選択可）
- `c`: ブランチクリーンアップ（自動判定、または選択済みブランチのクリーンアップを実行）
- `x`: Worktree修復（`git worktree repair`を実行）
- `n`: 新規ブランチ作成（Worktree作成フロー）
- `tab`: 表示モード切替（All/Local/Remote）
- `p`: プロファイル画面へ遷移
- `l`: ログ画面へ遷移

**この優先度の理由**: これはgwtツールの核心機能であり、全ての操作の起点となる基本画面です。最高優先度（P0）として、他の全ての機能より先に実装・維持される必要があります。

**独立したテスト**: ブランチ一覧の表示、カーソル移動、選択、各種キーバインドの動作を個別にテストすることで検証できます。

**受け入れシナリオ**:

1. **前提条件** Gitリポジトリでgwtを起動、**操作** ブランチ選択画面を表示、**期待結果** ヘッダー、ブランチ一覧、統計情報、フッターが表示される
2. **前提条件** ブランチ一覧が表示されている、**操作** 矢印キー（↑/↓）を押す、**期待結果** カーソルが上下に移動し、選択されたブランチがハイライト表示される
3. **前提条件** ブランチを選択している、**操作** `Enter`キーを押す、**期待結果** ツール選択画面へ遷移する
4. **前提条件** ブランチ一覧が表示されている、**操作** `r`キーを押す、**期待結果** Git情報が再取得され、ブランチ一覧が更新される
5. **前提条件** ブランチ一覧が表示されている、**操作** `c`キーを押す、**期待結果** ブランチクリーンアップ処理が開始される
   - クリーンアップ候補は「ブランチに設定された upstream があればそれをベース」とし、upstream が無い場合は `defaultBaseBranch`（既定: main）をベースに判定する
   - upstream との差分がなく（no-diff）、未コミット/未プッシュが無いローカルブランチ・ワークツリーは、リモートブランチが存在しなくてもクリーンアップ候補に含まれる
   - ローカルに未コミット・未プッシュがなくリモートと同期済みのブランチ/ワークツリーも候補として選定される
6. **前提条件** CLIを`bun ./dist/index.js`のような相対パスで起動、**操作** gwtを起動する、**期待結果** ブランチ選択画面が表示される（WSLを含む）
7. **前提条件** リモート取得が認証待ち/ネットワーク遅延で完了しない、**操作** ブランチ一覧画面を表示、**期待結果** ローカルブランチとワークツリーが表示され、操作が継続できる（リモート取得は致命的なブロッカーにならない）
8. **前提条件** ブランチ情報の読み込み中、**操作** ブランチ一覧画面を表示、**期待結果** ブランチ一覧領域の先頭に1行のローディング表示（ASCIIスピナー付き）が表示され、読み込み完了時に消える

---

### ユーザーストーリー 1 - ブランチリストの即座絞り込み（フィルター機能） (優先度: P1)

開発者がブランチ一覧画面で多数のブランチから目的のブランチを素早く見つけたい場合、`f`キーを押してフィルターモードに入り、キーワードを入力すると、入力中にリアルタイムでブランチリストが絞り込まれます。検索を終了したいときは`Esc`キーを押すことで、フィルターモードを抜けて通常の操作に戻ります。

**この優先度の理由**: ブランチが増えると目視で探すのは困難になります。即座に絞り込みできることで開発者の生産性が大幅に向上します。これは最も基本的で価値の高い機能です。

**独立したテスト**: ブランチ一覧画面で`f`キーを押し、テキストを入力してリストが絞り込まれることを確認し、`Esc`キーで元に戻ることをテストすることで、完全に検証できます。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面を表示している、**操作** `f`キーを押す、**期待結果** "Working Directory"と"Stats"の間にあるFilter(f)行が入力モードになり、カーソル付きで入力可能状態になる
2. **前提条件** フィルターモードが有効、**操作** "feature"と入力する、**期待結果** 入力した文字列を含むブランチのみが表示される（入力するたびにリアルタイムで更新）
3. **前提条件** フィルターモードでブランチが絞り込まれている、**操作** `Esc`キーを押す、**期待結果** フィルター入力がクリアされ、全ブランチが再表示され、Filter(f)行に"(press f to filter)"が表示される
4. **前提条件** フィルターモードが有効、**操作** "FEATURE"と大文字で入力する、**期待結果** 大文字小文字を区別せず、"feature"を含むブランチが表示される
5. **前提条件** フィルターモードが有効、**操作** `Enter`キーを押す、**期待結果** フィルターモードが解除される
6. **前提条件** フィルターモードが有効、**操作** `Esc`キーを押す、**期待結果** フィルター入力が空ならフィルターモードを解除し、入力済みなら入力をクリアする
7. **前提条件** フィルターモードが有効、**操作** 矢印キー（↑/↓）を押す、**期待結果** ブランチ選択が移動し、フィルター入力は維持される

---

### ユーザーストーリー 2 - PRタイトルでの検索 (優先度: P2)

開発者がPR（プルリクエスト）のタイトルをもとにブランチを探したい場合、フィルターモードでPRタイトルに含まれるキーワードを入力すると、そのPRに関連付けられたブランチが検索結果に表示されます。

**この優先度の理由**: ブランチ名だけでなくPRタイトルでも検索できることで、「あのPRのブランチどれだっけ?」という状況に対応でき、ユーザビリティが向上します。基本機能が確立した後に追加する価値があります。

**独立したテスト**: オープンまたはマージ済みのPRが紐づいたブランチがある状態で、フィルターモードでPRタイトルの一部を入力し、該当ブランチが表示されることを確認することで検証できます。

**受け入れシナリオ**:

1. **前提条件** ブランチにオープンまたはマージ済みのPRが紐づいている、**操作** フィルターモードでPRタイトルに含まれるキーワードを入力する、**期待結果** PRタイトルがマッチするブランチが検索結果に表示される
2. **前提条件** ブランチにPRが紐づいていない、**操作** フィルターモードで任意のテキストを入力する、**期待結果** ブランチ名のみで検索が行われ、PRタイトルでの検索は試みられない

---

### ユーザーストーリー 3 - フィルター結果の視覚的フィードバック (優先度: P3)

開発者がフィルター検索中に、現在何件のブランチがヒットしているか、全体の何件中何件なのかを知りたい場合、フィルター入力フィールドの近くまたはステータス行に「Showing X of Y branches」のような表示が現れます。

**この優先度の理由**: 検索結果の件数が分かることで、検索キーワードが適切かどうか判断しやすくなります。基本機能とPR検索が実装された後に追加することで、より洗練されたUXを提供できます。

**独立したテスト**: フィルターモードで絞り込みを行い、マッチ件数と全体件数が正確に表示されることを確認することで検証できます。

**受け入れシナリオ**:

1. **前提条件** 全100件のブランチがあり、フィルターモードが有効、**操作** "feature"と入力して10件にヒット、**期待結果** 「Showing 10 of 100 branches」のような表示が現れる
2. **前提条件** フィルターモードで絞り込み中、**操作** 検索キーワードを変更してヒット数が変化、**期待結果** 表示されるマッチ件数がリアルタイムで更新される
3. **前提条件** フィルターモードで検索キーワードを入力、**操作** どのブランチにもマッチしない文字列を入力、**期待結果** 「Showing 0 of X branches」と表示され、ブランチリストが空になる

---

### ユーザーストーリー 4 - 手動でクリーンアップ対象を選びたい (優先度: P1)

開発者が誤削除を避けるためにクリーンアップ対象を目視確認しながら選びたい場合、ブランチ一覧で`space`キーを押すと行をトグル選択でき、複数ブランチを選んだ上で`c`キーを押すと選択済みだけをクリーンアップできます。ローカルブランチについては、未コミットまたは未プッシュがある場合は選択マークを赤色の`[*]`で警告し、クリーンな場合は通常色の`[*]`で安全に実行できることを示します。

**この優先度の理由**: 自動判定だけでは削除対象を誤解するリスクがあり、選択式を補完することで安全性と操作性を両立するため。

**独立したテスト**: 複数ブランチを選択→`c`で選択分のみ削除候補になること、選択が無い場合は従来の自動判定にフォールバックすること、未コミット/未プッシュのあるローカルブランチが赤色の`[*]`で表示されクリーンアップから除外されることを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧が表示されている、**操作** 任意の2ブランチで`space`を押して選択→カーソル移動→戻っても選択が保持される、**期待結果** 行頭に`[*]`が表示され複数選択状態が維持される
2. **前提条件** 2つのクリーンなローカルブランチを選択済み、**操作** `c`キーを押す、**期待結果** 選択した2ブランチのみがクリーンアップ対象として処理され、他のブランチは影響を受けない
3. **前提条件** 選択がない状態、**操作** `c`キーを押す、**期待結果** 「No branches selected.」警告が表示され、クリーンアップは実行されない
4. **前提条件** 未コミット変更があるローカルブランチを選択、**操作** `space`で選択→`c`を押す、**期待結果** 選択マークが赤色の`[*]`で表示され、クリーンアップ実行時にそのブランチは削除されず警告メッセージが表示される（クリーンな選択分は実行される）

---

### ユーザーストーリー 5 - ブランチ表示モード切替（TABキー） (優先度: P2)

開発者がブランチ一覧画面で多数のブランチから目的のブランチを素早く見つけたい場合、TABキーを押すことで表示モードを切り替えることができます。表示モードは「All（全ブランチ）」「Local（ローカルのみ）」「Remote（リモートのみ）」の3種類があり、TABキーを押すたびに All → Local → Remote → All... の順で循環します。

**この優先度の理由**: フィルター機能と組み合わせることで、より効率的にブランチを見つけることができます。ローカルブランチのみで作業したい場合や、リモートブランチを確認したい場合に便利です。

**独立したテスト**: ブランチ一覧画面でTABキーを押し、表示モードが切り替わること、モードに応じてブランチリストがフィルタリングされることを確認することで検証できます。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面を表示している（デフォルト: All）、**操作** TABキーを押す、**期待結果** 表示モードが「Local」に切り替わり、ローカルブランチのみが表示される
2. **前提条件** 表示モードが「Local」、**操作** TABキーを押す、**期待結果** 表示モードが「Remote」に切り替わり、リモートブランチのみが表示される
3. **前提条件** 表示モードが「Remote」、**操作** TABキーを押す、**期待結果** 表示モードが「All」に切り替わり、全ブランチが表示される
4. **前提条件** フィルターモードが有効、**操作** TABキーを押す、**期待結果** 表示モードは切り替わらない（TABキーはフィルター入力フィールド内で無効化）
5. **前提条件** 表示モードが「Local」で検索キーワードが入力されている、**操作** 表示モードを確認、**期待結果** ローカルブランチかつ検索キーワードにマッチするブランチのみが表示される
6. **前提条件** 表示モードを切り替えた、**操作** カーソル位置を確認、**期待結果** カーソルは先頭にリセットされる（範囲外防止）

---

### ユーザーストーリー 6 - Worktree作成時のstaleディレクトリ自動回復 (優先度: P1)

開発者がブランチを選択してWorktreeを作成する際、過去のクリーンアップや破損したGitメタデータによりWorktreeディレクトリだけが残っている場合でも、gwtが自動的に検出・除去して作成を完了できる。

**この優先度の理由**: Worktree作成が「already exists」で失敗すると作業開始が止まり、ユーザーの手動削除が必要になるため。ブランチ選択画面の基本操作を阻害する重大な障害である。

**独立したテスト**: Worktree作成対象のパスにstaleディレクトリを用意し、作成フローが自動回復することを確認すれば検証でき、作成失敗の手戻り削減という価値を提供する。

**受け入れシナリオ**:

1. **前提条件** 対象パスが存在するが`git worktree list`に含まれず、`.git`が存在しない/参照するgitdirが欠落している、**操作** Worktree作成を実行する、**期待結果** staleディレクトリが削除され、Worktree作成が成功する
2. **前提条件** 対象パスが存在し、`.git`が実体ディレクトリとして存在するか参照するgitdirが有効、**操作** Worktree作成を実行する、**期待結果** 既存ディレクトリは削除されず、作成は中断されて手動解決のエラーが表示される
3. **前提条件** 対象パスが存在しない、**操作** Worktree作成を実行する、**期待結果** 既存と同じ挙動で作成が成功する

---

### ユーザーストーリー 7 - 選択中Worktreeのフルパス表示 (優先度: P2)

開発者が長いパスを正確に確認したい場合、ブランチ一覧で選択中ブランチのWorktreeフルパスがフッターのヘルプ表示の直上に表示される。

**この優先度の理由**: 一覧表示では省略される可能性があるため、誤選択を防ぎ、確実にブランチを把握できるようにする。

**独立したテスト**: ブランチ選択画面を表示し、選択中ブランチのWorktreeフルパスがヘルプ直上に表示されること、選択移動で表示が追随することを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧にWorktreeを持つローカルブランチが存在する、**操作** そのブランチにカーソルを移動する、**期待結果** ヘルプ直上に`Worktree: /abs/path/to/.worktrees/feature-very-long-branch-name`のようにフルパスが表示される
2. **前提条件** 別のWorktreeが存在するブランチがある、**操作** カーソルを移動する、**期待結果** フルパス表示が新しい選択ブランチの値に更新される
3. **前提条件** フィルター等で表示対象が空になっている、**操作** 画面を確認する、**期待結果** `Worktree: (none)` が表示される
4. **前提条件** 選択中ブランチが現在ブランチでWorktreeが存在しない、**操作** 画面を確認する、**期待結果** `Worktree: <working-directory>` が表示される

---

### ユーザーストーリー 8 - ブランチ選択後のウィザードポップアップ (優先度: P0)

開発者がブランチを選択（Enter キー）または新規ブランチを作成（n キー）した後、**ブランチ一覧画面の上にウィザードポップアップが表示され**、以下の設定選択フローを経てAIツールを起動する。

**この優先度の理由**: ブランチ選択からAIツール起動までの一連のフローは、gwtの中核機能であり、すべてのユーザーが必ず通過する重要な操作です。

**UI仕様:**

- ブランチ一覧画面は背景として表示されたまま（半透過オーバーレイ）
- ウィザードポップアップは画面中央に表示（z-index で前面）
- 各ステップは同じポップアップ内で切り替わる（画面遷移ではない）
- ポップアップ内コンテンツが表示領域を超える場合は、ポップアップ内でスクロールできる（マウスホイール/トラックパッド/上下キー）
- 上下キーで選択を移動した結果、カーソルが表示領域外になる場合は、ポップアップ側がスクロールしてカーソルを常に表示する
- Escape キーでウィザードをキャンセルし、ブランチ一覧に戻る

**設定選択フロー（7ステップ）:**

1. **ブランチタイプ選択**（新規ブランチ作成時のみ）- feature/ bugfix/ hotfix/ release/ など
2. **ブランチ名入力**（新規ブランチ作成時のみ）- テキスト入力でブランチ名を指定
3. **コーディングエージェント選択** - Claude Code / Codex CLI / Gemini CLI / カスタム
4. **モデル選択** - 各エージェントで利用可能なモデル一覧から選択
5. **推論レベル選択**（Codex のみ）- low / medium / high
6. **実行モード選択** - Normal（新規セッション）/ Continue（前回セッションから続行）/ Resume（セッションを再開）
7. **権限スキップ確認** - Yes / No

**独立したテスト**: ブランチ一覧画面でブランチを選択し、ウィザードポップアップが表示されること、各ステップを進めてAIツールが起動することを確認する。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面、**操作** Enter キーでブランチを選択、**期待結果** ブランチ一覧の上にウィザードポップアップが表示され、背景が半透過オーバーレイで覆われる
2. **前提条件** ウィザードポップアップ表示中、**操作** 背景を確認、**期待結果** ブランチ一覧画面が薄く見える状態で表示されている
3. **前提条件** ターミナル高さが小さくウィザードの内容が収まらない、**操作** マウスホイールまたはトラックパッドでスクロール、**期待結果** ポップアップ外に内容がはみ出さず、ポップアップ内でスクロールして下部の項目まで閲覧できる
4. **前提条件** ターミナル高さが小さくウィザードの内容が収まらない、**操作** 上下キーでスクロール、**期待結果** ポップアップ外に内容がはみ出さず、ポップアップ内でスクロールして下部の項目まで閲覧できる
5. **前提条件** ターミナル高さが小さく選択項目が画面下端に到達している、**操作** 下方向キーで選択を移動、**期待結果** ポップアップがスクロールし、カーソルが常に表示される
6. **前提条件** ターミナル高さが小さく選択項目が画面上端に到達している、**操作** 上方向キーで選択を移動、**期待結果** ポップアップがスクロールし、カーソルが常に表示される
7. **前提条件** ウィザードポップアップ表示中、**操作** Escape キーを押す、**期待結果** ウィザードが閉じ、ブランチ一覧画面に戻る
8. **前提条件** ブランチ一覧画面、**操作** n キーを押す、**期待結果** ウィザードポップアップが表示され、ブランチタイプ選択ステップが表示される
9. **前提条件** ブランチタイプ選択ステップ、**操作** feature/ を選択して Enter、**期待結果** 同じポップアップ内でブランチ名入力ステップに切り替わる
10. **前提条件** ブランチ名入力ステップ、**操作** ブランチ名を入力して Enter、**期待結果** コーディングエージェント選択ステップに切り替わる
11. **前提条件** コーディングエージェント選択ステップ、**操作** Claude Code を選択、**期待結果** モデル選択ステップに切り替わる
12. **前提条件** モデル選択ステップ（Claude/Gemini）、**操作** モデルを選択、**期待結果** 実行モード選択ステップに切り替わる
13. **前提条件** コーディングエージェント選択ステップ、**操作** Codex CLI を選択、**期待結果** モデル選択ステップに切り替わる
14. **前提条件** Codex のモデル選択後、**操作** モデルを選択、**期待結果** 推論レベル選択ステップに切り替わる
15. **前提条件** 推論レベル選択後、**操作** レベルを選択、**期待結果** 実行モード選択ステップに切り替わる
16. **前提条件** 実行モード選択ステップ、**操作** Normal を選択、**期待結果** 権限スキップ確認ステップに切り替わる
17. **前提条件** 権限スキップ確認ステップ、**操作** Yes を選択、**期待結果** ウィザードが閉じ、ワークツリー準備とAIツール起動が実行される
18. **前提条件** 任意のステップ、**操作** Escape キーを押す、**期待結果** 前のステップに戻る（最初のステップではウィザード終了）

---

### ユーザーストーリー 9 - 前回履歴からのクイック選択ポップアップ (優先度: P1)

開発者がブランチを選択した際、そのブランチで以前使用した設定履歴がある場合、**ウィザードポップアップ内にクイック選択画面**を表示し、素早く作業を再開できる。

**この優先度の理由**: 毎回ツールとモデルを選択する手間を削減し、誤操作なく高速に再開できるようにするため。

**クイック選択画面（エージェントごとに表示）:**

```text
┌─ Quick Start ─────────────────────────────────┐
│                                               │
│ Claude Code (claude-sonnet-4-20250514)             │
│   > Resume with previous settings             │
│     Start new with previous settings          │
│                                               │
│ Codex CLI (o3-mini, Reasoning: high)          │
│     Resume with previous settings             │
│     Start new with previous settings          │
│                                               │
│ ─────────────────────────────────────────     │
│   Choose different settings...                │
│                                               │
│ [Esc] Cancel  [Enter] Select  [↑↓] Navigate   │
└───────────────────────────────────────────────┘
```

**詳細仕様は SPEC-f47db390（セッションID永続化とContinue/Resume強化）を参照。**

**独立したテスト**: 履歴のあるブランチを選択し、クイック選択画面が表示されること、各オプションを選択した際に正しいフローに進むことを確認する。

**受け入れシナリオ**:

1. **前提条件** 履歴のあるブランチを選択、**操作** Enter キーを押す、**期待結果** ウィザードポップアップ内にクイック選択ステップが表示され、エージェントごとの履歴が一覧表示される
2. **前提条件** クイック選択ステップ、**操作** 「Resume with previous settings」を選択、**期待結果** 前回のセッションIDで再開フローに進む
3. **前提条件** クイック選択ステップ、**操作** 「Start new with previous settings」を選択、**期待結果** 前回の設定（ツール/モデル）で新規セッション開始
4. **前提条件** クイック選択ステップ、**操作** 「Choose different settings...」を選択、**期待結果** コーディングエージェント選択ステップへ進む
5. **前提条件** 履歴のないブランチを選択、**操作** Enter キーを押す、**期待結果** クイック選択をスキップし、コーディングエージェント選択ステップが表示される

---

### ユーザーストーリー 10 - コーディングエージェントのバージョン選択 (優先度: P1)

開発者がコーディングエージェントを選択した後、使用するバージョンを選択できる。選択肢は「installed」「latest」「具体的バージョン（直近10件）」の3種類。

**この優先度の理由**: 最新版にバグがある場合や、特定バージョンで動作確認したい場合に、バージョンを固定できることで開発効率と安定性が向上する。

**独立したテスト**: エージェント選択後にバージョン選択画面が表示され、installed/latest/具体的バージョンを選択して正しいバージョンで起動することを確認する。

**受け入れシナリオ**:

1. **前提条件** エージェント選択ステップ完了、**操作** バージョン選択画面を表示、**期待結果** installed/latest/直近10バージョンが表示される
2. **前提条件** バージョン選択画面、**操作** installedを選択、**期待結果** bunxのデフォルト動作（キャッシュ優先）で起動
3. **前提条件** バージョン選択画面、**操作** latestを選択、**期待結果** `bunx @package@latest` で最新版を取得して起動
4. **前提条件** バージョン選択画面、**操作** 特定バージョンを選択、**期待結果** `bunx @package@X.Y.Z` で指定バージョンを取得して起動
5. **前提条件** npmレジストリ取得失敗、**操作** バージョン選択画面を表示、**期待結果** installedとlatestのみ表示される
6. **前提条件** バージョンを選択して起動完了、**操作** セッション情報を確認、**期待結果** 選択したバージョンがセッションに保存されている
7. **前提条件** セッション履歴にバージョン情報あり、**操作** ブランチ一覧を表示、**期待結果** ツールカラムに`ToolName@X.Y.Z`形式でバージョンが表示される

---

### エッジケース

- **空の入力**: フィルター入力が空の場合、全てのブランチが表示される
- **マッチなし**: 検索キーワードがどのブランチにもマッチしない場合、空のリストが表示される（エラーではない）
- **特殊文字**: 検索キーワードに特殊文字（`/`, `-`, `_` 等）が含まれる場合でも、通常の文字列として扱い、部分一致検索を行う
- **長いキーワード**: 非常に長いキーワードを入力した場合でも、入力フィールドは適切に表示を処理する（スクロールまたは省略表示）
- **フィルターモード中のEnter**: フィルターモードが有効な状態では、Enterはフィルターモードの解除のみを行い、ブランチ選択は実行しない
- **リフレッシュとの相互作用**: フィルターモード中に`r`キーを押しても、リフレッシュは実行されず、`r`が通常のテキストとして入力される
- **リモート取得の停止**: `git fetch` が認証待ち/ネットワーク遅延で停止しても、ローカル情報の表示と操作は継続される
- **Worktreeのstale残骸**: `git worktree list` に存在しないがパスが残っている場合、stale判定できるもののみ自動削除し、判定不能な場合は削除せず作成を中断する
- **ブランチ空表示**: ブランチ一覧が空の場合、フルパス表示は`Worktree: (none)`となる
- **Worktree未作成の現在ブランチ**: 選択中ブランチが現在ブランチでWorktreeが存在しない場合、起動時の作業ディレクトリを`Worktree: <working-directory>`として表示する

## 要件 *(必須)*

### 機能要件

#### 基本表示・ナビゲーション（既存機能）

- **FR-001**: システムは、ヘッダー（タイトル、バージョン、作業ディレクトリ）を画面上部に表示**しなければならない**
- **FR-001a**: システムは、アクティブプロファイル情報が提供される場合、ヘッダーに`Profile(p): <name>`を表示し、プロファイル未選択時は`(none)`を表示**しなければならない**
- **FR-002**: システムは、統計情報（ローカルブランチ数、リモートブランチ数、ワークツリー数、変更数、最終更新時刻）をヘッダー下に表示**しなければならない**
- **FR-002b**: システムは、統計行の末尾に`Updated: <relative>`形式（例: `Updated: 12s ago`）で最終更新時刻を表示**しなければならない**
- **FR-002a**: システムは、ブランチ一覧がまだ表示されていない読み込み中にブランチ一覧領域の先頭へASCIIスピナー付きローディング行を表示し、完了時に非表示**にしなければならない**
- **FR-003**: システムは、ブランチ一覧をアイコン、ブランチ名、ツール表示、最終アクティビティ日時とともに表示**しなければならない**
- **FR-004**: システムは、フッター行にキーバインドのヘルプ（Enter: Select, n: New, r: Refresh, c: Cleanup, x: Repair, l: Logs）を表示**しなければならない**
- **FR-004a**: システムは、選択中ブランチのWorktreeフルパスをフッターヘルプの直上に`Worktree: <full-path>`形式で表示**しなければならない**
- **FR-004b**: システムは、表示対象のブランチが存在しない場合、`Worktree: (none)`を表示**しなければならない**
- **FR-004c**: システムは、選択中ブランチが現在ブランチでWorktreeが存在しない場合、起動時の作業ディレクトリを`Worktree: <working-directory>`として表示**しなければならない**
- **FR-005**: システムは、矢印キー（↑/↓）によるブランチリストのカーソル移動を提供**しなければならない**
- **FR-006**: システムは、選択中のブランチを視覚的にハイライト表示（背景色変更）**しなければならない**
- **FR-006a**: システムは、行頭のカーソル記号（`>`など）を表示せず、ハイライトのみで選択状態を表現**しなければならない**
- **FR-007**: システムは、`Enter`キーでブランチを選択し、ツール選択画面へ遷移する機能を提供**しなければならない**
- **FR-032**: システムは、リモート取得（`git fetch`）の完了を待たずにローカル情報を表示し、取得が停止/失敗/タイムアウトしてもブランチ一覧の操作を継続**しなければならない**

#### キーバインド・操作（既存機能）

- **FR-008**: システムは、`r`キーが押されたときにGit情報を再取得し、ブランチ一覧を更新**しなければならない**
- **FR-008c**: システムは、`n`キーが押されたときに新規ブランチ作成フローを開始**しなければならない**
- **FR-008a**: システムは、起動後最初の1回と`r`キー押下時のみGit状態を取得し、それ以外の画面切り替え時はキャッシュされたデータを使用**しなければならない**（パフォーマンス最適化）
- **FR-008b**: システムは、ブランチ作成・削除等の操作後は自動的にキャッシュを更新**しなければならない**
- **FR-009**: システムは、`p`キーが押されたときにプロファイル画面へ遷移**しなければならない**
- **FR-009a**: システムは、`l`キーが押されたときにログ画面へ遷移**しなければならない**
- **FR-010**: システムは、`c`キーが押されたときにブランチクリーンアップ処理を開始**しなければならない**
- **FR-011**: システムは、クリーンアップ処理中はキー入力をロックし、処理完了後に解除**しなければならない**
- **FR-011a**: クリーンアップ候補判定では、ブランチに upstream が設定されている場合はその upstream をベースとして差分を評価し、upstream が無い場合は `defaultBaseBranch`（既定: main）をベースとしなければならない
- **FR-011b**: upstream（または `defaultBaseBranch`）との差分がなく、未コミットおよび未プッシュの変更が存在しないローカルブランチ/ワークツリーは、リモートブランチが存在しなくてもクリーンアップ候補に含めなければならない
- **FR-025**: システムは、クリーンアップ候補として以下を含めなければならない
  - マージ済みPRが紐づくブランチ/ワークツリー
  - ベースブランチとの差分がないブランチ/ワークツリー
  - ローカルに未コミット・未プッシュがなく、リモートブランチが存在し、ベースブランチと差分を持つが未マージのブランチ/ワークツリー（ローカルのみ削除対象）

#### クリーンアップ選択モード（新規）

- **FR-026**: システムは、ブランチ一覧で`space`キーが押されたときに、現在カーソルがあるブランチの選択状態をトグルし、複数ブランチの同時選択を許可**しなければならない**
- **FR-027**: システムは、選択済みブランチに行頭チェックマーク（`[*]`/`[ ]`）を表示し、カーソル移動やフィルター入力後も選択状態を保持**しなければならない**（フィルターで一時的に非表示になったブランチも状態を保持する）
- **FR-028**: システムは、選択済みブランチが1件以上ある場合、`c`キーでクリーンアップを実行するときに選択済みブランチのみを対象とし、選択が0件のときは「No branches selected.」警告を表示して処理をスキップ**しなければならない**
- **FR-029**: システムは、ローカルブランチを選択した際に未コミットまたは未プッシュの変更がある場合は赤色の`[*]`、未変更かつ未プッシュが無い場合は通常色の`[*]`で表示し、安全度を可視化**しなければならない**
- **FR-030**: システムは、赤色の`[*]`のブランチを含む状態で`c`キーが押された場合、そのブランチをクリーンアップ対象から除外し、除外理由をフッターまたはメッセージで即時通知**しなければならない**（クリーンな選択分は継続実行する）
- **FR-031**: システムは、表示アイコンとして以下の組み合わせを使用**しなければならない**。また、行頭のアイコン間にスペースを入れる  
  - 選択: `[*]`（選択）、`[ ]`（未選択）  
  - Worktree: `w`（アクティブ）、`.`（なし）、`x`（アクセス不可）  
  - 安全判定: `!`（安全でない/未判定）、(space)（安全にクリーンアップ可）

#### フィルター・検索機能（新規）

- **FR-012**: システムは、ブランチ一覧画面の"Working Directory"と"Stats"の間に`Filter(f):`行を常に表示し、通常時は"(press f to filter)"を表示**しなければならない**
- **FR-013**: システムは、`f`キーが押されたときにフィルターモードに入り、Filter行のテキスト入力をアクティブにする**しなければならない**
- **FR-014**: システムは、フィルターモード中、ユーザーがテキストを入力できるようにし、入力内容に応じてリアルタイムでブランチリストを絞り込む**しなければならない**
- **FR-015**: システムは、ブランチ名に対して部分一致検索を実行し、大文字小文字を区別せずにマッチング**しなければならない**
- **FR-016**: システムは、ブランチにオープンPRが紐づいている場合、PRタイトルも検索対象に含める**しなければならない**
- **FR-017**: システムは、`Esc`キーが押されたときに、フィルター入力が空ならフィルターモードを終了し、入力がある場合は入力をクリア**しなければならない**
- **FR-018**: システムは、フィルターモード中でもブランチ選択モード中でも、選択中のブランチを反転表示（cyan背景）で表示**しなければならない**
- **FR-019**: システムは、ブランチ選択モード中、フィルター入力フィールドのカーソルを無効化**しなければならない**
- **FR-020**: システムは、フィルターモード中は`Enter`キーでフィルターモードを解除**しなければならない**
- **FR-021**: システムは、フィルターモード中の矢印キー（↑/↓）入力でブランチ選択を移動でき**なければならない**（フィルター入力は維持）
- **FR-022**: システムは、フィルター入力が空でない場合に現在表示されているブランチ数と全体のブランチ数を表示する**しなければならない**
- **FR-023**: システムは、フィルター入力が空の場合、全てのブランチを表示する**しなければならない**
- **FR-024**: システムは、検索キーワードがどのブランチにもマッチしない場合、空のリストを表示する**しなければならない**

#### 表示モード切替機能（新規）

- **FR-032**: システムは、ブランチ選択モード中にTABキーが押されたときに、表示モードを「All → Local → Remote → All」の順で切り替え**しなければならない**
- **FR-033**: システムは、デフォルトの表示モードを「All」（全ブランチ表示）に設定**しなければならない**
- **FR-034**: システムは、現在の表示モードをStatsエリア（統計情報行）に「Mode(tab): All/Local/Remote」の形式で表示**しなければならない**
- **FR-035**: システムは、表示モードフィルタリングと検索フィルタリングを組み合わせて適用（AND条件）**しなければならない**
- **FR-036**: システムは、フィルターモード中はTABキーによる表示モード切替を無効化**しなければならない**
- **FR-037**: システムは、表示モード切替時にカーソル位置を先頭にリセット**しなければならない**

#### Worktree作成の自己回復（新規）

- **FR-038**: システムは、Worktree作成時に対象パスが存在し`git worktree list`に含まれない場合、stale判定を実施**しなければならない**
- **FR-039**: システムは、staleと判定された既存ディレクトリを自動削除し、Worktree作成を再試行**しなければならない**
- **FR-040**: システムは、staleと確定できない既存ディレクトリを削除せず、作成を中断してユーザーに手動解決を促すエラーを表示**しなければならない**

#### 依存関係インストール時のUI表示（新規）

- **FR-040a**: システムは、Worktree作成後の依存関係インストール実行時に、パッケージマネージャー（bun/pnpm/npm）の出力をそのまま標準出力/標準エラーに表示**しなければならない**
- **FR-040b**: システムは、依存関係インストール中にスピナー表示を行っては**ならない**
  - **理由**: スピナーは `\r`（キャリッジリターン）で同一行を上書き更新する仕組みであり、パッケージマネージャーの出力（警告・進捗）が改行を含むため、スピナーと干渉して表示が崩れる。ユーザーにとってはパッケージマネージャーの出力（警告やエラー）を確認できることの方が重要である

#### 最終アクティビティ時間表示（新規）

- **FR-041**: システムは、ブランチ一覧の各行に「最終アクティビティ時間」を表示**しなければならない**。最終アクティビティ時間は、gitの最終コミット日時（`committerdate:unix`）とAIツールの最終操作時間のうち、新しい方とする
- **FR-042**: システムは、AIツール起動時に即座にセッション履歴へタイムスタンプを記録**しなければならない**
- **FR-043**: システムは、AIツール実行中に30秒間隔でタイムスタンプを更新**しなければならない**。これにより、強制終了時でも最新の操作時間が反映される

#### ウィザードポップアップUI（新規）

- **FR-044**: システムは、ブランチ選択または新規ブランチ作成時に、ブランチ一覧画面の上にウィザードポップアップをレイヤー表示**しなければならない**
- **FR-045**: システムは、ウィザードポップアップ表示中、背景のブランチ一覧画面を半透過オーバーレイで覆わ**なければならない**
- **FR-046**: システムは、ウィザードポップアップを画面中央に z-index を使用して前面表示**しなければならない**
- **FR-047**: システムは、ウィザードの各ステップを同一ポップアップ内で切り替え**なければならない**（画面遷移ではない）
- **FR-048**: システムは、ウィザードポップアップの下部にキーバインドヘルプ（Esc: Cancel, Enter: Select, ↑↓: Navigate）を表示**しなければならない**
- **FR-049**: システムは、Escape キーでウィザードをキャンセルし、ブランチ一覧画面に戻ら**なければならない**
- **FR-060**: システムは、ウィザードポップアップの内容が表示領域を超える場合、ポップアップ内で縦方向にスクロールできるようにし、内容がポップアップ外へはみ出さないように**しなければならない**
- **FR-061**: システムは、ウィザードポップアップの縦スクロールを上下キーでも操作できるように**しなければならない**
- **FR-062**: システムは、上下キーで選択を移動した結果、カーソルが表示領域外になる場合に、ポップアップをスクロールしてカーソルを常に表示**しなければならない**

#### 設定選択フロー（新規）

- **FR-050**: システムは、ブランチ選択後に前回履歴の有無を確認し、履歴がある場合はクイック選択ステップ（SPEC-f47db390 参照）を表示**しなければならない**
- **FR-051**: システムは、クイック選択で「Choose different settings...」が選択された場合、または履歴がない場合、設定選択フローを開始**しなければならない**
- **FR-052**: システムは、新規ブランチ作成時（n キー）にブランチタイプ選択ステップを表示**しなければならない**
- **FR-053**: システムは、ブランチタイプ選択後にブランチ名入力ステップを表示**しなければならない**
- **FR-054**: システムは、コーディングエージェント選択ステップで利用可能なエージェント一覧を表示**しなければならない**
- **FR-055**: システムは、選択されたエージェントに対応するモデル一覧を表示**しなければならない**
- **FR-056**: システムは、Codex CLI 選択時のみ推論レベル選択ステップを表示**しなければならない**
- **FR-057**: システムは、実行モード選択ステップで Normal / Continue / Resume を表示**しなければならない**
- **FR-058**: システムは、権限スキップ確認ステップで Yes / No を表示**しなければならない**
- **FR-059**: システムは、ウィザード内で Escape キーによる前ステップへの戻りを提供**しなければならない**（最初のステップでは Escape でウィザード終了）

#### バージョン選択フロー（新規）

- **FR-062**: システムは、エージェント選択ステップ完了後にバージョン選択ステップを表示**しなければならない**
- **FR-063**: システムは、バージョン選択肢として「installed」（インストール済みの場合のみ）、「latest」、および直近10バージョン（プレリリース含む）を表示**しなければならない**
- **FR-063a**: システムは、「installed」オプションを `installed (X.Y.Z)` 形式で表示し、descriptionにインストールパスを表示**しなければならない**
- **FR-063b**: システムは、グローバルにインストール済みのパッケージがない場合、「installed」オプションを非表示**にしなければならない**
- **FR-064**: システムは、npmレジストリからバージョン一覧を取得し、`dist-tags`と`versions`から直近10件を抽出**しなければならない**
- **FR-065**: システムは、npmレジストリ取得失敗時（タイムアウト・ネットワークエラー等）に「installed」（存在する場合）と「latest」のみを表示**しなければならない**
- **FR-066**: システムは、バージョン選択で「installed」が選択された場合、ローカルにインストールされたコマンド（`claude`等）を直接実行**しなければならない**
- **FR-066a**: システムは、バージョン選択で「installed」が選択され、ローカルコマンドが見つからない場合、`bunx`のデフォルト動作（キャッシュ優先）にフォールバック**しなければならない**
- **FR-067**: システムは、バージョン選択で「latest」が選択された場合、`bunx @package@latest`で起動**しなければならない**（ローカルインストールは使用しない）
- **FR-068**: システムは、バージョン選択で具体的バージョンが選択された場合、`bunx @package@X.Y.Z`で起動**しなければならない**（ローカルインストールは使用しない）
- **FR-069**: システムは、選択されたバージョン情報をセッション履歴（`ToolSessionEntry.toolVersion`）に保存**しなければならない**
- **FR-070**: システムは、ブランチ一覧のツール表示を`ToolName@X.Y.Z | YYYY-MM-DD HH:mm`形式で表示**しなければならない**（バージョン情報がない場合は`ToolName@latest | YYYY-MM-DD HH:mm`形式で表示する）
- **FR-072**: システムは、コーディングエージェント起動時に選択されたバージョン情報をコンソールログに出力**しなければならない**（例: `Version: @latest`、`Version: @2.1.1`、`Version: installed`）
- **FR-073**: システムは、「Using locally installed」メッセージを「installed」選択時のみ表示**しなければならない**（「latest」や具体的バージョン選択時は表示しない）

#### UI簡素化（新規）

- **FR-071**: システムは、ブランチ一覧画面からtoolStatuses表示行を削除**しなければならない**

### 主要エンティティ

このフィルター機能は主に表示とインタラクションに関わり、新しいデータエンティティを導入しません。既存のブランチとPR情報に加え、Worktree作成時の状態判定を行います。

- **StaleWorktreeDirectory**: `git worktree list` に含まれないがパスが存在し、`.git`または参照先のgitdirが欠落しているディレクトリ

## 成功基準 *(必須)*

### 測定可能な成果

#### 既存機能の成功基準

- **SC-001**: ブランチ選択画面は1秒以内に表示される（100ブランチまで）
- **SC-002**: リフレッシュ操作は3秒以内に完了する（通常のリポジトリサイズで）
- **SC-003**: キーボード操作（矢印キー、Enter）のレスポンス時間は50ms以内
- **SC-004**: ユーザーの95%が、初回使用時にキーバインドを理解してブランチを選択できる
- **SC-010**: リモート取得が停止/失敗/タイムアウトしても、ブランチ一覧のローカル情報が3秒以内に表示される
- **SC-011**: Worktree作成対象にstaleディレクトリが存在しても、手動削除なしで作成が完了する

#### 最終アクティビティ時間の成功基準

- **SC-012**: ブランチ一覧の日時表示は、gitコミット日時とAIツール操作時間のうち新しい方を正確に反映する
- **SC-013**: AIツール強制終了後でも、最後の定期更新時点（最大30秒前）のタイムスタンプが保持される

#### ウィザードポップアップの成功基準

- **SC-014**: ターミナル高さが小さい場合でも、ウィザードポップアップ内の全項目にスクロールで到達できる
- **SC-015**: 上下キーでもウィザードポップアップ内の縦スクロールができる
- **SC-016**: 上下キーで選択を連続移動しても、カーソルが表示領域外に出ない

#### フィルター機能の成功基準

- **SC-005**: ユーザーは、100件以上のブランチリストから目的のブランチを5秒以内に見つけることができる（フィルター機能使用時）
- **SC-006**: フィルター入力に対して、100ms以内にブランチリストが更新される（インクリメンタルサーチのレスポンス時間）
- **SC-007**: ユーザーの90%が、最初のフィルター試行で目的のブランチを見つけることができる
- **SC-008**: フィルター機能の使用により、ブランチ選択に関わる平均操作時間が50%以上短縮される

## 制約と仮定 *(該当する場合)*

### 制約

- CLI UI は OpenTUI（@opentui/solid）を使用する必要がある
- ターミナルの表示領域が限られているため、フィルター入力フィールドは1行に収める必要がある

### 仮定

- ユーザーは、ブランチ名またはPRタイトルの一部を記憶している
- ブランチ数は通常数十〜数百件の範囲であり、数千件には達しない（パフォーマンス想定）
- PRタイトル情報は既存のGitHub連携機能によって取得済みである
- Stale判定は`.git`/gitdirの欠落など明確な破損条件に限定し、確信できない場合は削除しない

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 正規表現による高度な検索パターン
- ファジー検索（あいまい検索）
- 検索履歴の保存と再利用
- 検索結果のソート順変更
- 複数キーワードによるAND/OR検索
- コミットメッセージやコミットハッシュでの検索
- フィルター設定の永続化（セッション終了後の保持）
- Staleディレクトリのバックアップや再接続（再利用）は行わない

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- フィルター入力内容はローカルメモリ上でのみ処理され、外部に送信されない
- PRタイトルの表示は既存のGitHub連携のセキュリティポリシーに従う

## 依存関係 *(該当する場合)*

- OpenTUIの入力コンポーネント（@opentui/solid）
- 既存のブランチ一覧表示ロジック
- 既存のPR情報取得機能（GitHub API連携）
- SPEC-f47db390: セッションID永続化とContinue/Resume強化（クイック選択画面の詳細）
- SPEC-3b0ed29b: コーディングエージェント対応（エージェント/モデル/推論レベルの詳細）

## 参考資料 *(該当する場合)*

- OpenTUI（@opentui/solid）ドキュメント
