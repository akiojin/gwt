# 機能仕様: ブランチ選択画面（Branch Selection Screen）

**仕様ID**: `SPEC-d2f4762a`
**作成日**: 2025-11-18
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ選択画面の全体仕様（既存機能＋フィルター・検索モード追加）"

## 概要

ブランチ選択画面は、gwtツールのメイン画面であり、開発者がローカル・リモートブランチを一覧表示し、ブランチを選択してワークツリーを作成したり、ブランチ管理操作を実行したりするためのインターフェースです。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 0 - ブランチ選択の基本操作（既存機能） (優先度: P0)

開発者がgwtを起動すると、ブランチ選択画面が表示されます。画面には、ローカル・リモートブランチがアイコン付きで一覧表示され、矢印キー（または`j`/`k`キー）でカーソルを移動し、`Enter`キーでブランチを選択できます。選択したブランチに対してワークツリー作成やツール起動などのアクションが実行されます。

また、以下のキーバインドで各種操作が可能です：
- `r`: Git情報のリフレッシュ（再取得）
- `m`: ワークツリー管理画面へ遷移
- `c`: ブランチクリーンアップ（マージ済みブランチの自動削除）

**この優先度の理由**: これはgwtツールの核心機能であり、全ての操作の起点となる基本画面です。最高優先度（P0）として、他の全ての機能より先に実装・維持される必要があります。

**独立したテスト**: ブランチ一覧の表示、カーソル移動、選択、各種キーバインドの動作を個別にテストすることで検証できます。

**受け入れシナリオ**:

1. **前提条件** Gitリポジトリでgwtを起動、**操作** ブランチ選択画面を表示、**期待結果** ヘッダー、ブランチ一覧、統計情報、フッターが表示される
2. **前提条件** ブランチ一覧が表示されている、**操作** 矢印キー（または`j`/`k`キー）を押す、**期待結果** カーソルが上下に移動し、選択されたブランチがハイライト表示される
3. **前提条件** ブランチを選択している、**操作** `Enter`キーを押す、**期待結果** ブランチアクション画面へ遷移する
4. **前提条件** ブランチ一覧が表示されている、**操作** `r`キーを押す、**期待結果** Git情報が再取得され、ブランチ一覧が更新される
5. **前提条件** ブランチ一覧が表示されている、**操作** `m`キーを押す、**期待結果** ワークツリー管理画面へ遷移する
6. **前提条件** ブランチ一覧が表示されている、**操作** `c`キーを押す、**期待結果** ブランチクリーンアップ処理が開始される
   - クリーンアップ候補は「ブランチに設定された upstream があればそれをベース」とし、upstream が無い場合は `defaultBaseBranch`（既定: main）をベースに判定する
   - upstream との差分がなく（no-diff）、未コミット/未プッシュが無いローカルブランチ・ワークツリーは、リモートブランチが存在しなくてもクリーンアップ候補に含まれる

---

### ユーザーストーリー 1 - ブランチリストの即座絞り込み（フィルター機能） (優先度: P1)

開発者がブランチ一覧画面で多数のブランチから目的のブランチを素早く見つけたい場合、`f`キーを押してフィルターモードに入り、キーワードを入力すると、入力中にリアルタイムでブランチリストが絞り込まれます。検索を終了したいときは`Esc`キーを押すことで、フィルターモードを抜けて通常の操作に戻ります。

**この優先度の理由**: ブランチが増えると目視で探すのは困難になります。即座に絞り込みできることで開発者の生産性が大幅に向上します。これは最も基本的で価値の高い機能です。

**独立したテスト**: ブランチ一覧画面で`f`キーを押し、テキストを入力してリストが絞り込まれることを確認し、`Esc`キーで元に戻ることをテストすることで、完全に検証できます。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面を表示している、**操作** `f`キーを押す、**期待結果** フィルター入力フィールドが"Working Directory"と"Stats"の間に表示され、入力可能状態になる
2. **前提条件** フィルターモードが有効、**操作** "feature"と入力する、**期待結果** 入力した文字列を含むブランチのみが表示される（入力するたびにリアルタイムで更新）
3. **前提条件** フィルターモードでブランチが絞り込まれている、**操作** `Esc`キーを押す、**期待結果** フィルター入力フィールドが消え、全ブランチが再表示され、通常の操作が可能になる
4. **前提条件** フィルターモードが有効、**操作** "FEATURE"と大文字で入力する、**期待結果** 大文字小文字を区別せず、"feature"を含むブランチが表示される
5. **前提条件** フィルターモードが有効、**操作** 他のキーバインド（`m`, `c`, `r`等）を押す、**期待結果** それらのキーの本来の機能は実行されず、通常のテキスト入力として処理される

---

### ユーザーストーリー 2 - PRタイトルでの検索 (優先度: P2)

開発者がPR（プルリクエスト）のタイトルをもとにブランチを探したい場合、フィルターモードでPRタイトルに含まれるキーワードを入力すると、そのPRに関連付けられたブランチが検索結果に表示されます。

**この優先度の理由**: ブランチ名だけでなくPRタイトルでも検索できることで、「あのPRのブランチどれだっけ?」という状況に対応でき、ユーザビリティが向上します。基本機能が確立した後に追加する価値があります。

**独立したテスト**: オープンまたはマージ済みのPRが紐づいたブランチがある状態で、フィルターモードでPRタイトルの一部を入力し、該当ブランチが表示されることを確認することで検証できます。

**受け入れシナリオ**:

1. **前提条件** ブランチにオープンまたはマージ済みのPRが紐づいている、**操作** フィルターモードでPRタイトルに含まれるキーワードを入力する、**期待結果** PRタイトルがマッチするブランチが検索結果に表示される
2. **前提条件** ブランチにPRが紐づいていない、**操作** フィルターモードで任意のテキストを入力する、**期待結果** ブランチ名のみで検索が行われ、PRタイトルでの検索は試みられない

---

### ユーザーストーリー 3 - フィルター結果の視覚的フィードバック (優先度: P3)

開発者がフィルター検索中に、現在何件のブランチがヒットしているか、全体の何件中何件なのかを知りたい場合、フィルター入力フィールドの近くまたはステータス行に「Showing X of Y branches」のような表示が現れます。

**この優先度の理由**: 検索結果の件数が分かることで、検索キーワードが適切かどうか判断しやすくなります。基本機能とPR検索が実装された後に追加することで、より洗練されたUXを提供できます。

**独立したテスト**: フィルターモードで絞り込みを行い、マッチ件数と全体件数が正確に表示されることを確認することで検証できます。

**受け入れシナリオ**:

1. **前提条件** 全100件のブランチがあり、フィルターモードが有効、**操作** "feature"と入力して10件にヒット、**期待結果** 「Showing 10 of 100 branches」のような表示が現れる
2. **前提条件** フィルターモードで絞り込み中、**操作** 検索キーワードを変更してヒット数が変化、**期待結果** 表示されるマッチ件数がリアルタイムで更新される
3. **前提条件** フィルターモードで検索キーワードを入力、**操作** どのブランチにもマッチしない文字列を入力、**期待結果** 「Showing 0 of X branches」と表示され、ブランチリストが空になる

---

### エッジケース

- **空の入力**: フィルター入力が空の場合、全てのブランチが表示される
- **マッチなし**: 検索キーワードがどのブランチにもマッチしない場合、空のリストが表示される（エラーではない）
- **特殊文字**: 検索キーワードに特殊文字（`/`, `-`, `_` 等）が含まれる場合でも、通常の文字列として扱い、部分一致検索を行う
- **長いキーワード**: 非常に長いキーワードを入力した場合でも、入力フィールドは適切に表示を処理する（スクロールまたは省略表示）
- **フィルターモード中の選択**: フィルターモードが有効な状態では、ブランチの選択（Enter）は無効化されず、絞り込まれたリストから選択可能
- **リフレッシュとの相互作用**: フィルターモード中に`r`キーを押しても、リフレッシュは実行されず、`r`が通常のテキストとして入力される

## 要件 *(必須)*

### 機能要件

#### 基本表示・ナビゲーション（既存機能）

- **FR-001**: システムは、ヘッダー（タイトル、バージョン、作業ディレクトリ）を画面上部に表示**しなければならない**
- **FR-002**: システムは、統計情報（ローカルブランチ数、リモートブランチ数、ワークツリー数、変更数、最終更新時刻）をヘッダー下に表示**しなければならない**
- **FR-003**: システムは、ブランチ一覧をアイコン、ブランチ名、最終コミット日時とともに表示**しなければならない**
- **FR-004**: システムは、フッター行にキーバインドのヘルプ（Enter: Select, f: Filter, r: Refresh, m: Manage worktrees, c: Cleanup branches）を表示**しなければならない**
- **FR-005**: システムは、矢印キー（↑/↓）または`j`/`k`キーによるブランチリストのカーソル移動を提供**しなければならない**
- **FR-006**: システムは、選択中のブランチを視覚的にハイライト表示（背景色変更）**しなければならない**
- **FR-007**: システムは、`Enter`キーでブランチを選択し、次の画面へ遷移する機能を提供**しなければならない**

#### キーバインド・操作（既存機能）

- **FR-008**: システムは、`r`キーが押されたときにGit情報を再取得し、ブランチ一覧を更新**しなければならない**
- **FR-009**: システムは、`m`キーが押されたときにワークツリー管理画面へ遷移**しなければならない**
- **FR-010**: システムは、`c`キーが押されたときにブランチクリーンアップ処理を開始**しなければならない**
- **FR-011**: システムは、クリーンアップ処理中はキー入力をロックし、処理完了後に解除**しなければならない**
- **FR-011a**: クリーンアップ候補判定では、ブランチに upstream が設定されている場合はその upstream をベースとして差分を評価し、upstream が無い場合は `defaultBaseBranch`（既定: main）をベースとしなければならない
- **FR-011b**: upstream（または `defaultBaseBranch`）との差分がなく、未コミットおよび未プッシュの変更が存在しないローカルブランチ/ワークツリーは、リモートブランチが存在しなくてもクリーンアップ候補に含めなければならない

#### フィルター・検索機能（新規）

- **FR-012**: システムは、ブランチ一覧画面の"Working Directory"と"Stats"の間に、フィルター入力行を常に表示**しなければならない**
- **FR-013**: システムは、`f`キーが押されたときにフィルターモードに入り、テキスト入力フィールドをアクティブにする**しなければならない**
- **FR-014**: システムは、フィルターモード中、ユーザーがテキストを入力できるようにし、入力内容に応じてリアルタイムでブランチリストを絞り込む**しなければならない**
- **FR-015**: システムは、ブランチ名に対して部分一致検索を実行し、大文字小文字を区別せずにマッチング**しなければならない**
- **FR-016**: システムは、ブランチにオープンPRが紐づいている場合、PRタイトルも検索対象に含める**しなければならない**
- **FR-017**: システムは、`Esc`キーが押されたときに、フィルターモードを終了し、ブランチ選択モードに戻る**しなければならない**
- **FR-018**: システムは、フィルターモード中でもブランチ選択モード中でも、選択中のブランチを反転表示（cyan背景）で表示**しなければならない**
- **FR-019**: システムは、ブランチ選択モード中、フィルター入力フィールドのカーソルを無効化**しなければならない**
- **FR-020**: システムは、フィルターモード中、他のキーバインド（`m`, `c`, `r`等）を無効化し、これらのキーを通常のテキスト入力として処理する**しなければならない**
- **FR-021**: システムは、フィルターモード中でも、矢印キーまたは`j`/`k`キーによるブランチリストのカーソル移動と`Enter`キーによる選択を有効にする**しなければならない**
- **FR-022**: システムは、フィルター検索の結果として現在表示されているブランチ数と全体のブランチ数を表示する**しなければならない**
- **FR-023**: システムは、フィルター入力が空の場合、全てのブランチを表示する**しなければならない**
- **FR-024**: システムは、検索キーワードがどのブランチにもマッチしない場合、空のリストを表示する**しなければならない**

### 主要エンティティ

このフィルター機能は主に表示とインタラクションに関わり、新しいデータエンティティを導入しません。既存のブランチとPR情報を参照します。

## 成功基準 *(必須)*

### 測定可能な成果

#### 既存機能の成功基準

- **SC-001**: ブランチ選択画面は1秒以内に表示される（100ブランチまで）
- **SC-002**: リフレッシュ操作は3秒以内に完了する（通常のリポジトリサイズで）
- **SC-003**: キーボード操作（矢印キー、j/k、Enter）のレスポンス時間は50ms以内
- **SC-004**: ユーザーの95%が、初回使用時にキーバインドを理解してブランチを選択できる

#### フィルター機能の成功基準

- **SC-005**: ユーザーは、100件以上のブランチリストから目的のブランチを5秒以内に見つけることができる（フィルター機能使用時）
- **SC-006**: フィルター入力に対して、100ms以内にブランチリストが更新される（インクリメンタルサーチのレスポンス時間）
- **SC-007**: ユーザーの90%が、最初のフィルター試行で目的のブランチを見つけることができる
- **SC-008**: フィルター機能の使用により、ブランチ選択に関わる平均操作時間が50%以上短縮される

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のInk.jsベースのCLI UIフレームワークを使用する必要がある
- 既存のキーボードナビゲーション（矢印キー、`j`/`k`キー）との互換性を保持する必要がある
- ターミナルの表示領域が限られているため、フィルター入力フィールドは1行に収める必要がある

### 仮定

- ユーザーは、ブランチ名またはPRタイトルの一部を記憶している
- ブランチ数は通常数十〜数百件の範囲であり、数千件には達しない（パフォーマンス想定）
- PRタイトル情報は既存のGitHub連携機能によって取得済みである

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 正規表現による高度な検索パターン
- ファジー検索（あいまい検索）
- 検索履歴の保存と再利用
- 検索結果のソート順変更
- 複数キーワードによるAND/OR検索
- コミットメッセージやコミットハッシュでの検索
- フィルター設定の永続化（セッション終了後の保持）

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- フィルター入力内容はローカルメモリ上でのみ処理され、外部に送信されない
- PRタイトルの表示は既存のGitHub連携のセキュリティポリシーに従う

## 依存関係 *(該当する場合)*

- Ink.jsのInputコンポーネント（テキスト入力用）
- 既存のブランチ一覧表示ロジック
- 既存のPR情報取得機能（GitHub API連携）

## 参考資料 *(該当する場合)*

- [Ink.js公式ドキュメント - useInput](https://github.com/vadimdemedes/ink#useinputinputhandler-options)
- [Ink.js公式ドキュメント - TextInput](https://github.com/vadimdemedes/ink#text-input)
