# 実装計画: ブランチ選択画面 クリーンアップ選択モード

**仕様ID**: `SPEC-d2f4762a` | **対象US**: 0, 4 | **日付**: 2025-12-11

## 方針
- アイコンは ASCII で表示し、行頭のアイコン間にスペースを入れる。
  - 選択: `[*]` / `[ ]`
  - Worktree: `w` / `.` / `x`
  - 安全判定: `*` / `!` / (space)
- クリーンアップは「自動判定」＋「選択済みブランチ優先」で両立。選択があれば選択対象のみ、無ければ従来の自動判定。
- 安全判定はクリーンアップ候補判定をベースにするが、upstreamの同名ブランチが存在しない場合は安全とみなさない。
- 表示色は未コミット/未プッシュで安全アイコン`*`を赤、未マージで`!`を黄色、その他の安全でない/未判定は`!`を赤で示す。
- Worktree作成時はstaleディレクトリのみ自動削除し、判定不能な既存ディレクトリは削除しない。

## ハイレベル ToDo
1) **データ取得/状態**: upstream・未コミット/未プッシュ・未マージの判定を取得し、`App`で `getMergedPRWorktrees()` の結果を補正して安全候補集合を持つ。
2) **選択状態管理**: `App` に選択ブランチ集合を追加し、`space` トグル、`c` 実行時に選択優先・0件時フォールバックを実装。
3) **UI表示**: `BranchListScreen` を選択/Worktree/安全の ASCII アイコン列で表示し、ブランチ名開始位置を固定。フィルター中はスペース入力を優先して入力欄にし、選択トグルは通常モードで動作。
4) **TDD**: コンポーネントテストで (a) アイコン列表示、(b) スペーストグル、(c) 選択有無によるクリーンアップ対象切替、(d) 安全判定アイコンの表示を検証。
5) **入力互換性**: WSL/Windows で分割されるエスケープシーケンスを矢印キーとして解釈できるよう、入力ハンドラの待機時間/判定を調整し、選択系画面での誤`Esc`をテストで防止する。
6) **起動互換性**: `bun ./dist/index.js` のような相対パス実行でもエントリポイント判定が外れないよう、`import.meta.url` と `process.argv[1]` の比較を正規化する。
7) **非ブロッキングフェッチ**: ブランチ一覧の初期ロードではリモートフェッチをバックグラウンド化し、認証待ち/ネットワーク遅延でもUIが進行するようにタイムアウトと非対話実行を導入する。
8) **Worktree自己回復**: Worktree作成前にstaleディレクトリを判定・削除し、`git worktree add` を再試行する。
9) **UI補助表示**: フッターヘルプ直上に選択ブランチのWorktreeフルパスを表示し、空リスト時は`Worktree: (none)`を表示する。Worktreeが無いが選択中ブランチが現在ブランチの場合は起動時の作業ディレクトリを表示する。レイアウトの固定行数を調整する。
10) **フッターヘルプ整理**: フッターのキーバインド一覧からFilter/Mode/Profilesを削除し、`Filter(f)`/`Mode(tab)`/`Profile(p)`を各表示行に併記する。
11) **ウィザードポップアップのスクロール対応**: ウィザード内容がポップアップ高さを超える場合に、ポップアップ内でスクロールできるようにし、内容のはみ出しを防止する（マウス/上下キー）。

## リスクと緩和
- **パフォーマンス**: `getMergedPRWorktrees()` を表示用に呼ぶ頻度を制御（ブランチ更新時のみ）し、結果をキャッシュ。
- **誤削除**: 安全判定は候補ロジックと同一（no-diff / no uncommitted / no unpushed）。安全でない選択は `!`/`*` 表示と実行時スキップ＋警告。
- **Worktree誤削除**: stale判定は`.git`/gitdir欠落など明確な破損条件に限定し、判定不能な既存ディレクトリは削除しない。
