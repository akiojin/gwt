# 実装計画: ブランチ選択画面 クリーンアップ選択モード

**仕様ID**: `SPEC-d2f4762a` | **対象US**: 0, 4 | **日付**: 2025-12-11

## 方針
- アイコン幅問題を解消するため、絵文字の最小幅を保証しつつ、選択/Worktree/安全判定は現行の絵文字セットで表示する。
  - 選択: `[ ]` / `[*]`
  - Worktree: `🟢` / `🔴` / `⚪`（ワークツリーあり / ワークツリーあり(アクセス不可) / なし）
  - 安全判定: `🛡` / `⚠`
- クリーンアップを「自動判定」＋「選択済みブランチ優先」で両立。選択があれば選択対象のみ、無ければ従来の自動判定。
- 安全判定はクリーンアップ候補判定と同じロジックを再利用し、事前に可視化する。
- ASCII 記号への統一（FR-031 の推奨セット）は後続フェーズで検討対象とする。

## ハイレベル ToDo
1) **データ取得/状態**: `useGitData` に worktree の未コミット状態を付与し、`App`で `getMergedPRWorktrees()` の結果をキャッシュして安全候補集合を持つ。
2) **選択状態管理**: `App` に選択ブランチ集合を追加し、`space` トグル、`c` 実行時に選択優先・0件時フォールバックを実装。
3) **UI表示**: `BranchListScreen` を選択/Worktree/安全の絵文字列で表示し、ブランチ名開始位置を固定。フィルター中はスペース入力を優先して入力欄にし、選択トグルは通常モードで動作。
4) **TDD**: コンポーネントテストで (a) アイコン列表示、(b) スペーストグル、(c) 選択有無によるクリーンアップ対象切替、(d) 安全判定アイコンの表示を検証。
5) **入力互換性**: WSL/Windows で分割されるエスケープシーケンスを矢印キーとして解釈できるよう、入力ハンドラの待機時間/判定を調整し、ブランチアクション画面での誤`Esc`をテストで防止する。

## リスクと緩和
- **パフォーマンス**: `getMergedPRWorktrees()` を表示用に呼ぶ頻度を制御（ブランチ更新時のみ）し、結果をキャッシュ。
- **誤削除**: 安全判定は候補ロジックと同一（no-diff / no uncommitted / no unpushed）。安全でない選択は `⚠` 表示と実行時スキップ＋警告。
