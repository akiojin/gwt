# 実装計画: ブランチ選択画面 クリーンアップ選択モード

**仕様ID**: `SPEC-d2f4762a` | **対象US**: 0, 0b, 4 | **日付**: 2026-01-16

## 方針
- アイコンは ASCII で表示し、行頭のアイコン間にスペースを入れる。
  - 選択: `[*]` / `[ ]`
  - Worktree: `w` / `.` / `x`
  - 安全判定: `!` / `*` / `o` / (spinner)
- クリーンアップは「自動判定」＋「選択済みブランチ優先」で両立。選択があれば選択対象のみ、無ければ従来の自動判定。
- 安全判定はクリーンアップ候補判定をベースにするが、upstreamの同名ブランチが存在しない場合は安全とみなさない（ただし選択済みブランチは安全判定に関係なく対象）。
- 表示色は安全にクリーンアップ可能な場合は`o`を明るい緑、未コミットで安全アイコン`!`を赤、未プッシュで`!`を黄色、未マージで`*`を黄色、その他の安全でないは`!`を赤で示す。Worktreeの`w`は明るい緑で表示する。
- 安全判定の取得中は安全アイコン位置にスピナーを表示し、完了したブランチから順に安全アイコンを更新する。リモートブランチは安全アイコンを空白で表示する。
- 未コミット/未プッシュが検出されたブランチは安全判定を即時確定し、ベースブランチ差分・upstream判定は実行しない。未マージ判定はベースブランチ差分で完了させる。
- 安全アイコン表示とunsafe選択警告の判定は同一の安全状態キャッシュから導出し、表示と確認の不一致を防ぐ。
- PRタイトル取得はバックグラウンドで実行し、ブランチ一覧の初期表示をブロックしない。
- 起動直後はブランチ一覧取得自体を非同期にし、空の一覧＋ローディング表示を即時描画する。一覧取得完了後に一覧を表示し、詳細状態（未コミット/未プッシュ/未マージ/安全判定、upstream有無/差分、Worktreeアクセス可否）をバックグラウンドで更新する（PRタイトル取得は既存の非同期処理を維持）。
- 状態更新中は進捗表示（ASCIIスピナー + `Status: Updating branch status (done/total)`）を表示し、完了後は非表示にする。ブランチ一覧取得中は `Status: Loading branch list...` を表示する。
- `r`キーの再取得時は進行中の一覧取得/状態更新を無効化し、最新の更新結果のみ反映する。
- 安全判定が完了している安全ではないブランチを`space`でチェックしようとした場合は警告（OK/Cancel）を表示し、OKで選択・Cancelで未選択を維持する（警告文言は英語）。
- 安全判定が取得中のブランチを`space`でチェックしようとした場合も警告（OK/Cancel）を表示し、OKで選択・Cancelで未選択を維持する（警告文言は英語）。
- 警告/クリーンアップ確認ダイアログはブランチ一覧の上にポップアップ表示し、背景の一覧を維持する。
- クリーンアップ実行中は画面更新や進捗表示を行わず、入力ロックのみを適用する。
- ブランチ一覧の表示領域は枠線で囲んで視認性を高める。
- ブランチ一覧のツール表示は短縮名（Codex/Claude/Gemini/OpenCode）を使用する。
- Mode(tab)行は現在の表示モードのみを表示し、Local/Remote/Worktrees/Changes/Updatedは表示しない。
- Mode(tab)行の直下に安全アイコンの凡例行を表示し、Safe/未コミット/未プッシュ/未マージの意味を英語で説明する。
- unsafe選択の警告ダイアログは反転表示が枠外に広がらないよう、ダイアログ内幅でハイライトする。
- unsafe選択の警告ダイアログでEnter確定したキー入力はブランチ一覧へ伝搬させない。
- 選択済みブランチは安全判定に関係なくクリーンアップ対象に含める（リモートブランチと現在ブランチは除外）。保護ブランチもチェックされていれば対象に含める。
- 修復（`x`）はチェック済みのローカルブランチを対象とし、アクセス可能/不可能に関わらず修復を試行する。
- Worktree作成時はstaleディレクトリのみ自動削除し、判定不能な既存ディレクトリは削除しない。
- エージェント選択後のバージョン選択ステップは Enter キー伝播で自動遷移せず、明示選択が行われるまで表示を維持する。選択確定は最初のEnterで行い、二重Enterを要求しない。
- ブランチ選択後の設定選択フローは最初にブランチアクション（Use selected branch / Create new branch from selected branch）を表示し、Create new 選択時は選択ブランチをベースにブランチタイプ/ブランチ名入力を経由する。
- ウィザードポップアップの幅は内容に応じて自動調整し、収まらない文言は`...`で省略する。
- ポップアップ内のコンテンツは左右に余白を入れ、枠線に密着しないようにする。
- 大量ブランチ時は表示範囲のみ描画し、フィルター/モード変更時のみ再計算、読み込み中はローディング表示を出す。

## ハイレベル ToDo
1) **データ取得/状態**: upstream・未コミット/未プッシュ・未マージの判定を取得し、`App`で `getMergedPRWorktrees()` の結果を補正して安全候補集合を持つ。
2) **選択状態管理**: `App` に選択ブランチ集合を追加し、`space` トグル、`c` 実行時に選択優先・0件時フォールバックを実装。
3) **安全ブランチ確認**: 安全判定済みのunsafeブランチに対する`space`トグル時に警告OK/Cancelを出し、Cancelなら選択しない。
4) **選択優先ルール**: 選択済みブランチは安全判定に関係なくクリーンアップ対象に含め、リモート/現在ブランチのみ除外する。`x` 修復はチェック済みローカルブランチを対象にする（アクセス可能/不可能は問わない）。
5) **UI表示**: `BranchListScreen` を選択/Worktree/安全の ASCII アイコン列で表示し、ブランチ名開始位置を固定。Mode(tab)行の直下に安全アイコンの凡例行を追加する。フィルター中はスペース入力を優先して入力欄にし、選択トグルは通常モードで動作。unsafe警告ダイアログの反転表示はダイアログ枠内で完結させる。警告/クリーンアップ確認はポップアップで表示する。
6) **TDD**: コンポーネントテストで (a) アイコン列表示、(b) スペーストグル、(c) 選択有無によるクリーンアップ対象切替、(d) 安全判定アイコンの表示とブランチ単位の進捗反映、(e) unsafeブランチ選択時の警告とCancel維持、(f) 選択済みunsafe/保護ブランチのクリーンアップ、(g) 修復対象の拡張を検証。
7) **入力互換性**: WSL/Windows で分割されるエスケープシーケンスを矢印キーとして解釈できるよう、入力ハンドラの待機時間/判定を調整し、選択系画面での誤`Esc`をテストで防止する。
8) **起動互換性**: `bun ./dist/index.js` のような相対パス実行でもエントリポイント判定が外れないよう、`import.meta.url` と `process.argv[1]` の比較を正規化する。
9) **非ブロッキングフェッチ**: ブランチ一覧の初期ロードではリモートフェッチをバックグラウンド化し、認証待ち/ネットワーク遅延でもUIが進行するようにタイムアウトと非対話実行を導入する。
10) **Worktree自己回復**: Worktree作成前にstaleディレクトリを判定・削除し、`git worktree add` を再試行する。
11) **UI補助表示**: フッターヘルプ直上に選択ブランチのWorktreeフルパスを表示し、空リスト時は`Worktree: (none)`を表示する。Worktreeが無いが選択中ブランチが現在ブランチの場合は起動時の作業ディレクトリを表示する。レイアウトの固定行数を調整する。
12) **フッターヘルプ整理**: フッターのキーバインド一覧からFilter/Mode/Profilesを削除し、`Filter(f)`/`Mode(tab)`/`Profile(p)`を各表示行に併記する。ブランチ一覧のフッターからEnter表記を削除する。
13) **ウィザードポップアップのスクロール対応**: ウィザード内容がポップアップ高さを超える場合に、ポップアップ内でスクロールできるようにし、内容のはみ出しを防止する（マウス/上下キー）。
14) **安全判定中の選択確認**: safety判定中のブランチを`space`で選択する際も警告を出し、OKで選択・Cancelで維持する。
15) **バージョン選択の自動遷移防止**: エージェント選択後にバージョン選択が必ず表示され、Enter伝播による自動遷移を抑止する。
16) **大量ブランチ対応**: ブランチ一覧の描画を可視範囲に限定し、フィルター/モード変更時のみ再計算する。読み込み中はローディング表示を維持する。
17) **起動時の完全非同期取得**: 起動直後は空一覧＋ローディングを描画し、一覧取得と詳細状態更新をすべてバックグラウンドで実行する。進捗表示を追加し、`r`で再取得した場合は古い更新を破棄する。

## リスクと緩和
- **パフォーマンス**: `getMergedPRWorktrees()` を表示用に呼ぶ頻度を制御（ブランチ更新時のみ）し、結果をキャッシュ。
- **誤削除**: 安全判定は候補ロジックと同一（no-diff / no uncommitted / no unpushed）。安全でない選択は `!`/`*` 表示と実行時スキップ＋警告。
- **Worktree誤削除**: stale判定は`.git`/gitdir欠落など明確な破損条件に限定し、判定不能な既存ディレクトリは削除しない。
- **描画負荷**: 進捗更新の過剰な再描画を避けるため、更新頻度を抑制し、完了したブランチから順次反映する。
