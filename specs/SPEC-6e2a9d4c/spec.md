# 機能仕様: Host OS 起動時の空タブ防止（Issue #1029）

**仕様ID**: `SPEC-6e2a9d4c`  
**作成日**: 2026-02-13  
**更新日**: 2026-02-13  
**ステータス**: ドラフト  
**カテゴリ**: GUI  
**依存仕様**:

- [SPEC-8c6f4a21](../SPEC-8c6f4a21/spec.md)
- [SPEC-a70a1ece](../archive/SPEC-a70a1ece/spec.md)

**入力**: ユーザー説明: "RUNTIME を Host OS にした起動でタブは開くが、何も表示されず入力できない（Windows 11、旧バージョンからマイグレーション済みプロジェクト）"

## 背景

- Windows で Host OS 実行時、起動プロセスが即終了または PTY 出力読取失敗になっても、UI 側ではタブが開いたまま無表示になるケースがある。
- 無表示状態ではユーザーが失敗理由を判断できず、入力不能なタブが残るため操作を継続しづらい。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Host OS 起動失敗時でも原因を把握したい (優先度: P0)

Windows ユーザーとして、Host OS 起動が失敗した場合でも、タブ内に終了/失敗メッセージが表示され、空白のまま固まらない状態で扱いたい。

**独立したテスト**: PTY ストリーム読取失敗経路でスクロールバックに失敗メッセージが記録されることを確認する。

**受け入れシナリオ**:

1. **前提条件** Host OS 起動で子プロセスが即終了する、**操作** Launch を実行する、**期待結果** タブ内に終了メッセージが表示される
2. **前提条件** PTY read がエラーになる、**操作** Launch 後にタブを表示する、**期待結果** タブ内に PTY read エラーとクローズ案内が表示される
3. **前提条件** 失敗タブが表示されている、**操作** Enter を押下する、**期待結果** タブが閉じる

---

### ユーザーストーリー 2 - Windows Host OS で起動コマンドを安定化したい (優先度: P0)

Windows ユーザーとして、`.cmd` / `.bat` を起点とするエージェント起動でも Host OS で確実に起動したい。

**独立したテスト**: Windows 条件でバッチスクリプト実行時に `cmd.exe /d /s /c` ラップへ変換されることを確認する。

**受け入れシナリオ**:

1. **前提条件** 起動コマンドが `npx.cmd` などのバッチスクリプト、**操作** PTY 起動コマンドを解決する、**期待結果** `cmd.exe /d /s /c <script> ...args` で実行される
2. **前提条件** 起動コマンドが通常実行ファイル、**操作** PTY 起動コマンドを解決する、**期待結果** 従来通り直接実行される

## エッジケース

- PTY 読取エラー時でもスクロールバック保存に失敗した場合、最低限イベント送信は継続する。
- Windows 以外ではバッチスクリプトラップを適用しない。
- 既存の Docker 起動経路には影響を与えない。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、Windows で `.cmd` / `.bat` 実行時に `cmd.exe /d /s /c` 経由で PTY 子プロセスを起動しなければならない。
- **FR-002**: システムは、PTY ストリーム読取エラー時に pane 状態を `Error` に更新しなければならない。
- **FR-003**: システムは、PTY ストリーム読取エラー時にタブへ失敗メッセージを出力しなければならない。
- **FR-004**: システムは、失敗時でも `Press Enter to close this tab.` を表示し、Enter クローズ動作を維持しなければならない。
- **FR-005**: システムは、既存の正常起動経路（Host/Docker）を維持しなければならない。

### 非機能要件

- **NFR-001**: 変更は Rust ユニットテストで検証可能であること。
- **NFR-002**: Windows 以外の挙動互換性を保つこと。

## 制約と仮定

- ルート原因が単一でなくても、今回の修正対象は「空タブ無表示を残さない」ことを優先する。
- UI 側は既存の launch-finished/error 表示導線を利用し、今回の中心は backend hardening とする。

## 成功基準 *(必須)*

- **SC-001**: PTY read エラー経路でタブが無表示のまま残らず、失敗メッセージが出る。
- **SC-002**: 失敗タブが Enter で閉じられる。
- **SC-003**: Windows 条件で `.cmd` / `.bat` がラップ実行されるテストが通る。
- **SC-004**: 対象クレートのテストが通過し、既存経路で回帰がない。
