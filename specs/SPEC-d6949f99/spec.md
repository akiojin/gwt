# 機能仕様: Session Summary + PR Status Preview（GUI）

**仕様ID**: `SPEC-d6949f99`
**作成日**: 2026-02-14
**更新日**: 2026-02-14
**ステータス**: レビュー済み
**カテゴリ**: GUI

**入力**:
- ユーザー説明: "PRの状態をわざわざGitHub Webを見に行かなくても良いように、gwt上で見られるようにしたい"
- 追記要望: "Session Summaryのタブ構成（Summary/PR/AI Summary/Git）を仕様として集約したい"

## 背景

- 現在、PRのステータス（CI結果、レビュー状態、マージ可否）を確認するにはGitHub Webを開く必要がある
- gwt はWorktree単位でブランチを管理しており、各ブランチに紐づくPRの状態をgwt内で一覧確認できれば開発効率が大幅に向上する
- 既存の `gwt-core` には `PrCache`（`pullrequest.rs`）や `gh_cli.rs` などGitHub CLIとの統合基盤が存在しており、これを拡張する形で実現可能
- Session SummaryのUI要件（Summary/PR/AI Summary/Git）が複数SPECに分散しており、タブ構成の正本を明確化する必要がある

## 依存仕様（Session Summary）

- `SPEC-3a1b7c2d`: AI Summary（スクロールバック要約）の生成・更新ルール
- `SPEC-735cbc5d`: Gitセクション内のChanges/Commits/Stash表示ルール
- 本SPECは Session Summary のタブ構成と表示責務の正本とする。レイアウト競合時は本SPECを優先する

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Worktreeツリー上でPR/CIステータスを確認する (優先度: P0)

開発者として、Worktree一覧の各Worktree項目に紐づくPRのステータスとCIの実行状態を一目で確認したい。

**独立したテスト**: Worktree一覧にPRステータスバッジとCI Workflow Runステータスが表示されること

**受け入れシナリオ**:

1. **前提条件** gh CLIが認証済みでPRが存在するWorktreeがある、**操作** Worktree一覧をLocalまたはAllフィルターで表示する、**期待結果** 各Worktree行にPRステータス（Open/Merged/Closed + PR番号）が表示される
2. **前提条件** PRにCI Workflow Runが紐づいている、**操作** Worktree行の左にある専用トグルアイコン（▶）をクリックする、**期待結果** ツリーが展開され各Workflowの最新1 Runがワークフロー名とステータス（pass/fail/running/pending）付きで表示される
3. **前提条件** ブランチにPRが存在しない、**操作** Worktree一覧を表示する、**期待結果** 当該Worktree行に「No PR」と表示される
4. **前提条件** gh CLIが未インストールまたは未認証、**操作** Worktree一覧を表示する、**期待結果** PR関連のUI要素が「GitHub not connected」とグレースフルに表示される
5. **前提条件** Remoteフィルターが選択されている、**操作** Worktree一覧を表示する、**期待結果** PRステータスバッジのみ表示（ツリー展開なし）。AllフィルターでRemoteのみのブランチも同様

---

### ユーザーストーリー 2 - Session SummaryでPR詳細を確認する (優先度: P0)

開発者として、Session Summary内のPRセクションでPRのフル情報（メタデータ、レビューコメント、変更サマリー）を確認したい。

**独立したテスト**: Session SummaryにPR Statusセクションが追加され、PRの詳細情報が構造化表示されること

**受け入れシナリオ**:

1. **前提条件** 選択中のWorktreeのブランチにOpen PRがある、**操作** WorktreeSummaryPanel内の「PR」サブタブをクリックする、**期待結果** AI Summaryとは別のタブビューでPR Statusが表示され、PRタイトル・作成者・base/head branch・ラベル・アサイニー・マイルストーン・リンクIssue・mergeableステータスが表示される
2. **前提条件** PRにレビューコメントがある、**操作** PR StatusセクションのReviewsサブセクションを確認する、**期待結果** レビューアーの承認/要変更状態とレビューコメント（inline commentはファイルパス・行番号・コードスニペット・シンタックスハイライト付き）が表示される
3. **前提条件** PRに変更ファイルがある、**操作** PR StatusセクションのChangesサブセクションを確認する、**期待結果** 変更ファイル一覧・追加/削除行数・コミット一覧が表示される

---

### ユーザーストーリー 3 - CI Workflow Runのログを確認する (優先度: P1)

開発者として、失敗したCIジョブのログをgwt内で直接確認したい。

**独立したテスト**: Workflow Runをクリックするとxterm.jsタブ内にCIログが表示されること

**受け入れシナリオ**:

1. **前提条件** ツリー上にWorkflow Runが表示されている、**操作** Workflow Run項目をクリックする、**期待結果** 新しいタブがxterm.jsターミナルとして開き、`gh run view --log`相当のログ出力がANSIカラー付きで表示される
2. **前提条件** Workflow Runがrunning状態、**操作** Workflow Run項目をクリックする、**期待結果** ログタブが開き現時点のログが表示される（ストリーミングではなくスナップショット）

---

### ユーザーストーリー 4 - 定期ポーリングによるステータス自動更新 (優先度: P1)

開発者として、PR/CIのステータスが自動的に更新され、常に最新の情報が表示されてほしい。

**独立したテスト**: ポーリング間隔（30秒固定）でステータスが自動更新され、バックグラウンド時にはポーリングが停止すること

**受け入れシナリオ**:

1. **前提条件** アプリがフォアグラウンドで表示されている、**操作** 30秒待機する、**期待結果** PR/CIステータスが自動的にリフレッシュされ最新状態が反映される
2. **前提条件** アプリがバックグラウンドに移行した、**操作** 60秒以上待機する、**期待結果** ポーリングが停止しAPI呼び出しが発生しない
3. **前提条件** アプリがバックグラウンドからフォアグラウンドに復帰した、**操作** フォアグラウンド復帰する、**期待結果** 即座にステータスをリフレッシュし、以降30秒間隔のポーリングが再開する

---

### ユーザーストーリー 5 - Session Summaryのタブ構成を統一する (優先度: P0)

開発者として、Session Summary内でSummary/PR/AI Summary/Gitを明確に切り替えて確認したい。

**独立したテスト**: WorktreeSummaryPanelに4タブが表示され、Gitタブは折りたたみなしで展開表示されること

**受け入れシナリオ**:

1. **前提条件** Worktreeが選択されている、**操作** Session Summaryを表示する、**期待結果** タブに `Summary / PR / AI Summary / Git` の4項目が表示される
2. **前提条件** `Summary` タブが表示されている、**操作** 内容を確認する、**期待結果** ブランチ基本情報とQuick Startのみを表示し、AI Summaryは表示されない
3. **前提条件** `AI Summary` タブを選択する、**操作** 内容を確認する、**期待結果** AI Summaryのみを表示する
4. **前提条件** `Git` タブを選択する、**操作** 内容を確認する、**期待結果** Gitセクションは初期状態で展開され、折りたたみトグルは表示されない

### ユーザーストーリー 6 - Worktree一覧の上下キーで選択移動する (優先度: P0)

開発者として、Worktree一覧でマウスに依存せず、`↑`/`↓`キーだけで選択中ブランチを移動できるようにしたい。

**独立したテスト**: Worktree一覧でキー操作による行移動とハイライト更新が行えること

**受け入れシナリオ**:

1. **前提条件** Worktree一覧に複数行が表示されている、**操作** 一覧上の任意行にフォーカスを合わせて `↓` を押下、**期待結果** 選択ハイライトが1行下に移動し、その行の `selectedBranch` が更新される
2. **前提条件** Worktree一覧の最上段行が選択中、**操作** `↑` を押下、**期待結果** 選択ハイライトは最上段に留まり、選択が末端外に移動しない
3. **前提条件** Worktree一覧の最下段行が選択中、**操作** `↓` を押下、**期待結果** 選択ハイライトは最下段に留まり、選択が末端外に移動しない
4. **前提条件** 検索フィルター適用後に一覧が更新されている、**操作** 任意行を選択して `↑`/`↓` を押下、**期待結果** 表示中のフィルタ済み一覧内で移動し、選択行が見える範囲に保持される
5. **前提条件** Remote / All / Local フィルターの切替を行った、**操作** 一覧を確認し `↑`/`↓` を押下、**期待結果** 現在表示中の一覧内で同様に選択移動が機能する

### ユーザーストーリー 7 - Worktree一覧のソート種類を切替える (優先度: P0)

開発者として、Worktree一覧の表示順を切り替えて、作業状況に合わせて見やすく確認したい。

**独立したテスト**: `Name` と `Updated` の2種類のソートモードを切り替え可能

**受け入れシナリオ**:

1. **前提条件** Worktree一覧が表示されている、**操作** ソートボタンを確認する、**期待結果** 現在のモードが `Name` である
2. **前提条件** 複数行が表示されている、**操作** ソートボタンを1回押下、**期待結果** 表示順が `Updated`（更新日時降順）へ切り替わる
3. **前提条件** `main` と `develop` が存在する、**操作** 任意モードで確認する、**期待結果** 先頭は `main`、次に `develop` が常に優先される
4. **前提条件** Updatedモードで更新日時未取得のブランチがある、**操作** ソートモードを確認する、**期待結果** 未取得分が末尾に表示される
5. **前提条件** Allフィルターが選択されている、**操作** 一覧を確認する、**期待結果** Local側とRemote側の並びが維持される

## エッジケース

- gh CLIが未インストール: GhCliStatusチェック後、PR関連UIを非表示にしグレースフルデグレード
- gh CLIが認証切れ: `gh auth status` 失敗時に「GitHub not connected」を表示
- Worktree一覧のフォーカスが検索入力欄にある場合、`↑`/`↓` は一覧移動に使用しない（検索文字入力を優先）
- Worktreeのブランチが複数のPRに紐づく場合: 最新のOpen PRを優先表示（既存の `select_latest_pr` ロジックを流用）
- GitHub APIレートリミット到達時: エラーを静かに処理し、前回のキャッシュデータを表示し続ける
- ネットワークオフライン時: キャッシュデータを表示し、次回ポーリング時に再試行
- Worktreeが0個の場合: PR関連UIは表示されない
- PRにCI/Workflowが設定されていない場合: ツリー展開しても「No workflows」と表示
- Session Summaryタブ追加後に既存表示が混在する場合: 各タブは責務外セクションを表示しない

## 要件 *(必須)*

### 機能要件

- **FR-001**: Worktree一覧の各行にPRステータスバッジ（PR番号 + Open/Merged/Closed）を表示する。LocalおよびAllフィルター時に有効。Remoteフィルター時はバッジのみ表示（ツリー展開なし）
- **FR-002**: Worktree行の左に専用トグルアイコン（▶/▼）を設け、クリックで展開/折りたたみする。ブランチ名クリックの既存操作（エージェント起動）は維持する
- **FR-003**: ツリー展開時に各Workflowの最新1 Runのみを表示する（workflow名 + ステータス）。過去のRunは表示しない
- **FR-004**: Workflow Runのステータスを視覚的アイコン＋色で表示する（pass=緑, fail=赤, running=黄, pending=グレー）
- **FR-005**: Workflow Run項目をクリックするとxterm.jsターミナルタブが開き、`gh run view <run_id> --log`のANSIログを表示する
- **FR-006**: WorktreeSummaryPanel内に `Summary / PR / AI Summary / Git` のサブタブ切替えを追加する
- **FR-006a**: `Summary` タブはブランチ基本情報とQuick Startを表示し、AI Summaryは含めない
- **FR-006b**: `PR` タブはPR Status詳細を表示する
- **FR-006c**: `AI Summary` タブはAI Summaryのみを表示する
- **FR-006d**: `Git` タブはGitセクションを折りたたみなしで表示する（ヘッダーの折りたたみトグルを無効化）
- **FR-007**: PR Statusセクションにメタデータ（タイトル、作成者、base/head branch、ラベル、アサイニー、マイルストーン、リンクIssue）を表示する
- **FR-008**: PR Statusセクションにレビュー情報（レビューアー名、承認/要変更ステータス）を表示する
- **FR-009**: レビューコメント（inline含む）をファイルパス・行番号・コードスニペット（シンタックスハイライト付き）・コメント本文のフルレンダリングで表示する（読み取り専用、返信機能なし）
- **FR-010**: PR Statusセクションに変更サマリー（変更ファイル一覧、追加/削除行数、コミット一覧）を表示する
- **FR-011**: GitHubの `mergeable` フィールドをそのまま表示する（MERGEABLE / CONFLICTING / UNKNOWN）
- **FR-012**: PRが存在しないブランチには「No PR」を表示する
- **FR-013**: gh CLIが未認証の場合、PR関連UIで「GitHub not connected」と表示するグレースフルデグレード（既存の `GhCliStatus` パターンを流用）
- **FR-014**: GraphQL APIを段階取得する。ツリー用は軽量クエリ（PRステータス + 最新CI結果のみ）、PRサブタブ用は詳細クエリ（レビューコメント、変更サマリー等）を選択中ブランチのPRに対してのみ取得する
- **FR-015**: CIログ取得にはCLI（`gh run view --log`）を使用するハイブリッドアプローチ
- **FR-016**: 30秒固定間隔のポーリングでPR/CIステータスを自動更新する
- **FR-017**: アプリがバックグラウンド（フォーカスロス）時にはポーリングを停止する
- **FR-018**: フォアグラウンド復帰時に即座にリフレッシュし、ポーリングを再開する
- **FR-019**: Worktree一覧はキー入力（`ArrowUp`/`ArrowDown`）で1件ずつ選択行を移動できること
- **FR-020**: 末端到達時のキー移動はクランプされ、選択行は一覧外へ移動しないこと（上端/下端で保持）
- **FR-021**: 一覧移動時、選択行は表示範囲内に自動で表示されること
- **FR-022**: Worktree一覧はソートモード切替をサポートし、`name` と `updated` の2種を切り替え可能であること
- **FR-023**: `main` / `develop` は常に上位として表示され、他ブランチより先に表示されること（`main` -> `develop`）
- **FR-024**: `name` モードでは `main` / `develop` の後にブランチ名の昇順でソートすること
- **FR-025**: `updated` モードでは `main` / `develop` の後に `commit_timestamp` 降順（最新優先）でソートすること
- **FR-026**: `updated` モードで `commit_timestamp` 未取得のブランチは末尾に配置すること
- **FR-027**: Allモードは、Local側を先に表示し、Remote側を後に表示すること
- **FR-028**: 検索フィルタ適用中も、元のソート順は維持したまま抽出のみを更新すること

### 非機能要件

- **NFR-001**: GraphQLクエリは段階取得とする。ツリー表示用の軽量クエリ（全ブランチ分のPRステータス + 最新CI）は1回のAPI呼び出しで一括取得しN+1問題を回避する。詳細クエリ（レビュー、変更サマリー）は選択時にのみ発行する
- **NFR-002**: ポーリング中のレートリミットエラーはリトライせずキャッシュを維持する
- **NFR-003**: PR/CI情報の取得はバックエンド（Rust gwt-core）で実行し、フロントエンドはTauri IPC経由でデータを受け取る
- **NFR-004**: コードスニペットのシンタックスハイライトはフロントエンド側で処理する
- **NFR-005**: 自動テスト（Rust単体テスト + フロントエンドvitest）が必須

## 制約と仮定

- gh CLI（`gh`）がインストール済みかつ認証済みであることを前提とする（未対応時はグレースフルデグレード）
- GitHub Actions を CI/CD として使用していることを前提とする（他のCI/CDサービスは対象外）
- GraphQL APIは `gh api graphql` を経由して呼び出すため、追加のOAuthトークン管理は不要
- 実装場所は `gwt-core` のGitHubモジュール内（既存の `pullrequest.rs`、`issue.rs` と同じレイヤー）
- UIアイコンはGUIに適したスタイル（SVG/Unicode シンボル等）を使用する

## 成功基準 *(必須)*

- **SC-001**: Worktree一覧でPR紐づきブランチのステータス（Open/Merged/Closed + PR番号）が正しく表示される
- **SC-002**: ツリー展開でWorkflow Run一覧がステータスアイコン付きで表示される
- **SC-003**: Session SummaryのPR Statusセクションにフル情報（メタデータ、レビューコメント、変更サマリー）が表示される
- **SC-004**: inline commentがファイルパス・行番号・シンタックスハイライト付きコードスニペットで正しくレンダリングされる
- **SC-005**: Workflow Runクリックでxterm.jsタブにCIログが表示される
- **SC-006**: 30秒ポーリングでステータスが自動更新され、バックグラウンド時にポーリングが停止する
- **SC-007**: gh CLI未認証時にグレースフルデグレードが動作する
- **SC-008**: Rust単体テストとフロントエンドvitestが全てパスする
- **SC-009**: Session Summaryに `Summary / PR / AI Summary / Git` の4タブが表示される
- **SC-010**: `Git` タブ選択時にGitセクションが初期展開され、折りたたみトグルが表示されない
- **SC-011**: Worktree一覧で `↑`/`↓` キーにより選択中ブランチを1件ずつ移動できる
- **SC-012**: 選択移動の末端到達時も選択が保持され、一覧外へ逸脱しない
- **SC-013**: `Name` / `Updated` のソートモードがボタン操作で切り替わり、表示順が変化する
- **SC-014**: `updated` モードで `commit_timestamp` 未取得ブランチが末尾に表示される
- **SC-015**: Allモードの表示順が Local 側→Remote 側であること
