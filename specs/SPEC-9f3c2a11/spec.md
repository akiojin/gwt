# 機能仕様: Voice Input Mode（GUI 全入力 + Qwen3-ASR）

**仕様ID**: `SPEC-9f3c2a11`
**作成日**: 2026-02-13
**更新日**: 2026-02-14
**カテゴリ**: GUI

## 対象範囲

- Tauri GUI の音声入力機能を、キーボード入力を受け付ける全入力ターゲットへ適用する。
- 音声認識エンジンは `Qwen3-ASR`（`qwen-asr + transformers`）を利用する。
- 本ビルドでは GPU 利用可能端末のみ音声入力を有効化し、GPU 非搭載/非利用端末では機能を明示的に無効化する。
- 音声認識実行にはローカル Python ランタイムが必要であり、`qwen_asr` 依存は gwt が管理する専用ランタイムへ自動導入する。

## ユーザーシナリオ

### ユーザーストーリー 1 - 全キーボード入力領域で音声入力する (P1)

ユーザーとして、キーボード入力を受け付けるすべての箇所で音声入力を使いたい。

**受け入れシナリオ**

1. **前提** `input` または `textarea` にフォーカスがある、**操作** Toggle ホットキーで録音し停止する、**期待** 認識結果がその場に挿入される。
2. **前提** Agent Mode 入力欄にフォーカスがある、**操作** Push-to-talk ホットキーを押下中に発話して離す、**期待** 認識結果が入力欄に挿入される（自動送信しない）。
3. **前提** Worktree terminal タブが入力可能状態、**操作** 音声入力で発話する、**期待** 認識結果が terminal 入力として送られる。

### ユーザーストーリー 2 - Voice 設定を管理する (P1)

ユーザーとして、Settings から音声入力の動作を調整したい。

**受け入れシナリオ**

1. **前提** Settings を開く、**操作** Voice Input を有効化して保存する、**期待** 再起動後も設定が維持される。
2. **前提** Voice Input が有効、**操作** `toggle` と `push-to-talk` のホットキーを別々に設定して保存する、**期待** それぞれの動作が反映される。
3. **前提** Voice Input が有効、**操作** 言語 (`auto/ja/en`) と品質 (`fast/balanced/accurate`) を変更する、**期待** Qwen モデル選択へ反映される。

### ユーザーストーリー 3 - GPU 非対応端末では安全に無効化する (P1)

ユーザーとして、GPU を使えない端末では音声入力が誤動作しないようにしたい。

**受け入れシナリオ**

1. **前提** GPU を検出できない端末、**操作** Settings やホットキーを操作する、**期待** Voice Input は無効状態のままで理由が表示される。
2. **前提** GPU 非対応端末、**操作** 音声入力開始を試みる、**期待** 録音/認識処理に進まずエラーで停止する。

### ユーザーストーリー 4 - Qwen モデルを自動準備する (P2)

ユーザーとして、モデル管理を手動で行わずに音声入力を使いたい。

**受け入れシナリオ**

1. **前提** 選択品質のモデルが未取得、**操作** 初回音声入力を開始する、**期待** HuggingFace キャッシュへ必要モデルが準備される。
2. **前提** 品質を切り替える、**操作** 次回音声入力を開始する、**期待** 切り替え先のモデルで認識される。
3. **前提** `qwen_asr` が未導入、**操作** 初回音声入力を開始する、**期待** gwt 管理ランタイムへ依存が自動導入される（失敗時は理由表示）。

### ユーザーストーリー 5 - 自分の声で精度を継続検証する (P2)

ユーザーとして、自分の録音データで認識精度を測定し、回帰を検出したい。

**受け入れシナリオ**

1. **前提** `manifest.json` と WAV 音声を用意、**操作** 評価コマンドを実行する、**期待** 品質別の `WER/CER/遅延/RTF` が出力される。
2. **前提** ベースラインレポートが存在する、**操作** 回帰閾値付きで評価する、**期待** 閾値を超える悪化があれば失敗で検知される。

## 機能要件

- **FR-001**: システムは `toggle` ホットキーで録音開始/停止を切り替えできなければならない。
- **FR-002**: システムは `push-to-talk` ホットキー押下中のみ録音し、キーを離した時点で停止しなければならない。
- **FR-003**: システムは `input` / `textarea` / `contenteditable` / Agent Mode 入力欄へ認識結果を挿入しなければならない。
- **FR-004**: システムは terminal が入力ターゲットの場合、既存 `write_terminal` 経由で認識結果を送信しなければならない。
- **FR-005**: システムは認識結果を自動送信してはならない（入力欄挿入のみ）。
- **FR-006**: システムは Voice Input 設定（`enabled`, `engine`, `hotkey`, `ptt_hotkey`, `language`, `quality`, `model`）を保存・復元しなければならない。
- **FR-007**: システムは `engine=qwen3-asr` を有効値として扱い、`whisper` を受け取った場合は互換のため `qwen3-asr` として正規化しなければならない。
- **FR-008**: システムは品質プリセットを以下にマップしなければならない。
  - `fast -> Qwen/Qwen3-ASR-0.6B`
  - `balanced -> Qwen/Qwen3-ASR-1.7B`
  - `accurate -> Qwen/Qwen3-ASR-1.7B`
- **FR-009**: システムは必要モデル未準備時に自動ダウンロードし、準備後に認識処理を実行しなければならない。
- **FR-010**: システムは Qwen 実行ランタイムが未準備の場合、gwt 管理ランタイム（`~/.gwt/runtime/voice-venv`）への自動セットアップを試行しなければならない。
- **FR-011**: システムは GPU 未利用環境で Voice Input を利用不可として扱い、理由を返さなければならない。
- **FR-012**: システムは Voice 状態（`supported`, `available`, `preparing`, `listening`, `error`）を GUI で参照可能にしなければならない。
- **FR-013**: システムは空音声または空転写結果の場合、入力ターゲットを変更してはならない。
- **FR-014**: システムはクラウド STT API を前提にせず、ローカル推論を基本としなければならない（モデル配布取得は除く）。
- **FR-015**: システムは本仕様の主要動作を自動テストで担保しなければならない（Settings 検証、GPU/ランタイム ゲート、転写挿入フロー）。
- **FR-016**: システムはローカル音声データセット（manifest + WAV）を入力として精度評価を実行できなければならない。
- **FR-017**: システムは品質プリセットおよび追加モデル（例: `medium`, `large-v3-turbo`）ごとに `WER/CER/平均遅延/平均RTF` をレポートしなければならない。
- **FR-018**: システムはベースラインレポートとの差分を比較し、設定閾値を超える精度悪化を失敗として返さなければならない。
- **FR-019**: システムは評価CLIでモデル指定（`--models`）と人気モデルプリセット指定（`popular` / `popular-lite`）を受け付けなければならない。
- **FR-020**: システムはランタイム自動セットアップが失敗した場合、再試行可能な利用不可理由を GUI へ返さなければならない。

## 制約

- 初期対応 OS は `macOS` と `Windows`。
- UI 文言は英語で提供する。
- デフォルトホットキーは既存ショートカットと衝突しにくい値を使う。
- GPU 要件は現在ビルドの仕様であり、CPU フォールバックは対象外とする。

## 成功基準

- **SC-001**: 主要入力コンポーネント（Settings / Agent Mode / Open Project / Sidebar Search / Launch Form）で音声挿入が成功する。
- **SC-002**: Terminal タブで音声認識テキストが入力として送信される。
- **SC-003**: Voice 設定の保存・再起動復元が自動テストで検証される。
- **SC-004**: GPU 非対応端末で Voice Input が無効化され、誤って録音/転写に進まない。
- **SC-005**: 品質変更時に Qwen モデル切替が行われる。
- **SC-006**: 既存の Enter 送信挙動（Agent Mode）を壊さない。
- **SC-007**: 音声評価コマンドで品質別 `WER/CER` が算出され、JSONレポートとして保存できる。
- **SC-008**: ベースライン比較で閾値超過時に非ゼロ終了し、回帰を検出できる。
