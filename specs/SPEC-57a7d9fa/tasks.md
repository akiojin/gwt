# タスク: Worktreeディレクトリパスを`.git/worktree`から`.worktrees`に変更

**入力**: `/specs/SPEC-57a7d9fa/` からの設計ドキュメント
**前提条件**: plan.md、spec.md、research.md、data-model.md、quickstart.md

**テスト**: このプロジェクトはTDD（Test-Driven Development）を採用しているため、テストタスクが含まれています。

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリーの独立した実装とテストを可能にします。

## フォーマット: `[ID] [P?] [ストーリー] 説明`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[ストーリー]**: このタスクが属するユーザーストーリー（例: US1、US2、US3）
- 説明に正確なファイルパスを含める

## Commitlintルール

- コミットメッセージは件名のみを使用し、空にしてはいけません
- 件名は100文字以内に収めてください
- タスク生成時は、これらのルールを満たすコミットメッセージが書けるよう変更内容を整理してください

## Lint最小要件

タスク完了条件には以下のチェックが成功することを含めてください：

- `bun run format:check`
- `bunx --bun markdownlint-cli "**/*.md" --config .markdownlint.json --ignore-path .markdownlintignore`
- `bun run lint`

## パス規約

このプロジェクトは単一プロジェクト構造を使用：

- `src/` - ソースコード
- `tests/unit/` - ユニットテスト

## フェーズ2: ユーザーストーリー1 - 新規Worktree作成時の配置先変更 (優先度: P1)

**ストーリー**: 開発者がclaude-worktreeツールを使用して新しいブランチのWorktreeを作成する際、リポジトリルート直下の`.worktrees`ディレクトリに作成されるようになります。

**価値**: Worktreeの作成場所を`.git`ディレクトリ内部からルート直下に変更することで、より分かりやすく管理しやすい構造を提供します。

**独立したテスト**: 新しいブランチでWorktreeを作成し、`.worktrees/[ブランチ名]`ディレクトリが作成されることを確認することで完全にテストできます。

### TDDサイクル: Red（テストを先に書く/修正する）

- [ ] **T001** [US1] `tests/unit/worktree.test.ts:106`行目のテスト期待値を`.git/worktree`から`.worktrees`に更新

### TDDサイクル: Green（実装を修正してテストを通す）

- [ ] **T002** [US1] T001の後に `src/worktree.ts:135`行目のWorktreeパス生成ロジックを`.git/worktree`から`.worktrees`に変更

### TDDサイクル: ビルドとテストの検証

- [ ] **T003** [US1] T002の後に `bun run build`を実行して型エラーがないことを確認
- [ ] **T004** [US1] T003の後に `bun test`を実行してgenerateWorktreePathのテストが全て通過することを確認

### 追加テストケース

- [ ] **T005** [P] [US1] `tests/unit/worktree.test.ts`に特殊文字を含むブランチ名のテストケースを追加（サニタイズ検証）
- [ ] **T006** [P] [US1] `tests/unit/worktree.test.ts`にWindowsパスのテストケースを追加（クロスプラットフォーム検証）

### コード品質チェック

- [ ] **T007** [US1] T004の後に `bun run lint`を実行してコードスタイルを検証
- [ ] **T008** [US1] T007の後に `bun run format:check`を実行してコードフォーマットを検証

**✅ MVP1チェックポイント**: US1完了後、新規Worktreeは`.worktrees/`配下に作成されます

## フェーズ3: ユーザーストーリー2 - Gitによる管理対象外の設定 (優先度: P2)

**ストーリー**: 開発者がWorktreeを作成すると、`.worktrees`ディレクトリがGitの管理対象外として`.gitignore`に自動的に追加されます。

**価値**: Worktree内の作業ファイルが誤ってコミットされることを防ぎ、リポジトリのクリーンな状態を維持します。

**独立したテスト**: `.gitignore`ファイルを確認し、`.worktrees/`エントリーが含まれていることを検証することで完全にテストできます。

### データ層（.gitignoreヘルパー関数）

- [ ] **T101** [US2] `src/git.ts`に`ensureGitignoreEntry(repoRoot: string, entry: string): Promise<void>`関数を実装
  - `.gitignore`ファイルの読み込み（存在しない場合は空文字列）
  - エントリーの重複チェック
  - エントリーが存在しない場合のみ追加
  - エラーハンドリング（パーミッション、ディスク容量など）

### テスト（TDD）

- [ ] **T102** [P] [US2] `tests/unit/git.test.ts`に`ensureGitignoreEntry`関数のユニットテストを作成
  - `.gitignore`が存在しない場合のテスト
  - `.gitignore`が存在し、エントリーがない場合のテスト
  - `.gitignore`にエントリーが既に存在する場合のテスト（重複防止）
  - `.gitignore`が読み取り専用の場合のエラーテスト

### 統合（Worktree作成時に自動実行）

- [ ] **T103** [US2] T101とT102の後に `src/worktree.ts`の`createWorktree`関数から`ensureGitignoreEntry`を呼び出す
  - Worktree作成成功後に`.gitignore`を更新
  - エラーが発生しても致命的エラーとしない（警告のみ）

### 統合テスト

- [ ] **T104** [US2] T103の後に `tests/unit/worktree.test.ts`に統合テストを追加
  - `createWorktree`実行後に`.gitignore`が更新されることを検証

### ビルドとテストの検証

- [ ] **T105** [US2] T104の後に `bun run build && bun test`を実行して全テストが通過することを確認

### コード品質チェック

- [ ] **T106** [US2] T105の後に `bun run lint && bun run format:check`を実行してコード品質を検証

**✅ MVP2チェックポイント**: US2完了後、Worktree作成時に`.gitignore`が自動的に更新されます

## フェーズ4: ユーザーストーリー3 - 既存Worktreeの互換性維持 (優先度: P3)

**ストーリー**: 既存の`.git/worktree`配下に作成済みのWorktreeは、新しい実装後も影響を受けず、そのまま動作し続けます。

**価値**: 既存ユーザーの作業環境を保護し、移行コストをゼロにします。

**独立したテスト**: 既存の`.git/worktree/[ブランチ名]`ディレクトリでGitコマンドが正常に動作することを確認することで完全にテストできます。

### 後方互換性テスト

- [ ] **T201** [P] [US3] `tests/unit/worktree.test.ts`に既存Worktreeの互換性テストを追加
  - `.git/worktree`パスで作成されたWorktreeが`listWorktrees`で正常に一覧表示されることを検証
  - 既存Worktreeに対する`worktreeExists`の動作を検証

### 統合テスト（既存と新規の共存）

- [ ] **T202** [US3] T201の後に `tests/integration/worktree-compatibility.test.ts`に統合テストを作成
  - `.git/worktree`と`.worktrees`のWorktreeが共存できることを検証
  - 両方のパスのWorktreeに対してGitコマンドが正常に動作することを検証

### ビルドとテストの検証

- [ ] **T203** [US3] T202の後に `bun run build && bun test`を実行して全テストが通過することを確認

**✅ MVP3チェックポイント**: US3完了後、既存Worktreeが影響を受けずに動作し続けます

## フェーズ5: 統合とポリッシュ

**目的**: 全てのユーザーストーリーの統合と最終検証

### 統合テスト

- [ ] **T301** [P] [統合] `tests/integration/worktree-full-workflow.test.ts`にエンドツーエンドテストを作成
  - Worktree作成から削除までの完全なワークフローをテスト
  - `.worktrees`パスでWorktreeが作成されることを検証
  - `.gitignore`が自動的に更新されることを検証
  - 既存Worktreeが影響を受けないことを検証

### パフォーマンステスト

- [ ] **T302** [P] [統合] `tests/performance/worktree-performance.test.ts`にパフォーマンステストを作成
  - Worktree作成時間が5秒以内であることを検証
  - `.gitignore`更新時間が無視できるレベルであることを検証

### エッジケーステスト

- [ ] **T303** [P] [統合] `tests/unit/worktree.test.ts`にエッジケースのテストを追加
  - `.worktrees`がファイルとして存在する場合のエラーハンドリング
  - ディスク容量不足時のエラーハンドリング
  - 同名ブランチが既に存在する場合のエラーハンドリング

### ドキュメント更新

- [ ] **T304** [P] [ドキュメント] `README.md`にWorktreeディレクトリパスの変更を文書化
- [ ] **T305** [P] [ドキュメント] `CHANGELOG.md`に変更内容を追加

### 最終検証

- [ ] **T306** [統合] T301-T305の後に `bun run build && bun test`を実行して全テストが通過することを確認
- [ ] **T307** [統合] T306の後に `bun run lint && bun run format:check`を実行してコード品質を検証
- [ ] **T308** [統合] T307の後に `bunx --bun markdownlint-cli "**/*.md"`を実行してMarkdownの品質を検証

### 実地テスト

- [ ] **T309** [統合] T308の後に実際のリポジトリで`bunx .`を実行して動作を確認
  - 新しいWorktreeが`.worktrees/`配下に作成されることを確認
  - `.gitignore`に`.worktrees/`が追加されることを確認
  - 既存Worktreeが正常に動作することを確認

**✅ 最終チェックポイント**: 全ての機能が正常に動作し、テストが通過し、ドキュメントが更新されました

## 依存関係グラフ

### ユーザーストーリーの完了順序

```
US1 (P1) → US2 (P2) → US3 (P3) → 統合とポリッシュ
```

**説明**:

- **US1**: 最初に実装（他のストーリーの基盤）
- **US2**: US1の後に実装（Worktreeパスが変更された後に.gitignore更新を追加）
- **US3**: US1とUS2の後に実装（既存の実装が安定した後に後方互換性を検証）
- **統合**: 全てのストーリーが完了した後に最終統合

### タスク依存関係

#### US1内の依存関係

```
T001 → T002 → T003 → T004 → T007 → T008
       ↓
T005, T006（並列実行可能）
```

#### US2内の依存関係

```
T101 → T103 → T104 → T105 → T106
  ↓
T102（並列実行可能）
```

#### US3内の依存関係

```
T201 → T202 → T203
```

#### 統合内の依存関係

```
T301, T302, T303（並列実行可能）
  ↓
T304, T305（並列実行可能）
  ↓
T306 → T307 → T308 → T309
```

## 並列実行の機会

### US1での並列実行

```bash
# T002完了後、以下を並列実行可能
- T005: 特殊文字テストケース追加
- T006: Windowsパステストケース追加
```

### US2での並列実行

```bash
# T101開始と同時に以下を並列実行可能
- T102: ensureGitignoreEntry関数のユニットテスト作成
```

### 統合での並列実行

```bash
# フェーズ5開始時に以下を並列実行可能
- T301: エンドツーエンドテスト作成
- T302: パフォーマンステスト作成
- T303: エッジケーステスト追加

# T303完了後、以下を並列実行可能
- T304: README.md更新
- T305: CHANGELOG.md更新
```

## 実装戦略

### MVPファースト

**MVP1** (US1のみ): 新規Worktreeが`.worktrees/`配下に作成される

- 最小限の変更でコア機能を提供
- テスト: 8タスク
- 所要時間: 約2-3時間

**MVP2** (US1 + US2): `.gitignore`の自動更新も含む

- 実用的な完全機能を提供
- 追加テスト: 6タスク
- 追加所要時間: 約2-3時間

**MVP3** (US1 + US2 + US3): 後方互換性の検証も含む

- 本番環境で安全に使用可能
- 追加テスト: 3タスク
- 追加所要時間: 約1-2時間

**完全版** (全てのUS + 統合): ポリッシュとドキュメント完備

- 全機能 + 完全なテスト + ドキュメント
- 追加テスト: 9タスク
- 追加所要時間: 約2-3時間

### 推奨実装順序

1. **Week 1**: US1（MVP1）を完了 → デプロイ → フィードバック収集
2. **Week 2**: US2（MVP2）を完了 → デプロイ → フィードバック収集
3. **Week 3**: US3（MVP3）を完了 → デプロイ → フィードバック収集
4. **Week 4**: 統合とポリッシュ → 最終デプロイ

## フェーズ6: ユーザーストーリー4 - Worktree作成時の進捗インジケーター表示 (優先度: P1)

**ストーリー**: 開発者が既存ブランチを選択してWorktreeを作成する際、500ms以内にスピナーによる進捗フィードバックが表示され、作成完了時に自動的に停止する。

**価値**: Worktree作成中にCLIが無反応に見える問題を解消し、ユーザーが処理中であることを視覚的に把握できる。

**独立したテスト**: スピナー開始/停止をモックで検証するユニットテストと、CLIログにスピナー開始メッセージが出力されるかを確認するテストで担保できる。

### TDDサイクル: Red（テストを先に作成）

- [ ] **T401** [US4] `tests/unit/worktree-spinner.test.ts`を新規作成し、Worktree作成時に`startSpinner`が呼ばれ、完了後に停止することを検証

### TDDサイクル: Green（実装でテストを通す）

- [ ] **T402** [US4] `src/utils/spinner.ts`を実装し、`createWorktree`から呼び出してスピナーを制御
- [ ] **T403** [US4] `src/index.ts`でWorktree生成時のログをスピナーと整合する形に更新

### 検証

- [ ] **T404** [US4] `bun run test`を実行して全テストが成功することを確認
- [ ] **T405** [US4] `bun run lint && bun run format:check`でコード品質を検証

**✅ US4チェックポイント**: Worktree作成時にスピナーが表示され、処理完了後に必ず停止します

## タスク集計

### 総タスク数

- **US1**: 8タスク
- **US2**: 6タスク
- **US3**: 3タスク
- **US4**: 5タスク
- **統合**: 9タスク
- **合計**: 31タスク

### ストーリーごとのタスク数

| ストーリー | タスク数 | 並列実行可能タスク | 所要時間（推定） |
|-----------|---------|------------------|---------------|
| US1 (P1) | 8 | 2 | 2-3時間 |
| US2 (P2) | 6 | 1 | 2-3時間 |
| US3 (P3) | 3 | 1 | 1-2時間 |
| US4 (P1) | 5 | 2 | 1-2時間 |
| 統合 | 9 | 5 | 2-3時間 |
| **合計** | **31** | **11** | **8-12時間** |

### 並列実行による効率化

- **シーケンシャル実行**: 約7-11時間
- **並列実行**: 約5-8時間（30%削減）

### 独立したテスト基準

各ユーザーストーリーは以下のテスト基準を満たすことで完了とみなされます：

- **US1**: `bun test`でgenerateWorktreePathのテストが全て通過
- **US2**: `bun test`でensureGitignoreEntryとcreateworktree統合テストが通過
- **US3**: `bun test`で既存Worktree互換性テストが通過
- **US4**: `bun test`でスピナーの開始/停止を検証するテストが通過
- **統合**: `bun test`で全テストが通過 + Lint/Format検証成功

### MVP推奨スコープ

**推奨MVPスコープ**: US1のみ（タスクT001-T008）

**理由**:

- コア機能（Worktreeパス変更）を最速で提供
- テストとビルドの成功を確認
- フィードバックを早期に収集

**次のインクリメント**: US2を追加（`.gitignore`自動更新）

## フォーマット検証

**確認**: 全てのタスクが以下のチェックリストフォーマットに従っています：

- ✅ チェックボックス: `- [ ]`
- ✅ タスクID: T001-T309
- ✅ [P]マーカー: 並列実行可能なタスクに付与
- ✅ [ストーリー]ラベル: US1, US2, US3, 統合
- ✅ 説明: 明確なアクションと正確なファイルパス
- ✅ 依存関係: "T00Xの後に"で明示

**検証結果**: 全26タスクがフォーマット要件を満たしています。
