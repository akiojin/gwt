# 機能仕様: プロジェクトを開いたときに前回のエージェントタブを復元する

**仕様ID**: `SPEC-f466bc68`
**作成日**: 2026-02-13
**更新日**: 2026-02-13
**ステータス**: 実装完了
**カテゴリ**: GUI / Agent
**依存仕様**: なし
**入力**: ユーザー説明: "プロジェクトを開いた場合に前回開いていたエージェントタブ（セッション）を復元したい"

## 背景

- プロジェクトを開き直した際に、前回表示していたエージェントタブ（どのブランチでどのセッションを見ていたか）が失われ、作業文脈の復元コストが高い。
- 本仕様は「バックエンドに存在する pane の UI 復元」に限定し、存在しない pane の自動再起動やセッションの自動再開は行わない。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - プロジェクト再オープン時にエージェントタブを復元したい (優先度: P0)

開発者として、プロジェクトを開いたときに前回開いていたエージェントタブを復元し、すぐに作業を継続したい。

**独立したテスト**: 1つ以上のエージェント pane が存在する状態でプロジェクトを開き直し、エージェントタブの一覧とアクティブタブが復元されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** 以前に同一プロジェクトでエージェントタブを開いている、かつバックエンドに対応 pane が存在する、**操作** プロジェクトを開く、**期待結果** エージェントタブが前回の順序で復元され、前回アクティブだったタブが選択される
2. **前提条件** 保存状態に含まれる pane の一部がバックエンドに存在しない、**操作** プロジェクトを開く、**期待結果** 存在する pane のみが復元され、存在しない pane のタブは表示されない

---

### ユーザーストーリー 2 - 復元直後にターミナルが空に見えないようにしたい (優先度: P1)

開発者として、復元されたターミナルタブが真っ白に見える時間を減らし、直近の出力をすぐ確認したい。

**受け入れシナリオ**:

1. **前提条件** 復元されたエージェントタブがある、**操作** そのタブを表示する、**期待結果** スクロールバック末尾（ANSI除去済み）が先に表示され、その後にライブ出力が追記される

---

### ユーザーストーリー 3 - 永続化が失敗してもアプリが壊れないようにしたい (優先度: P2)

開発者として、localStorage や Tauri API が利用できない環境でもアプリがクラッシュせず、従来どおり操作できることを望む。

**受け入れシナリオ**:

1. **前提条件** localStorage が無効、または保存データが破損している、**操作** プロジェクトを開く、**期待結果** エラーで停止せず、復元は行われない（または部分的な復元に留まる）

## エッジケース

- localStorage が利用不可（例: 厳格な環境設定）: 復元/保存は best-effort で無視する
- 保存データが破損/不正フォーマット: 復元しない（クラッシュしない）
- 保存データに重複/空 paneId が含まれる: 正規化・重複排除して扱う
- バックエンドに pane が存在しない: エージェントタブは復元しない
- Web preview 等で Tauri API が無い: 復元/イベント購読は行わない（クラッシュしない）

## 要件 *(必須)*

### 機能要件

- **FR-001**: GUI はプロジェクトを開いたとき、当該プロジェクトに対する前回のエージェントタブ状態（順序/ラベル）を復元**しなければならない**
- **FR-002**: GUI は復元したエージェントタブのうち、前回アクティブだったタブを復元**しなければならない**（存在する場合）
- **FR-003**: GUI はバックエンドに存在する pane のみを復元**しなければならない**（存在しない pane のタブは表示しない）
- **FR-004**: GUI は復元した状態をプロジェクト単位で永続化**しなければならない**
- **FR-005**: ターミナル表示は復元直後に scrollback tail を表示することで、空表示時間を低減**しなければならない**

### 非機能要件

- **NFR-001**: localStorage/Tauri API が利用できない場合でも、復元/保存は best-effort で失敗してよいが、アプリはクラッシュ**してはならない**
- **NFR-002**: 復元処理は UI をブロックしない（非同期・best-effort）

## 制約と仮定

- 本仕様は「存在する pane の UI 復元」のみを対象とし、存在しない pane の自動再起動/セッション自動再開は行わない。
- 永続化は DB を持たず localStorage を利用する（保存容量/権限により失敗する可能性がある）。

## 成功基準 *(必須)*

- **SC-001**: 既存 pane がある状態でプロジェクトを開くと、エージェントタブが復元される
- **SC-002**: 前回アクティブだった pane が存在する場合、アクティブタブも復元される
- **SC-003**: `pnpm -C gwt-gui test` と `pnpm -C gwt-gui check` が成功する
