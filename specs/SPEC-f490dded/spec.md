# 機能仕様: シンプルターミナルタブ

**仕様ID**: `SPEC-f490dded`
**作成日**: 2026-02-13
**更新日**: 2026-02-13
**ステータス**: 確定
**カテゴリ**: GUI

**入力**: ユーザー説明: "Tools メニューから New Terminal で素のシェルターミナルを起動するタブ機能"

## 背景

- 現在の gwt GUI はエージェント（Claude, Codex, Gemini, OpenCode）起動に紐づいたターミナルタブのみ提供している
- 開発者がちょっとした git コマンドやファイル操作を行いたい場合、外部ターミナルを開く必要がある
- IDE のように Tools > New Terminal で素のシェル（bash/zsh）を直接開けると、ワークフローが完結する

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - メニューからターミナル起動 (優先度: P0)

ユーザーとして、Tools > New Terminal を選択して、選択中ブランチの Worktree ディレクトリで素のシェルを開きたい。

**独立したテスト**: プロジェクトを開いた状態で Tools > New Terminal を選択し、シェルが起動すること

**受け入れシナリオ**:

1. **前提条件** プロジェクトが開いておりサイドバーでブランチを選択中、**操作** Tools > New Terminal を選択、**期待結果** 新しいターミナルタブが作成され、選択中ブランチの Worktree パスでシェルが起動する
2. **前提条件** プロジェクトが開いておりブランチ未選択、**操作** Tools > New Terminal を選択、**期待結果** プロジェクトルートディレクトリでシェルが起動する
3. **前提条件** プロジェクト未オープン、**操作** Tools > New Terminal を選択、**期待結果** ホームディレクトリ（~/）でシェルが起動する

---

### ユーザーストーリー 2 - ショートカットキーでターミナル起動 (優先度: P0)

ユーザーとして、Ctrl+` キーで素早くターミナルタブを開きたい。

**独立したテスト**: Ctrl+` を押下してターミナルタブが作成されること

**受け入れシナリオ**:

1. **前提条件** アプリがフォーカス中、**操作** Ctrl+` を押下、**期待結果** US1 と同じ挙動でターミナルタブが作成される

---

### ユーザーストーリー 3 - タブバーでの表示と識別 (優先度: P0)

ユーザーとして、ターミナルタブがエージェントタブと視覚的に区別でき、現在の作業ディレクトリがタブラベルに表示されることを確認したい。

**独立したテスト**: ターミナルタブがグレードット + cwd ラベルで表示されること

**受け入れシナリオ**:

1. **前提条件** ターミナルタブが開いている、**操作** タブバーを確認、**期待結果** グレー色（`--text-muted`）のドットと cwd の basename がラベルに表示される。タブにホバーするとフルパスがツールチップで表示される
2. **前提条件** ターミナルタブでエージェントタブも開いている、**操作** タブバーを確認、**期待結果** ターミナルタブとエージェントタブが作成順に混在配置されている
3. **前提条件** ターミナルタブが開いている、**操作** ターミナル内で `cd /tmp` を実行、**期待結果** タブラベルが `tmp` に更新され、ホバー時に `/tmp` がツールチップ表示される（OSC 7 経由でリアルタイム追従）

---

### ユーザーストーリー 4 - ターミナルタブのクローズ (優先度: P0)

ユーザーとして、ターミナルタブを閉じるとき、PTY プロセスが適切にクリーンアップされることを確認したい。

**独立したテスト**: タブの × ボタンで PTY が終了し、タブが除去されること

**受け入れシナリオ**:

1. **前提条件** ターミナルタブが開いている、**操作** タブの × ボタンをクリック、**期待結果** PTY プロセスが kill され、タブがタブバーから除去される
2. **前提条件** ターミナルタブでシェル内で `exit` を実行、**操作** シェルプロセスが終了、**期待結果** タブが自動的に閉じられる
3. **前提条件** ターミナルタブが開いている、**操作** プロジェクトを閉じる（Close Project）、**期待結果** ターミナルタブの PTY が kill され、タブが除去される

---

### ユーザーストーリー 5 - cwd のリアルタイム追従 (優先度: P1)

ユーザーとして、ターミナル内でディレクトリを移動したとき、タブラベルがリアルタイムに更新されることを確認したい。

**独立したテスト**: OSC 7 エスケープシーケンスの検出によりタブラベルが更新されること

**受け入れシナリオ**:

1. **前提条件** macOS の zsh でターミナルタブが開いている、**操作** `cd ~/Documents` を実行、**期待結果** タブラベルが `Documents` に更新される
2. **前提条件** OSC 7 を送出しないシェル環境、**操作** `cd /tmp` を実行、**期待結果** タブラベルは起動時の cwd のまま変化しない（グレースフルデグレード）

---

### ユーザーストーリー 6 - Window メニューでのタブ一覧 (優先度: P1)

ユーザーとして、Window メニューからターミナルタブにフォーカスを切り替えたい。

**独立したテスト**: Window メニューにターミナルタブが一覧表示され、選択でフォーカスが切り替わること

**受け入れシナリオ**:

1. **前提条件** ターミナルタブとエージェントタブが開いている、**操作** Window メニューを開く、**期待結果** 両方のタブが一覧に表示される
2. **前提条件** Window メニューにターミナルタブが表示されている、**操作** ターミナルタブの項目を選択、**期待結果** 対応するターミナルタブがアクティブになる

---

### ユーザーストーリー 7 - アプリ再起動後の復元 (優先度: P2)

ユーザーとして、アプリを再起動した後に、以前開いていたターミナルタブが同じ cwd で復元されることを確認したい。

**独立したテスト**: localStorage に保存された cwd で新しいシェルが再起動され、タブが復元されること

**受け入れシナリオ**:

1. **前提条件** ターミナルタブが開いている状態でアプリを終了、**操作** アプリを再起動し同じプロジェクトを開く、**期待結果** 以前のターミナルタブが同じ cwd で新しいシェルとして復元される

## エッジケース

- Worktree パスが存在しない場合（削除済み）→ プロジェクトルートにフォールバック
- シェルの実行ファイルが見つからない場合（`$SHELL` 未設定）→ `/bin/sh` にフォールバック
- OSC 7 の URI が不正な場合 → パース失敗を無視し、ラベルを変更しない
- 大量のターミナルタブを開いた場合 → 制限なし（ユーザー責任）
- cwd が非常に長いパスの場合 → タブラベルは basename のみ表示、フルパスはホバーツールチップで確認可能
- Ctrl+` が Tauri の accelerator でサポートされない場合 → フロントエンド側のキーイベントで処理

## 要件 *(必須)*

### 機能要件

- **FR-001**: Tab.type に新しい `terminal` タイプを追加する
- **FR-002**: Tools メニューに "New Terminal" 項目を追加し、Ctrl+` ショートカットを割り当てる
- **FR-003**: PaneManager 経由で素のシェル PTY を生成する（`$SHELL` または `/bin/sh`）
- **FR-004**: 起動ディレクトリは選択中ブランチの Worktree パス。未選択時はプロジェクトルート、プロジェクト未オープン時はホームディレクトリ
- **FR-005**: タブラベルに cwd の basename を表示する。タブホバー時にフルパスをツールチップで表示する
- **FR-006**: Rust バックエンドで PTY 出力から OSC 7 シーケンスをパースし、cwd 変更を Tauri イベントでフロントエンドに通知する（ターミナルタブ専用、エージェントタブには適用しない）
- **FR-007**: タブのドットカラーはグレー（`--text-muted`）を使用する
- **FR-008**: タブは作成順でエージェントタブと混在配置する
- **FR-009**: シェルプロセス終了時（exit/logout）にタブを自動クローズする
- **FR-010**: プロジェクトクローズ時にターミナルタブの PTY を kill しタブを除去する
- **FR-011**: Window メニューにターミナルタブも含めて一覧表示する
- **FR-012**: アプリ再起動後に localStorage に保存された cwd でターミナルタブを復元する

### 非機能要件

- **NFR-001**: OSC 7 パースの処理コストは PTY I/O ループ内で最小限に抑える（正規表現ではなくバイトスキャンを使用）
- **NFR-002**: ターミナル起動から入力可能状態まで 500ms 以内

## 制約と仮定

- macOS の zsh はデフォルトで OSC 7 を送出する（`/etc/zshrc` の `update_terminal_cwd` 関数）
- bash はデフォルトでは OSC 7 を送出しない（ユーザーが PROMPT_COMMAND を設定する必要がある）
- Tauri v2 の accelerator で Ctrl+` がサポートされない可能性がある → フロントエンドキーイベントで代替
- PaneManager の `launch_agent()` メソッドはシェルコマンドでも動作する（command/args の差し替えのみ）

## 成功基準 *(必須)*

- **SC-001**: Tools > New Terminal でシェルターミナルが起動し、コマンド入力・出力が正常に動作する
- **SC-002**: macOS zsh で cd 実行時にタブラベルが自動更新される
- **SC-003**: タブの × ボタン、exit コマンド、プロジェクトクローズの3つの方法でターミナルが正常終了する
- **SC-004**: アプリ再起動後にターミナルタブが復元される
- **SC-005**: Window メニューからターミナルタブへのフォーカス切り替えが動作する
