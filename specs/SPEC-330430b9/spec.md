# 機能仕様: セッション変換一覧の内容表示とSpaceプレビュー

**仕様ID**: `SPEC-330430b9`
**作成日**: 2026-01-29
**ステータス**: ドラフト
**入力**: ユーザー説明: "セッション変換一覧にセッション内容（開始ユーザーメッセージ）を表示し、Spaceでプレビュー画面を出したい。仕様・TDDにも対応して。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 一覧で開始メッセージを識別できる (優先度: P1)

開発者がセッション変換の一覧を開いたとき、セッションIDだけでなくセッション名（Worktree名・ブランチ名相当）と開始ユーザーメッセージを一覧に表示して、変換対象を見分けられる。

**この優先度の理由**: セッションIDのみでは識別が困難で、誤変換が起きやすい。

**独立したテスト**: 既知のセッションファイルを用意し、一覧表示の各行に開始ユーザーメッセージが含まれることを検証できる。

**受け入れシナリオ**:

1. **前提条件** 変換対象エージェントに複数セッションが存在、**操作** セッション選択一覧を表示、**期待結果** 各行に「セッション名 + 開始ユーザーメッセージ + 更新日時」が表示される（セッションIDやメッセージ数は表示しない）。
2. **前提条件** セッション名（Worktree名）が取得できないセッションがある、**操作** 一覧を表示、**期待結果** セッション名欄に英語のプレースホルダが表示され、一覧は崩れない。
3. **前提条件** 開始ユーザーメッセージが空または存在しないセッションがある、**操作** 一覧を表示、**期待結果** メッセージ欄に英語のプレースホルダが表示され、一覧は崩れない。

---

### ユーザーストーリー 2 - Spaceでセッション内容をプレビューできる (優先度: P1)

開発者が一覧で対象セッションを選択し、Spaceキーでプレビュー画面を開き、内容を確認してから変換できる。

**この優先度の理由**: 短い一覧表示だけでは判断が難しいケースがある。

**独立したテスト**: 選択中のセッションでSpaceを押すとプレビューが開閉し、内容が表示されることを確認できる。

**受け入れシナリオ**:

1. **前提条件** セッション一覧が表示されている、**操作** Spaceキーを押す、**期待結果** プレビュー画面が表示され、ヘッダーにセッション名（Worktree名）が表示される。
2. **前提条件** プレビュー画面が表示されている、**操作** SpaceまたはEscキーを押す、**期待結果** プレビューが閉じ、一覧に戻る。
3. **前提条件** セッション変換の確定操作を行った、**操作** 変換処理が実行中、**期待結果** スピナー付きの「Converting session...」が表示され、処理完了後に次のステップへ進む。

---

### ユーザーストーリー 3 - 失敗時でも一覧と変換が継続できる (優先度: P2)

開発者が一覧でセッション内容の読み込みに失敗しても、一覧表示や変換フローが継続できる。

**この優先度の理由**: セッションファイルの欠落や破損があっても変換作業を止めないため。

**独立したテスト**: 破損したセッションファイルを用意し、一覧がエラー表示のまま操作可能であることを確認できる。

**受け入れシナリオ**:

1. **前提条件** 一部セッションの読み取りが失敗、**操作** 一覧を表示、**期待結果** エラー行は英語の簡易メッセージで表示され、他の行は正常に表示される。

---

### エッジケース

- 開始ユーザーメッセージが非常に長い場合、一覧では省略表示になり、プレビューで全文が確認できる。
- セッション名（Worktree名）が取得できない場合、英語のプレースホルダを表示する。
- セッションファイルが巨大/読み込みに時間がかかる場合でも一覧は表示され、開始ユーザーメッセージ抽出に失敗した行は英語のプレースホルダを表示する。
- セッションファイルが削除された/権限不足の場合、該当行は英語のプレースホルダ表示になる。
- すべてのメッセージがassistantのみのセッションでは開始ユーザーメッセージ欄に英語のプレースホルダを表示する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはセッション変換の一覧行に「開始ユーザーメッセージの短い抜粋」を表示**しなければならない**。
- **FR-002**: システムは一覧行に更新日時（`YYYY-MM-DD HH:MM`）を表示**しなければならない**。
- **FR-003**: システムは一覧行にセッションIDやメッセージ数を表示**してはならない**。
- **FR-004**: システムはセッション選択画面でSpaceキーによりプレビュー画面を開閉**できなければならない**。
- **FR-005**: システムはプレビュー画面に選択中セッションの先頭10メッセージ（User/Assistant）を表示**しなければならない**。
- **FR-006**: システムはセッション内容の読み込み失敗時、英語のプレースホルダを表示し、一覧と変換フローを継続**しなければならない**。
- **FR-007**: システムはCLIユーザー向け表示文言を英語で統一**しなければならない**。
- **FR-008**: システムはASCIIのみのUI表現を使用**しなければならない**。
- **FR-009**: システムはこの変更に対する自動テスト（TDD）を必須**としなければならない**。
- **FR-010**: システムはセッション変換処理中にスピナーと「Converting session...」を表示**しなければならない**。
- **FR-011**: システムはセッション変換の一覧行にセッション名（Worktree名）を表示**しなければならない**。
- **FR-012**: システムはセッションプレビューのヘッダーにセッション名（Worktree名）を表示**しなければならない**。
- **FR-013**: システムはセッション名（Worktree名）が取得できない場合に英語のプレースホルダを表示**しなければならない**。

### 主要エンティティ *(機能がデータを含む場合は含める)*

- **ConvertSessionEntry**: 変換一覧の表示用データ（セッション名（Worktree名）、更新日時、開始ユーザーメッセージ抜粋など）。
- **SessionPreview**: プレビュー画面に表示するセッション内容（先頭10メッセージ、ヘッダーにエージェント名・セッション名（Worktree名）・更新日時）。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: セッション変換一覧で、各行に開始ユーザーメッセージ抜粋が表示される。
- **SC-002**: Spaceキーでプレビューが開閉できる。
- **SC-003**: セッションファイル欠落/破損時でも一覧表示が継続し、クラッシュしない。
- **SC-004**: 自動テストが追加され、対象ロジックの主要分岐がカバーされる。
- **SC-005**: 変換中のスピナーが表示され、完了後に次ステップへ遷移する。
- **SC-006**: セッション名が一覧とプレビューに表示される。

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のExecution Mode: Convertのフローを壊さない。
- UIのユーザー向け表示は英語のみ。

### 仮定

- セッション開始のユーザーメッセージは既存のセッションパーサーで抽出可能である。
- 一覧に表示する抜粋は短く整形しても意味が失われない。

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- セッション内容の編集/削除機能
- 変換ロジック（内容変換精度）の改善
- Web UIでの同等機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- セッション内容はローカルUIにのみ表示し、外部送信しない。
- プレビュー表示により機微情報が画面に出る可能性があるため、表示は明示操作（Space）でのみ開く。

## 依存関係 *(該当する場合)*

- 既存のセッションパーサー（Claude Code / Codex / Gemini / OpenCode）
- 既存のTUI Wizard（Execution Mode: Convert）

## 参考資料 *(該当する場合)*

- [既存TUIウィザード設計（Execution Mode: Convert）](specs/SPEC-d2f4762a/spec.md)
