# 機能仕様: エージェントモード

**仕様ID**: `SPEC-ba3f610c`
**作成日**: 2026-01-22
**ステータス**: ドラフト
**カテゴリ**: Porting

**入力**: ユーザー説明: "エージェントモード: マスターエージェント（gwt内蔵LLM、既存AI要約と同じAPI設定共有）がユーザーと対話し、タスクを完全自律的に分割・計画し、複数のサブエージェント（Claude Code等）をtmux制御でオーケストレーションする新機能。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - モード切り替えと基本対話 (優先度: P1)

開発者がブランチモードで`Tab`を押すと、エージェントモードに切り替わり、マスターエージェントとの対話画面が表示される。ユーザーは自由形式でタスクを入力し、マスターエージェントがタスクを分析・計画を応答する。

**この優先度の理由**: エージェントモードへの入口であり、マスターエージェントとの対話がすべての機能の基盤となる。

**独立したテスト**: ブランチモードから`Tab`を押し、エージェントモード画面でタスクを入力して応答を受け取ることで検証できる。

**受け入れシナリオ**:

1. **前提条件** ブランチモードが表示されている、**操作** `Tab`を押す、**期待結果** エージェントモードに切り替わり、チャット画面が表示される
2. **前提条件** エージェントモードが表示されている、**操作** `Tab`を押す、**期待結果** ブランチモードに戻る
3. **前提条件** AI設定が無効（エンドポイントまたはモデル未設定）、**操作** エージェントモードに切り替え、**期待結果** 設定促進メッセージが表示される
4. **前提条件** エージェントモードが表示されている、**操作** 「認証機能を実装して」と入力、**期待結果** マスターエージェントがタスク分析と実行計画を応答
5. **前提条件** エージェントモードでタスクが実行中、**操作** `Tab`でブランチモードに切り替え、**期待結果** タスクはバックグラウンドで継続、ブランチモードに切り替わる

---

### ユーザーストーリー 2 - タスク分割とWorktree自動作成 (優先度: P1)

マスターエージェントがユーザーのタスクを分析し、必要に応じて複数のサブタスクに分割する。各サブタスクに対して、LLMが判断したWorktree戦略に基づいて`agent/`プレフィックス付きブランチとworktreeを自動作成する。

**この優先度の理由**: 自律的なタスク分割とWorktree管理がエージェントモードの核心機能であり、サブエージェント実行の前提条件となる。

**独立したテスト**: タスクを入力し、マスターエージェントがタスクを分割してworktreeを作成することを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** マスターエージェントがタスク計画を策定、**操作** 実行を承認、**期待結果** `agent/`プレフィックス付きブランチとworktreeが作成される
2. **前提条件** 独立した複数タスク、**操作** マスターエージェントがLLM判断で戦略決定、**期待結果** 各タスクに別々のworktreeが作成される
3. **前提条件** 依存関係のあるタスク、**操作** マスターエージェントがLLM判断で戦略決定、**期待結果** 依存タスクは同じworktreeで順次実行される
4. **前提条件** ブランチ名の命名、**操作** worktree作成、**期待結果** `agent/task-description`のような意味のある名前が付けられる

---

### ユーザーストーリー 3 - サブエージェント起動と指示 (優先度: P1)

マスターエージェントがサブエージェント（Claude Code等）をtmuxペインで起動し、`tmux send-keys`でプロンプトを送信する。プロンプトには「タスクが完了したらqで終了して」という指示を含める。

**この優先度の理由**: サブエージェントへの指示がタスク実行の実体であり、エージェントモードの価値を実現する核心機能。

**独立したテスト**: タスク実行を開始し、サブエージェントがtmuxペインで起動してプロンプトを受け取ることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** worktreeが作成済み、**操作** タスク実行開始、**期待結果** tmuxペインでサブエージェント（Claude Code等）が起動
2. **前提条件** サブエージェントが起動、**操作** マスターエージェントがプロンプト送信、**期待結果** `tmux send-keys`でプロンプトが入力される
3. **前提条件** プロンプト送信、**操作** プロンプト内容を確認、**期待結果** タスク指示と「完了したらqで終了」の指示が含まれる
4. **前提条件** 複数サブエージェントを起動、**操作** 並列実行、**期待結果** 各エージェントが別々のtmuxペインで動作

---

### ユーザーストーリー 4 - サブエージェント完了検出 (優先度: P1)

マスターエージェントがサブエージェントの完了を検出する。Claude CodeはHookのStop経由、他のエージェントはtmux複合方式（プロセス終了監視 + 出力パターン監視 + アクティビティ監視）で検出する。

**この優先度の理由**: 完了検出なしにはタスクの進行管理と次のステップへの移行ができない。

**独立したテスト**: サブエージェントがタスクを完了し、マスターエージェントが完了を検出して次のアクションに移行することを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** Claude Codeがサブエージェントとして動作中、**操作** タスク完了でqを押す、**期待結果** Hook経由で完了が検出される
2. **前提条件** Claude Code以外のエージェントが動作中、**操作** プロセスが終了、**期待結果** tmux pane_dead等で完了が検出される
3. **前提条件** tmux出力パターン監視、**操作** 特定の完了パターンが出力、**期待結果** capture-paneで完了が検出される
4. **前提条件** 複合方式での監視、**操作** いずれかの条件を満たす、**期待結果** 完了が検出され、マスターエージェントに通知される

---

### ユーザーストーリー 5 - 成果物統合（PR経由） (優先度: P2)

複数タスクが完了した後、各worktreeからPRを作成して成果物を統合する。コンフリクトが発生した場合はサブエージェントに解決させる。

**この優先度の理由**: 成果物統合はフルサイクルに必須だが、基本的なタスク実行が動作してからの改善項目。

**独立したテスト**: 複数タスク完了後、PRが作成されマージされることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** サブエージェントがタスク完了、**操作** 成果物統合フェーズ開始、**期待結果** worktreeからPRが作成される
2. **前提条件** 複数PRが存在、**操作** マージ、**期待結果** GitHub上でマージされる
3. **前提条件** マージ時にコンフリクト発生、**操作** マスターエージェントが検出、**期待結果** サブエージェントにコンフリクト解決を指示

---

### ユーザーストーリー 6 - 失敗ハンドリング (優先度: P2)

サブエージェントがタスクに失敗した場合（エラー終了、タスク未達成）、マスターエージェントがLLM判断で対応する（リトライ、代替アプローチ、ユーザーへの相談など）。

**この優先度の理由**: エラーハンドリングは堅牢性に必要だが、基本フローが動作してからの改善項目。

**独立したテスト**: サブエージェントが失敗し、マスターエージェントが適切に対応することを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** サブエージェントがエラー終了、**操作** マスターエージェントが検出、**期待結果** LLM判断で対応策を決定（リトライ/代替/相談）
2. **前提条件** タスク未達成（テスト失敗等）、**操作** マスターエージェントが検出、**期待結果** LLM判断で修正指示を送信
3. **前提条件** 複数回の失敗、**操作** マスターエージェントが判断、**期待結果** ユーザーに相談または代替アプローチを提案

---

### ユーザーストーリー 7 - セッション永続化と再開 (優先度: P2)

エージェントモードのセッション状態（タスク一覧、進捗、会話履歴）を完全永続化する。gwtを再起動しても途中のセッションを再開できる。

**この優先度の理由**: 長時間タスクの中断・再開に必須だが、基本フローが動作してからの改善項目。

**独立したテスト**: セッションを中断して再起動し、再開できることを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** タスク実行中、**操作** gwtを終了、**期待結果** セッション状態が`~/.gwt/sessions/`に保存される
2. **前提条件** セッションが保存されている、**操作** gwtを再起動、**期待結果** 前回のセッションを再開できる
3. **前提条件** セッション再開、**操作** 継続実行、**期待結果** 中断前の状態から継続できる
4. **前提条件** 会話履歴が保存されている、**操作** セッション再開、**期待結果** 過去の会話を参照できる

---

### ユーザーストーリー 8 - コンテキスト管理（要約圧縮） (優先度: P3)

タスクが大規模になりLLMのコンテキストウィンドウを超える可能性がある場合、完了タスクの情報を要約圧縮してコンテキストを管理する。

**この優先度の理由**: 大規模タスクへの対応に必要だが、基本的なタスクサイズでは不要。

**独立したテスト**: 長時間の大規模タスク実行後、コンテキストが圧縮されて継続動作することを確認することで検証できる。

**受け入れシナリオ**:

1. **前提条件** 対話が長くなりコンテキストが大きくなる、**操作** 継続して対話、**期待結果** 完了タスクの情報が要約圧縮される
2. **前提条件** 要約圧縮が実行される、**操作** 継続して対話、**期待結果** 重要な情報は保持されつつコンテキストウィンドウ内に収まる

---

### エッジケース

- サブエージェント起動中にtmuxセッションが切断された場合、どう復旧するか？
- 同一ファイルを複数サブエージェントが同時に編集しようとした場合、コンフリクト検出のタイミングは？
- マスターエージェントのLLM API呼び出しがタイムアウトした場合、進行中のタスクはどうなるか？
- セッション復元時に参照していたworktreeが削除されていた場合、どう対処するか？

## 詳細仕様 *(必須)*

### AI設定未構成時の扱い

- AI設定が有効とみなされる条件は「endpointとmodelが設定済みで、AIClientの初期化に成功すること」。
- AI設定が無効の場合でもエージェントモード画面は表示するが、送信入力は無効化する。
- 画面内に英語のエラーメッセージ（例: "AI settings are required"）と、既存のAI設定ウィザードへ遷移する導線を表示する。
- AI設定が有効化されたら、入力と実行を即時再開できる。

### タスク分割の入出力仕様

- LLM出力は構造化データで返し、必須項目は以下とする。
  - tasks: 複数タスクの配列
  - 各タスク: id, name, description, dependencies, worktree_strategy
- idは`task-<number>`形式でセッション内一意、dependenciesは存在するidのみ参照可能で循環不可。
- worktree_strategyは`new`または`shared`のいずれかとする。
- 出力がパース不能または必須項目欠落の場合、同一依頼で最大2回まで再要求する。
- 再要求でも失敗した場合は単一タスクとして扱い、`task-1`/`worktree_strategy=new`を既定とする。

### Worktree/ブランチ命名と作成ルール

- ブランチ名は必ず`agent/`プレフィックスを付ける。
- タスク名からブランチ名を生成する際のルール:
  - 英小文字化する
  - 空白/連続スペースは`-`に置換する
  - `/`と`\`は`-`に置換する
  - 記号は除去し、英数字・ハイフン・アンダースコアのみ許可する
  - 長さは64文字以内とする
- 既に同名ブランチまたは同名worktreeパスが存在する場合は`-2`,`-3`の連番を付与する。
- worktree作成パスは`{repo_root}/.worktrees/{sanitized_branch_name}`を使用する。
- ブランチの起点は「エージェントモード開始時点の現在ブランチ」とする。

### tmux要件と非tmux時の挙動

- `$TMUX`が未設定、またはtmuxコマンド実行に失敗した場合はエージェントモード実行を拒否する。
- 画面には英語で"tmux is required"などのメッセージと再起動手順を表示する。
- 既存のブランチモード操作は継続可能とする。

### サブエージェント起動プロンプト規約

- プロンプトには必ず「完了したらqで終了して」を含める。
- Claude Code以外のエージェントには「終了前に`GWT_TASK_DONE`を出力する」指示を追加する。

### サブエージェント完了検出の条件

- Claude CodeはHook Stopを最優先で使用し、失敗時はtmux複合方式へフォールバックする。
- tmux複合方式の判定条件は以下のいずれか:
  - プロセス終了（pane_deadまたはPID終了）
  - 出力パターン検出（`GWT_TASK_DONE`）
  - アイドルタイムアウト（出力が5分以上更新されない）

### PR作成と統合条件

- PR作成の前提条件:
  - worktree内がクリーンであること
  - baseブランチに対して差分が存在すること
  - `gh`が利用可能で認証済みであること
- baseブランチは「エージェントモード開始時点の現在ブランチ」、headは`agent/...`ブランチとする。
- PRタイトルはタスク名、本文はタスク結果要約から生成する。
- PR作成に失敗した場合は統合を保留し、英語でユーザーに通知する。

### セッション永続化と復元

- 保存トリガー: 会話メッセージ追加、タスク状態変更、worktree作成/削除、サブエージェント状態変更。
- 保存は同一ディレクトリの一時ファイルへ書き出し後、原子的にリネームする。
- セッションファイルのパーミッションは0600、ディレクトリは0700を維持する。
- 起動時、未完了セッションが存在する場合は一覧を提示し、再開/破棄を選択できる。
- JSON破損時は`.broken`に退避して新規セッションを開始する。
- 参照worktreeが欠落している場合は該当タスクを`Failed`または`Paused`とし、再作成/再割当の選択肢を提示する。

### コンテキスト要約（圧縮）条件

- 直近メッセージと未完了タスク情報は保持し、完了タスクと古い会話を要約対象とする。
- 目安となるトリガー:
  - モデルの最大コンテキストが取得できる場合: 推定トークンが最大の80%を超える前に要約
  - 取得できない場合: 最大16kトークンとみなし、12kトークン相当で要約
- 要約結果はシステムメッセージとして保存し、直近20メッセージは原文を保持する。

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは`Tab`キーでブランチモードとエージェントモードを切り替えできなければならない
- **FR-001a**: ブランチモード画面では、ブランチ詳細パネルとAI要約パネルを縦に並べて同時表示しなければならない（既存のTab切り替えは廃止）
- **FR-002**: システムはマスターエージェント（gwt内蔵LLM）を通じてユーザーと自然言語で対話できなければならない
- **FR-003**: マスターエージェントはユーザーの自由形式タスク入力を分析し、サブタスクに分割できなければならない
- **FR-004**: システムは`agent/`プレフィックス付きブランチとworktreeを自動作成できなければならない
- **FR-005**: システムはtmux制御（send-keys, capture-pane等）でサブエージェントを起動・制御できなければならない
- **FR-006**: システムはClaude CodeのHook（Stop）経由で完了を検出できなければならない
- **FR-007**: システムはtmux複合方式（プロセス終了+出力パターン+アクティビティ）でClaude Code以外のエージェント完了を検出できなければならない
- **FR-008**: システムはPR経由で複数worktreeの成果物を統合できなければならない
- **FR-009**: システムはコンフリクト発生時にサブエージェントに解決を指示できなければならない
- **FR-010**: システムはセッション状態を`~/.gwt/sessions/`に永続化できなければならない
- **FR-011**: システムは永続化されたセッションを復元して再開できなければならない
- **FR-012**: システムはコンテキストが大きくなった際に要約圧縮できなければならない
- **FR-013**: マスターエージェントは既存のAI要約機能と同じAPI設定を共有しなければならない

### 主要エンティティ

- **Session**: エージェントモードのセッション全体を表す。会話履歴、タスク一覧、進捗状態を含む
- **Task**: マスターエージェントが分割した個別のタスク。状態（pending/running/completed/failed）、依存関係、割り当てworktreeを持つ
- **SubAgent**: サブエージェント（Claude Code等）のインスタンス。tmuxペイン、worktree、状態を持つ
- **Conversation**: マスターエージェントとユーザーの対話履歴

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは`Tab`キーで1秒以内にモード切り替えができる
- **SC-002**: マスターエージェントは5秒以内に初回応答を返す
- **SC-003**: サブエージェントの完了検出は実際の完了から10秒以内に行われる
- **SC-004**: セッション永続化は状態変更から1秒以内に完了する
- **SC-005**: gwtクラッシュ後もセッションの99%が復元可能である

## 制約と仮定 *(該当する場合)*

### 制約

- tmux環境が必須（tmux外では使用不可）
- Claude Code以外のエージェントでは完了検出の精度が落ちる可能性がある
- LLM APIコストはユーザー責任で管理（制限機能なし）
- `agent/`プレフィックス以外のブランチは自動作成不可

### 仮定

- ユーザーは有効なLLM API設定（既存AI要約機能と共有）を持っている
- サブエージェント（Claude Code等）が正常にインストールされている
- tmuxが利用可能な環境で実行される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- tmux以外の端末多重化ツール（screen等）のサポート
- LLM APIコスト管理・制限機能
- `agent/`以外のプレフィックスでのブランチ自動作成
- サブエージェント以外への作業委譲（外部サービス呼び出し等）

**注**: ブランチモードの画面構成変更（詳細/AI要約パネルの縦並び化）はFR-001aとして本仕様の範囲内に含まれる

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- LLM APIキーは既存のAI要約機能と同じ安全な方法で管理される
- セッションファイルにはタスク内容や会話履歴が含まれるため、適切なファイルパーミッションが必要
- サブエージェントへのプロンプトにセンシティブ情報が含まれる可能性がある

## 依存関係 *(該当する場合)*

- 既存のAI要約機能（SPEC-4b893dae）のAPI設定を共有
- 既存のtmuxマルチエージェントモード
- 既存のworktree管理機能
- Claude Code Hook機能（Stop）

## 参考資料 *(該当する場合)*

- [既存AI要約機能仕様](../SPEC-4b893dae/spec.md)
- [tmux man page - send-keys](https://man7.org/linux/man-pages/man1/tmux.1.html)
