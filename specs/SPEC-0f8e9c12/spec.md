# 機能仕様: Sidebar Filter Cache for Local/Remote/All

**仕様ID**: `SPEC-0f8e9c12`
**作成日**: 2026-02-14
**更新日**: 2026-02-14
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- `SPEC-d6949f99`（Sidebar の Local/Remote/All フィルター）

**入力**: ユーザー説明: "worktree一覧にLocal/Remote/Allのフィルターがありますが、切り替えるたびに読み込みをしているのか、固まります。これを改善して下さい。"

## 背景

- `Sidebar.svelte` はフィルター切替のたびに `list_worktree_branches` / `list_remote_branches` / `list_worktrees` を同期的に再実行している
- ブランチ数やリモートアクセス状況によって、切替時に `Loading...` が表示され続け、体感として「固まる」
- 切替時のレスポンスを最優先しつつ、データ鮮度は裏更新で維持する必要がある

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - フィルターを即時切り替えたい (優先度: P0)

開発者として、Local/Remote/All を切り替えたときに待たされず即時に一覧を見たい。

**独立したテスト**: Local → Remote → Local の往復切替で、TTL内は再取得せず即時表示されること

**受け入れシナリオ**:

1. **前提条件** Local 一覧を1回取得済み、**操作** Remote に切り替えてから Local に戻す、**期待結果** Local 復帰時にキャッシュ表示され `list_worktree_branches` が再実行されない
2. **前提条件** Remote 一覧を1回取得済み、**操作** Local/All へ切替後に Remote に戻す、**期待結果** Remote 復帰時に即時表示される

---

### ユーザーストーリー 2 - 鮮度は裏更新で保ちたい (優先度: P0)

開発者として、即時表示のままでも古いデータが残り続けないよう、適切に再取得してほしい。

**独立したテスト**: TTL超過時に `Loading...` なしで背景再取得が走ること

**受け入れシナリオ**:

1. **前提条件** フィルターのキャッシュが存在し最終取得から10秒超過、**操作** そのフィルターへ切替、**期待結果** キャッシュを即時表示しつつ背景再取得が1回実行される
2. **前提条件** `refreshKey` または `localRefreshKey` が更新された、**操作** フィルターを表示、**期待結果** 旧キャッシュを使わず再取得する

---

### ユーザーストーリー 3 - フィルター切替でPR取得が連発しないでほしい (優先度: P0)

開発者として、Local/Remote/All の切替中に `fetch_pr_status` が都度即時実行されず、切替操作が重くならないようにしたい。

**独立したテスト**: Local→Remote→Local 切替時に `fetch_pr_status` 呼び出し回数が増えないこと

**受け入れシナリオ**:

1. **前提条件** Sidebar 表示直後で PR ステータスを1回取得済み、**操作** 30秒未満で Local/Remote を切替、**期待結果** `fetch_pr_status` の即時追加呼び出しが発生しない
2. **前提条件** PR ステータスポーリング中に取得が未完了、**操作** フィルターを切替、**期待結果** in-flight 呼び出しと並列で追加呼び出しを作らない

---

### ユーザーストーリー 4 - 30秒周期と文字入力が重ならないでほしい (優先度: P0)

開発者として、30秒PRポーリングや検索入力中の再計算がタイピングを阻害しないようにしたい。

**独立したテスト**: 検索入力中は `fetch_pr_status` の周期呼び出しをスキップし、入力反映は短いデバウンス後に行われること

**受け入れシナリオ**:

1. **前提条件** Sidebar の検索入力欄にフォーカス中、**操作** 30秒経過、**期待結果** `fetch_pr_status` の周期呼び出しが発生しない
2. **前提条件** 検索入力欄を blur した、**操作** 次の30秒経過、**期待結果** `fetch_pr_status` の周期呼び出しが再開する
3. **前提条件** 検索語を入力中、**操作** キー入力直後、**期待結果** ブランチ絞り込みは即時ではなく短時間デバウンス後に反映される

---

### ユーザーストーリー 5 - プロジェクト切替時にPR表示が混ざらないでほしい (優先度: P0)

開発者として、`projectPath` を切り替えたときに旧プロジェクトのPR状態が残らず、新プロジェクトで即時に正しい状態取得が始まってほしい。

**独立したテスト**: 旧プロジェクトの in-flight ポーリング中でも、新プロジェクトの `fetch_pr_status` が即時実行され、旧PRバッジが残らないこと

**受け入れシナリオ**:

1. **前提条件** プロジェクトAの `fetch_pr_status` が in-flight、**操作** `projectPath` をA→Bへ変更、**期待結果** Bの `fetch_pr_status` が30秒待ちなしで開始する
2. **前提条件** AでPRバッジ表示済み、**操作** `projectPath` をA→Bへ変更、**期待結果** A由来のPRバッジは即時クリアされる
3. **前提条件** 初回表示時にブランチ一覧が遅延、**操作** ブランチ一覧がロードされる、**期待結果** 最初の30秒を待たず `fetch_pr_status` がブートストラップされる

## エッジケース

- 高速連打でフィルターを切り替えたときに、古いレスポンスで画面が巻き戻らない
- 背景再取得が失敗しても、既存キャッシュ表示を維持してUIが壊れない
- `cleanup-completed` 後の `localRefreshKey` 更新時は Local/All のキャッシュを無効扱いにする
- フィルター切替直後に PR ステータス取得が同時多発しても、UI 操作がブロックされない
- テキスト入力中は PR ポーリング周期が来ても入力遅延を発生させない
- `projectPath` 変更直後に旧プロジェクトのポーリング結果が戻ってきても、新プロジェクト表示を汚染しない

## 要件 *(必須)*

### 機能要件

- **FR-001**: フィルターごと（Local/Remote/All）にブランチ一覧のキャッシュを保持しなければならない
- **FR-002**: キャッシュが有効なフィルターへ切替時は即時表示し、`Loading...` を表示してはならない
- **FR-003**: 同一フィルターで最終取得から10秒以内は再取得を実行してはならない
- **FR-004**: 同一フィルターで最終取得から10秒超過時は、表示を維持したまま背景再取得を実行しなければならない
- **FR-005**: `refreshKey` 更新時は全フィルター、`localRefreshKey` 更新時は Local/All のキャッシュを無効扱いにしなければならない
- **FR-006**: 同一フィルター・同一キーの同時フェッチは1回に集約しなければならない
- **FR-007**: `fetch_pr_status` の即時呼び出しは Sidebar 初期化時のみとし、フィルター切替だけで再実行してはならない
- **FR-008**: PR ステータス取得は in-flight 中の重複呼び出しを禁止しなければならない
- **FR-009**: テキスト入力欄にフォーカスがある間は、`fetch_pr_status` の周期呼び出しをスキップしなければならない
- **FR-010**: ブランチ検索入力は短時間デバウンスを介して絞り込みに反映しなければならない
- **FR-011**: `projectPath` が切り替わったとき、`pollingStatuses` / `pollingGhCliStatus` / ブートストラップ状態を即時リセットしなければならない
- **FR-012**: `fetch_pr_status` の in-flight 抑止は `projectPath` 単位で管理し、別プロジェクトの初回取得を阻害してはならない
- **FR-013**: ブランチ一覧の初期ロード完了時は、30秒周期を待たず `fetch_pr_status` をブートストラップ実行しなければならない

### 非機能要件

- **NFR-001**: フィルター切替操作で主観的なフリーズ（入力に対する反応遅延）を発生させない
- **NFR-002**: 既存の Sidebar 公開インターフェース（props / Tauri command 名）を変更しない
- **NFR-003**: 挙動は `Sidebar.test.ts` の自動テストで検証可能であること
- **NFR-004**: フィルター切替時に PR ステータス取得の追加待ちで操作応答を劣化させない
- **NFR-005**: タイピング中のキー入力で体感上の引っかかりを発生させない
- **NFR-006**: プロジェクト切替時に旧プロジェクト由来のPRバッジが一時表示されない

## 制約と仮定

- 背景更新TTLは `10秒` 固定とする
- データ鮮度より切替レスポンスを優先し、鮮度は背景更新で担保する
- Tauri API失敗時は既存方針どおりグレースフルデグレードする

## 成功基準 *(必須)*

- **SC-001**: Local/Remote/All 往復切替で、TTL内は不要な再取得が発生しない
- **SC-002**: TTL超過時に `Loading...` を出さず背景更新が実行される
- **SC-003**: `refreshKey` / `localRefreshKey` 更新時にキャッシュ無効化と再取得が行われる
- **SC-004**: `gwt-gui/src/lib/components/Sidebar.test.ts` の追加ケースが通過する
- **SC-005**: 30秒未満のフィルター切替で `fetch_pr_status` 呼び出しが増加しない
- **SC-006**: 検索入力フォーカス中の30秒周期で `fetch_pr_status` 呼び出しが増加しない
- **SC-007**: 検索入力の絞り込み反映がデバウンス後に行われることをテストで確認できる
- **SC-008**: 旧プロジェクトの in-flight 中でも、`projectPath` 切替直後に新プロジェクトの `fetch_pr_status` 呼び出しが確認できる
- **SC-009**: `projectPath` 切替時に旧PRバッジが即時消えることをテストで確認できる
- **SC-010**: ブランチ遅延ロード後、30秒待機なしで `fetch_pr_status` が開始されることをテストで確認できる
