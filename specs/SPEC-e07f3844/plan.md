# 実装計画: ヘッダーへの起動ディレクトリ表示

**仕様ID**: `SPEC-e07f3844` | **日付**: 2025-01-05 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/SPEC-e07f3844/spec.md` からの機能仕様

## 概要

claude-worktreeのヘッダー部分に起動ディレクトリの絶対パスを表示する機能を実装します。ユーザーが複数プロジェクトを扱う際に、現在の作業ディレクトリを即座に確認できるようにします。

**主要要件**:
- 起動時の作業ディレクトリの絶対パス取得
- ヘッダー部分への表示（タイトル→区切り線→ディレクトリ→統計情報の順序）
- "Working Directory: " ラベルでの表示
- シンボリックリンク解決

**技術的アプローチ**:
- 既存のReact Ink UIコンポーネント（Header.tsx）を拡張
- Node.jsの`process.cwd()`または既存の`getRepositoryRoot()`関数を活用
- propsベースでディレクトリ情報を親コンポーネントから子コンポーネントへ渡す

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.x、Node.js 18+、Bun 1.0+
**主要な依存関係**: React (ink), execa (for git commands)
**ストレージ**: N/A（表示機能のみ）
**テスト**: Bun test（既存のテストフレームワーク）
**ターゲットプラットフォーム**: Linux/macOS/Windows（CLIアプリケーション）
**プロジェクトタイプ**: 単一プロジェクト（CLIツール）
**パフォーマンス目標**: 起動時のディレクトリ取得は<10ms（既存の同期処理と同等）
**制約**:
- 既存のHeader.tsxコンポーネント構造を維持
- React Inkの宣言的UIパターンに準拠
- 80文字幅のターミナルでの表示を基準とする
**スケール/範囲**: 3ファイルの変更（Header.tsx、BranchListScreen.tsx、App.tsx）

## 原則チェック

*ゲート: フェーズ0の調査前に合格する必要があります。フェーズ1の設計後に再チェック。*

### CLAUDE.mdからの原則適用

1. **シンプルさの極限を追求** ✅
   - 既存のpropsパターンを活用し、新規アーキテクチャを導入しない
   - ディレクトリ取得は既存の`process.cwd()`を使用

2. **ユーザビリティと開発者体験の品質** ✅
   - ヘッダーへの表示で視認性を確保
   - 既存のHeaderコンポーネントの一貫性を維持

3. **エラー解消の徹底** ✅
   - TypeScriptの型チェックで実装時のエラーを防止
   - ビルド成功を完了条件とする

4. **作業の並列化** ✅
   - ファイル変更は独立しており、並列実装可能

5. **TDDの遵守** ⚠️
   - この機能は表示層の変更であり、ユニットテストよりも手動検証が適切
   - ビルド成功と実行時の表示確認をテスト代替とする

**判定**: ✅ **合格** - 原則に準拠

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-e07f3844/
├── spec.md              # 機能仕様書
├── checklists/          # 品質チェックリスト
├── plan.md              # このファイル（/speckit.plan コマンド出力）
├── research.md          # フェーズ0出力（/speckit.plan コマンド）
├── data-model.md        # N/A（データモデルなし）
├── quickstart.md        # フェーズ1出力（/speckit.plan コマンド）
└── tasks.md             # フェーズ2出力（/speckit.tasks コマンド）
```

### ソースコード（リポジトリルート）

```text
src/
├── ui/
│   ├── components/
│   │   ├── parts/
│   │   │   └── Header.tsx           # 変更: workingDirectory props追加
│   │   └── screens/
│   │       └── BranchListScreen.tsx # 変更: workingDirectory props追加
│   └── App.tsx                       # 変更: process.cwd()でディレクトリ取得
└── git.ts                            # 既存: getRepositoryRoot()関数（参照のみ）
```

## フェーズ0: 調査（技術スタック選定）

**目的**: 既存のコードベースを理解し、最適な実装方法を決定する

**出力**: `specs/SPEC-e07f3844/research.md`

### 調査項目

1. **既存のコードベース分析**
   - Header.tsxの現在のprops構造とレンダリングロジック
   - BranchListScreen.tsxのHeader呼び出しパターン
   - App.tsxでのデータフロー（statsやversionの渡し方）
   - 既存のディレクトリ取得方法（git.tsのgetRepositoryRoot()の実装詳細）

2. **技術的決定**
   - `process.cwd()` vs `getRepositoryRoot()`: どちらを使用するか
   - Headerコンポーネントでの表示位置: dividerの前 vs 後
   - props名: `workingDirectory` vs `directory` vs `currentPath`

3. **制約と依存関係**
   - React Inkのレイアウト制約（Boxコンポーネントの使用方法）
   - 既存のHeader propsとの互換性維持
   - 80文字幅での折り返し処理の必要性

## フェーズ1: 設計（アーキテクチャと契約）

**目的**: コンポーネント間のインターフェースと表示ロジックを定義する

**出力**:
- `specs/SPEC-e07f3844/quickstart.md`
- `specs/SPEC-e07f3844/contracts/` （N/A - UIコンポーネントのため外部契約なし）

### 1.1 データモデル設計

**ファイル**: N/A

この機能は新規のデータモデルを導入しません。既存の文字列型プロパティとして起動ディレクトリパスを扱います。

### 1.2 クイックスタートガイド

**ファイル**: `quickstart.md`

開発者向けの実装ガイド：
- 変更対象ファイルの特定方法
- Headerコンポーネントの拡張手順
- propsの型定義追加
- 表示ロジックの実装
- 手動テスト手順

### 1.3 契約/インターフェース

**ディレクトリ**: N/A

UIコンポーネントの内部変更のため、外部契約は不要です。TypeScriptの型定義がインターフェースの役割を果たします。

## フェーズ2: タスク生成

**次のステップ**: `/speckit.tasks` コマンドを実行

**入力**: このプラン + 仕様書 + 設計ドキュメント

**出力**: `specs/SPEC-e07f3844/tasks.md` - 実装のための実行可能なタスクリスト

## 実装戦略

### 優先順位付け

ユーザーストーリーの優先度に基づいて実装：
1. **P1: 現在の作業ディレクトリの即座確認**
   - Header.tsxの拡張
   - App.tsxでのprocess.cwd()取得
   - BranchListScreenでのprops渡し
2. **P2: 視認性の高い配置**
   - 表示位置の調整（dividerの後）
   - スタイリングの確認

### 独立したデリバリー

この機能は単一のプルリクエストとして実装されますが、以下の順序で段階的に実装可能：
1. Header.tsxへのprops追加のみ → ビルド確認
2. App.tsx → BranchListScreen → Header のデータフロー実装 → 動作確認
3. 表示位置の微調整 → 最終確認

## テスト戦略

この機能は表示層の変更であり、以下のテスト戦略を採用：

- **ビルドテスト**: `bun run build` でTypeScriptエラーがないこと
- **手動テスト**:
  - 複数の異なるディレクトリからclaude-worktreeを起動
  - ヘッダーに正しい絶対パスが表示されることを確認
  - 80文字を超えるパスでの折り返し確認
  - シンボリックリンク経由での起動確認
- **統合テスト**: N/A（既存のテストスイートへの影響なし）

## リスクと緩和策

### 技術的リスク

1. **長いディレクトリパスでの表示崩れ**
   - **緩和策**: React Inkは自動で折り返すため、特別な処理は不要。ただし視覚的に確認する。

2. **シンボリックリンクの解決**
   - **緩和策**: `process.cwd()`は既にシンボリックリンクを解決済みのパスを返すため、追加処理は不要。

### 依存関係リスク

1. **React Inkのバージョン互換性**
   - **緩和策**: 既存のHeader.tsxが動作しているため、互換性問題のリスクは低い。

2. **既存のprops構造への影響**
   - **緩和策**: オプショナルなprops（`workingDirectory?: string`）として追加し、既存コードへの影響を最小化。

## 次のステップ

1. ⏭️ フェーズ0: `research.md` を生成（既存コード調査）
2. ⏭️ フェーズ1: `quickstart.md` を生成（実装ガイド）
3. ⏭️ `/speckit.tasks` を実行してタスクを生成
4. ⏭️ `/speckit.implement` で実装を開始
