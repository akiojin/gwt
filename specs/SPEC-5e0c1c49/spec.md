# 機能仕様: Codex CLI gpt-5.1 デフォルト更新

**仕様ID**: `SPEC-5e0c1c49`
**作成日**: 2025-11-14
**ステータス**: ドラフト
**入力**: ユーザー説明: "gpt-5からgpt-5.1にアップデートがかかりましたので、アップデート対応をしてください"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Codex CLI を常に最新モデルで起動 (優先度: P1)

ローカルで `claude-worktree` から Codex CLI を起動する開発者は、追加設定をしなくても既定で `gpt-5.1-codex` が利用され、OpenAI 側の最新機能をすぐに試すことができる。

**この優先度の理由**: Codex CLI の価値は最新モデルをシームレスに使える点にあるため、デフォルトが古いと即座に価値を失う。

**独立したテスト**: `launchCodexCLI` をデフォルト設定で呼び出し、`execa` に渡される引数配列に `--model=gpt-5.1-codex` が含まれることをユニットテストで検証すれば達成。

**受け入れシナリオ**:

1. **前提条件** Codex CLI がローカルにインストール済み、**操作** `claude-worktree` で Codex ツールを選択、**期待結果** コンソールに新しいモデルがログされ、CLI は正常起動
2. **前提条件** 追加の `extraArgs` なし、**操作** `launchCodexCLI` を呼び出す、**期待結果** `@openai/codex@latest` への引数に `--model=gpt-5.1-codex` が含まれる

---

### ユーザーストーリー 2 - 既存オプションとの順序保証 (優先度: P2)

Codex CLI の `resume` や `extraArgs` を使う開発者は、モデル更新後も既定フラグの順序が変わらないため、自動化スクリプトや監視ツールが壊れない。

**この優先度の理由**: 既存の順序依存ワークフローが壊れるとアップデート導入が遅れるため、安定性が重要。

**独立したテスト**: `mode: "continue"` や `extraArgs` を指定して `launchCodexCLI` を実行し、`--model=gpt-5.1-codex` が常にデフォルト引数群の一部として末尾側に挿入されることをテストで確認すれば十分。

**受け入れシナリオ**:

1. **前提条件** `mode: "continue"` で実行、**操作** `launchCodexCLI` 呼び出し、**期待結果** `resume --last` の後に `--model=gpt-5.1-codex` を含むデフォルト引数が続く
2. **前提条件** `extraArgs=["--custom-flag"]`、**操作** `launchCodexCLI` 呼び出し、**期待結果** `--custom-flag` の後にデフォルト引数列が並び、その中に最新モデル指定が存在

---

### ユーザーストーリー 3 - ドキュメントとテストの同期 (優先度: P3)

メンテナは `DEFAULT_CODEX_ARGS` とテスト資産が同期していることを確認でき、将来の Codex モデル更新時も差分が一目で分かる。

**この優先度の理由**: 小さな差分でもドキュメント/テストに齟齬があるとリグレッション検知が遅れるため、整合性が品質へ直結する。

**独立したテスト**: `tests/unit/codex.test.ts` のスナップショット的な配列比較が `gpt-5.1-codex` を期待し、実装と揃っていることを確認すれば目的を達成できる。

**受け入れシナリオ**:

1. **前提条件** リポジトリの説明文に旧モデルが記載されていない、**操作** README/Spec を確認、**期待結果** `gpt-5.1-codex` が明示 or 旧記述が存在しない
2. **前提条件** テストスイート実行、**操作** `bun test tests/unit/codex.test.ts`、**期待結果** モデル文字列差分に起因する失敗が発生しない

### エッジケース

- `bypassApprovals` などの特殊フラグを付与しても、デフォルト引数列に新モデルが含まれること
- Codex CLI 側で `gpt-5.1-codex` が利用できない環境に備え、エラーメッセージは既存のまま（この仕様では変更しない）
- `isCodexAvailable` の挙動は変えず、`--help` チェックのみで十分とする

## 要件 *(必須)*

### 機能要件

- **FR-001**: `DEFAULT_CODEX_ARGS` に `--model=gpt-5.1-codex` を含め、既存の `--model=gpt-5-codex` を完全に置き換えなければならない
- **FR-002**: `launchCodexCLI` はどのモード/追加引数でも `DEFAULT_CODEX_ARGS` を末尾に結合し、順序と内容を保たなければならない
- **FR-003**: `tests/unit/codex.test.ts` は新しい既定引数配列を期待し、旧モデル文字列が残っていないことを検証しなければならない
- **FR-004**: 仕様/README に旧モデル名が存在する場合は更新または削除し、情報の不整合を避けなければならない（本ブランチでは該当箇所がないことを確認する）

### 主要エンティティ

- **CodexLaunchConfig**: Codex CLI を起動する際のフラグ集合（`DEFAULT_CODEX_ARGS`, `extraArgs`, `mode`, `bypassApprovals`）

## 成功基準 *(必須)*

- **SC-001**: `bun test tests/unit/codex.test.ts` が `--model=gpt-5.1-codex` を前提とする期待値で成功する
- **SC-002**: `launchCodexCLI` を実行したログに新モデル名が出力され、旧モデル名は一切表示されない
- **SC-003**: `rg "gpt-5-codex" src tests README.md README.ja.md` を実行した際にヒットが 0 件である（spec ドキュメントは対象外）

## 制約と仮定

### 制約

- Codex CLI が `gpt-5.1-codex` モデル名を受け付けるバージョンを `@openai/codex@latest` が提供していること
- Bun + `execa` ベースの実装構造は変更しない

### 仮定

- 開発者はデフォルトモデルを個別に上書きしない（オプションで `extraArgs` を渡す運用は継続）
- 現行 README などにはモデル名を明記していないため、コードとテストの更新のみで整合性が取れる

## 範囲外 *(必須)*

- Codex CLI の他フラグ (`--enable`, `--sandbox` など) の削除や追加
- CLI 以外（例: Web UI, Fastify サーバー）の変更
- モデル選択を UI から切り替える機能

## セキュリティとプライバシーの考慮事項

- モデル更新によるセキュリティ上の追加フラグは本仕様に含めない
- CLI ログに API Key など秘匿情報を出さない既存ルールを維持する

## 依存関係

- `@openai/codex` CLI バージョンアップ（gpt-5.1-codex サポート）
- `execa` によるプロセス起動

## 参考資料

- OpenAI Codex CLI リリースノート 2025-11-13（gpt-5.1-codex 提供開始）
- 現行 `src/codex.ts` / `tests/unit/codex.test.ts` 実装
