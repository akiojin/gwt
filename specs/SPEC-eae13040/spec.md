# 機能仕様: Worktree内でのコマンド実行制限機能

**仕様ID**: `SPEC-eae13040`
**作成日**: 2025-11-09
**ステータス**: ドラフト
**入力**: ユーザー説明: "Worktree内でのコマンド実行制限機能"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Bashコマンドによる作業ディレクトリ保護 (優先度: P1)

Claude CodeがWorktree内で作業する際、意図しない作業ディレクトリの変更やWorktree外部へのディレクトリ移動を防止し、常にWorktree内で作業が完結することを保証する。

**この優先度の理由**: Worktreeの基本設計思想である「起動ブランチで作業を完結する」を技術的に保証する最重要機能。作業ディレクトリが変わると、意図しないファイル操作や設定の混乱が発生する。

**独立したテスト**: `cd`コマンドの実行をテストし、Worktree内への移動は許可され、Worktree外への移動がブロックされることを確認する。

**受け入れシナリオ**:

1. **前提条件** Worktree内でClaude Codeが動作している、**操作** `cd /tmp`を実行、**期待結果** コマンドがブロックされ、エラーメッセージが表示される
2. **前提条件** Worktree内でClaude Codeが動作している、**操作** `cd ./src`を実行、**期待結果** コマンドが許可され、Worktree内のsrcディレクトリに移動できる
3. **前提条件** Worktree内でClaude Codeが動作している、**操作** `cd ~`を実行、**期待結果** コマンドがブロックされる(ホームディレクトリはWorktree外)

---

### ユーザーストーリー 2 - Gitブランチ操作の制御 (優先度: P1)

Claude Codeがgitコマンドを実行する際、参照系の操作(ブランチ情報の確認)は許可しつつ、ブランチの切り替えや作成・削除などの変更操作を制限する。

**この優先度の理由**: Worktreeの「起動ブランチで作業を完結する」という設計思想を保証する。ブランチが切り替わると、作業対象が変わり意図しない変更が発生する。

**独立したテスト**: 各gitコマンドを実行し、参照系(`git branch --list`等)は許可され、変更系(`git checkout`、`git branch new-branch`等)はブロックされることを確認する。

**受け入れシナリオ**:

1. **前提条件** feature/testブランチで作業中、**操作** `git branch --list`を実行、**期待結果** コマンドが許可され、ブランチ一覧が表示される
2. **前提条件** feature/testブランチで作業中、**操作** `git branch`(引数なし)を実行、**期待結果** コマンドが許可され、現在のブランチが表示される
3. **前提条件** feature/testブランチで作業中、**操作** `git checkout main`を実行、**期待結果** コマンドがブロックされる
4. **前提条件** feature/testブランチで作業中、**操作** `git branch new-branch`を実行、**期待結果** コマンドがブロックされる
5. **前提条件** feature/testブランチで作業中、**操作** `git branch -d old-branch`を実行、**期待結果** コマンドがブロックされる
6. **前提条件** feature/testブランチで作業中、**操作** `git checkout -- file.txt`を実行、**期待結果** コマンドが許可され、ファイルが復元される(ブランチ切り替えではないため)

---

### ユーザーストーリー 3 - ファイル・ディレクトリ操作の範囲制限 (優先度: P2)

Claude CodeがWorktree外部のファイルシステムに意図しない変更を加えることを防止し、Worktree内でのみファイル・ディレクトリの作成・削除・変更を許可する。

**この優先度の理由**: セキュリティとデータ保護の観点から重要。Worktree外部のシステムファイルや他のプロジェクトファイルへの意図しない変更を防ぐ。

**独立したテスト**: `mkdir`、`rm`、`touch`等のコマンドを実行し、Worktree内では許可され、Worktree外ではブロックされることを確認する。

**受け入れシナリオ**:

1. **前提条件** Worktree内でClaude Codeが動作している、**操作** `mkdir ./new-dir`を実行、**期待結果** コマンドが許可され、Worktree内にディレクトリが作成される
2. **前提条件** Worktree内でClaude Codeが動作している、**操作** `rm /tmp/file.txt`を実行、**期待結果** コマンドがブロックされる(Worktree外のファイル削除のため)
3. **前提条件** Worktree内でClaude Codeが動作している、**操作** `touch ../outside.txt`を実行、**期待結果** コマンドがブロックされる(Worktree外のファイル作成のため)

---

### ユーザーストーリー 4 - 複合コマンドでの制限適用 (優先度: P2)

`&&`や`;`、`|`で連結された複合コマンド内でも、各コマンドに対して制限が適用され、禁止コマンドが含まれている場合は全体がブロックされる。

**この優先度の理由**: 複合コマンドを使った制限回避を防ぐ。単独コマンドの制限が有効でも、複合コマンドで回避できる場合は機能が無意味になる。

**独立したテスト**: 複合コマンドを実行し、禁止コマンドが含まれている場合は全体がブロックされることを確認する。

**受け入れシナリオ**:

1. **前提条件** feature/testブランチで作業中、**操作** `echo "test" && git checkout main`を実行、**期待結果** コマンド全体がブロックされる
2. **前提条件** Worktree内でClaude Codeが動作している、**操作** `git status && git branch --list`を実行、**期待結果** コマンドが許可され、両方が実行される(どちらも許可コマンドのため)
3. **前提条件** Worktree内でClaude Codeが動作している、**操作** `pwd && cd /tmp`を実行、**期待結果** コマンド全体がブロックされる

---

### エッジケース

- シンボリックリンクを経由したWorktree外へのアクセス試行はどう処理されますか？
  - シンボリックリンクを解決して実際のパスを判定し、Worktree外であればブロックする
- 相対パス(`../../..`)を使ったWorktree外へのアクセス試行はどう処理されますか？
  - 相対パスを絶対パスに変換してWorktree境界を判定する
- 存在しないディレクトリへの`cd`はどう処理されますか？
  - パスが存在しない場合でもWorktree境界を判定し、Worktree外であればブロックする
- `git checkout`でブランチではなくファイルを復元する場合はどう処理されますか？
  - ファイル復元(`git checkout -- file`)は許可し、ブランチ切り替えのみをブロックする
- `git branch`で新しいブランチを作成せず、ブランチ情報のみを参照する場合はどう処理されますか？
  - 参照系オプション(`--list`、`--contains`、`--merged`等)や引数なしの場合は許可する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは`cd`コマンドがWorktree外へのディレクトリ移動を試みた場合、コマンドをブロック**しなければならない**
- **FR-002**: システムは`cd`コマンドがWorktree内へのディレクトリ移動の場合、コマンドを許可**しなければならない**
- **FR-003**: システムは`git checkout <branch>`または`git switch <branch>`によるブランチ切り替えをブロック**しなければならない**
- **FR-004**: システムは`git checkout -- <file>`によるファイル復元を許可**しなければならない**
- **FR-005**: システムは`git branch`(引数なし)または参照系オプション(`--list`、`--contains`、`--merged`、`--show-current`等)を許可**しなければならない**
- **FR-006**: システムは`git branch <new-branch>`によるブランチ作成をブロック**しなければならない**
- **FR-007**: システムは`git branch -d`、`git branch -D`、`git branch -m`等の変更系オプションをブロック**しなければならない**
- **FR-008**: システムは`git worktree`コマンドをブロック**しなければならない**
- **FR-009**: システムはファイル・ディレクトリ作成・削除コマンド(`mkdir`、`rm`、`touch`等)がWorktree外を対象とする場合、コマンドをブロック**しなければならない**
- **FR-010**: システムはファイル・ディレクトリ作成・削除コマンドがWorktree内を対象とする場合、コマンドを許可**しなければならない**
- **FR-011**: システムは複合コマンド(`&&`、`;`、`|`等で連結)内の各コマンドに対して制限を適用**しなければならない**
- **FR-012**: システムは禁止コマンドが複合コマンド内に含まれている場合、コマンド全体をブロック**しなければならない**
- **FR-013**: システムはシンボリックリンクを解決して実際のパスを判定し、Worktree境界チェックを実施**しなければならない**
- **FR-014**: システムは相対パスを絶対パスに変換してWorktree境界チェックを実施**しなければならない**
- **FR-015**: システムはブロック時に、ブロック理由と代替手段を含むエラーメッセージを表示**しなければならない**

### 主要エンティティ

- **Worktreeルートパス**: 現在のWorktreeディレクトリのルート絶対パス。すべてのパス判定の基準となる
- **コマンドセグメント**: 複合コマンドを演算子(`&&`、`;`、`|`等)で分割した個別のコマンド単位
- **禁止コマンドパターン**: ブロック対象のコマンドを識別する正規表現パターン
- **許可オプションリスト**: `git branch`等で許可される参照系オプションのリスト

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: Claude Codeが`cd`コマンドでWorktree外へ移動しようとした場合、100%の確率でブロックされる
- **SC-002**: Claude Codeが`git branch --list`等の参照系コマンドを実行した場合、100%の確率で許可される
- **SC-003**: Claude Codeが`git checkout <branch>`でブランチ切り替えを試みた場合、100%の確率でブロックされる
- **SC-004**: Claude Codeが`git checkout -- <file>`でファイル復元を試みた場合、100%の確率で許可される
- **SC-005**: 複合コマンド内に禁止コマンドが含まれている場合、100%の確率でコマンド全体がブロックされる
- **SC-006**: シンボリックリンクや相対パスを使ったWorktree外へのアクセス試行が、100%の確率で検出・ブロックされる
- **SC-007**: ブロック時のエラーメッセージが、ブロック理由と代替手段を含む分かりやすい内容である

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のClaude Code PreToolUseフック機構を使用する必要がある
- フックスクリプトはBashで実装される必要がある
- フックスクリプトは`jq`コマンドを使用してJSON入力を解析する必要がある

### 仮定

- Worktreeルートは`git rev-parse --show-toplevel`で取得できる
- `realpath`コマンドが利用可能である(シンボリックリンク解決のため)
- フックスクリプトは各Bashツール呼び出しの前に実行される
- ユーザーはWorktree内で完結する作業フローを理解している

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です:

- Read、Write、Edit等の専用ツールによるファイル操作の制限(これらはBashツールではないため)
- Bashツール以外のツール(Task、Grep、Glob等)の制限
- gitコマンド以外のバージョン管理システム(svn、hg等)の制限
- ネットワーク経由のリモート操作の制限
- 環境変数の変更や設定ファイルの書き換えによる制限回避の検出

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- フックスクリプトはセキュリティ境界を提供するため、スクリプト自体の改ざん防止が重要
- エラーメッセージには機密情報(絶対パス、ユーザー名等)が含まれる可能性があるため、適切な情報レベルを維持する
- シンボリックリンク経由の攻撃(Worktree外へのリンク作成後、そのリンクを経由したアクセス)を防ぐため、リンク解決が必須

## 依存関係 *(該当する場合)*

- Claude Code PreToolUseフック機構
- Bashシェル環境(バージョン4.0以上を推奨)
- `jq`コマンド(JSON解析のため)
- `git`コマンド(Worktreeルート取得のため)
- `realpath`コマンド(シンボリックリンク解決のため、利用不可の場合はフォールバック処理)

## 参考資料 *(該当する場合)*

- [既存のblock-cd-command.shフックスクリプト](.claude/hooks/block-cd-command.sh)
- [既存のblock-git-branch-ops.shフックスクリプト](.claude/hooks/block-git-branch-ops.sh)
- [Claude Code設定ファイル](.claude/settings.json)
