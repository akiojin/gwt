# 機能仕様: ブランチ一覧の表示順序改善

**仕様ID**: `SPEC-a5ae4916`
**作成日**: 2025-10-25
**ステータス**: ドラフト
**入力**: ユーザー説明: "ブランチ一覧の表示順序を改善する。Worktreeが存在するブランチを優先的に上部に表示し、その次にローカルブランチを表示する。これにより、ユーザーが現在作業中のブランチや作業可能なブランチに素早くアクセスできるようにする。"

## Clarifications

### Session 2025-10-25

- Q: `develop` やその他の長期運用ブランチが存在する場合の表示優先度をどうしますか？ → A: 1（mainの直後に配置）
- Q: リリース／ホットフィックスなどの長期メンテナンス系ブランチが存在する場合の表示順は？ → A: 2（特別扱いせず汎用ルール）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Worktree付きブランチの優先表示 (優先度: P1)

開発者がブランチ一覧を開いたとき、現在worktreeが作成されているブランチ（作業中のブランチ）が一覧の上部に表示される。これにより、作業を再開したいブランチや管理したいworktreeに素早くアクセスできる。

**この優先度の理由**: worktreeが作成されているブランチは、ユーザーが現在アクティブに作業しているか、最近作業していたブランチである可能性が高い。これらを優先表示することで、最も頻繁にアクセスするブランチへの到達時間を短縮し、開発効率を向上させる。

**独立したテスト**: 複数のブランチが存在し、一部にworktreeが作成されている状態で一覧を表示し、worktree付きブランチが上部にグループ化されていることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧に10個のブランチが存在し、そのうち3個にworktreeが作成されている、**操作** ブランチ一覧を表示する、**期待結果** worktreeが作成されている3個のブランチが、worktreeがない7個のブランチより上に表示される
2. **前提条件** すべてのブランチにworktreeが作成されていない、**操作** ブランチ一覧を表示する、**期待結果** ブランチは従来の順序（現在のブランチ、mainブランチ、名前順）で表示される
3. **前提条件** worktreeが作成されたブランチA（最新コミット: 2025-11-04T15:00Z）とブランチB（最新コミット: 2025-11-01T02:00Z）が存在する、**操作** ブランチ一覧を表示する、**期待結果** ブランチAがブランチBより上位に表示される

---

### ユーザーストーリー 2 - ローカルブランチの優先表示 (優先度: P2)

開発者がブランチ一覧を開いたとき、ローカルに存在するブランチがリモートオンリーのブランチより上に表示される。これにより、すぐに作業を開始できるブランチに素早くアクセスできる。

**この優先度の理由**: ローカルブランチは既にチェックアウト可能で、すぐに作業を開始できる。リモートオンリーのブランチは追加の操作（フェッチやチェックアウト）が必要なため、頻繁にアクセスするローカルブランチを優先表示することでユーザー体験が向上する。

**独立したテスト**: ローカルブランチとリモートオンリーブランチが混在する状態で一覧を表示し、ローカルブランチがリモートオンリーブランチより上に表示されることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** 5個のローカルブランチと5個のリモートオンリーブランチが存在し、どちらもworktreeがない、**操作** ブランチ一覧を表示する、**期待結果** すべてのローカルブランチがすべてのリモートオンリーブランチより上に表示される
2. **前提条件** リモートオンリーブランチにworktreeが作成されている（ローカルブランチ化している）、**操作** ブランチ一覧を表示する、**期待結果** そのブランチはworktree付きブランチとして上部に表示される
3. **前提条件** worktreeなしのローカルブランチCとリモートブランチDが存在し、最新コミット時刻がそれぞれ 2025-11-03T09:00Z と 2025-11-04T12:00Z である、**操作** ブランチ一覧を表示する、**期待結果** リモートブランチDがブランチCより上位に表示される

---

### ユーザーストーリー 3 - 既存の優先順位の維持 (優先度: P3)

開発者がブランチ一覧を開いたとき、現在のブランチとmainブランチは最も優先度が高い位置に表示され続ける。新しいソート機能が追加されても、既存の重要な優先順位は維持される。

**この優先度の理由**: 現在のブランチとmainブランチは特別な意味を持ち、ユーザーが最も頻繁に参照する情報である。新機能追加により既存のUXが損なわれないよう、これらの優先順位は保持する必要がある。

**独立したテスト**: 現在のブランチとmainブランチが存在する状態で一覧を表示し、これらが最上部に表示され、その後にdevelopブランチ、worktree付きブランチ、ローカルブランチの順で表示されることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** 現在のブランチはfeature/testで、mainブランチとdevelopブランチ、worktree付きブランチが存在する、**操作** ブランチ一覧を表示する、**期待結果** feature/testが最上部、mainが2番目、developが3番目、その後にworktree付きブランチが表示される
2. **前提条件** 現在のブランチがmainで、developブランチと複数のworktree付きブランチが存在する、**操作** ブランチ一覧を表示する、**期待結果** mainが最上部、developが2番目に表示され、その後にworktree付きブランチが表示される

---

### ユーザーストーリー 4 - 最新コミット時刻の可視化と選択行の強調 (優先度: P2)

開発者がブランチ一覧を閲覧したとき、各ブランチが最後に更新されたタイミングと、現在選択している行を即座に把握できる。

**この優先度の理由**: 最新コミット時刻を表示することで、直近でアクティブだったブランチを判断しやすくなり、選択行の視認性向上は誤操作を抑制する。

**独立したテスト**: ブランチ行に「最終更新:」が表示されること、および選択中の行のみ背景色が変化することを検証することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** 最新コミット時刻が設定されたブランチが3本存在する、**操作** ブランチ一覧を表示する、**期待結果** 各行の右端に「YYYY-MM-DD HH:mm」形式の時刻が表示され、3つ全ての行で確認できる
2. **前提条件** ブランチ一覧で先頭行が選択されている、**操作** 画面を確認する、**期待結果** 選択中の行全体が水色背景で表示され、それ以外の行の背景色は変化しない
3. **前提条件** 選択行を1行下へ移動する、**操作** 移動後の表示を確認する、**期待結果** 水色背景は新たに選択した行に移動し、前の行からは消える

---

### エッジケース

- ブランチ数が0の場合、空の一覧が表示される
- すべてのブランチにworktreeが作成されている場合、すべてが上部グループに表示され、その中で既存の優先順位（current、main、名前順）でソートされる
- ブランチ名が同一で異なる条件を持つ場合（例: ローカルとリモート両方に存在）、重複排除ロジックにより片方のみが表示される
- worktreeの情報取得に失敗した場合、その情報がない状態でソートが実行され、従来の順序で表示される
- mainブランチが存在しない場合、developブランチは一般的なソート優先度（worktree有無、ローカル/リモート、名前順）に従う
- release/\* や hotfix/\* ブランチは、worktreeがない限り一般ルールに従って並び、worktreeがある場合はworktreeグループに含まれる

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは、ブランチ一覧のソート処理において、各ブランチにworktreeが存在するかどうかを判定**しなければならない**
- **FR-002**: システムは、worktreeが存在するブランチを、worktreeが存在しないブランチより上位に表示**しなければならない**
- **FR-002a**: システムは、worktreeの有無が一致するブランチ群の内部で、最新コミットのタイムスタンプが新しい順にソート**しなければならない**
- **FR-002c**: システムは、各ブランチ行に最新コミット時刻を「YYYY-MM-DD HH:mm」形式で表示**しなければならない**
- **FR-002d**: システムは、選択中のブランチ行全体を水色背景で強調表示**しなければならない**（他の行の配色・レイアウトは維持する）
- **FR-003**: システムは、worktreeの有無と最新コミット時刻が同一のブランチ間では、ローカルブランチをリモートオンリーブランチより上位に表示**しなければならない**
- **FR-004**: システムは、現在のブランチ（isCurrent=true）を最優先で表示**しなければならない**
- **FR-005**: システムは、現在のブランチの次にmainブランチ（branchType=main）を表示**しなければならない**
- **FR-005a**: システムは、mainブランチが存在する場合に限り、developブランチ（branchType=develop）をmainの直後に表示**しなければならない**
- **FR-005b**: システムは、release/\* や hotfix/\* などのメンテナンス系ブランチについて、worktreeがない場合は特別扱いせず、一般の優先度ルール（worktree有無→ローカル/リモート→名前順）に従わせなければならない
- **FR-006**: システムは、同じ優先度レベル内では、ブランチ名のアルファベット順でソート**しなければならない**
- **FR-007**: システムは、既存のブランチ表示形式（アイコン、パディング、説明文）を維持**しなければならない**

### 主要エンティティ

- **ブランチ（Branch）**: ブランチ名、タイプ（local/remote）、現在のブランチかどうか、ブランチタイプ（main/feature/hotfixなど）を持つ
- **Worktree**: パス、関連するブランチ名を持つ
- **ブランチ一覧選択肢（Branch Choice）**: 表示名、値（ブランチ名）、説明文を持つUI要素

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: worktreeが作成されているブランチが、worktreeがないブランチより常に上部に表示される（現在のブランチとmainブランチを除く）
- **SC-002**: ローカルブランチが、リモートオンリーブランチより常に上部に表示される（worktreeの有無が同じ場合）
- **SC-003**: 現在のブランチとmainブランチの表示位置が既存の動作から変更されない
- **SC-004**: ユーザーが作業中のブランチ（worktree付き）にアクセスするまでのスクロール量が平均50%削減される（10個以上のブランチが存在する場合）
- **SC-005**: developブランチが存在する場合、常にmainブランチの直後に表示される
- **SC-006**: 表示されたブランチ行の100%に「最終更新:」が表示され、最新コミット時刻が人間可読な形式で確認できる
- **SC-007**: ブランチ選択時、水色背景のハイライトが常に1行だけに適用される

## 制約と仮定 *(該当する場合)*

### 制約

- 既存のブランチ一覧表示機能を基盤とする必要がある
- 既存のworktree情報取得ロジック（worktreeMap）を使用する
- 既存のブランチ情報構造（BranchInfo）は後方互換性を保ちながら拡張する（プロパティ追加は可、既存フィールドの破壊的変更は不可）
- パフォーマンスの劣化を引き起こしてはならない（ソート処理はO(n log n)以内）

### 仮定

- ブランチ情報とworktree情報は既に取得済みで利用可能である
- worktreeMapには、ブランチ名をキーとしたworktree情報が格納されている
- ブランチ一覧は`createBranchTable`関数で生成される
- ソートロジックは`sortedBranches`変数の生成時に実装される

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- ブランチ情報の取得方法の変更
- worktree情報の取得方法の変更
- ブランチ一覧の大幅なレイアウト刷新（アイコン・文字配置の基本構造は維持する）
- ブランチのフィルタリング機能
- ブランチのグループ化表示機能
- ソート順のユーザーカスタマイズ機能
- ブランチ一覧のページネーション機能

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

この機能はUI表示順序の改善であり、セキュリティやプライバシーへの直接的な影響はない。

## 依存関係 *(該当する場合)*

- 既存のブランチ情報取得機能（`getAllBranches`）
- 既存のworktree情報取得機能（`listAdditionalWorktrees`）
- 既存のブランチテーブル生成機能（`createBranchTable`）
- ブランチ情報の型定義（`BranchInfo`）
- Worktree情報の型定義（`WorktreeInfo`）

## 参考資料 *(該当する場合)*

- [既存のブランチテーブル生成ロジック](../src/ui/table.ts)
- [既存のソート実装](../src/ui/table.ts#L80-L86)
