# 機能仕様: コーディングエージェント対応

**仕様ID**: `SPEC-3b0ed29b`
**作成日**: 2025-12-06
**ステータス**: 実装済み
**入力**: ユーザー説明: "コーディングエージェント対応: gwtから各コーディングエージェント（Claude Code、Codex、Gemini、OpenCode）を起動する機能。各エージェントは独自のデフォルト引数を持ち、モード（新規/継続/再開）に応じた引数、権限スキップオプション、およびCodex CLIのスキル機能（--enable skills）などの機能拡張オプションを提供する。"

## 概要

gwtから各コーディングエージェント（Claude Code、Codex、Gemini、OpenCode）を起動する機能。各エージェントは独自のデフォルト引数を持ち、モード（新規/継続/再開）に応じた引数、権限スキップオプション、およびエージェント固有の機能拡張オプションを提供する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - コーディングエージェントをデフォルト設定で起動 (優先度: P1)

開発者がgwtからコーディングエージェントを選択して起動する際、各エージェントに最適化されたデフォルト引数が自動的に適用され、追加設定なしですぐに作業を開始できる。

**この優先度の理由**: 開発者が最小限の操作でコーディングエージェントを起動できることがgwtの基本価値であり、デフォルト設定の自動適用はユーザー体験の根幹となる。

**独立したテスト**: 各コーディングエージェント（Claude Code、Codex、Gemini、OpenCode）を新規セッションで起動し、期待されるデフォルト引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** gwtが起動しブランチが選択されている、**操作** エージェント選択画面でCodexを選択して起動、**期待結果** Codexが`--enable web_search_request`、`--enable skills`、`--sandbox workspace-write`などのデフォルト引数付きで起動する
2. **前提条件** gwtが起動しブランチが選択されている、**操作** エージェント選択画面でClaude Codeを選択して起動、**期待結果** Claude Codeがデフォルト設定で起動し、モデル選択が可能
3. **前提条件** gwtが起動しブランチが選択されている、**操作** エージェント選択画面でGeminiを選択して起動、**期待結果** Gemini CLIがデフォルト設定で起動する
4. **前提条件** gwtが起動しブランチが選択されている、**操作** エージェント選択画面でOpenCodeを選択して起動、**期待結果** OpenCodeがデフォルト設定で起動する
5. **前提条件** Claude CodeのChrome拡張機能統合が未対応の環境（例: WSL）、**操作** Claude Codeを起動、**期待結果** Chrome統合フラグは付与されず、警告が表示された上でClaude Codeが起動する

---

### ユーザーストーリー 2 - セッションの継続と再開 (優先度: P1)

開発者が以前の作業セッションを継続または再開したい場合、各コーディングエージェントに適切なモード引数が渡され、過去の会話履歴にアクセスできる。

**この優先度の理由**: セッションの継続性は開発者の作業効率に直結し、コンテキストを失わずに作業を再開できることが重要。

**独立したテスト**: 各コーディングエージェントを「継続」または「再開」モードで起動し、適切なコマンドライン引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** 過去のCodexセッションが存在、**操作** 「Continue」モードでCodexを起動、**期待結果** `resume --last`引数が渡され、最後のセッションが再開される
2. **前提条件** 過去のClaude Codeセッションが存在、**操作** 「Continue」モードでClaude Codeを起動、**期待結果** `-c`引数が渡され、最新の会話が継続される
3. **前提条件** 過去のGeminiセッションが存在、**操作** 「Continue」モードでGeminiを起動、**期待結果** `-r latest`引数が渡され、最新セッションが再開される
4. **前提条件** 過去のOpenCodeセッションが存在、**操作** 「Continue」モードでOpenCodeを起動、**期待結果** `-c`引数が渡され、最新の会話が継続される
5. **前提条件** 過去のOpenCodeセッションIDが既知、**操作** 「Resume」モードでOpenCodeを起動、**期待結果** `-s [sessionId]`引数が渡され、指定セッションが再開される

---

### ユーザーストーリー 3 - 権限スキップモードでの起動 (優先度: P2)

開発者が信頼された環境（自動化スクリプト、Docker環境など）でコーディングエージェントを使用する際、権限確認をスキップして全てのアクションを自動承認できる。

**この優先度の理由**: 自動化やCI/CD環境での利用に有用だが、通常の対話的な開発では必須ではない。セキュリティリスクを伴うため、意識的な選択が必要。

**独立したテスト**: 各コーディングエージェントを権限スキップモードで起動し、適切なフラグ（--yolo、--dangerously-skip-permissions、-y）がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** 権限スキップモードが有効、**操作** Codexを起動、**期待結果** `--yolo`フラグが渡され、自動承認モードで起動する
2. **前提条件** 権限スキップモードが有効、**操作** Claude Codeを起動、**期待結果** `--dangerously-skip-permissions`フラグと`IS_SANDBOX=1`環境変数が設定される
3. **前提条件** 権限スキップモードが有効、**操作** Geminiを起動、**期待結果** `-y`フラグが渡され、自動承認モードで起動する
4. **前提条件** 権限スキップモードが有効、**操作** OpenCodeを起動、**期待結果** OpenCodeはデフォルトで自動承認のため追加フラグなしで起動する（現時点で権限スキップ用のフラグは未提供）

---

### ユーザーストーリー 4 - Codex CLIのスキル機能を利用 (優先度: P1)

開発者がCodex CLIを起動する際、スキル機能が自動的に有効化され、`~/.codex/skills/`に配置したカスタムスキルを利用できる。

**この優先度の理由**: スキル機能はCodex CLIの重要な拡張機能であり、開発者の生産性を向上させる。デフォルトで有効化することで、追加設定なしでスキルを活用できる。

**独立したテスト**: Codexを起動し、`--enable skills`引数がプロセスに渡されることを確認すれば検証できる。スキルファイルが存在する場合、Codex CLI内でスキルが利用可能であることを確認できる。

**受け入れシナリオ**:

1. **前提条件** ~/.codex/skills/にスキルファイルが存在、**操作** gwtからCodexを起動、**期待結果** `--enable skills`引数が渡され、スキルがCodex CLI内で利用可能
2. **前提条件** スキルファイルが存在しない、**操作** gwtからCodexを起動、**期待結果** `--enable skills`引数が渡されるが、スキルは利用不可（エラーにはならない）

---

### ユーザーストーリー 5 - モデル選択オプション (優先度: P2)

開発者が特定のAIモデルを選択してエージェントを起動したい場合、選択したモデルがコマンドライン引数として渡される。

**この優先度の理由**: モデル選択は高度なユースケースであり、デフォルトモデルで十分な場合が多いが、特定のタスクに最適なモデルを選択できることは価値がある。

**独立したテスト**: 各コーディングエージェントをモデル指定付きで起動し、適切な`--model`引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** モデル選択画面でgpt-5.1-codex-maxを選択、**操作** Codexを起動、**期待結果** `--model=gpt-5.1-codex-max`引数が渡される
2. **前提条件** モデル選択画面でgpt-5.2を選択、**操作** Codexを起動、**期待結果** `--model=gpt-5.2`引数が渡され、推論レベル選択肢に`Extra high`（xhigh）が含まれる
3. **前提条件** モデル選択画面でsonnetを選択、**操作** Claude Codeを起動、**期待結果** `--model sonnet`引数が渡される
4. **前提条件** モデル選択なし（デフォルト）、**操作** Codexを起動、**期待結果** `--model=gpt-5.1-codex`（デフォルトモデル）が使用される
5. **前提条件** モデル選択画面でprovider/modelを選択、**操作** OpenCodeを起動、**期待結果** `-m provider/model`引数が渡される

---

### ユーザーストーリー 6 - Quick Startでブランチ／エージェント別に最新セッションを提示 (優先度: P1)

開発者がQuick Startを開いたとき、選択したブランチ・ワークツリーに紐づく各コーディングエージェントの最新設定とセッションIDが正しく表示され、Resume選択ですぐ再開できる。

**この優先度の理由**: セッションIDの取り違えは再開失敗を招き、作業効率を大きく損なうため。

**独立したテスト**: 各エージェントでセッションを開始→終了し、同じブランチ/ワークツリーでQuick Startを開いて最新IDが表示されること、別ブランチのIDは表示されないことを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** feature/update-claude-md のワークツリーでClaude Codeを起動しセッションを終了、**操作** Quick Startを開く、**期待結果** ClaudeのResume行に直近で保存されたセッションIDが表示され、別ブランチのIDは出ない
2. **前提条件** Codexで新規セッション開始後すぐ終了、**操作** Quick Startを開く、**期待結果** CodexのResume行に開始直後のセッションIDが表示される
3. **前提条件** agentファイルなどsession_idを持たないファイルが最新更新となっている、**操作** Quick Startを開く、**期待結果** 有効なsession_idを持つ最新ファイルが優先され、無効なファイルで上書きされない
4. **前提条件** Reasoningを持たないエージェント(Gemini/Claude/OpenCode)、**操作** Quick Startを見る、**期待結果** Reasoning表示が出ず、モデル・スキップ可否・セッションIDのみが表示される

---

### ユーザーストーリー 7 - Worktree再利用時のブランチ整合性保証 (優先度: P1)

開発者がブランチを選択してコーディングエージェントを起動する際、gwtは再利用するWorktreeが選択ブランチと一致していることを確認し、異なるブランチのWorktreeを誤って使わない。

**この優先度の理由**: 異なるブランチのWorktreeを誤って使うと、作業対象のコードや履歴が混在し重大な作業ミスを招くため。
**独立したテスト**: `git worktree list` に登録されたパスの現在ブランチが一致しないケースを擬似的に作り、選択ブランチに一致しないWorktreeが再利用されず、警告が表示されることを確認する。

**受け入れシナリオ**:
1. **前提条件** 選択ブランチに一致するWorktreeが存在、**操作** エージェント起動フローを進める、**期待結果** 一致するWorktreeが再利用される
2. **前提条件** Worktreeのパスが存在するが選択ブランチと異なるブランチがチェックアウトされている、**操作** エージェント起動フローを進める、**期待結果** そのWorktreeは再利用されず警告が表示され、選択ブランチに対する正しいWorktreeが用意される

---

### ユーザーストーリー 8 - モデル名表示の正規化 (優先度: P2)

開発者が選択サマリやQuick Startでモデル名を確認する際、モデル名は公式の識別子に正規化され、タイプミスや表記揺れが混入しない。

**この優先度の理由**: モデル名の誤表示は誤設定の疑念を生み、作業の信頼性を損なうため。
**独立したテスト**: 既存履歴や選択結果に誤ったモデル名が含まれるケースを作成し、表示および保存時に正規化されることを確認する。

**受け入れシナリオ**:
1. **前提条件** Claudeモデル名に誤表記（例: 末尾の余分な文字）が含まれる履歴が存在、**操作** Quick Startを表示、**期待結果** 正規化されたモデル名が表示される
2. **前提条件** モデル選択後に選択サマリが表示される、**操作** サマリを確認、**期待結果** 正規化されたモデル名が表示される

---

### ユーザーストーリー 9 - エージェントインストール状態の視覚的確認 (優先度: P2)

開発者がgwtを起動したとき、上部ステータスバーで各コーディングエージェント（Claude Code、Codex、Gemini、OpenCode）のインストール状態を即座に確認できる。

**この優先度の理由**: エージェントの起動方法（ローカルインストール版かbunx経由か）を事前に把握することで、起動時間の見通しが立ち、問題発生時のトラブルシューティングが容易になる。

**独立したテスト**: gwtを起動し、Header下部のTools行に各エージェントの状態（installed/bunx）が表示されることを確認すれば検証できる。

**受け入れシナリオ**:
1. **前提条件** Claude Codeがグローバルインストール済み（`~/.bun/bin/claude`等に存在、バージョン1.0.3）、**操作** gwtを起動、**期待結果** ステータスに「Claude: v1.0.3」（緑色）と表示される
2. **前提条件** Codexが未インストール（bunx経由で利用可能）、**操作** gwtを起動、**期待結果** ステータスに「Codex: bunx」（黄色）と表示される
3. **前提条件** Geminiが未インストール、**操作** gwtを起動、**期待結果** ステータスに「Gemini: bunx」（黄色）と表示される
4. **前提条件** OpenCodeが未インストール、**操作** gwtを起動、**期待結果** ステータスに「OpenCode: bunx」（黄色）と表示される
5. **前提条件** エージェントがインストール済みだがバージョン取得に失敗、**操作** gwtを起動、**期待結果** ステータスに「エージェント名: installed」（緑色）と表示される

---

### エッジケース

- コーディングエージェントのコマンドがPATHに存在しない場合、bunx経由でのフォールバック起動を試み、それも失敗した場合は適切なエラーメッセージとトラブルシューティング情報を表示する
- WSL環境で非インタラクティブシェル経由の`which`がPATHを正しく参照できない場合、既知のインストールパス（`~/.bun/bin/`、`~/.local/bin/`等）をフォールバックで確認する
- worktreeパスが存在しない場合、起動前にエラーを返し、エージェントは起動しない
- `git worktree list` の情報と実際のWorktreeのチェックアウトブランチが一致しない場合は再利用せず警告する
- 既存履歴に誤ったモデル名が保存されている場合は正規化された表記で表示する
- Windows環境でのエラー発生時は、プラットフォーム固有のトラブルシューティングメッセージを表示する
- Claude CodeのChrome拡張機能統合が未対応の環境（例: WSL）では`--chrome`を付与せずに起動し、警告を表示する
- 環境変数に同じキーが共有envとエージェント固有envの両方に存在する場合、エージェント固有の環境変数が優先される
- rootユーザーでClaude Codeを起動する場合、Docker/サンドボックス環境として検出され、追加の警告が表示される

## 要件 *(必須)*

### 機能要件

#### 共通要件

- **FR-001**: 各コーディングエージェント起動関数は、worktreeパスの存在を確認し、存在しない場合はエラーを返さ**なければならない**
- **FR-002**: 各コーディングエージェントは、ローカルにインストールされたコマンドを優先的に使用し、見つからない場合はbunx経由でのフォールバック起動を試み**なければならない**
- **FR-003**: 各コーディングエージェントは、起動モード（normal/continue/resume）に応じた適切なコマンドライン引数を渡さ**なければならない**
- **FR-004**: 各コーディングエージェントは、権限スキップモードが有効な場合、エージェント固有の自動承認フラグを渡さ**なければならない**
- **FR-005**: 各コーディングエージェントは、モデル選択オプションが指定された場合、適切な`--model`引数を渡さ**なければならない**
- **FR-006**: 各コーディングエージェントは、追加引数（extraArgs）が指定された場合、それらをコマンドライン引数に追加**しなければならない**
- **FR-007**: 各コーディングエージェントは、環境変数オーバーライドが指定された場合、プロセス環境変数にマージ**しなければならない**
- **FR-008**: 各コーディングエージェントは、起動時に実際に渡されるコマンドライン引数をログに表示**しなければならない**
- **FR-009**: Quick Startは、選択中のブランチ／ワークツリーごとにエージェント別最新セッションを表示し、他ブランチのセッションIDを混在させてはならない
- **FR-010**: Quick Startは、履歴が古い場合でもワークツリー内のセッションファイルを走査し、有効な`session_id`を持つ最新ファイルを優先して表示しなければならない
- **FR-011**: Quick Startは、Reasoning設定を持たないエージェント（Claude Code / Gemini / OpenCode）ではReasoning表示を出してはならない
- **FR-012**: 各コーディングエージェントは、起動プロセスのstdin/stdout/stderrを親ターミナル（TTY）へ接続し、色表示・ターミナル幅・インタラクティブ描画が失われないように**しなければならない**
- **FR-013**: コーディングエージェント選択画面は、未サポートのビルトインエージェントを選択肢として表示してはならない
- **FR-014**: Quick Start の履歴に未サポートのエージェントが含まれる場合、ユーザーに未サポートである旨を明示し、選択されても起動処理を中断しなければならない
- **FR-015**: 既存Worktreeを再利用する際は、選択ブランチとWorktreeのチェックアウトブランチが一致していることを検証し、一致しない場合は再利用せず警告を表示しなければならない
- **FR-016**: 選択サマリやQuick Startで表示されるモデル名は公式の識別子に正規化し、タイプミスや表記揺れを含むべきではない
- **FR-017**: gwtは起動時に全ビルトインコーディングエージェントのインストール状態を検出し、アプリケーション状態にキャッシュ**しなければならない**
- **FR-018**: エージェント検出は`which`/`where`を試行し、失敗時は既知のインストールパス（`~/.bun/bin/`、`~/.local/bin/`、`/usr/local/bin/`等）をフォールバックで確認**しなければならない**
- **FR-019**: エージェント状態はHeader下部の専用行に「エージェント名: 状態」形式で表示**しなければならない**（状態: バージョン番号 | `installed` | `bunx`）
- **FR-020**: ブランチ選択時やエージェント起動時は、起動時にキャッシュした検出結果を再利用し、再検出を行っては**ならない**
- **FR-021**: エージェント状態の表示は状態に応じて色分け**しなければならない**（バージョン番号/`installed`: 緑、`bunx`: 黄色）
- **FR-022**: インストール済みエージェントは `--version` でバージョン番号を取得し、「v{バージョン}」形式で表示**しなければならない**。取得失敗時は「installed」にフォールバック**しなければならない**
- **FR-023**: バージョン取得は3秒でタイムアウトし、起動時間への影響を最小化**しなければならない**

#### Claude Code固有要件

- **FR-101**: Claude Codeは、権限スキップモード時に`--dangerously-skip-permissions`フラグと`IS_SANDBOX=1`環境変数を設定**しなければならない**
- **FR-102**: Claude Codeは、継続モード時に`-c`フラグを、再開モード時に`-r`フラグを渡さ**なければならない**
- **FR-103**: Claude Codeは、起動後に生成されるセッションファイル群から最終更新順に`session_id`を抽出し、agent等の`session_id`を持たないファイルで上書きしてはならない
- **FR-104**: Claude Codeは、Chrome拡張機能統合が未対応の環境（例: WSL）では`--chrome`を付与せず、警告を表示して起動を継続**しなければならない**
- **FR-105**: Claude Codeのローカルコマンドが存在しない場合、OSに関わらず`bunx`で起動する

#### Codex固有要件

- **FR-201**: Codexは、デフォルト引数として`--enable web_search_request`を含め**なければならない**
- **FR-202**: Codexは、デフォルト引数として`--enable skills`を含め、スキル機能を有効化**しなければならない**
- **FR-203**: Codexは、デフォルト引数として`--sandbox workspace-write`を含め**なければならない**
- **FR-204**: Codexは、デフォルト引数として推論設定（`-c model_reasoning_effort`、`-c model_reasoning_summaries`）を含め**なければならない**
- **FR-205**: Codexは、継続モード時に`resume --last`を、再開モード時に`resume`を渡さ**なければならない**
- **FR-206**: Codexは、権限スキップモード時に`--yolo`フラグを渡さ**なければならない**
- **FR-207**: Codexは、起動開始時刻近傍のセッションファイルを優先して`sessionId`を記録し、他ブランチのセッションを誤って再開してはならない
- **FR-208**: Codexは、起動完了後に取得可能な最新セッションIDを保存時に必ず再解決し、履歴より新しいIDがある場合はそれを使用しなければならない
- **FR-209**: Codexは、モデル選択肢に`gpt-5.2`を含め、選択時に`--model=gpt-5.2`を渡し、推論レベルとして`Extra high`（xhigh）を選択可能にしなければならない

#### Gemini固有要件

- **FR-301**: Geminiは、継続/再開モード時に`-r latest`フラグを渡さ**なければならない**
- **FR-302**: Geminiは、権限スキップモード時に`-y`フラグを渡さ**なければならない**

#### OpenCode固有要件

- **FR-401**: OpenCodeは、継続モード時に`-c`フラグを渡さ**なければならない**
- **FR-402**: OpenCodeは、再開モード時に`-s [sessionId]`フラグを渡さ**なければならない**
- **FR-403**: OpenCodeは、モデル選択オプションが指定された場合、`-m provider/model`形式で引数を渡さ**なければならない**
- **FR-404**: OpenCodeは、セッションファイルを`~/.local/share/opencode/`から検索**しなければならない**
- **FR-405**: OpenCodeは、現時点で権限スキップ用の公式フラグが未提供のため、権限スキップモードでも追加フラグなしで起動**しなければならない**

### 主要エンティティ

- **CodingAgentLaunchOptions**: コーディングエージェント起動時のオプション。skipPermissions（真偽値）、mode（"normal" | "continue" | "resume"）、extraArgs（文字列配列）、envOverrides（キー・値のマップ）、model（文字列）を含む
- **CodingAgentError**: 各コーディングエージェント起動時のエラークラス。ClaudeError、CodexError、GeminiError、OpenCodeErrorとして実装され、message（文字列）、cause（unknown）を含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者はコーディングエージェント選択画面から3秒以内にコーディングエージェントを起動できる
- **SC-002**: 各コーディングエージェントの起動時間はローカルコマンド使用時2秒以内、bunxフォールバック時10秒以内である
- **SC-003**: コーディングエージェント起動エラーの90%以上で、ユーザーが問題を自己解決できるトラブルシューティング情報が提供される
- **SC-004**: セッション継続/再開機能を使用した場合、95%以上の確率で過去のセッションにアクセスできる
- **SC-005**: 開発者の95%以上が、既存のコーディングエージェントと同じ操作性で全てのエージェントを利用できる
- **SC-006**: 選択ブランチと異なるWorktreeが再利用されないことを回帰テストで確認できる
- **SC-007**: Claudeモデル名の誤表記が選択サマリおよびQuick Startに表示されないことを確認できる

## 制約と仮定 *(該当する場合)*

### 制約

- bunまたはbunxが環境にインストールされている必要がある（ローカルコマンドがない場合のフォールバック用）
- 各コーディングエージェントのnpmパッケージがnpmレジストリで利用可能である必要がある
- ターミナル環境（TTY）で実行される必要がある

### 仮定

- ユーザーは各コーディングエージェントの基本的な使い方を理解している
- 各コーディングエージェントのCLIオプションは公式ドキュメントに従って動作する
- ローカルにインストールされたコマンドがbunxよりも高速に起動する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 各コーディングエージェント本体の機能拡張やバグ修正
- カスタムエージェントの起動オプション管理（ビルトインエージェントのみ対象）
- コーディングエージェントの設定ファイルの自動生成や管理
- Web UI経由でのコーディングエージェント起動

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 権限スキップモード（--yolo、--dangerously-skip-permissions、-y）は、すべてのアクションを自動承認するため、本番環境や重要なデータを扱う環境では慎重に使用する必要がある
- 環境変数に機密情報（APIキー、アクセストークンなど）が含まれる可能性があるため、環境変数のマージ順序を適切に管理する必要がある
- Claude Codeの権限スキップモードでは、IS_SANDBOX=1環境変数も設定され、サンドボックス環境として動作する

## 依存関係 *(該当する場合)*

- @anthropic-ai/claude-code: Claude Code CLI
- @openai/codex: OpenAI Codex CLI
- @google/gemini-cli: Google Gemini CLI
- opencode-ai: OpenCode
- bun/bunx: パッケージ実行環境
- execa: プロセス実行ライブラリ

## 参考資料 *(該当する場合)*

- [OpenAI Codex CLI ドキュメント](https://developers.openai.com/codex/cli/)
- [Claude Code ドキュメント](https://claude.ai/docs)
- [Gemini CLI ドキュメント](https://ai.google.dev/gemini-api/docs/cli)
- [OpenCode ドキュメント](https://opencode.ai/docs/cli/)
- [既存実装: src/codex.ts](../../src/codex.ts)
- [既存実装: src/claude.ts](../../src/claude.ts)
- [既存実装: src/gemini.ts](../../src/gemini.ts)
