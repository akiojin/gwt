# 機能仕様: AIツール起動機能

**仕様ID**: `SPEC-3b0ed29b`
**作成日**: 2025-12-06
**ステータス**: ドラフト
**入力**: ユーザー説明: "AIツール起動機能: gwtから各AIツール（Claude Code、Codex、Gemini、Qwen）を起動する機能。各ツールは独自のデフォルト引数を持ち、モード（新規/継続/再開）に応じた引数、権限スキップオプション、およびCodex CLIのスキル機能（--enable skills）などの機能拡張オプションを提供する。"

## 概要

gwtから各AIツール（Claude Code、Codex、Gemini、Qwen）を起動する機能。各ツールは独自のデフォルト引数を持ち、モード（新規/継続/再開）に応じた引数、権限スキップオプション、およびツール固有の機能拡張オプションを提供する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - AIツールをデフォルト設定で起動 (優先度: P1)

開発者がgwtからAIツールを選択して起動する際、各ツールに最適化されたデフォルト引数が自動的に適用され、追加設定なしですぐに作業を開始できる。

**この優先度の理由**: 開発者が最小限の操作でAIツールを起動できることがgwtの基本価値であり、デフォルト設定の自動適用はユーザー体験の根幹となる。

**独立したテスト**: 各AIツール（Claude Code、Codex、Gemini、Qwen）を新規セッションで起動し、期待されるデフォルト引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** gwtが起動しブランチが選択されている、**操作** AIツール選択画面でCodexを選択して起動、**期待結果** Codexが`--enable web_search_request`、`--enable skills`、`--sandbox workspace-write`などのデフォルト引数付きで起動する
2. **前提条件** gwtが起動しブランチが選択されている、**操作** AIツール選択画面でClaude Codeを選択して起動、**期待結果** Claude Codeがデフォルト設定で起動し、モデル選択が可能
3. **前提条件** gwtが起動しブランチが選択されている、**操作** AIツール選択画面でGeminiを選択して起動、**期待結果** Gemini CLIがデフォルト設定で起動する
4. **前提条件** gwtが起動しブランチが選択されている、**操作** AIツール選択画面でQwenを選択して起動、**期待結果** Qwen CLIが`--checkpointing`オプション付きで起動する

---

### ユーザーストーリー 2 - セッションの継続と再開 (優先度: P1)

開発者が以前の作業セッションを継続または再開したい場合、各AIツールに適切なモード引数が渡され、過去の会話履歴にアクセスできる。

**この優先度の理由**: セッションの継続性は開発者の作業効率に直結し、コンテキストを失わずに作業を再開できることが重要。

**独立したテスト**: 各AIツールを「継続」または「再開」モードで起動し、適切なコマンドライン引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** 過去のCodexセッションが存在、**操作** 「Continue」モードでCodexを起動、**期待結果** `resume --last`引数が渡され、最後のセッションが再開される
2. **前提条件** 過去のClaude Codeセッションが存在、**操作** 「Continue」モードでClaude Codeを起動、**期待結果** `-c`引数が渡され、最新の会話が継続される
3. **前提条件** 過去のGeminiセッションが存在、**操作** 「Continue」モードでGeminiを起動、**期待結果** `-r latest`引数が渡され、最新セッションが再開される
4. **前提条件** 過去のQwenセッションが存在、**操作** 「Continue」モードでQwenを起動、**期待結果** Qwenが起動し、ユーザーは`/chat resume`コマンドでセッションを再開できる

---

### ユーザーストーリー 3 - 権限スキップモードでの起動 (優先度: P2)

開発者が信頼された環境（自動化スクリプト、Docker環境など）でAIツールを使用する際、権限確認をスキップして全てのアクションを自動承認できる。

**この優先度の理由**: 自動化やCI/CD環境での利用に有用だが、通常の対話的な開発では必須ではない。セキュリティリスクを伴うため、意識的な選択が必要。

**独立したテスト**: 各AIツールを権限スキップモードで起動し、適切なフラグ（--yolo、--dangerously-skip-permissions、-y）がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** 権限スキップモードが有効、**操作** Codexを起動、**期待結果** `--yolo`フラグが渡され、自動承認モードで起動する
2. **前提条件** 権限スキップモードが有効、**操作** Claude Codeを起動、**期待結果** `--dangerously-skip-permissions`フラグと`IS_SANDBOX=1`環境変数が設定される
3. **前提条件** 権限スキップモードが有効、**操作** Geminiを起動、**期待結果** `-y`フラグが渡され、自動承認モードで起動する
4. **前提条件** 権限スキップモードが有効、**操作** Qwenを起動、**期待結果** `--yolo`フラグが渡され、自動承認モードで起動する

---

### ユーザーストーリー 4 - Codex CLIのスキル機能を利用 (優先度: P1)

開発者がCodex CLIを起動する際、スキル機能が自動的に有効化され、`~/.codex/skills/`に配置したカスタムスキルを利用できる。

**この優先度の理由**: スキル機能はCodex CLIの重要な拡張機能であり、開発者の生産性を向上させる。デフォルトで有効化することで、追加設定なしでスキルを活用できる。

**独立したテスト**: Codexを起動し、`--enable skills`引数がプロセスに渡されることを確認すれば検証できる。スキルファイルが存在する場合、Codex CLI内でスキルが利用可能であることを確認できる。

**受け入れシナリオ**:

1. **前提条件** ~/.codex/skills/にスキルファイルが存在、**操作** gwtからCodexを起動、**期待結果** `--enable skills`引数が渡され、スキルがCodex CLI内で利用可能
2. **前提条件** スキルファイルが存在しない、**操作** gwtからCodexを起動、**期待結果** `--enable skills`引数が渡されるが、スキルは利用不可（エラーにはならない）

---

### ユーザーストーリー 5 - モデル選択オプション (優先度: P2)

開発者が特定のAIモデルを選択してツールを起動したい場合、選択したモデルがコマンドライン引数として渡される。

**この優先度の理由**: モデル選択は高度なユースケースであり、デフォルトモデルで十分な場合が多いが、特定のタスクに最適なモデルを選択できることは価値がある。

**独立したテスト**: 各AIツールをモデル指定付きで起動し、適切な`--model`引数がプロセスに渡されることを確認すれば検証できる。

**受け入れシナリオ**:

1. **前提条件** モデル選択画面でgpt-5.1-codex-maxを選択、**操作** Codexを起動、**期待結果** `--model=gpt-5.1-codex-max`引数が渡される
2. **前提条件** モデル選択画面でsonnetを選択、**操作** Claude Codeを起動、**期待結果** `--model sonnet`引数が渡される
3. **前提条件** モデル選択なし（デフォルト）、**操作** Codexを起動、**期待結果** `--model=gpt-5.1-codex`（デフォルトモデル）が使用される

---

### エッジケース

- AIツールのコマンドがPATHに存在しない場合、bunx経由でのフォールバック起動を試み、それも失敗した場合は適切なエラーメッセージとトラブルシューティング情報を表示する
- worktreeパスが存在しない場合、起動前にエラーを返し、ツールは起動しない
- Windows環境でのエラー発生時は、プラットフォーム固有のトラブルシューティングメッセージを表示する
- 環境変数に同じキーが共有envとツール固有envの両方に存在する場合、ツール固有の環境変数が優先される
- rootユーザーでClaude Codeを起動する場合、Docker/サンドボックス環境として検出され、追加の警告が表示される

## 要件 *(必須)*

### 機能要件

#### 共通要件

- **FR-001**: 各AIツール起動関数は、worktreeパスの存在を確認し、存在しない場合はエラーを返さ**なければならない**
- **FR-002**: 各AIツールは、ローカルにインストールされたコマンドを優先的に使用し、見つからない場合はbunx経由でのフォールバック起動を試み**なければならない**
- **FR-003**: 各AIツールは、起動モード（normal/continue/resume）に応じた適切なコマンドライン引数を渡さ**なければならない**
- **FR-004**: 各AIツールは、権限スキップモードが有効な場合、ツール固有の自動承認フラグを渡さ**なければならない**
- **FR-005**: 各AIツールは、モデル選択オプションが指定された場合、適切な`--model`引数を渡さ**なければならない**
- **FR-006**: 各AIツールは、追加引数（extraArgs）が指定された場合、それらをコマンドライン引数に追加**しなければならない**
- **FR-007**: 各AIツールは、環境変数オーバーライドが指定された場合、プロセス環境変数にマージ**しなければならない**
- **FR-008**: 各AIツールは、起動時に実際に渡されるコマンドライン引数をログに表示**しなければならない**

#### Claude Code固有要件

- **FR-101**: Claude Codeは、権限スキップモード時に`--dangerously-skip-permissions`フラグと`IS_SANDBOX=1`環境変数を設定**しなければならない**
- **FR-102**: Claude Codeは、継続モード時に`-c`フラグを、再開モード時に`-r`フラグを渡さ**なければならない**

#### Codex固有要件

- **FR-201**: Codexは、デフォルト引数として`--enable web_search_request`を含め**なければならない**
- **FR-202**: Codexは、デフォルト引数として`--enable skills`を含め、スキル機能を有効化**しなければならない**
- **FR-203**: Codexは、デフォルト引数として`--sandbox workspace-write`を含め**なければならない**
- **FR-204**: Codexは、デフォルト引数として推論設定（`-c model_reasoning_effort`、`-c model_reasoning_summaries`）を含め**なければならない**
- **FR-205**: Codexは、継続モード時に`resume --last`を、再開モード時に`resume`を渡さ**なければならない**
- **FR-206**: Codexは、権限スキップモード時に`--yolo`フラグを渡さ**なければならない**

#### Gemini固有要件

- **FR-301**: Geminiは、継続/再開モード時に`-r latest`フラグを渡さ**なければならない**
- **FR-302**: Geminiは、権限スキップモード時に`-y`フラグを渡さ**なければならない**

#### Qwen固有要件

- **FR-401**: Qwenは、デフォルト引数として`--checkpointing`を含め、セッション管理機能を有効化**しなければならない**
- **FR-402**: Qwenは、権限スキップモード時に`--yolo`フラグを渡さ**なければならない**

### 主要エンティティ

- **AIToolLaunchOptions**: AIツール起動時のオプション。skipPermissions（真偽値）、mode（"normal" | "continue" | "resume"）、extraArgs（文字列配列）、envOverrides（キー・値のマップ）、model（文字列）を含む
- **AIToolError**: 各AIツール起動時のエラークラス。ClaudeError、CodexError、GeminiError、QwenErrorとして実装され、message（文字列）、cause（unknown）を含む

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者はAIツール選択画面から3秒以内にAIツールを起動できる
- **SC-002**: 各AIツールの起動時間はローカルコマンド使用時2秒以内、bunxフォールバック時10秒以内である
- **SC-003**: AIツール起動エラーの90%以上で、ユーザーが問題を自己解決できるトラブルシューティング情報が提供される
- **SC-004**: セッション継続/再開機能を使用した場合、95%以上の確率で過去のセッションにアクセスできる
- **SC-005**: 開発者の95%以上が、既存のAIツールと同じ操作性で全てのツールを利用できる

## 制約と仮定 *(該当する場合)*

### 制約

- bunまたはbunxが環境にインストールされている必要がある（ローカルコマンドがない場合のフォールバック用）
- 各AIツールのnpmパッケージがnpmレジストリで利用可能である必要がある
- ターミナル環境（TTY）で実行される必要がある

### 仮定

- ユーザーは各AIツールの基本的な使い方を理解している
- 各AIツールのCLIオプションは公式ドキュメントに従って動作する
- ローカルにインストールされたコマンドがbunxよりも高速に起動する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- 各AIツール本体の機能拡張やバグ修正
- カスタムツールの起動オプション管理（ビルトインツールのみ対象）
- AIツールの設定ファイルの自動生成や管理
- Web UI経由でのAIツール起動

## セキュリティとプライバシーの考慮事項 *(該当する場合)*

- 権限スキップモード（--yolo、--dangerously-skip-permissions、-y）は、すべてのアクションを自動承認するため、本番環境や重要なデータを扱う環境では慎重に使用する必要がある
- 環境変数に機密情報（APIキー、アクセストークンなど）が含まれる可能性があるため、環境変数のマージ順序を適切に管理する必要がある
- Claude Codeの権限スキップモードでは、IS_SANDBOX=1環境変数も設定され、サンドボックス環境として動作する

## 依存関係 *(該当する場合)*

- @anthropic-ai/claude-code: Claude Code CLI
- @openai/codex: OpenAI Codex CLI
- @google/gemini-cli: Google Gemini CLI
- @qwen-code/qwen-code: Qwen CLI
- bun/bunx: パッケージ実行環境
- execa: プロセス実行ライブラリ

## 参考資料 *(該当する場合)*

- [OpenAI Codex CLI ドキュメント](https://developers.openai.com/codex/cli/)
- [Claude Code ドキュメント](https://claude.ai/docs)
- [Gemini CLI ドキュメント](https://ai.google.dev/gemini-api/docs/cli)
- [Qwen Code ドキュメント](https://qwenlm.github.io/qwen-code-docs/)
- [既存実装: src/codex.ts](../../src/codex.ts)
- [既存実装: src/claude.ts](../../src/claude.ts)
- [既存実装: src/gemini.ts](../../src/gemini.ts)
- [既存実装: src/qwen.ts](../../src/qwen.ts)
