# 実装計画: コーディングエージェント起動の互換性整備（起動準備の非同期化/単一パイプライン）

**仕様ID**: `SPEC-3b0ed29b` | **日付**: 2026-01-20 | **仕様書**: `specs/SPEC-3b0ed29b/spec.md`
**概要**: Codex/Claude/Gemini/OpenCodeの起動フローにおける準備処理を非同期化し、シングル/ tmux モードで共通の起動準備パイプラインを使う。進捗はTUIのステータス表示領域へ英語で表示する。

## 1. 前提・対象範囲

- Rust 実装の `gwt-cli` / `gwt-core` が対象。
- TTYの挙動を維持し、CLI出力は英語/ASCIIのみ。
- セッション保存やQuick Startの既存挙動を保持する。

## 2. 成功基準との対応

| 成功基準 | 計画での対応 |
| --- | --- |
| SC-003 | 起動失敗時のログ出力とユーザー向けメッセージを追加する |
| SC-008 | 異常終了を検知し、成功扱いにしない |
| SC-009 | OpenCodeのモデル選択にデフォルト/任意入力を常に提示する |
| SC-010 | 起動開始メッセージの即時表示を追加する |
| SC-011 | 終了復帰の待機遅延を1秒以内に抑える |
| SC-012 | 起動準備の進捗をTUI上に即時表示し、入力が応答することを保証する |
| SC-013 | 依存インストールを含む準備パイプラインをシングル/ tmux で統一する |

## 3. アーキテクチャ方針

1. Codexの権限スキップはバージョン判定ヘルパーで `--yolo` / `--dangerously-bypass-approvals-and-sandbox` を切替する。
2. 起動ログは整形ヘルパーで統一し、Working directory/Model/Reasoning/Mode/Skip/Args/Version/Execution method を出力する。
3. 起動終了時は exit classification (success/interrupted/failure) を行い、TUIへの復帰コンテキストに変換する。
4. OpenCodeモデルは固定リストに default/custom を保持し、空リストを許さない。
5. Codexの権限スキップ時はスキップフラグが後勝ちになるように引数順を調整し、Claude Codeのスキップ時に`IS_SANDBOX=1`を必ず付与する。
6. 起動開始時は依存インストール前に英語のステータス行を出力し、空白待機を避ける。
7. セッション更新のバックグラウンド待機は停止シグナルで即時解除できるようにする。
8. 起動準備（Worktree解決/依存インストール/コマンド組み立て）はバックグラウンドタスクとして実行し、TUIはメッセージ受信で進捗表示を更新する。
9. シングル/ tmux の分岐は「最終的な起動実行」だけに限定し、準備パイプラインは共通化する。

## 4. 実装ステップ (ハイレベル ToDo)

1. Codex権限スキップの互換フラグ判定とユニットテストを追加する。
2. 起動ログ整形ヘルパーを追加し、ログ出力を統一する。
3. 終了判定の分類とエラー表示/一覧復帰を実装する。
4. OpenCodeのモデル選択デフォルト/カスタム入力を明示し、ユニットテストで空リストを防止する。
5. Codexデフォルトモデル/モデル選択肢を仕様に合わせ、権限スキップの引数順序と`IS_SANDBOX`付与を修正する。
6. 起動開始メッセージを依存インストール前に表示し、終了復帰の待機遅延を解消する。
7. 起動準備パイプラインを抽出し、シングル/ tmux の両方から同じ関数を利用する。
8. 起動準備の進捗をTUIステータス表示領域に反映する。
9. tmux モードでも依存インストールをパイプライン内で実行する（有効時）。
10. `cargo build --release` でビルド確認する。

## 5. テスト戦略

- ユニットテスト: 起動準備パイプラインのステップ順序、tmux/シングルで同一準備が使われること、進捗表示更新、起動開始メッセージ、終了復帰遅延の抑制。
- ビルド検証: `cargo build --release`。

## 6. リスクと軽減策

| リスク | 影響 | 軽減策 |
| --- | --- | --- |
| OSによる終了コード/シグナル差 | 異常終了の誤判定 | exit code + signal の併用判定にする |
| Codex CLI のバージョン取得失敗 | スキップフラグ誤選択 | 判定不能時は新フラグを優先する |
| バックグラウンド準備で競合が起きる | 二重起動/表示混乱 | 進捗を1件に限定し、同一ブランチの再起動を抑止する |

## 7. 次のステップ

1. `specs/SPEC-3b0ed29b/tasks.md` を更新
2. 必要なテストを追加・実行
