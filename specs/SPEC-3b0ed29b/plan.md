# 実装計画: コーディングエージェント起動の異常終了可視化とOpenCodeモデル選択

**仕様ID**: `SPEC-3b0ed29b` | **日付**: 2026-01-10 | **仕様書**: `specs/SPEC-3b0ed29b/spec.md`
**入力**: `specs/SPEC-3b0ed29b/spec.md` からの機能仕様

## 概要

- 起動直後の異常終了を検知し、成功扱いせずにエラー可視化とログ記録を行う。
- OpenCodeのモデル選択を空にせず、デフォルト選択または任意入力で進行可能にする。
- 既存の起動フロー/セッション保存/ログ出力との整合を保つ。

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.8 + Bun >= 1.0
**主要な依存関係**: execa, node-pty, @opentui/solid, chalk
**ストレージ**: ファイル（セッションファイル、ログ JSONL）
**テスト**: bun test（Vitestベース）
**ターゲットプラットフォーム**: Linux/macOS/Windows Terminal
**プロジェクトタイプ**: 単一（CLI + Web）
**パフォーマンス目標**: 起動フローの体感遅延を増やさない
**制約**: 既存のTTY体験を崩さない、TDD必須
**スケール/範囲**: コーディングエージェント起動フローに限定

## 原則チェック

- シンプルさ優先、既存ファイルの改修を優先
- TDD必須（テスト作成 → 承認 → 実装）
- 品質ゲート（lint/format/commitlint）を遵守

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-3b0ed29b/
├── plan.md
├── spec.md
└── tasks.md
```

### ソースコード（リポジトリルート）

```text
src/
├── claude.ts
├── codex.ts
├── launcher.ts
├── logging/
└── cli/ui/

tests/
├── unit/
└── logging/
```

## フェーズ0: 調査

- 起動処理の共通点は `launcher.ts` と各エージェント起動関数に集約されていることを確認済み
- モデル選択は UI 側のモデル一覧定義に依存していることを確認済み

## フェーズ1: 設計

- **異常終了判定**: 非ゼロ終了コードまたは想定外シグナルを異常終了として扱い、成功完了表示を抑止する
- **エラーログ**: エージェントID・バージョン・終了コード/シグナル・経過時間を構造化ログへ記録する
- **OpenCodeモデル選択**: モデル一覧が空でも「Default (Auto)」を必ず提示し、任意入力が可能な場合は provider/model を保持する
- **UI遷移**: モデル選択が空の場合でも次ステップへ進めることを保証する

## 実装戦略

1. **P1**: 起動直後の異常終了を検知してエラー表示・ログ記録
2. **P1**: OpenCodeモデル選択の空状態を解消（デフォルト/任意入力）
3. **P2**: 既存のセッション保存・履歴表示との整合確認

## テスト戦略

- **ユニットテスト**: 異常終了判定とログ記録の分岐
- **UIテスト**: OpenCode選択時にモデル一覧が空にならないこと
- **回帰テスト**: 既存エージェントの起動フローが影響を受けないこと

## リスクと緩和策

### 技術的リスク

1. **TTY体験の毀損**: 追加の検知で起動がブロックされる
   - **緩和策**: 異常終了判定は終了後の処理に限定する

2. **誤検知**: ユーザー中断と異常終了の判定が混同される
   - **緩和策**: 中断シグナルは警告扱いに留める

### 依存関係リスク

1. **外部CLIの仕様変更**: 起動時の挙動が変わる
   - **緩和策**: エラーハンドリングを保守的にし、ログに詳細を残す

## 補足: Codex CLI skills フラグ互換

- Codex CLI v0.80.0+ では `--enable skills` が未知フラグとなるため、起動引数から除外する。
- v0.79.x 以前では `--enable skills` を付与してスキルを利用可能にする。
- CLI/TUI起動とWeb UI起動の両方で同じ判定を適用する。

### 対象ファイル

- `src/shared/codingAgentConstants.ts`: 互換判定ヘルパー追加
- `src/codex.ts`: バージョンに応じたフラグ付与
- `src/services/codingAgentResolver.ts`: installed/bunxでの付与切り替え
- `tests/unit/codex.test.ts`
- `tests/unit/codingAgentResolver.test.ts`
- `tests/unit/services/codingAgentResolver.test.ts`

### 互換テスト

- v0.80.0+ (latest) では `--enable skills` が含まれないこと
- installed v0.79.x では `--enable skills` が含まれること
- 既存の引数順序と起動経路が維持されること

## 次のステップ

1. ⏭️ `specs/SPEC-3b0ed29b/tasks.md` を更新
2. ⏭️ TDDタスクの承認後に実装着手
