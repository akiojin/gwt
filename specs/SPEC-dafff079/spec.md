# 機能仕様: 環境変数プロファイル機能

**仕様ID**: `SPEC-dafff079`
**作成日**: 2025-12-15
**ステータス**: 実装済み
**入力**: ユーザー説明: "環境変数プロファイル機能：AIツール起動時に環境変数を適用"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - プロファイル切り替えによるAIツール起動 (優先度: P1)

開発者として、異なる環境（開発/本番/ステージング）で異なるAPIキーやデバッグ設定を使用してAIツールを起動したい。gwt内でプロファイルを選択し、そのプロファイルの環境変数がAIツール（Claude Code、Codex等）に自動的に適用されるようにしたい。

**この優先度の理由**: これがコア機能であり、環境変数プロファイル機能の主目的である。この機能なしでは、ユーザーは手動で環境変数を設定する必要があり、複数環境での開発効率が低下する。

**独立したテスト**: プロファイルを選択してAIツールを起動し、AIツール内で環境変数が正しく設定されていることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** プロファイル「development」に`ANTHROPIC_API_KEY=sk-dev-xxx`が設定されている、**操作** ユーザーがプロファイル「development」を選択してClaude Codeを起動する、**期待結果** Claude Code内で`ANTHROPIC_API_KEY`が`sk-dev-xxx`に設定されている
2. **前提条件** プロファイル「production」に`DEBUG=false`が設定されている、**操作** ユーザーがプロファイル「production」に切り替えてAIツールを起動する、**期待結果** AIツール内で`DEBUG`が`false`に設定されている
3. **前提条件** OS環境変数に`ANTHROPIC_API_KEY=sk-os-xxx`が設定されており、プロファイルに`ANTHROPIC_API_KEY=sk-profile-xxx`が設定されている、**操作** ユーザーがそのプロファイルを選択してAIツールを起動する、**期待結果** AIツール内で`ANTHROPIC_API_KEY`がプロファイルの値`sk-profile-xxx`で上書きされている

---

### ユーザーストーリー 2 - 現在のプロファイル表示 (優先度: P1)

開発者として、現在どのプロファイルが選択されているかを常に把握したい。ブランチ一覧画面のヘッダーに現在のプロファイル名が表示されるようにしたい。

**この優先度の理由**: ユーザーが意図しないプロファイルでAIツールを起動するミスを防ぐために、現在のプロファイルを常に視認できることが重要である。

**独立したテスト**: gwtを起動してヘッダー部分を確認し、現在のプロファイル名が表示されることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** プロファイル「development」がアクティブである、**操作** gwtを起動してブランチ一覧画面を表示する、**期待結果** ヘッダーに「Profile: development」と表示される
2. **前提条件** プロファイルが選択されていない、**操作** gwtを起動してブランチ一覧画面を表示する、**期待結果** ヘッダーに「Profile: (none)」と表示される
3. **前提条件** プロファイル「staging」がアクティブである、**操作** プロファイルを「production」に切り替える、**期待結果** ヘッダーの表示が「Profile: production」に即座に更新される

---

### ユーザーストーリー 3 - プロファイルエディター（切り替え） (優先度: P2)

開発者として、ブランチ一覧画面から素早くプロファイルを切り替えたい。`p`キーを押すとプロファイルエディター画面が表示され、プロファイルを選択できるようにしたい。

**この優先度の理由**: プロファイル切り替えは頻繁に行う操作であり、素早くアクセスできることが開発効率に直結する。

**独立したテスト**: `p`キーを押してプロファイルエディター画面を表示し、プロファイルを選択して戻ることで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面が表示されている、**操作** `p`キーを押す、**期待結果** プロファイルエディター画面が表示される
2. **前提条件** プロファイルエディター画面でプロファイル「production」が選択されている、**操作** Enterキーを押す、**期待結果** 「production」がアクティブプロファイルになり、画面に反映される
3. **前提条件** プロファイルエディター画面が表示されている、**操作** Escキーを押す、**期待結果** ブランチ一覧画面に戻る

---

### ユーザーストーリー 4 - OS環境変数の表示と上書き確認 (優先度: P2)

開発者として、プロファイルの環境変数がOS環境変数をどのように上書きするかを確認したい。プロファイルエディター画面で、OS環境変数の一覧を表示し、プロファイルで上書きされるキーは変数名の色が変わるようにしたい。

**この優先度の理由**: 環境変数の競合を視覚的に確認できることで、意図しない上書きによる問題を事前に防ぐことができる。

**独立したテスト**: プロファイルエディター画面でOS環境変数一覧を表示し、上書きされるキーが黄色で表示されることを確認することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** OS環境変数に`ANTHROPIC_API_KEY`が設定されており、プロファイルにも`ANTHROPIC_API_KEY`が設定されている、**操作** プロファイルエディター画面でOS環境変数セクションを表示する、**期待結果** OS環境変数の`ANTHROPIC_API_KEY`の変数名が黄色で表示される
2. **前提条件** OS環境変数に`HOME`が設定されており、プロファイルには`HOME`が設定されていない、**操作** プロファイルエディター画面でOS環境変数セクションを表示する、**期待結果** OS環境変数の`HOME`の変数名は通常色で表示される
3. **前提条件** プロファイルエディター画面が表示されている、**操作** OS環境変数セクションで`j/k`キーでスクロールする、**期待結果** 大量のOS環境変数をスクロールして閲覧できる

---

### ユーザーストーリー 5 - プロファイルの作成・削除 (優先度: P3)

開発者として、新しいプロファイルを作成したり、不要なプロファイルを削除したい。

**この優先度の理由**: プロファイルの作成・削除は初期設定時や環境変更時に必要だが、日常的な操作ではないため、切り替え機能より優先度が低い。

**独立したテスト**: 新しいプロファイルを作成し、環境変数を追加し、その後削除することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** プロファイルエディター画面が表示されている、**操作** `n`キーを押して新しいプロファイル名「test-env」を入力する、**期待結果** 新しいプロファイル「test-env」が作成され、一覧に表示される
2. **前提条件** プロファイル「test-env」が選択されている、**操作** `d`キーを押して削除を確認する、**期待結果** プロファイル「test-env」が削除され、一覧から消える
3. **前提条件** アクティブプロファイル「development」が選択されている、**操作** `d`キーを押す、**期待結果** 「アクティブなプロファイルは削除できません」という警告が表示される

---

### ユーザーストーリー 6 - 環境変数の編集 (優先度: P3)

開発者として、プロファイル内の環境変数を追加・編集・削除したい。

**この優先度の理由**: 環境変数の編集は設定変更時に必要だが、一度設定したら頻繁には変更しないため、優先度が低い。

**独立したテスト**: プロファイル内の環境変数を追加・編集・削除することで完全にテストできる。

**受け入れシナリオ**:

1. **前提条件** プロファイル「development」の詳細画面が表示されている、**操作** `a`キーを押して新しい環境変数`MY_VAR=test`を追加する、**期待結果** 環境変数`MY_VAR`がプロファイルに追加される
2. **前提条件** 環境変数`MY_VAR`が選択されている、**操作** `e`キーを押して値を`new-value`に変更する、**期待結果** 環境変数`MY_VAR`の値が`new-value`に更新される
3. **前提条件** 環境変数`MY_VAR`が選択されている、**操作** `d`キーを押して削除を確認する、**期待結果** 環境変数`MY_VAR`がプロファイルから削除される

---

### エッジケース

- プロファイル設定ファイル（profiles.yaml）が存在しない場合、システムはデフォルト設定で初期化する
- プロファイル設定ファイルが不正なYAML形式の場合、エラーメッセージを表示してデフォルト設定にフォールバックする
- 存在しないプロファイル名が指定された場合、警告を表示してプロファイルなし（none）として扱う
- プロファイル名に空文字や特殊文字（英数字とハイフン以外）が入力された場合、バリデーションエラーを表示する
- プロファイルと`tools.json`の`env`フィールドで同じキーが定義されている場合、プロファイルの値が優先される
- 環境変数のマージ優先順位（後勝ち）: 1. OS環境変数（process.env）、2. tools.jsonのenvフィールド、3. profiles.yamlのアクティブプロファイル

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはYAML形式のプロファイル設定ファイル（`~/.gwt/profiles.yaml`）を読み書きでき**なければならない**
- **FR-002**: システムはプロファイル設定を永続化し、gwt再起動後も選択されたプロファイルを保持**しなければならない**
- **FR-003**: ユーザーは複数のプロファイルを作成・編集・削除でき**なければならない**
- **FR-004**: ユーザーはプロファイルを切り替えでき**なければならない**
- **FR-005**: システムはAIツール起動時に、選択されたプロファイルの環境変数を適用**しなければならない**
- **FR-006**: システムはブランチ一覧画面のヘッダーに現在のプロファイル名を表示**しなければならない**
- **FR-007**: プロファイルが未選択の場合、ヘッダーに「Profile: (none)」と表示**しなければならない**
- **FR-008**: ユーザーは`p`キーでプロファイルエディター画面にアクセスでき**なければならない**
- **FR-009**: システムはプロファイルエディター画面で全てのOS環境変数を表示**しなければならない**
- **FR-010**: システムはプロファイルで上書きされるOS環境変数のキー名を黄色で表示**しなければならない**
- **FR-011**: システムは大量のOS環境変数をスクロール可能なリストとして表示**しなければならない**
- **FR-012**: プロファイル名は英数字とハイフンのみを許可し、それ以外の文字はバリデーションエラーとして拒否**しなければならない**

### 主要エンティティ

- **プロファイル（Profile）**: 環境変数のセットを表す。表示名、説明（オプション）、環境変数のキーバリューペアを持つ
- **プロファイル設定（ProfilesConfig）**: 全プロファイルを管理する設定。バージョン、アクティブプロファイル名、プロファイルの辞書を持つ
- **環境変数（Environment Variable）**: キー（大文字英数字とアンダースコア）と値（文字列）のペア

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは3ステップ以内（`p`キー → プロファイル選択 → Enter）でプロファイルを切り替えられる
- **SC-002**: ユーザーは30秒以内に新しいプロファイルを作成し、環境変数を1つ以上追加できる
- **SC-003**: ヘッダーのプロファイル表示は、プロファイル切り替え後1秒以内に更新される
- **SC-004**: 100個以上のOS環境変数がある環境でも、スクロール操作が滑らかに動作する
- **SC-005**: ユーザーの90%が初回でプロファイル切り替え操作を正常に完了できる

## 制約と仮定

### 制約

- 既存の`tools.json`の`env`フィールドとの互換性を維持する必要がある
- 既存のgwt UIフレームワーク（Ink.js/React）を使用する必要がある
- 既存のショートカットキー（f、c、r、スペース）と競合してはならない

### 仮定

- ユーザーはターミナルで色付きテキストを表示できる環境を使用している
- ユーザーは基本的なキーボード操作（矢印キー、Enter、Esc）に慣れている
- プロファイル数は通常10個以下である

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- プロファイルの暗号化や機密情報の保護（環境変数の値は完全表示）
- プロファイルのインポート/エクスポート機能
- プロファイルのリモート同期（クラウド保存）
- ブランチごとのプロファイル自動切り替え
- 環境変数の値のバリデーション（形式チェック）

## セキュリティとプライバシーの考慮事項

- プロファイル設定ファイルにはAPIキーなどの機密情報が含まれる可能性があるため、ファイル権限を適切に設定する必要がある（推奨: 0600）
- プロファイルエディター画面では環境変数の値を完全表示するため、画面共有時などに注意が必要である

## 依存関係

- 既存のgwt設定管理システム（`~/.gwt/`ディレクトリ）
- 既存のAIツール起動フロー（`getSharedEnvironment()`関数）
- 既存のInk.js UIコンポーネント

## 参考資料

- [gwt README](https://github.com/akiojin/gwt)
- [実装計画ファイル](/root/.claude/plans/curious-orbiting-avalanche.md)
