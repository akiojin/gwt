# 実装計画: 環境変数プロファイル機能（Ratatui）

**仕様ID**: `SPEC-dafff079` | **日付**: 2026-01-15 | **仕様書**: `/specs/SPEC-dafff079/spec.md`
**入力**: `/specs/SPEC-dafff079/spec.md` からの機能仕様

## 概要

- Ratatui 版のプロファイルUIを完成させる（一覧/切替/作成/削除/環境変数編集）。
- 環境変数編集画面でOS環境変数とプロファイル環境変数を統合表示し、色分けで上書き/追加/OSのみを区別する。
- 既存の `profiles.yaml` を読み書きするロジックは流用し、UI から更新を行う。

## 技術コンテキスト

**言語/バージョン**: Rust（Stable）
**主要な依存関係**: `ratatui`, `crossterm`, `serde`, `serde_yaml`
**ストレージ**: `~/.gwt/profiles.yaml`
**テスト**: `cargo test -p gwt-cli`
**ターゲットプラットフォーム**: macOS / Linux / Windows（WSL/PowerShell）
**プロジェクトタイプ**: 単一（CLI + Ratatui）
**パフォーマンス目標**: OS環境変数が100件以上でもスクロールが重くならない
**制約**: Ratatuiのみ使用、ASCII表記、既存キーバインドと競合しない
**スケール/範囲**: プロファイル数は10件以下想定、環境変数は100件程度

## 原則チェック

- 原則ファイルはテンプレートのため、追加ゲートは設定しない。

## プロジェクト構造

### ドキュメント（この機能）

```text
specs/SPEC-dafff079/
├── plan.md              # このファイル
└── tasks.md             # 実装タスク一覧
```

### ソースコード（リポジトリルート）

```text
crates/gwt-cli/src/
├── tui/app.rs
├── tui/screens/environment.rs
├── tui/screens/profiles.rs
└── tui/screens/mod.rs
```

## 実装戦略

### 優先順位付け

1. **P1**: 既存の切替・表示は維持（破壊変更なし）
2. **P2**: OS環境変数の表示と上書きハイライト
3. **P3**: 作成/削除/環境変数の編集フロー

### UI方針

- `Profiles` 画面は一覧/切替に使用し、`Space` でアクティブ化、`Enter` で環境変数編集へ遷移する。`n/d` の追加操作をサポート。
- 環境変数編集画面は `n/Enter/d` で追加/編集/削除を行う。
- OS環境変数は同じリストに統合表示し、上書きは黄色、プロファイル追加のみは緑、OSのみは通常色で表示する。
- 上書き項目は `r` でOS値へリセットできる。
- OS環境変数は `d` で無効化し、赤色の取り消し線で表示する。
- 入力系は幅32文字のテキスト入力を標準とする。
- 入力モード中はショートカットを無効化し、文字入力を優先する。
- 環境変数の空値はプレースホルダーで表示するが、入力値としては保存しない。
- 新規環境変数作成時は Enter/Tab で値入力へフォーカス移動し、値入力中の Enter で確定する。
- 値は常時表示し、マスク表示は行わない。

## テスト戦略

- 既存のユニットテストは維持。
- 統合表示の色分け/スクロール/入力挙動のユニットテストを追加する。

## リスクと緩和策

1. **入力キーの残留**: 画面遷移時のキーが入力欄に混入する
   - **緩和策**: 初回入力の抑止フラグを導入する
2. **OS環境変数の描画負荷**: 大量の環境変数で描画が重くなる
   - **緩和策**: 表示範囲のみ描画するスクロールロジックを維持

## 次のステップ

1. ✅ plan.md 更新
2. ✅ tasks.md 更新
3. ✅ Ratatui 実装の反映
