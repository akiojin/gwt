# 機能仕様: Launch Agent のデフォルト設定保持（前回成功起動値）

**仕様ID**: `SPEC-552c5e74`
**作成日**: 2026-02-14
**更新日**: 2026-02-14
**ステータス**: ドラフト
**カテゴリ**: GUI
**依存仕様**:

- `SPEC-c6ba640a`（Agent Launch Form）
- `SPEC-90217e33`（archive: Quick Start / 起動オプション互換）

**入力**: ユーザー説明: "Launch Agent表示時のデフォルト設定を前回のLaunch成功時の値で保持する（Launch失敗/キャンセル/単純Closeでは保存しない）"

## 背景

- 現状の Launch Agent はモーダルを開くたびに初期値へ戻るため、同じ設定で繰り返し起動する運用で入力コストが高い。
- ただし「画面を閉じただけ」の状態を保存すると、意図しない値が次回デフォルトへ混入するリスクがある。
- 本仕様では「復元」ではなく「次回表示時のデフォルト設定」を定義し、保存契機を Launch 成功時に限定する。

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - Launch 成功時の設定を次回デフォルトにしたい (優先度: P0)

開発者として、Launch Agent で実際に成功起動した設定を、次回 Launch Agent を開いたときのデフォルトとして使いたい。

**独立したテスト**: Launch 成功後にモーダルを再オープンし、主要起動オプションが前回値で表示されることをコンポーネントテストで検証する。

**受け入れシナリオ**:

1. **前提条件** Launch Agent で Agent/Mode/Model/Version/Skip/Reasoning を変更済み、**操作** Launch を成功させて再度 Launch Agent を開く、**期待結果** 前回成功起動時の値がデフォルト表示される
2. **前提条件** Docker オプションと Advanced（Extra Args / Env Overrides）を設定済み、**操作** Launch 成功後に再表示する、**期待結果** これらの設定もデフォルト表示される
3. **前提条件** アプリ再起動前に Launch 成功している、**操作** 再起動後に Launch Agent を開く、**期待結果** 前回成功起動時の値が保持される

---

### ユーザーストーリー 2 - 未成功操作でデフォルトを汚染したくない (優先度: P0)

開発者として、Launch しなかった操作や失敗した操作は次回デフォルトに反映されたくない。

**独立したテスト**: Launch せずに Close / Launch エラー時に再オープンし、デフォルトが更新されていないことを検証する。

**受け入れシナリオ**:

1. **前提条件** 既存デフォルトがある、**操作** 値を変更して Launch せず Close、**期待結果** 次回デフォルトは更新されない
2. **前提条件** 既存デフォルトがある、**操作** 値を変更して Launch するが起動が失敗、**期待結果** 次回デフォルトは更新されない
3. **前提条件** 既存デフォルトがある、**操作** 起動ジョブをキャンセル、**期待結果** 次回デフォルトは更新されない

---

### ユーザーストーリー 3 - 不正データでも安全に開きたい (優先度: P1)

開発者として、保存済みデフォルト値が壊れていても Launch Agent が安全に開き、妥当な値へフォールバックしてほしい。

**独立したテスト**: localStorage に不正 JSON / 不正値を投入した場合でも UI がクラッシュせず既定値へフォールバックすることを検証する。

**受け入れシナリオ**:

1. **前提条件** 保存データが壊れている、**操作** Launch Agent を開く、**期待結果** クラッシュせず既定値で表示される
2. **前提条件** 保存 Agent が現在未利用可能、**操作** Launch Agent を開く、**期待結果** 利用可能な Agent へフォールバックする
3. **前提条件** 保存 runtime が Docker だが Docker 非対応、**操作** Launch Agent を開く、**期待結果** Host へフォールバックする

## エッジケース

- 保存済み `agentVersion=installed` だが対象 Agent が `bunx/npx` フォールバック状態の場合は `latest` へフォールバックする。
- 保存済み `sessionMode=resume` かつ `opencode` で Session ID が空の場合、起動時バリデーションでエラーを維持する（保存層では自動補完しない）。
- 保存対象外の `New Branch` 入力（base/name/issue）は毎回初期化し、誤作成を防ぐ。

## 要件 *(必須)*

### 機能要件

- **FR-001**: Launch Agent は表示時、保存済みデフォルト値が存在する場合にそれを初期表示へ適用しなければならない
- **FR-002**: デフォルト値の保存は Launch 成功時にのみ実行しなければならない
- **FR-003**: Close のみ・起動失敗・キャンセルではデフォルト値を更新してはならない
- **FR-004**: デフォルト値は GUI ローカルストレージにバージョン付きで保存しなければならない
- **FR-005**: 保存対象は起動オプション（Agent/Mode/Model/Version/Skip/Reasoning/Resume/Runtime/Docker/Advanced/Env Overrides）でなければならない
- **FR-006**: `New Branch` 入力（base/name/issue 選択）は保存対象外でなければならない
- **FR-007**: 保存データが不正な場合、Launch Agent はクラッシュせず既定値へフォールバックしなければならない
- **FR-008**: 保存 Agent が無効な場合は利用可能 Agent へフォールバックしなければならない
- **FR-009**: 保存 runtime が無効な場合は Host へフォールバックしなければならない

### 非機能要件

- **NFR-001**: 既存の Tauri コマンド（`launch_agent` / `start_launch_job`）およびバックエンド設定ファイル形式を変更しない
- **NFR-002**: デフォルト保存/読込は UI 操作に対して体感遅延を発生させない（同期 localStorage 操作で完結）
- **NFR-003**: テストは TDD で追加し、実装前に失敗テストを作成する

## 制約と仮定

- デフォルト値の保存単位はグローバル（project/branch 非依存）とする。
- `Env Overrides` は profile env とは別系統だが、Launch デフォルト保持の対象として扱う。
- UI 文言は既存方針どおり英語表示を維持する。

## 成功基準 *(必須)*

- **SC-001**: Launch 成功後に Launch Agent を再表示したとき、保存対象項目の少なくとも 95% が前回成功値で一致する
- **SC-002**: Launch せず Close した場合、次回デフォルトが更新されないことを自動テストで担保する
- **SC-003**: 不正保存データ（壊れ JSON / 無効値）でも Launch Agent がクラッシュしないことを自動テストで担保する
