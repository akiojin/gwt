# 機能仕様: CLI起動時Web UIサーバー自動起動

**仕様ID**: `SPEC-c8e7a5b2`
**作成日**: 2025-12-12
**ステータス**: 承認済み（後付け仕様化）
**入力**: 実装コード（src/index.ts:877-883）の後付け仕様化

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - CLIとWeb UIの同時利用 (優先度: P1)

開発者がgwtコマンドを起動すると、CLIインターフェースと並行してWeb UIサーバーがバックグラウンドで起動し、ブラウザからも操作可能になる。

**この優先度の理由**: CLI操作とブラウザ操作の両方を同時に提供することで、ユーザーの好みに応じた操作方法を選択できる。

**独立したテスト**: gwtを起動後、`http://localhost:3000` にアクセスしてWeb UIが表示されることを確認。同時にCLIでの操作も継続できる。

**受け入れシナリオ**:

1. **前提条件** Gitリポジトリ内でgwtを起動、**操作** 起動完了を待つ、**期待結果** 「Web UI available at `http://localhost:3000`」メッセージが表示される
2. **前提条件** gwtが起動している、**操作** ブラウザで`http://localhost:3000`にアクセス、**期待結果** Web UIが表示され操作可能
3. **前提条件** Web UIサーバーが起動失敗、**操作** gwtの起動を継続、**期待結果** CLIは正常に動作し、警告ログのみ記録される

### ユーザーストーリー 2 - カスタムポート指定 (優先度: P2)

開発者がPORT環境変数を設定することで、Web UIサーバーの起動ポートをカスタマイズできる。

**この優先度の理由**: デフォルトポート3000が他のサービスと競合する場合の回避策を提供。

**独立したテスト**: `PORT=8080 gwt` で起動し、`http://localhost:8080` でアクセス可能なことを確認。

**受け入れシナリオ**:

1. **前提条件** PORT=8080を設定、**操作** gwtを起動、**期待結果** 「Web UI available at `http://localhost:8080`」メッセージが表示される
2. **前提条件** PORTが未設定、**操作** gwtを起動、**期待結果** デフォルトポート3000でサーバーが起動

### エッジケース

- ポート3000が既に使用中の場合、システムはどのように処理しますか？
  - Web UIサーバー起動がエラーになるが、CLIは継続動作。警告ログに「Web UI server failed to start」と記録
- startWebServerが例外をスローした場合、main関数の実行はどうなりますか？
  - catch()で捕捉されappLogger.warnで記録。runInteractiveLoop()は正常に続行
- PORT環境変数に無効な値（文字列など）が設定された場合はどうなりますか？
  - parseInt()の結果がNaNとなり、FastifyがNaNポートでlisten()を試行してエラー

## 要件

### 機能要件

- **FR-001**: システムはmain()関数実行時、runInteractiveLoop()の前にWeb UIサーバーを非同期でバックグラウンド起動**しなければならない**
- **FR-002**: システムはWeb UIサーバー起動後、「Web UI available at `http://localhost:{port}`」メッセージを画面出力**しなければならない**
- **FR-003**: システムはWeb UIサーバー起動失敗時、appLoggerにwarnレベルでエラーを記録**しなければならない**
- **FR-004**: システムはWeb UIサーバー起動失敗時もCLIのインタラクティブループを継続**しなければならない**
- **FR-005**: システムはPORT環境変数でサーバーポートをカスタマイズ可能に**しなければならない**
- **FR-006**: システムはPORT環境変数が未設定の場合、デフォルトでポート3000を使用**しなければならない**
- **FR-007**: システムはGitリポジトリチェック通過後にのみWeb UIサーバーを起動**しなければならない**

### 主要エンティティ

- **startWebServer**: Web UIサーバー起動関数（src/web/server/index.ts）。Promiseを返し、起動完了またはエラーで解決
- **appLogger**: pinoベースのアプリケーションロガー（category: "cli"）
- **printInfo**: 画面出力用ユーティリティ関数

## 成功基準

- **SC-001**: gwtコマンド起動後5秒以内にWeb UIがアクセス可能となる
- **SC-002**: Web UIサーバー起動失敗時、CLIの動作が100%継続する
- **SC-003**: 起動メッセージにポート番号が正しく表示される
- **SC-004**: 警告ログがJSON構造化形式で記録される

## 制約と仮定

### 制約

- startWebServer()は動的import()で遅延ロード（バンドルサイズ最適化）
- Web UIサーバーはFastifyベース（既存実装）
- ログはpino構造化ログ仕様（SPEC-b9f5c4a1）に準拠

### 仮定

- ユーザーはGitリポジトリ内でコマンドを実行
- ポート3000はデフォルトで利用可能と想定

## 範囲外

- Web UIサーバー自体の機能実装（別仕様で管理）
- HTTPS対応
- 複数ポートでのリッスン
- サーバー起動のリトライ機構

## セキュリティとプライバシーの考慮事項

- Web UIサーバーは0.0.0.0でリッスンするためLAN内からアクセス可能
- 本番環境では適切なファイアウォール設定が必要

## 依存関係

- 既存実装: src/web/server/index.ts (startWebServer)
- 既存実装: src/logging/logger.ts (createLogger)
- 仕様: SPEC-b9f5c4a1 (ログ運用統一仕様)

## 参考資料

- 実装ファイル: [src/index.ts](../../src/index.ts) (877-883行目)
- Web UIサーバー: [src/web/server/index.ts](../../src/web/server/index.ts)
