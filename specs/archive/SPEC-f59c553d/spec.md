# 機能仕様: npm postinstall ダウンロード安定化

**仕様ID**: `SPEC-f59c553d`
**作成日**: 2026-01-26
**ステータス**: 廃止（Tauri GUI移行により無効）
**入力**: ユーザー説明: "Issue #795: bunx @akiojin/gwt@latest が1回目失敗し、2回目は成功する"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 初回実行での安定ダウンロード (優先度: P1)

`bunx @akiojin/gwt@latest` や `npm install -g @akiojin/gwt` を実行したユーザーが、初回のpostinstallで確実にバイナリを取得できる。

**この優先度の理由**: 初回失敗は体験を大きく損ね、再実行が必要になるため。

**独立したテスト**: GitHub Releasesのダウンロードが1回目にHTTP 404を返し、2回目に成功する状況を模擬してpostinstallの再試行が成功することを検証する（最大5回、初回0.5秒、倍率2、上限5秒）。

**受け入れシナリオ**:

1. **前提条件** GitHub Releasesの直接URLが一時的に404を返す、**操作** postinstallを実行、**期待結果** 指定回数の再試行後にダウンロードが成功する
2. **前提条件** GitHub Releasesのアセットが存在する、**操作** postinstallを実行、**期待結果** 最新リリースの指し先ではなくパッケージのバージョンタグに紐づいたURLからダウンロードされる

---

### ユーザーストーリー 2 - bunxオンデマンド取得のバージョン固定 (優先度: P1)

bunx実行でpostinstallが走らない場合でも、`bin/gwt.js` が指定バージョンのGitHub Releasesアセットを取得して起動できる。

**この優先度の理由**: 指定バージョンが無視されるとバージョン不整合が発生し、再現性が失われるため。

**独立したテスト**: `bin/gwt.js` が `package.json` のバージョンからタグURLを構築し、`latest` にフォールバックしないことを確認する。

**受け入れシナリオ**:

1. **前提条件** `bunx @akiojin/gwt@6.25.0` または `bunx @akiojin/gwt@v6.25.0` で実行、**操作** `bin/gwt.js` がオンデマンドでダウンロード、**期待結果** `v6.25.0` のタグURLから取得される
2. **前提条件** 指定バージョンのアセットが存在しない、**操作** `bin/gwt.js` がオンデマンドでダウンロード、**期待結果** `latest` へフォールバックせず英語のエラーと手動復旧案内が表示される

---

### ユーザーストーリー 3 - 失敗時の英語ガイダンス (優先度: P2)

再試行しても取得できない場合、ユーザーが英語のガイダンスで復旧できる。

**この優先度の理由**: リトライで解決しない場合でも、手動復旧が必要になるため。

**独立したテスト**: 全てのリトライが失敗した場合に、英語のエラー文とリンク案内が出力されることを確認する。

**受け入れシナリオ**:

1. **前提条件** GitHub Releasesが継続的に失敗する、**操作** postinstallを実行、**期待結果** 英語のエラーと手動ダウンロード案内が表示される

---

### エッジケース

- GitHub APIが一時的にタイムアウトする/不正なJSONを返す
- 指定バージョンのアセットが存在しない（release未作成/アップロード遅延）
- 途中でダウンロードが失敗し、部分ファイルが残る
- 未サポートのOS/アーキテクチャで実行された
- bunxの一時実行でpostinstallがスキップされ、`bin/` が空のまま起動される
- `bunx @akiojin/gwt@vX.Y.Z` と `bunx @akiojin/gwt@X.Y.Z` の両方が使われる
- `package.json` のバージョン取得に失敗する

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは `package.json` のバージョンを基準に `vX.Y.Z` のGitHub ReleasesアセットURLを生成**しなければならない**
- **FR-002**: システムは GitHub API からアセットURL取得に失敗した場合、`https://github.com/${REPO}/releases/download/vX.Y.Z/<artifact>` へフォールバック**しなければならない**
- **FR-003**: システムはHTTP 404/403/5xxやネットワークエラーを検知した場合、最大5回まで指数バックオフで再試行**しなければならない**（初回0.5秒、倍率2、上限5秒）
- **FR-004**: システムは未サポートのOS/アーキテクチャで即時に英語エラーを表示し終了**しなければならない**
- **FR-005**: システムは再試行失敗時に英語の復旧ガイダンス（GitHub Releasesとビルド方法）を表示**しなければならない**
- **FR-006**: 本機能に対する自動テストを実装**しなければならない**
- **FR-007**: システムは指定バージョンのアセットが存在しない場合でも `latest` にフォールバック**してはならない**
- **FR-008**: システムは `bin/gwt.js` のオンデマンド取得時に `package.json` のバージョンを基準に `vX.Y.Z` のGitHub ReleasesアセットURLを生成**しなければならない**
- **FR-009**: システムは `bin/gwt.js` のオンデマンド取得時に `latest` へフォールバック**してはならない**

### 主要エンティティ

- **DownloadAttempt**: ダウンロード試行の状態（試行回数、HTTPステータス、失敗理由）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 1回目にHTTP 404が発生しても、設定した最大試行回数以内にダウンロードが成功する
- **SC-002**: アセット未存在時、英語のエラーメッセージにリリースページとビルド手順が含まれる
- **SC-003**: 自動テストがURL生成とリトライ判定をカバーしている
- **SC-004**: bunxオンデマンド取得が `vX.Y.Z` のタグURLを使用し、`latest` を参照しない

## 制約と仮定 *(該当する場合)*

### 制約

- Node 18+の標準ライブラリのみを使用する
- CLI出力は英語のみとする

### 仮定

- npm公開時点で同じバージョンのGitHub Releasesが存在する

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- リリース作成ワークフローの変更
- バイナリの署名/チェックサム検証

## セキュリティとプライバシーの考慮事項

- 追加の機密情報は扱わない

## 依存関係

- GitHub Releases API
- npm レジストリで配布される `@akiojin/gwt` パッケージバージョン

## 参考資料

- [Issue #795](https://github.com/akiojin/gwt/issues/795)
