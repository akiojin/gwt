# 機能仕様: gwt GUI ブランチフィルター修正・エージェント起動ウィザード・Profiles設定

**仕様ID**: `SPEC-86bb4e7c`
**作成日**: 2026-02-09
**更新日**: 2026-02-11
**ステータス**: ドラフト
**カテゴリ**: GUI

**依存仕様**:

- `SPEC-d6210238`（TUI→Tauri GUI完全移行 Phase 1: 基盤構築）
- `SPEC-dfb1611a`（gwt GUI プロジェクト管理 Phase 2 追加機能）

**参照仕様（移植元 / Porting）**:

- `SPEC-a70a1ece`（bareリポジトリ対応: FR-124/FR-126）
- `SPEC-d2f4762a`（ブランチ選択後のウィザードポップアップ）
- `SPEC-f5f5657e`（Docker環境統合）
- `SPEC-dafff079`（環境変数プロファイル機能）

**入力**: ユーザー報告: 「Local/Remote/All のフィルターが誤って見える」「ブランチ選択からエージェント起動が分からない」「設定（AI/環境変数）がGUIにない」「TUI移行中の既存設定が初期化されないこと」

## 背景

- GUI 版ではブランチ一覧に `Local/Remote/All` のUIが存在するが、bare リポジトリ運用時に `Remote` の意味が一致せず、ユーザーには `Local` が `Remote` を表示しているように見える。
- GUI 版ではエージェント起動導線がメニューに偏っており、TUI 版の「ブランチ選択→起動ウィザード」体験から後退している。
- GUI 版 Settings は最小実装に留まり、TUI で提供されていた AI 設定や環境変数プロファイル編集が欠落している。
- TUI からの移行段階では、既存の設定ファイルを勝手に初期化（上書き/空で保存/意図しない変換）しないことが重要。

## ユーザーシナリオとテスト

### ユーザーストーリー 1 - Branch Filter の期待動作 (優先度: P0)

開発者として、`Local/Remote/All` を選択したときに **期待した集合** が表示され、bare リポジトリ運用でも `Remote` が空にならず正しく見えるようにしたい。

**受け入れシナリオ**:

1. **前提条件** Open Project で gwt の作業ルート（bare repo の親ディレクトリ）を開いている、**操作** Sidebar の `Local` を選択、**期待結果** **ローカルに存在する Worktree のブランチのみ**（例: `develop`, `feature/...`）が表示される（bare リポジトリ自身は除外される）
2. **前提条件** 同上、**操作** Sidebar の `Remote` を選択、**期待結果** bare リポジトリの場合は `git ls-remote --heads origin` 相当で取得されたブランチ（`origin/main` など）が表示される
3. **前提条件** 同上、**操作** Sidebar の `All` を選択、**期待結果** `Local` と `Remote` の両方が表示される（同名の表示ルールは後述の要件に従う）
4. **前提条件** `origin` remote が未設定、**操作** `Remote` を選択、**期待結果** UI がクラッシュせず空一覧またはエラー表示となり、`Local` へ戻れば通常表示できる

---

### ユーザーストーリー 2 - ブランチからエージェント起動できる (優先度: P0)

開発者として、ブランチを選択したあと迷わずエージェント起動ウィザードを開き、Worktree を作成/解決した上で内蔵ターミナルでエージェントを起動したい。

**受け入れシナリオ**:

1. **前提条件** ブランチが未選択、**操作** ブランチをクリック、**期待結果** Summary パネルにブランチ詳細と `Launch Agent...` ボタンが表示される
2. **前提条件** ブランチが選択されている、**操作** `Launch Agent...` を押す、**期待結果** 起動ウィザード（オーバーレイ）が表示される
3. **前提条件** ブランチが選択されている、**操作** ブランチをダブルクリック、**期待結果** 起動ウィザードが表示される
4. **前提条件** 対象ブランチの Worktree が存在しない、**操作** ウィザードで起動を実行、**期待結果** Worktree が作成され、その Worktree ディレクトリを working directory としてエージェントが起動する
5. **前提条件** 対象ブランチの Worktree が既に存在する、**操作** ウィザードで起動を実行、**期待結果** 既存 Worktree を使用してエージェントが起動する
6. **前提条件** Worktree 作成先パスが存在するが worktree list に含まれない（衝突）、**操作** ウィザードで起動を実行、**期待結果** 自動削除/自動修復は行われず、エラーが UI に表示され起動は中断される
7. **前提条件** 対象エージェントがローカルに未インストール、**操作** ウィザードで当該エージェントを選択して起動、**期待結果** gwt は bunx（または npx）によるフォールバック起動を試み、起動可能な場合はエージェントが起動する（TUI 仕様 `SPEC-3b0ed29b` FR-002/FR-002a に準拠）

---

### ユーザーストーリー 3 - ブランチ作成 + Worktree 作成を起動ウィザードで行える (優先度: P0)

開発者として、選択したブランチをベースに新規ブランチを作成し、その Worktree を作成した上で、エージェントを起動したい（TUI の「ブランチ選択→ウィザード」体験を維持したい）。

**受け入れシナリオ**:

1. **前提条件** 何らかのブランチが選択されている、**操作** `Launch Agent...` を開き `New Branch` を選択し `Base Branch` と `New Branch Name` を入力して Launch、**期待結果** 新規ブランチが作成され Worktree が作成され、Worktree を working directory としてエージェントが起動する
2. **前提条件** `Base Branch` がリモートブランチ（例: `origin/develop`）、**操作** 同上、**期待結果** 事前にリモート refs がローカルに存在しない場合でも、必要に応じて fetch され、作成したブランチが `Base Branch` のコミットに基づく
3. **前提条件** `New Branch Name` が既に存在する、**操作** 同上、**期待結果** 既存ブランチは上書きされず、UI にエラーが表示され起動は中断される
4. **前提条件** Worktree 作成先パスが衝突する、**操作** 同上、**期待結果** 自動削除/自動修復は行われず、UI にエラーが表示され起動は中断される
5. **前提条件** Sidebar の `Local` を表示している、**操作** 同上で起動が成功する、**期待結果** 起動成功直後に Sidebar の一覧が更新され、新規ブランチが表示される（手動更新不要）

---

### ユーザーストーリー 4 - Profiles（AI/環境変数）をGUIで編集できる (優先度: P0)

開発者として、TUI と同等に AI 設定と環境変数プロファイルを編集し、エージェント起動時に適用したい。

**受け入れシナリオ**:

1. **前提条件** `~/.gwt/profiles.toml` が存在、**操作** Settings を開く、**期待結果** 既存プロファイルと環境変数、AI 設定が読み込まれて表示される
2. **前提条件** `~/.gwt/profiles.yaml` のみ存在、**操作** Settings を開く、**期待結果** YAML が読み込まれて表示される（この時点で自動保存/変換は行われない）
3. **前提条件** Settings で環境変数を編集、**操作** Save を実行、**期待結果** TOML 形式（`~/.gwt/profiles.toml`）として保存される（既存 YAML は自動削除されない）
4. **前提条件** アクティブプロファイルが設定されている、**操作** エージェント起動、**期待結果** そのプロファイルの環境変数が起動プロセスに渡される（OS 環境変数より優先される）
5. **前提条件** ブランチを選択し、エージェントタブが存在する、**操作** Menu から Settings を開く、**期待結果** Settings が **タブとして** 追加/表示され、既存のエージェントタブは閉じられない
6. **前提条件** Settings で AI 設定（endpoint/api key）が入力されている、**操作** Model フィールドを開く、**期待結果** `GET /v1/models` の結果に基づくドロップダウンが表示され、自由入力はできない
7. **前提条件** `GET /v1/models` の取得に失敗する、または現在保存済みモデルが一覧に含まれない、**操作** Settings を表示する、**期待結果** エラーヒント/注意メッセージを表示しつつ、保存済みモデル値は保持される

---

### ユーザーストーリー 5 - 起動ウィザードでモデル/バージョンを選択できる (優先度: P0)

開発者として、エージェント起動ウィザードで **モデル** と **バージョン** を選択し、選択結果が起動コマンドに反映されてほしい。

**受け入れシナリオ**:

1. **前提条件** 起動ウィザードが開いている、**操作** Codex を選択し Model を選択して Launch、**期待結果** Codex の起動引数に `--model=...` が追加される
2. **前提条件** 起動ウィザードが開いている、**操作** Claude Code を選択し Model を選択して Launch、**期待結果** Claude Code の起動引数に `--model ...` が追加される
3. **前提条件** 起動ウィザードが開いている、**操作** Model の選択肢を確認、**期待結果** エージェントごとに代表的なモデル候補（Codex: `gpt-5.3-codex`, `gpt-5.2-codex`, `gpt-5.1-codex-max`, `gpt-5.2`, `gpt-5.1-codex-mini` / Claude: `opus`, `sonnet`, `haiku` / Gemini: `gemini-3-pro-preview`, `gemini-3-flash-preview`, `gemini-2.5-pro`, `gemini-2.5-flash`, `gemini-2.5-flash-lite` 等）が表示され、**自由入力はできない**
4. **前提条件** 対象エージェントがローカルに未インストールで bunx/npx フォールバックが利用可能、**操作** Version の選択肢を確認、**期待結果** 少なくとも `latest` が表示され、取得できる場合は npm レジストリ由来のバージョン候補が表示される
5. **前提条件** 同上、**操作** Version で `1.2.3` を選択して Launch、**期待結果** bunx/npx の最初の引数（パッケージ指定）が `@...@1.2.3` になる
6. **前提条件** 同上、**操作** Version で `latest` を選択して Launch、**期待結果** `@...@latest` が使用される

## エッジケース

- Open Project で Git リポジトリそのものではなく gwt の作業ルートを開いた場合でも動作する（bare repo 自動検出）。
- GUI アプリ起動時はシェル起動時と `PATH` が異なる場合があるため、エージェント未インストール時の `bunx`/`npx` フォールバック検出は `PATH` のみに依存しない（標準的なインストールパスも探索する）。
- bare リポジトリでは `Remote` ブランチ取得に `refs/remotes/*` を前提にしない（`ls-remote` を使用する）。
- Profiles は読み込み時にディスクへ副作用を書き込まない（ユーザーが Save するまで変更しない）。
- 既存設定ファイルの破損は `.broken` 退避の仕組みに従う（既存仕様）。
- Profiles の選択が空、または profiles マップが未定義でも、Settings の編集操作で UI がクラッシュしない。
- アクティブプロファイルに AI 設定が存在する場合（有効/無効に関わらず）、`default_ai` へフォールバックして AI を有効化してはならない（TUI/GUI/Session Summary で一致させる）。
- Git 操作で予期しないエラーやパニックが発生しても、UI はクラッシュせずエラー表示で継続する。
- Worktree 作成を伴う操作の後、Worktree 一覧（`Local`）が最新状態へ更新されない場合でも UI はクラッシュせず、少なくともエージェント起動は継続できる（更新はフォールバック手段で行えること）。
- 起動ウィザードの Agent ドロップダウンで利用可能なエージェントが 0 件の場合、選択は空のまま維持し `Launch` は無効でなければならない（誤って unavailable agent が選択されてはならない）。
- AI 提案が未知のプレフィックス（`feature/bugfix/hotfix/release` 以外）を返した場合、その候補を適用してはならない。UI はエラー表示し、提案モーダルを閉じてはならない。
- OpenAI 互換 endpoint では `/responses` が不安定または未対応な実装があるため、互換性条件に該当する場合は `chat/completions` 経路を優先し、ブランチ名提案/要約の初回リクエストで Network Error を出さない。
- `GET /v1/models` が同一 model id を重複返却する場合でも、UI では重複排除とソートを行って表示する。

## 要件

### 機能要件

#### Branch filter

- **FR-001**: `Local/Remote/All` の各モードは、明確に異なるブランチ集合を表示しなければ**ならない**
- **FR-002**: bare リポジトリにおける `Remote` は `git ls-remote --heads origin` により取得しなければ**ならない**（`SPEC-a70a1ece` FR-124）
- **FR-003**: `Remote` 取得に失敗しても UI はクラッシュしては**ならない**（エラー表示/空表示で継続）
- **FR-004**: `Local` は **ローカルに存在する Worktree のブランチのみ** を表示しなければ**ならない**（`git worktree list --porcelain` 相当の情報に基づく）
- **FR-005**: `Local` は bare リポジトリ自身（main worktree）を表示しては**ならない**
- **FR-029**: ブランチ一覧/現在ブランチ取得中に予期しないエラーが発生しても、UI はクラッシュしては**ならない**（エラー表示で継続）

#### Agent launch

- **FR-010**: ブランチ詳細（Summary）に `Launch Agent...` の主要導線を表示しなければ**ならない**
- **FR-010a**: 起動ウィザードの Agent 選択はドロップダウンで表示し、利用不可（unavailable）のエージェントは選択できないようにしなければ**ならない**（表示自体は維持する）
- **FR-011**: ブランチのダブルクリックで `Launch Agent...` と同等の導線を提供しなければ**ならない**
- **FR-012**: エージェント起動時の working directory は必ず対象ブランチの Worktree ディレクトリでなければ**ならない**
- **FR-012a**: 起動ウィザードの `Existing Branch` は選択中ブランチを使用し、ブランチ名は **編集不可（read-only）** でなければ**ならない**
- **FR-013**: Worktree が存在しない場合は作成し、存在する場合は再利用しなければ**ならない**
- **FR-014**: Worktree 衝突時に自動復旧（削除/修復/初期化）を行っては**ならない**
- **FR-015**: 起動ウィザードは `New Branch`（新規ブランチ作成）モードを提供しなければ**ならない**
- **FR-016**: `New Branch` モードでは `Base Branch` と `New Branch Name` を入力でき、Launch 実行時にブランチ作成 + Worktree 作成を行わなければ**ならない**
- **FR-016a**: `New Branch` の `Base Branch` は自由入力ではなく、`Local`（Worktreeが存在するブランチ）および `Remote` ブランチ候補から **選択** できなければ**ならない**
- **FR-016b**: `New Branch Name` はブランチタイプ（`feature/bugfix/hotfix/release`）のプレフィックスを **選択式で固定** し、それ以降のサフィックス部分のみを編集可能にしなければ**ならない**
- **FR-016c**: 起動ウィザードは `New Branch Name` の AI 提案 UI を提供し、ユーザー説明からプレフィックス込みの **3つのブランチ名候補** を生成して選択できなければ**ならない**。AI未設定/エラー時も UI はクラッシュしては**ならない**
- **FR-016d**: アクティブプロファイルに AI 設定が存在する場合（有効/無効に関わらず）、`default_ai` へフォールバックして AI 提案を有効化しては**ならない**
- **FR-031**: AI クライアントは OpenAI 互換 endpoint 互換性のため、`api.openai.com` 以外または `:` を含む model id（例: `gpt-oss:20b`）では `chat/completions` を優先経路として使用しなければ**ならない**
- **FR-017**: `Base Branch` がリモートブランチの場合、必要に応じて fetch を行い、Worktree 作成後にブランチを `Base Branch` のコミットへ一致させなければ**ならない**
- **FR-018**: エージェントがローカルに未インストールの場合でも、起動ウィザードの選択肢から除外しては**ならない**。起動時に bunx でフォールバック実行を試みなければ**ならない**（`SPEC-3b0ed29b` FR-002）
- **FR-019**: bunx が `node_modules/.bin` 配下で検出された場合、その bunx を使用しては**ならない**。代わりに `npx --yes` へフォールバックしなければ**ならない**（`SPEC-3b0ed29b` FR-002a）
- **FR-019a**: `bunx`/`npx` が `PATH` から検出できない場合でも、標準的なインストールパス（例: `~/.bun/bin`）を探索し、利用可能であればフォールバック実行に使用しなければ**ならない**
- **FR-030**: Worktree 作成を伴う起動操作の直後、Sidebar の `Local` 一覧は自動的に最新状態へ更新されなければ**ならない**
- **FR-025**: 起動ウィザードは Model（任意）を **選択** できなければ**ならない**。Codex の場合は `--model=...`、Claude Code の場合は `--model ...`、Gemini の場合は `-m ...` 形式で起動引数へ反映しなければ**ならない**（`SPEC-3b0ed29b` FR-005）
- **FR-026**: 起動ウィザードは Version（任意）を **選択** できなければ**ならない**。選択肢は `installed`（利用可能な場合）、`latest`、および取得できたバージョン候補である。bunx/npx フォールバック実行時は `@...@{version}` としてパッケージ指定へ反映しなければ**ならない**
- **FR-026a**: Codex を選択した場合のみ Reasoning を表示し、Reasoning の表示位置は `Agent Version` の直下でなければ**ならない**
- **FR-027**: 起動ウィザードの Model/Version は **選択式のみ** で、自由入力を受け付けては**ならない**（選択肢はエージェントごとに異なる）
- **FR-028**: Agent Version の候補一覧は、取得可能な場合は **bun（`bun info <pkg> time/dist-tags --json`）を優先して** npm レジストリ由来のバージョン一覧を表示しなければ**ならない**。取得に失敗しても UI はクラッシュしては**ならない**（`latest` のみ表示で継続）

#### Profiles / Settings

- **FR-020**: Settings から Profiles（環境変数 + AI 設定）を閲覧・編集できなければ**ならない**
- **FR-021**: 既存 `profiles.toml` が存在する場合はそれを優先して読み込まなければ**ならない**
- **FR-022**: Profiles が未選択/未定義の状態でも、Settings の編集操作で UI がクラッシュしては**ならない**
- **FR-022**: `profiles.yaml` のみ存在する場合、読み込みは可能だが Save するまで自動変換/自動保存しては**ならない**
- **FR-023**: Save は常に TOML（`profiles.toml`）へ書き込み、旧形式は自動削除しては**ならない**
- **FR-024**: エージェント起動時にアクティブプロファイルの環境変数をプロセスへ注入しなければ**ならない**
- **FR-029**: Settings はモーダル/オーバーレイではなく **タブ** として表示されなければ**ならない**
- **FR-032**: Settings の AI `Model` は自由入力ではなく、`GET /v1/models` による候補ドロップダウンで選択しなければ**ならない**
- **FR-033**: Settings は AI endpoint / API key / profile 変更時に model 候補を再取得でき、手動 `Refresh` も提供しなければ**ならない**
- **FR-034**: 現在保存済み model が `GET /v1/models` 一覧に存在しない場合でも、値を破棄しては**ならない**。UI は注意メッセージを表示し、ユーザーが明示的に変更するまで保持しなければ**ならない**

## インターフェース（フロント/バック間）

### Tauri Commands

- `list_worktree_branches(projectPath: string) -> BranchInfo[]`
- `list_remote_branches(projectPath: string) -> BranchInfo[]`（bare の場合は ls-remote を使用）
- `detect_agents() -> DetectedAgentInfo[]`
- `launch_agent(request: LaunchAgentRequest) -> paneId: string`（新規ブランチ作成モードを含む。Model/Agent Version を含む）
- `suggest_branch_names(description: string) -> BranchSuggestResult`（New Branch Name のAI提案用。3候補を返す）
- `get_profiles() -> ProfilesConfig`
- `save_profiles(config: ProfilesConfig) -> void`
- `list_ai_models(endpoint: string, apiKey: string) -> ModelInfo[]`（`GET /v1/models` の疎通確認と model 候補表示用）

## 成功基準

- `Local/Remote/All` の表示が bare 運用でも直感に一致し、ユーザーが「Local が Remote を表示している」と誤認しない。
- ブランチ選択から 1 クリックでエージェント起動ウィザードへ到達できる。
- Profiles の既存ファイルを壊さずに読み込み、Save 明示時のみ TOML へ反映できる。
- Settings の AI model が `/v1/models` 由来のドロップダウンで選択でき、候補取得失敗時も UI はクラッシュしない。
- OpenAI 互換 endpoint でブランチ名提案/要約を実行した際、初回経路選択により不要な Network Error を回避できる。

## 制約と仮定

- GUI のユーザー向け表示は英語のみ。
- 開発作業は現在の git ブランチ（`feature/multi-terminal`）で完結し、開発用の新規ブランチ作成/切り替えは行わない。
