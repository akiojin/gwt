# 機能仕様: GitView画面

**仕様ID**: `SPEC-1ea18899`
**作成日**: 2026-02-02
**ステータス**: 確定
**カテゴリ**: Porting

**入力**: ユーザー説明: "GitView画面の新規実装。ブランチ一覧でvキーを押すとカーソル位置のブランチのgit状態詳細ページを表示する。現在のDetailsパネルは削除し、Branches + Sessionの2ペイン構成に変更。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - GitView画面でブランチのgit状態を確認する (優先度: P1)

ユーザーはブランチ一覧画面で任意のブランチを選択し、`v`キーを押すことで、そのブランチの詳細なgit状態（変更ファイル、diff、コミット履歴、PRリンク等）を専用画面で確認できる。

**この優先度の理由**: ブランチの状態把握は日常的なgit操作の中核機能であり、現在のDetailsパネルを置き換える主要機能となるため。

**独立したテスト**: ブランチ一覧で`v`キーを押すことで完全にテストでき、git状態の詳細確認という価値を提供する。

**受け入れシナリオ**:

1. **前提条件** ブランチ一覧画面でワークツリーを持つブランチにカーソルがある、**操作** `v`キーを押す、**期待結果** GitView画面が表示され、ヘッダーにブランチ名・PRリンク・ahead/behind情報が表示される
2. **前提条件** GitView画面が表示されている、**操作** `Esc`または`v`キーを押す、**期待結果** ブランチ一覧画面に戻る
3. **前提条件** GitView画面のFilesセクションにファイルがある、**操作** 上下キーでファイルを選択し`Space`を押す、**期待結果** 選択ファイルのdiffがインラインで展開表示される
4. **前提条件** GitView画面のCommitsセクションにコミットがある、**操作** コミットを選択し`Space`を押す、**期待結果** 選択コミットの詳細（メッセージ、変更ファイル一覧）がインラインで展開表示される

---

### ユーザーストーリー 2 - PRリンクをブラウザで開く (優先度: P2)

ユーザーはGitView画面のヘッダーに表示されているPRリンクを選択し、`Enter`キーでブラウザを起動してPRページを開くことができる。表示するPRは **openを優先し、同状態内ではupdatedAtが最新のPR** とする。PRが存在しない場合は「No PR」を表示し、**mergedの場合は色付きで「(merged)」を表示する**。

**この優先度の理由**: PRとの連携はgwt本来の価値であり、素早くPRを確認できることでワークフローが効率化されるため。

**独立したテスト**: PRが紐づいたブランチでGitViewを開き、リンク上で`Enter`を押すことでテスト可能。

**受け入れシナリオ**:

1. **前提条件** GitView画面でPRリンクがあるブランチを表示、**操作** PRリンクにカーソルを合わせ`Enter`を押す、**期待結果** デフォルトブラウザでPRページが開く

---

### ユーザーストーリー 3 - ワークツリーなしブランチの情報表示 (優先度: P2)

ユーザーはワークツリーを持たないブランチでも、git show/rev-parseで取得可能な情報（コミット履歴、ahead/behind等）を確認できる。

**この優先度の理由**: ワークツリーがないブランチでも最低限の情報確認ができることで、全ブランチに対してGitViewの価値を提供できるため。

**独立したテスト**: ワークツリーを持たないブランチで`v`キーを押すことでテスト可能。

**受け入れシナリオ**:

1. **前提条件** ワークツリーを持たないブランチにカーソルがある、**操作** `v`キーを押す、**期待結果** GitView画面が表示され、ヘッダー情報とCommitsセクションが表示される（Filesセクションは空または「No worktree」と表示）

---

### ユーザーストーリー 4 - Detailsパネル削除と2ペイン構成への移行 (優先度: P1)

ユーザーはブランチ一覧画面でBranches + Sessionの2ペイン構成を使用し、詳細情報は`v`キーでGitView画面を開いて確認する。

**この優先度の理由**: UIの簡素化により情報のオーバーロードを防ぎ、必要なときだけ詳細を確認できるモーダル型UXを実現するため。

**独立したテスト**: ブランチ一覧画面を開き、Detailsパネルが表示されないことを確認。

**受け入れシナリオ**:

1. **前提条件** アプリケーションを起動、**操作** ブランチ一覧画面を表示、**期待結果** Branchesペイン（上部）とSessionペイン（下部）の2ペイン構成で表示され、Detailsパネルは存在しない

---

### エッジケース

- 変更ファイルが50件以上の場合：最初20件を表示し、「Show more (残りN件)」で残りを展開表示する
- diff行数が50行を超える場合：50行で切り詰め、末尾に「... (N more lines)」と表示する
- バイナリファイルの場合：ファイル名とサイズ変化（例: `+1.2KB`、`-500B`）を表示し、diff内容は表示しない
- PRが存在しないブランチの場合：ヘッダーにPRリンクを表示せず、ブランチ名とahead/behind情報のみ表示する
- upstream追跡なしのブランチの場合：ahead/behind情報は「No remote」と表示する

## 要件 *(必須)*

### 機能要件

#### 画面遷移・キーバインド

- **FR-001**: ブランチ一覧画面で`v`キーを押すと、カーソル位置のブランチのGitView画面に遷移**しなければならない**
- **FR-002**: GitView画面で`Esc`キーまたは`v`キーを押すと、ブランチ一覧画面に戻ら**なければならない**
- **FR-003**: GitView画面では上下キーで全アイテム（Files、Commits）をシームレスに移動でき**なければならない**（セクション境界を跨ぐ）
- **FR-004**: GitView画面でアイテムを選択し`Space`キーを押すと、展開/折りたたみをトグルでき**なければならない**
- **FR-005**: GitView画面でリンク（PRリンク等）上で`Enter`キーを押すと、デフォルトブラウザでリンクを開か**なければならない**
- **FR-006**: 上下キーでFilesセクションの上端からさらに上に移動すると、ヘッダー内のPRリンクにフォーカスが移ら**なければならない**
- **FR-007**: マウスクリックでPRリンクを直接開けなければ**ならない**

#### レイアウト・表示

- **FR-010**: GitView画面は垂直スタック構成（上からヘッダー → Files → Commits）で表示**しなければならない**
- **FR-010a**: GitView画面を開いた時の初期フォーカスは、Filesセクションの最初のファイル（ファイルがない場合はCommitsセクションの最初のコミット）に設定**しなければならない**
- **FR-011**: ヘッダーは画面上部に固定表示し、ブランチ名・PR行（最新PR）・ahead/behind情報を含ま**なければならない**
- **FR-011a**: PR行は常時表示し、PRが存在する場合は「#番号 タイトル」をリンク表示し、存在しない場合は「No PR」を表示**しなければならない**
- **FR-011b**: PRがmergedの場合、PR行に色付きで「(merged)」を付与**しなければならない**
- **FR-011c**: GitViewで取得したPR情報は、空の更新で「No PR」に戻さず保持**しなければならない**
- **FR-011d**: bareリポジトリでもPR取得が成功するよう、PR取得処理はbareリポジトリパスを優先**しなければならない**
- **FR-011e**: PRリンクオープンの失敗はステータスバーに表示し、外部コマンドの出力でUIを汚してはならない**
- **FR-012**: Filesセクションはstaged/unstaged/untrackedのファイルをフラットリストで一覧表示し、各ファイルにステータスアイコン/ラベル（`[S]`=staged, `[U]`=unstaged, `[?]`=untracked）を付与**しなければならない**
- **FR-013**: Filesセクションは最初20件を表示し、残りがある場合は「Show more (残りN件)」という疑似アイテムをリスト末尾に表示し、`Space`または`Enter`で残りを展開表示でき**なければならない**
- **FR-014**: Commitsセクションは直近5件のコミット履歴を表示**しなければならない**

#### diff表示

- **FR-020**: ファイルを展開した際、diff内容をインラインで表示**しなければならない**
- **FR-021**: diff表示は最大50行に制限し、超過分は「... (N more lines)」と省略表示**しなければならない**
- **FR-022**: バイナリファイルの場合、diff内容の代わりにサイズ変化（例: `+1.2KB`）を表示**しなければならない**
- **FR-023**: diff表示は追加行（+）と削除行（-）を視覚的に区別でき**なければならない**（色分け等）

#### コミット表示

- **FR-030**: コミットを展開した際、コミットメッセージ全文と変更ファイル一覧を表示**しなければならない**

#### Detailsパネル削除

- **FR-040**: ブランチ一覧画面からDetailsパネルを削除し、Branches + Sessionの2ペイン構成に変更**しなければならない**
- **FR-041**: 現Detailsパネルに表示されていた情報（ブランチメタ情報、PRリンク等）はGitView画面のヘッダーに移動**しなければならない**

#### データ取得・キャッシュ

- **FR-050**: ブランチ一覧表示時に、全ブランチのgit情報（status/diff/log）をバックグラウンドで事前取得しメモリにキャッシュ**しなければならない**
- **FR-051**: `v`キー押下時はキャッシュからデータを取得し、即座にGitView画面を表示**しなければならない**
- **FR-052**: ブランチ一覧のリロード（`r`キー）時に全キャッシュを無効化し、再取得**しなければならない**
- **FR-053**: ワークツリーを持たないブランチの場合、git show/rev-parseで取得可能な情報のみを表示**しなければならない**

### 主要エンティティ

- **GitViewState**: GitView画面の状態を表現（対象ブランチ、選択位置、展開状態、取得データ）
- **GitViewCache**: 全ブランチのgit情報をキャッシュ（ブランチ名をキーとしたHashMap）
- **FileEntry**: 変更ファイルの情報（パス、ステータス[staged/unstaged/untracked]、diffキャッシュ、バイナリフラグ、サイズ変化）
- **CommitEntry**: コミット情報（ハッシュ、メッセージ、著者、日時、変更ファイル一覧）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ブランチ一覧から`v`キーでGitView画面が即座（100ms以内）に表示される（キャッシュ済みの場合）
- **SC-002**: GitView画面から`Esc`/`v`でブランチ一覧に0.5秒以内に戻れる
- **SC-003**: 上下キーでのアイテム移動がラグなく（16ms以内）反応する
- **SC-004**: 50件のファイル変更があるブランチでも初期表示が2秒以内に完了する

## 制約と仮定

### 制約

- 既存のratatui TUIフレームワークとElmアーキテクチャに準拠する
- 既存のScreen enum、Message enum、画面遷移パターンに従う
- 端末描画で使用するアイコンはASCIIに統一（絵文字不可）

### 仮定

- gitコマンド（git status, git diff, git log, git show）が実行可能な環境である
- ブランチ一覧画面のBranchItem構造体から必要な情報（ブランチ名、ワークツリーパス等）を取得できる

## 範囲外 *(必須)*

次の項目は、この機能の範囲外です：

- GitView画面からのファイル操作（stage/unstage/discard/commit）
- GitView画面内でのブランチ切り替え
- diffのside-by-side表示
- コミット間のdiff比較
- ファイル内検索

## セキュリティとプライバシーの考慮事項

- ローカルファイルシステムとgitリポジトリへのアクセスは既存のgwt-coreを経由する
- 外部へのネットワーク通信は既存のPRリンク取得機能の範囲内

## 依存関係

- gwt-core: gitコマンド実行、ブランチ情報取得
- 既存のBranchListState: 選択中ブランチの情報取得
- 既存のSessionパネル: 2ペイン構成での共存

## 参考資料

- [既存のDetailsパネル実装](../crates/gwt-cli/src/tui/screens/branch_list.rs) - render_details_panel関数
- [既存のScreen enum定義](../crates/gwt-cli/src/tui/app.rs) - Screen enum
