# 実装計画: ブランチ選択画面 クリーンアップ選択モード

**仕様ID**: `SPEC-d2f4762a` | **対象US**: 0, 0b, 4 | **日付**: 2026-01-31

## 方針
- アイコンは行頭の「選択 + 安全性」に絞り、アイコン間にスペースを入れる。ASCIIに限定せず、単幅（1セル）にならない文字はASCIIへフォールバックする。
  - 選択: `[*]` / `[ ]` を基準とし、視認性を優先
  - 安全判定: `!`（未コミット/unsafe）/ `^`（未プッシュ）/ `*`（未マージ）/ `o`（安全）/ スピナー（判定中/削除中）
- クリーンアップは「自動判定」＋「選択済みブランチ優先」で両立。選択があれば選択対象のみ、無ければ従来の自動判定。
- 安全判定はクリーンアップ候補判定をベースにするが、upstreamの同名ブランチが存在しない場合は安全とみなさない（ただし選択済みブランチは安全判定に関係なく対象）。
- 表示色は安全にクリーンアップ可能な場合は`o`を明るい緑、未コミットで安全アイコン`!`を赤、未プッシュで`!`を黄色、未マージで`*`を黄色、その他の安全でないは`!`を赤で示す。Worktreeの`w`は明るい緑で表示する。
- 安全判定の取得中は安全アイコン位置にスピナーを表示し、完了したブランチから順に安全アイコンを更新する。リモートブランチは安全アイコンを空白で表示する。
- 未コミット/未プッシュが検出されたブランチは安全判定を即時確定し、ベースブランチ差分・upstream判定は実行しない。未マージ判定はベースブランチ差分で完了させる。
- `defaultBaseBranch` がローカルに存在しない場合はデフォルトリモート（origin優先）の `remote/<base>` を優先し、存在しなければ `remote/HEAD` から推定したブランチをベースに安全判定を行う。
- 安全アイコン表示とunsafe選択警告の判定は同一の安全状態キャッシュから導出し、表示と確認の不一致を防ぐ。
- PRタイトル取得はバックグラウンドで実行し、ブランチ一覧の初期表示をブロックしない。
- 起動直後はブランチ一覧取得自体を非同期にし、空の一覧＋ローディング表示を即時描画する。一覧取得完了後に一覧を表示し、詳細状態（未コミット/未プッシュ/未マージ/安全判定、upstream有無/差分、Worktreeアクセス可否）をバックグラウンドで更新する（PRタイトル取得は既存の非同期処理を維持）。
- 状態更新中は進捗表示（ASCIIスピナー + `Status: Updating branch status (done/total)`）を表示し、完了後は非表示にする。ブランチ一覧取得中は `Status: Loading branch list...` を表示する。
- スピナーのフレームカウンタは常にフレーム数で循環させ、他コンポーネント由来の大きなカウンタでも描画がパニックしないようにする。
- `r`キーの再取得時は進行中の一覧取得/状態更新を無効化し、最新の更新結果のみ反映する。
- 依存関係インストールはデフォルトで無効化し、エージェント起動をブロックしない。必要な場合のみ設定/環境変数で有効化し、無効時は警告メッセージを表示する。
- エージェント起動前の既存Worktree解決は軽量なメタデータ確認のみで行い、未コミット/未プッシュなどの詳細状態チェックを実行しない。
- 設定画面は選択中項目の補足説明を表示し、Auto Install Deps の挙動を明示する。
- 出力の警告文と設定画面のDescription文言はユニットテストで検証し、意図しない変更を防ぐ。
- 安全判定が完了している安全ではないブランチを`space`でチェックしようとした場合は警告（OK/Cancel）を表示し、OKで選択・Cancelで未選択を維持する（警告文言は英語）。
- 安全判定が取得中のブランチを`space`でチェックしようとした場合も警告（OK/Cancel）を表示し、OKで選択・Cancelで未選択を維持する（警告文言は英語）。
- 警告/クリーンアップ確認ダイアログはブランチ一覧の上にポップアップ表示し、背景の一覧を維持する。
- クリーンアップ実行中も画面更新を継続し、ステータスバーにスピナーと`Cleanup: Running (done/total)`の進捗を英語で表示する。入力ロックは維持し、描画はブロックしない。
- クリーンアップ実行中は削除処理中のブランチの安全アイコン位置にASCIIスピナーを表示し、選択/カーソル移動/クリック入力をロックする。削除中ブランチはカーソル選択の対象外とし、マウスクリックでも選択しない。
- ブランチ一覧の表示領域は枠線で囲んで視認性を高める。
- ブランチ一覧の枠内コンテンツは左右1文字分の余白を設け、枠線に密着しないようにする。
- ブランチ一覧のマウス選択はダブルクリックで行い、単クリックでは選択を変更しない。ダブルクリックは同一行の連続クリックかつ500ms以内で判定し、Enter相当のフロー（ペインフォーカス/ウィザード）を開始する。
- ブランチ一覧のツール表示は短縮名（Codex/Claude/Gemini/OpenCode）を使用する。
- Mode(tab)行は現在の表示モードのみを表示し、Local/Remote/Worktrees/Changes/Updatedは表示しない。
- Mode(tab)行の直下に安全アイコンの凡例行を表示し、Safe/未コミット/未プッシュ/未マージの意味を英語で説明する。
- unsafe選択の警告ダイアログは反転表示が枠外に広がらないよう、ダイアログ内幅でハイライトする。
- unsafe選択の警告ダイアログでEnter確定したキー入力はブランチ一覧へ伝搬させない。
- 選択済みブランチは安全判定に関係なくクリーンアップ対象に含める（リモートブランチと現在ブランチは除外）。保護ブランチもチェックされていれば対象に含める。
- Worktree作成時に既存パスがある場合は自動復元や削除を行わず、必ずエラーで中断して手動解決を促す。
- エージェント選択後のバージョン選択ステップは Enter キー伝播で自動遷移せず、明示選択が行われるまで表示を維持する。選択確定は最初のEnterで行い、二重Enterを要求しない。
- ブランチ選択後の設定選択フローは最初にブランチアクション（Use selected branch / Create new branch from selected branch）を表示し、Create new 選択時は選択ブランチをベースにブランチタイプ/ブランチ名入力を経由する。
- ウィザードポップアップの幅は内容に応じて自動調整し、収まらない文言は`...`で省略する。
- ポップアップ内のコンテンツは左右に余白を入れ、枠線に密着しないようにする。
- 大量ブランチ時は表示範囲のみ描画し、フィルター/モード変更時のみ再計算、読み込み中はローディング表示を出す。
- ブランチ詳細サマリ（Commits/Stats/Meta）は選択変更時にバックグラウンド取得し、旧結果は破棄する。取得中はLoading表示を出し、キャッシュは使わず毎回再取得する。

## ハイレベル ToDo
1) **データ取得/状態**: upstream・未コミット/未プッシュ・未マージの判定を取得し、`App`で `getMergedPRWorktrees()` の結果を補正して安全候補集合を持つ。
2) **選択状態管理**: `App` に選択ブランチ集合を追加し、`space` トグル、`c` 実行時に選択優先・0件時フォールバックを実装。
3) **安全ブランチ確認**: 安全判定済みのunsafeブランチに対する`space`トグル時に警告OK/Cancelを出し、Cancelなら選択しない。
4) **選択優先ルール**: 選択済みブランチは安全判定に関係なくクリーンアップ対象に含め、リモート/現在ブランチのみ除外する。
5) **UI表示**: `BranchListScreen` の行頭は「選択 + 安全性」アイコンに統一し、Worktree列は持たない。単幅でない記号はASCIIへフォールバックし、ブランチ名開始位置を固定する。Mode(m)行の直下に安全アイコン凡例を表示し、フィルター中はスペース入力を入力欄へ優先する。警告/クリーンアップ確認はポップアップで表示し、下部にはフッターヘルプと常時表示ステータスバーを配置する。
6) **TDD**: コンポーネントテストで (a) アイコン列表示、(b) スペーストグル、(c) 選択有無によるクリーンアップ対象切替、(d) 安全判定アイコンの表示とブランチ単位の進捗反映、(e) unsafeブランチ選択時の警告とCancel維持、(f) 選択済みunsafe/保護ブランチのクリーンアップを検証。
7) **入力互換性**: WSL/Windows で分割されるエスケープシーケンスを矢印キーとして解釈できるよう、入力ハンドラの待機時間/判定を調整し、選択系画面での誤`Esc`をテストで防止する。
8) **起動互換性**: `bun ./dist/index.js` のような相対パス実行でもエントリポイント判定が外れないよう、`import.meta.url` と `process.argv[1]` の比較を正規化する。
9) **非ブロッキングフェッチ**: ブランチ一覧の初期ロードではリモートフェッチをバックグラウンド化し、認証待ち/ネットワーク遅延でもUIが進行するようにタイムアウトと非対話実行を導入する。
10) **Worktree復元の無効化**: Worktree作成時は既存パスを自動削除せずエラーにし、起動時/終了時の自動クリーンアップを無効化し、repair操作は提供しない。
11) **Worktree表示の移設**: 選択ブランチのWorktreeフルパスはフッター周辺ではなくDetailsパネル内に表示し、空リスト時は`Worktree: (none)`、現在ブランチでWorktreeなしの場合は起動時の作業ディレクトリを表示する。
12) **フッターヘルプ整理**: ステータスバー直上にフッターヘルプを復活させ、キーバインドを短い英語ラベルでコンパクト表示する（幅不足時のみ2行化）。
13) **ウィザードポップアップのスクロール対応**: ウィザード内容がポップアップ高さを超える場合に、ポップアップ内でスクロールできるようにし、内容のはみ出しを防止する（マウス/上下キー）。
14) **安全判定中の選択確認**: safety判定中のブランチを`space`で選択する際も警告を出し、OKで選択・Cancelで維持する。
15) **バージョン選択の自動遷移防止**: エージェント選択後にバージョン選択が必ず表示され、Enter伝播による自動遷移を抑止する。
16) **大量ブランチ対応**: ブランチ一覧の描画を可視範囲に限定し、フィルター/モード変更時のみ再計算する。読み込み中はローディング表示を維持する。
17) **起動時の完全非同期取得**: 起動直後は空一覧＋ローディングを描画し、一覧取得と詳細状態更新をすべてバックグラウンドで実行する。進捗表示を追加し、`r`で再取得した場合は古い更新を破棄する。
18) **依存インストールの非ブロッキング化**: 依存関係インストールはデフォルト無効。`agent.auto_install_deps` または `GWT_AGENT_AUTO_INSTALL_DEPS` でのみ実行し、無効時は警告のみ出して即起動する。
19) **設定画面の補足表示**: 選択中項目の説明エリアを追加し、項目ごとの説明文を表示する。
20) **出力検証テスト**: 自動インストール無効時の警告文と設定画面Description文言のユニットテストを追加する。
21) **クリーンアップ進捗の非ブロッキング化**: クリーンアップをバックグラウンドで実行し、ステータスバーにスピナー+`done/total`を表示する。
22) **ブランチ詳細サマリ非同期化**: 選択変更時にサマリ取得をバックグラウンド化し、Loading/破棄ルールとエラー表示を実装する。
23) **エージェント起動前の軽量Worktree解決**: 既存Worktreeの解決はメタデータのみで判定し、詳細状態チェックで起動フローをブロックしない。
24) **クリーンアップ中スピナー表示**: 削除処理中のブランチ安全アイコン位置にASCIIスピナーを表示する。
25) **ベースブランチ解決**: `defaultBaseBranch` がローカルに無い場合はデフォルトリモートの `remote/<base>` または `remote/HEAD` を用いて安全判定を継続する。
26) **クリーンアップ中ブランチの選択スキップ**: 削除中ブランチはカーソル移動/マウスクリックの対象外とし、選択が移動しないようにする。

## 追加方針: ブランチ名の色分けによるWorktree状態表現 (2026-01-22)

- Worktree列（`w`/`x`/`.`アイコン）を削除し、ブランチ名のテキスト色でWorktree状態を表現する。
- 色分けルール:
  - Worktreeが存在し有効: 白色（`Color::White`）
  - Worktreeが存在しない: 灰色（`Color::Gray`）
  - Worktreeパスが欠損（Inaccessible）: 赤色（`Color::Red`）
  - リモート削除済み（gone）ブランチ: 赤色（`Color::Red`）
- 選択中のブランチは、Worktree状態の色より選択視認性を優先し、シアン背景・黒テキストで表示する。
- goneステータスは`git for-each-ref`の`upstream:track`情報から`[gone]`を検出し、Branch構造体に追加する。
- 行のレイアウト: 「選択アイコン + 安全性アイコン + ブランチ名（色分け） + エージェント情報」の順で表示する。

## 追加方針: エージェント履歴表示の拡張 (2026-01-22)

- Worktreeの有無に関係なく、エージェント履歴（SPEC-2ca73d7d）から直近使用エージェント情報を取得して表示する。
- 実行中エージェント情報を履歴より優先して表示する。
- 履歴から取得したエージェント情報は`{AgentName}@{version}`形式で表示する（例: `Claude@latest`）。
- 起動時にAgentHistoryStoreを読み込み、ブランチごとの履歴を参照する。

## 追加 ハイレベル ToDo (2026-01-22)

1) **Worktree列削除と色分け**: `BranchListScreen`からWorktree列を削除し、ブランチ名の色でWorktree状態を表現する。
2) **goneステータス検出**: `git for-each-ref`のフォーマットに`upstream:track`を追加し、`[gone]`を検出してBranch構造体に反映する。
3) **エージェント履歴統合**: ブランチ一覧表示時にAgentHistoryStoreから履歴を取得し、Worktreeなしブランチでもエージェント情報を表示する。
4) **選択状態の色優先**: 選択中ブランチではWorktree状態色より選択視認性（シアン背景・黒テキスト）を優先する。

## 追加方針: ベースブランチのリモートフォールバック (2026-01-26)

- `defaultBaseBranch` がローカルに無い場合でも、デフォルトリモート（origin優先）の `remote/<base>` を優先し、存在しなければ `remote/HEAD` から推定したブランチを安全判定のベースとして使用する。
- ベースブランチがローカルに無いことだけを理由に安全判定を `Unsafe` に固定しない。

## 追加方針: レイアウト統一とステータスバー統合 (2026-01-27)

- 主要画面は共通の画面骨格（ヘッダー + コンテンツ + フッターヘルプ + ステータスバー）で描画し、BranchListだけがフッター/ヘッダーを省略する状態を解消する。
- ヘッダーはboxed headerを基準に統一し、主要画面で同じ高さ・同じ枠線色・同じ左右余白に揃える。
- ステータスバーは画面最下部に1行を常時確保し、エージェント集計・選択数・グローバルなステータスメッセージ（起動/クリーンアップ進捗含む）を集約する。エージェント0件でも`Agents: none`で行を維持する。
- 既存の「起動中ステータス行（コンテンツ上部）」は廃止し、ステータスバーへ統合する。
- Details/Sessionパネルへのグローバルステータスメッセージ重複表示をやめ、ステータスバーを唯一の表示場所にする（パネル固有の状態表示は維持）。
- Branches/Details/Session各パネルとポップアップの枠線スタイル・タイトルスタイル・左右余白を統一し、「枠がある/ない」「余白がある/ない」の揺れを解消する。
- ヘッダーの画面名は `Branch Screen` / `Agent Screen` のように「画面」表現へ統一し、Mode表現を残さない。
- Details/Sessionパネルのタイトルからブランチ名を除去し、タイトルはラベルのみ（`Details` / `Session`）で表示する。
- 主要パネルとポップアップのタイトルは同じ前後パディングと同じ色スタイル（例: シアン + 太字）に統一する。
- Settings画面の専用Instructionsパネルは廃止し、操作ヒントは `app.rs` のフッターヘルプへ統合する。
- Settings画面のカテゴリタブと各パネルの枠線色・タイトル色・タイトルパディングを他画面の規約に揃える。

## 追加 ハイレベル ToDo (2026-01-27)

- **No.27** 画面骨格の統一: `crates/gwt-cli/src/tui/app.rs` のレイアウト計算を見直し、主要画面でヘッダーと下部2行（フッターヘルプ + ステータスバー）を常に確保する。
- **No.28** ステータスバーの常時表示化: `crates/gwt-cli/src/tui/screens/branch_list.rs` でエージェント0件でもステータスバーを描画し、選択数とステータスメッセージを統合表示する。
- **No.29** 起動ステータス行の統合: `crates/gwt-cli/src/tui/app.rs` の起動中ステータス行を廃止し、同情報をステータスバーへ渡す。
- **No.30** 重複表示の解消: `crates/gwt-cli/src/tui/screens/branch_list.rs` のDetails/Sessionパネルでグローバルステータスメッセージを表示しないよう整理する。
- **No.31** 枠線/余白の統一: `crates/gwt-cli/src/tui/screens/branch_list.rs` と各ポップアップ描画で枠線色・タイトルスタイル・左右余白を揃える。
- **No.32** TDDでの担保: 画面骨格（ヘッダー/フッター/ステータスバー）と重複表示がないことをユニットテストで固定化する。
- **No.33** 画面名ラベルの統一: `crates/gwt-cli/src/tui/app.rs` のヘッダー画面名を `Branch Screen` / `Agent Screen` に変更する。
- **No.34** パネルタイトルの簡素化と統一: `crates/gwt-cli/src/tui/screens/branch_list.rs` のDetails/Sessionタイトルからブランチ名を除去し、タイトル色とパディングを揃える。
- **No.35** Settings下部構造の統一: `crates/gwt-cli/src/tui/screens/settings.rs` のInstructionsブロックを廃止し、フッターヘルプへ寄せる。
- **No.36** Settingsタイトル規約の統一: `crates/gwt-cli/src/tui/screens/settings.rs` のタブ/一覧/説明/フォーム/確認/AI/環境変数のタイトル色とパディングを揃える。

## 追加方針: 現在ブランチのラベル表示 (2026-01-31)

- ブランチ一覧で現在ブランチのブランチ名直後に `(current)` を追加し、緑色で表示する。
- 右側のエージェント情報のアライメントを維持するため、左側幅計算に `(current)` の幅を加算する。
- 選択中のブランチでも `(current)` は緑色で表示する。

## 追加 ハイレベル ToDo (2026-01-31)

1) **表示仕様反映**: `specs/SPEC-d2f4762a/spec.md` / `specs/SPEC-d2f4762a/plan.md` に現在ブランチの `(current)` 表示要件を追記する。
2) **TDD**: `crates/gwt-cli/src/tui/screens/branch_list.rs` に `(current)` 表示と色を検証するテストを追加する。
3) **実装**: `crates/gwt-cli/src/tui/screens/branch_list.rs` で現在ブランチに `(current)` を緑で描画し、左側幅計算を更新する。

## リスクと緩和
- **パフォーマンス**: `getMergedPRWorktrees()` を表示用に呼ぶ頻度を制御（ブランチ更新時のみ）し、結果をキャッシュ。
- **誤削除**: 安全判定は候補ロジックと同一（no-diff / no uncommitted / no unpushed）。安全でない選択は `!`/`*` 表示と実行時スキップ＋警告。
- **Worktree誤削除**: 自動削除を行わないため誤削除は発生しない。手動解決のみ許可する。
- **描画負荷**: 進捗更新の過剰な再描画を避けるため、更新頻度を抑制し、完了したブランチから順次反映する。
- **色分けの視認性**: 色覚多様性を考慮し、赤のみで状態を表現（goneとInaccessibleは同一の警告色）。
