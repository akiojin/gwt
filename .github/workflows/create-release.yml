name: Create Release PR

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create release PR (develop â†’ main)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get next version from release-please
        id: version
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Get current version from manifest
          CURRENT_VERSION=$(jq -r '.["."]' .release-please-manifest.json)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Check for conventional commits since last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline)
          else
            COMMITS=$(git log --oneline "${LAST_TAG}..HEAD")
          fi

          # Determine bump type based on commits
          if echo "$COMMITS" | grep -qE "^[a-f0-9]+ (feat|feature)(\(.+\))?!:"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "BREAKING CHANGE"; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^[a-f0-9]+ (feat|feature)(\(.+\))?:"; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -qE "^[a-f0-9]+ (fix|perf)(\(.+\))?:"; then
            BUMP="patch"
          else
            BUMP="none"
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT

          if [ "$BUMP" = "none" ]; then
            echo "No releasable commits found"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Calculate next version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          case "$BUMP" in
            major)
              NEXT_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac

          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "has_release=true" >> $GITHUB_OUTPUT
          echo "Next version will be: $NEXT_VERSION (bump: $BUMP)"

      - name: Check for existing PR
        if: steps.version.outputs.has_release == 'true'
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head develop --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release PR
        if: steps.version.outputs.has_release == 'true' && steps.check_pr.outputs.pr_exists != 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          NEXT_VERSION: ${{ steps.version.outputs.next_version }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head develop \
            --title "chore(release): v${NEXT_VERSION}" \
            --body "## Release v${NEXT_VERSION}

          This PR merges develop into main for release.

          After this PR is merged:
          1. \`release.yml\` will create the Git tag and GitHub Release via release-please
          2. \`publish.yml\` will handle npm publish and backmerge to develop

          ---
          ðŸ¤– Generated with GitHub Actions")

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"

      - name: Enable auto-merge
        if: steps.version.outputs.has_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.create_pr.outputs.pr_number || steps.check_pr.outputs.pr_number }}
        run: |
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge "$PR_NUMBER" --auto --merge
            echo "Auto-merge enabled for PR #$PR_NUMBER"
          fi

      - name: Summary
        run: |
          if [ "${{ steps.version.outputs.has_release }}" != "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## No Release Needed

          No releasable commits (feat/fix) found since last release.
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Release PR Created/Updated

          - **Next Version**: v${{ steps.version.outputs.next_version }}
          - **PR**: #${{ steps.create_pr.outputs.pr_number || steps.check_pr.outputs.pr_number }}
          - **Auto-merge**: Enabled

          ### Next steps
          1. CI checks will run on the Release PR
          2. Once checks pass, the PR will be auto-merged to main
          3. release.yml will create tag and GitHub Release
          4. publish.yml will handle npm publish and backmerge to develop
          EOF
          fi
