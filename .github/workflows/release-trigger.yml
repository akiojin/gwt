name: Release Trigger

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'release' to confirm release"
        required: true
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create develop â†’ main PR
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'release'

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop
          persist-credentials: false

      - name: Prepare metadata
        id: meta
        run: |
          echo "date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Create or update release PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TITLE="Release: ${{ steps.meta.outputs.date }} (${{ steps.meta.outputs.sha }})"
          BODY=$(cat <<'BODY'
Automatic release PR from develop to main.

After merge, semantic-release will:
- Determine version from Conventional Commits
- Update package.json and CHANGELOG.md
- Create Git tag (e.g., v1.2.0) and GitHub Release
- Publish to npm (enable via configuration)
- Back-merge release commit to develop
BODY
)
          EXISTING_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number' 2>/dev/null || true)
          if [ -z "$EXISTING_NUMBER" ]; then
            PR_URL=$(gh pr create --base main --head develop --title "$TITLE" --body "$BODY" --label release --label auto-merge)
            PR_NUMBER=$(gh pr view "$PR_URL" --json number --jq '.number')
          else
            PR_NUMBER="$EXISTING_NUMBER"
            gh pr edit "$PR_NUMBER" --title "$TITLE" --body "$BODY" --add-label release --add-label auto-merge >/dev/null
            PR_URL=$(gh pr view "$PR_NUMBER" --json url --jq '.url')
          fi
          gh pr merge "$PR_NUMBER" --auto --merge >/dev/null || true
          echo "url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Summary
        env:
          PR_URL: ${{ steps.pr.outputs.url }}
          SHA: ${{ steps.meta.outputs.sha }}
        run: |
          cat <<'SUMMARY' >> "$GITHUB_STEP_SUMMARY"
## Release trigger
- Source branch: develop
- Target branch: main
- Head commit: ${SHA}
- Release PR: ${PR_URL}

Ensure the Release workflow (push to main) succeeds to complete semantic-release.
SUMMARY
