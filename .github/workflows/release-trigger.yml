name: Release Trigger

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'release' to confirm release"
        required: true
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-and-release:
    name: Merge develop to main
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'release'

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop
          token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

      - name: Configure git credentials
        env:
          GH_RELEASE_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
        run: |
          if [ -z "$GH_RELEASE_TOKEN" ]; then
            echo "SEMANTIC_RELEASE_TOKEN secret is not configured"
            exit 1
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_RELEASE_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Fetch main branch
        run: |
          git fetch origin main:main

      - name: Merge develop into main
        run: |
          git checkout main
          git merge --ff-only develop || {
            echo "Fast-forward merge failed. Creating merge commit..."
            git merge develop --no-ff -m "chore: merge develop into main for release"
          }

      - name: Push to main
        run: |
          git push origin main
          echo "Successfully pushed to main. Release workflow will be triggered automatically."

      - name: Summary
        run: |
          echo "## Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "develop branch has been merged into main." >> $GITHUB_STEP_SUMMARY
          echo "The Release workflow will now automatically:" >> $GITHUB_STEP_SUMMARY
          echo "- Run tests and build" >> $GITHUB_STEP_SUMMARY
          echo "- Execute semantic-release" >> $GITHUB_STEP_SUMMARY
          echo "- Publish to npm" >> $GITHUB_STEP_SUMMARY
          echo "- Create GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Release workflow](https://github.com/${{ github.repository }}/actions/workflows/release.yml) for progress." >> $GITHUB_STEP_SUMMARY
