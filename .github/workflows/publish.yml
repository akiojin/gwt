name: Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # npm publish job (currently disabled in .releaserc.json)
  # Enable by setting npmPublish: true in .releaserc.json and configuring NPM_TOKEN
  npm-publish:
    name: NPM Publish
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if release commit
        id: check_release
        run: |
          if git log -1 --pretty=%B | grep -q '^chore(release):'; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      # Uncomment when ready to publish to npm
      # - name: Publish to npm
      #   if: steps.check_release.outputs.is_release == 'true'
      #   env:
      #     NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: npm publish --access public

  backmerge-to-develop:
    name: Backmerge to develop
    runs-on: ubuntu-latest
    needs: npm-publish
    if: always() && !contains(github.event.head_commit.message, '[skip ci]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Backmerge main to develop
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git fetch origin main develop

          if ! git ls-remote --exit-code origin develop >/dev/null 2>&1; then
            echo "develop branch not found on origin; skipping backmerge."
            exit 0
          fi

          if git show-ref --verify --quiet refs/heads/develop; then
            git checkout develop
            git reset --hard origin/develop
          else
            git checkout -b develop origin/develop
          fi

          if git merge origin/main --no-edit -m "chore: Backmerge main to develop [skip ci]

          Automated backmerge from main to develop after release.

          ðŸ¤– Generated with GitHub Actions"; then
            git push origin HEAD:develop
            echo "âœ“ Successfully merged main to develop"
          else
            echo "Merge conflict detected - creating sync PR"
            git merge --abort

            SYNC_BRANCH="sync/main-to-develop-$(date +%s)"
            git checkout -b "$SYNC_BRANCH" origin/main
            git push origin "$SYNC_BRANCH"

            gh pr create \
              --base develop \
              --head "$SYNC_BRANCH" \
              --title "chore: Sync main â†’ develop after release" \
              --body "Automatic sync after release.

          Manual merge required due to conflicts.

          ðŸ¤– Generated with GitHub Actions" || echo "PR may already exist"
          fi

  delete-release-branch:
    name: Delete release branch
    runs-on: ubuntu-latest
    needs: backmerge-to-develop
    if: always() && !contains(github.event.head_commit.message, '[skip ci]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Delete release branch
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Find the release branch that was merged
          # Check recent merged PRs to main
          RELEASE_BRANCH=$(gh pr list \
            --base main \
            --state merged \
            --limit 5 \
            --json headRefName,mergedAt \
            --jq 'map(select(.headRefName | startswith("release/"))) | sort_by(.mergedAt) | reverse | .[0].headRefName' || echo "")

          if [ -z "$RELEASE_BRANCH" ]; then
            echo "No release branch found to delete"
            exit 0
          fi

          echo "Found release branch: $RELEASE_BRANCH"

          # Check if branch exists on remote
          if git ls-remote --exit-code origin "$RELEASE_BRANCH" >/dev/null 2>&1; then
            echo "Deleting $RELEASE_BRANCH..."
            git push origin --delete "$RELEASE_BRANCH" || echo "Failed to delete branch (may already be deleted)"
            echo "âœ“ Release branch deleted: $RELEASE_BRANCH"
          else
            echo "Release branch $RELEASE_BRANCH does not exist on remote"
          fi
