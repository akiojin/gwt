name: Enable Auto Merge

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize

jobs:
  warn-missing-token:
    if: >-
      github.event.pull_request.draft == false &&
      (github.event.pull_request.base.ref == 'main' ||
       github.event.pull_request.base.ref == 'develop') &&
      secrets.AUTO_MERGE_TOKEN == ''
    runs-on: ubuntu-latest
    steps:
      - run: echo "::notice::AUTO_MERGE_TOKEN is not configured; skipping auto-merge enablement for this pull request." >&2

  enable-auto-merge:
    if: >-
      github.event.pull_request.draft == false &&
      (github.event.pull_request.base.ref == 'main' ||
       github.event.pull_request.base.ref == 'develop') &&
      secrets.AUTO_MERGE_TOKEN != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
    steps:
      - name: Skip when auto-merge already enabled
        id: check
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          if gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json autoMergeRequest --jq '.autoMergeRequest != null' | grep -q true; then
            echo "already-enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "already-enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto merge
        if: steps.check.outputs.already-enabled == 'false'
        env:
          PR_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -euo pipefail
          gh api graphql --method POST \
            -f query='mutation($pr:ID!,$method:PullRequestMergeMethod!){enablePullRequestAutoMerge(input:{pullRequestId:$pr,mergeMethod:$method}){pullRequest{number}}}' \
            -F pr="$PR_ID" \
            -F method=MERGE
