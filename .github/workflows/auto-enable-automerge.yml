name: Enable Auto Merge

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - ready_for_review
      - synchronize

jobs:
  enable-auto-merge:
    if: >-
      github.event.pull_request.draft == false &&
      (github.event.pull_request.base.ref == 'main' ||
       github.event.pull_request.base.ref == 'develop')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Resolve auto merge token
        id: token
        env:
          AUTO_MERGE_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
        run: |
          if [ -z "$AUTO_MERGE_TOKEN" ]; then
            echo "::notice::AUTO_MERGE_TOKEN is not configured; skipping auto-merge enablement." >&2
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "token=$AUTO_MERGE_TOKEN" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip when auto-merge already enabled
        id: check
        if: steps.token.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          if gh pr view "$PR_NUMBER" --repo "$GH_REPO" --json autoMergeRequest --jq '.autoMergeRequest != null' | grep -q true; then
            echo "already-enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "already-enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Enable auto merge
        if: steps.token.outputs.skip != 'true' && steps.check.outputs.already-enabled == 'false'
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}
          PR_ID: ${{ github.event.pull_request.node_id }}
        run: |
          set -euo pipefail
          gh api graphql --method POST \
            -f query='mutation($pr:ID!,$method:PullRequestMergeMethod!){enablePullRequestAutoMerge(input:{pullRequestId:$pr,mergeMethod:$method}){pullRequest{number}}}' \
            -F pr="$PR_ID" \
            -F method=MERGE
